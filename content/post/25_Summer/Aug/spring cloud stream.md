---
title: ã€Shopeeã€‘Spring Cloud Stream
date: 2025-08-21 00:00:00+0000
categories: [nutrition]
tags: [Shopee]
---

## Spring Integration

Spring Integration æ˜¯ Spring æ¡†æ¶çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œä¸“æ³¨äºå®ç°**ä¼ä¸šé›†æˆæ¨¡å¼ï¼ˆEnterprise Integration Patterns, EIPï¼‰**ï¼Œæ—¨åœ¨é€šè¿‡æ¶ˆæ¯é©±åŠ¨çš„ç¼–ç¨‹æ¨¡å‹ç®€åŒ–ç³»ç»Ÿé—´é€šä¿¡å’Œé›†æˆã€‚å®ƒæ‰©å±•äº† Spring çš„æ ¸å¿ƒæ¶ˆæ¯å¤„ç†èƒ½åŠ›ï¼ˆ`Spring Messaging`ï¼‰ï¼Œæä¾›äº†ä¸€å¥—æ ‡å‡†åŒ–çš„ç»„ä»¶å’ŒæŠ½è±¡ï¼Œä»¥æ„å»ºæ¾è€¦åˆã€å¯æ‰©å±•çš„äº‹ä»¶é©±åŠ¨æ¶æ„ã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒæ¦‚å¿µå’Œç‰¹æ€§çš„è¯¦ç»†è§£æï¼š

------

### ğŸ§± ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸ç»„ä»¶

1. **æ¶ˆæ¯ï¼ˆMessageï¼‰**
   - **ç»“æ„**ï¼šåŒ…å«**æœ‰æ•ˆè´Ÿè½½ï¼ˆPayloadï¼‰**ï¼ˆå®é™…ä¼ è¾“çš„æ•°æ®ï¼Œå¦‚å¯¹è±¡ã€å­—ç¬¦ä¸²ï¼‰å’Œ**æ ‡å¤´ï¼ˆHeaderï¼‰**ï¼ˆå…ƒæ•°æ®ï¼Œå¦‚æ¶ˆæ¯IDã€æ—¶é—´æˆ³ã€æ¥æºæ ‡è¯†ç­‰ï¼‰ã€‚æ ‡å¤´å¯ç”¨äºä¼ é€’è·¯ç”±ã€ä¼˜å…ˆçº§ç­‰é™„åŠ ä¿¡æ¯ã€‚
   - **ä½œç”¨**ï¼šä½œä¸ºæ•°æ®è½½ä½“ï¼Œå®ç°ç³»ç»Ÿé—´è§£è€¦é€šä¿¡ã€‚
2. **æ¶ˆæ¯é€šé“ï¼ˆMessage Channelï¼‰**
   - **ç±»å‹**ï¼š
     - **ç›´æ¥é€šé“ï¼ˆDirectChannelï¼‰**ï¼šç‚¹å¯¹ç‚¹é€šä¿¡ï¼Œé»˜è®¤åŒæ­¥å¤„ç†ï¼Œæ”¯æŒäº‹åŠ¡ä¼ æ’­ã€‚
     - **å‘å¸ƒ-è®¢é˜…é€šé“ï¼ˆPublishSubscribeChannelï¼‰**ï¼šå¹¿æ’­æ¶ˆæ¯è‡³æ‰€æœ‰è®¢é˜…è€…ï¼Œé€‚ç”¨äºäº‹ä»¶é€šçŸ¥ã€‚
     - **é˜Ÿåˆ—é€šé“ï¼ˆQueueChannelï¼‰**ï¼šå¼‚æ­¥ç¼“å†²æ¶ˆæ¯ï¼Œæ”¯æŒå®¹é‡é™åˆ¶å’ŒæŒä¹…åŒ–ï¼Œé˜²æ­¢æ¶ˆè´¹è€…è¿‡è½½ã€‚
     - **ä¼˜å…ˆçº§é€šé“ï¼ˆPriorityChannelï¼‰**ï¼šæŒ‰æ¶ˆæ¯ä¼˜å…ˆçº§æ’åºå¤„ç†ã€‚
     - **çº¦ä¼šé€šé“ï¼ˆRendezvousChannelï¼‰**ï¼šå®ç°â€œè¯·æ±‚-å“åº”â€åŒæ­¥äº¤äº’ï¼Œå‘é€æ–¹é˜»å¡ç›´è‡³æ¥æ”¶æ–¹å¤„ç†ã€‚
3. **æ¶ˆæ¯ç«¯ç‚¹ï¼ˆMessage Endpointï¼‰**
   - **åŠŸèƒ½**ï¼šè¿æ¥é€šé“ä¸ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†æ¶ˆæ¯çš„èµ·ç‚¹æˆ–ç»ˆç‚¹ã€‚
   - **å¸¸è§ç±»å‹**ï¼š
     - **æœåŠ¡æ¿€æ´»å™¨ï¼ˆService Activatorï¼‰**ï¼šè°ƒç”¨ä¸šåŠ¡æ–¹æ³•å¤„ç†æ¶ˆæ¯ï¼ˆå¦‚ `@ServiceActivator`ï¼‰ã€‚
     - **è·¯ç”±å™¨ï¼ˆRouterï¼‰**ï¼šåŸºäºå†…å®¹ï¼ˆå¦‚æ ‡å¤´æˆ–è´Ÿè½½ç±»å‹ï¼‰åŠ¨æ€è·¯ç”±æ¶ˆæ¯è‡³ä¸åŒé€šé“ã€‚
     - **è½¬æ¢å™¨ï¼ˆTransformerï¼‰**ï¼šä¿®æ”¹æ¶ˆæ¯æ ¼å¼ï¼ˆå¦‚ JSON â†’ å¯¹è±¡ï¼‰ã€‚
     - **è¿‡æ»¤å™¨ï¼ˆFilterï¼‰**ï¼šæ‹¦æˆªä¸ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯ï¼ˆå¦‚ç©ºæ¶ˆæ¯ä¸¢å¼ƒï¼‰ã€‚
     - **é€‚é…å™¨ï¼ˆAdapterï¼‰**ï¼šé›†æˆå¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚æ–‡ä»¶ã€æ•°æ®åº“ã€HTTPï¼‰ï¼Œå®ç°åè®®è½¬æ¢ï¼ˆå¦‚ `FileReadingMessageSource`ç›‘å¬æ–‡ä»¶å˜æ›´ï¼‰ã€‚

------

### ğŸ”§ äºŒã€é›†æˆæ¨¡å¼ä¸åŠŸèƒ½

1. **ä¼ä¸šé›†æˆæ¨¡å¼ï¼ˆEIPï¼‰æ”¯æŒ**
   - **è·¯ç”±ï¼ˆRoutingï¼‰**ï¼šåŠ¨æ€åˆ†å‘æ¶ˆæ¯è‡³ä¸åŒå¤„ç†å™¨ã€‚
   - **èšåˆï¼ˆAggregationï¼‰**ï¼šåˆå¹¶å¤šä¸ªç›¸å…³æ¶ˆæ¯ï¼ˆå¦‚è®¢å•åˆ†é¡¹åˆå¹¶ä¸ºæ€»å•ï¼‰ã€‚
   - **æ‹†åˆ†ï¼ˆSplittingï¼‰**ï¼šå°†å¤æ‚æ¶ˆæ¯æ‹†åˆ†ä¸ºå­æ¶ˆæ¯ç‹¬ç«‹å¤„ç†ï¼ˆå¦‚æ‰¹é‡æ•°æ®åˆ†ç‰‡ï¼‰ã€‚
   - **äº‹åŠ¡ç®¡ç†**ï¼šé€šè¿‡ `DirectChannel`æ”¯æŒè·¨é€šé“äº‹åŠ¡ä¸€è‡´æ€§ï¼ˆå¦‚æ•°æ®åº“æ›´æ–°ä¸æ¶ˆæ¯å‘é€åŸå­æ€§ï¼‰ã€‚
2. **å¼‚æ­¥ä¸æµå¤„ç†**
   - ç»“åˆé˜Ÿåˆ—é€šé“æˆ–æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQã€Kafkaï¼‰ï¼Œå®ç°å‰Šå³°å¡«è°·å’Œå¼‚æ­¥ä»»åŠ¡å¤„ç†ã€‚
   - æ”¯æŒå®æ—¶æ•°æ®æµå¤„ç†ï¼ˆå¦‚æ—¥å¿—åˆ†æã€ç›‘æ§å‘Šè­¦ï¼‰ã€‚

------

### âš™ï¸ ä¸‰ã€é…ç½®ä¸æ‰©å±•æ–¹å¼

1. **é…ç½®çµæ´»æ€§**

   - **XML é…ç½®**ï¼šä¼ ç»Ÿæ–¹å¼ï¼Œå£°æ˜å¼å®šä¹‰é€šé“å’Œç«¯ç‚¹ï¼ˆå¦‚ `<int:channel id="inputChannel"/>`ï¼‰ã€‚
   - **Java æ³¨è§£**ï¼šæ¨èæ–¹å¼ï¼Œä¸ Spring Boot æ— ç¼é›†æˆï¼ˆå¦‚ `@EnableIntegration`ã€`@Bean`å®šä¹‰é€šé“ï¼‰ã€‚

   ```
   @Configuration
   @EnableIntegration
   public class IntegrationConfig {
       @Bean
       public MessageChannel inputChannel() {
           return new DirectChannel();
       }
   
       @ServiceActivator(inputChannel = "inputChannel")
       public void handleMessage(String payload) {
           System.out.println("Received: " + payload);
       }
   }
   ```

2. **é€‚é…å™¨æ‰©å±•**

   - å†…ç½®æ”¯æŒæ–‡ä»¶ã€JMSã€HTTPã€Emailã€æ•°æ®åº“ç­‰é€‚é…å™¨ï¼Œç®€åŒ–å¤–éƒ¨ç³»ç»Ÿé›†æˆã€‚

   - ç¤ºä¾‹ï¼šHTTP é€‚é…å™¨ç›‘å¬è¯·æ±‚å¹¶è½¬ä¸ºæ¶ˆæ¯ï¼š

     ```
     <int-http:inbound-channel-adapter 
         path="/receive" 
         channel="httpInputChannel" 
         supported-methods="POST"/>
     ```

------

### âœ… å››ã€æ ¸å¿ƒä¼˜åŠ¿

1. **è§£è€¦ä¸å¯æ‰©å±•æ€§**
   - ç»„ä»¶é€šè¿‡æ¶ˆæ¯é€šé“é€šä¿¡ï¼Œé¿å…ç›´æ¥ä¾èµ–ï¼Œæ”¯æŒç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•ã€‚
2. **ä¸ Spring ç”Ÿæ€æ— ç¼é›†æˆ**
   - å¤ç”¨ Spring çš„äº‹åŠ¡ã€å®‰å…¨ã€ç›‘æ§ï¼ˆå¦‚ Actuatorï¼‰èƒ½åŠ›ã€‚
3. **å£°æ˜å¼å¼€å‘**
   - é€šè¿‡ DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰æˆ–æ³¨è§£ç®€åŒ–é…ç½®ï¼Œèšç„¦ä¸šåŠ¡é€»è¾‘ã€‚
4. **å®¹é”™èƒ½åŠ›**
   - æ”¯æŒæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰ã€é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æ¶ˆæ¯å¯é æ€§ã€‚

------

### ğŸš€ äº”ã€å…¸å‹åº”ç”¨åœºæ™¯

1. **ç³»ç»Ÿé›†æˆ**
   - è¿æ¥å¼‚æ„ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“ â†” æ¶ˆæ¯é˜Ÿåˆ— â†” HTTP æœåŠ¡ï¼‰ã€‚
2. **å¼‚æ­¥ä»»åŠ¡å¤„ç†**
   - é«˜å¹¶å‘åœºæ™¯ï¼ˆå¦‚è®¢å•æ”¯ä»˜åå¼‚æ­¥å‘é€é€šçŸ¥ï¼‰ã€‚
3. **äº‹ä»¶é©±åŠ¨æ¶æ„**
   - å¾®æœåŠ¡é—´é€šè¿‡äº‹ä»¶åä½œï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œè§¦å‘ç§¯åˆ†å‘æ”¾ï¼‰ã€‚
4. **ETL æ•°æ®å¤„ç†**
   - æŠ½å–ã€è½¬æ¢ã€åŠ è½½æ•°æ®ï¼ˆå¦‚ä» FTP è¯»å–æ–‡ä»¶ â†’ è½¬æ¢æ ¼å¼ â†’ å­˜å…¥æ•°æ®åº“ï¼‰ã€‚
5. **å®æ—¶æµå¤„ç†**
   - ç»“åˆ Kafka å¤„ç†æ—¥å¿—æˆ–ç›‘æ§æ•°æ®æµã€‚

------

### ğŸ’ æ€»ç»“

Spring Integration æ˜¯æ„å»º**æ¶ˆæ¯é©±åŠ¨å‹åº”ç”¨**çš„æ ¸å¿ƒæ¡†æ¶ï¼Œé€šè¿‡æ ‡å‡†åŒ–æ¶ˆæ¯æ¨¡å‹ã€é€šé“æœºåˆ¶å’Œ EIP æ¨¡å¼ï¼Œè§£å†³äº†ä¼ä¸šé›†æˆä¸­çš„å¤æ‚æ€§é—®é¢˜ã€‚å…¶ä»·å€¼åœ¨äºå°†å¼€å‘è€…ä»åº•å±‚é€šä¿¡åè®®ä¸­è§£æ”¾ï¼Œæä¾›**å£°æ˜å¼é…ç½®**ã€**æ— ç¼æ‰©å±•**åŠ**å¯é æ¶ˆæ¯ä¼ é€’**èƒ½åŠ›ï¼Œæ˜¯æ„å»ºé«˜å¯ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºçŸ³ã€‚

## Spring Cloud Stream

Spring Cloud Stream æ˜¯ä¸€ä¸ªç”¨äºæ„å»º**æ¶ˆæ¯é©±åŠ¨å‹å¾®æœåŠ¡**çš„æ¡†æ¶ï¼Œå®ƒåŸºäº Spring Boot å’Œ Spring Integrationï¼Œé€šè¿‡æŠ½è±¡åŒ–æ¶ˆæ¯ä¸­é—´ä»¶çš„åº•å±‚ç»†èŠ‚ï¼Œç®€åŒ–å¾®æœåŠ¡é—´çš„å¼‚æ­¥é€šä¿¡ã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€ç¼–ç¨‹æ¨¡å‹åŠä¼˜åŠ¿çš„è¯¦ç»†è§£æï¼š

------

### ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ

1. **Binderï¼ˆç»‘å®šå™¨ï¼‰**
   - **ä½œç”¨**ï¼šè¿æ¥åº”ç”¨ç¨‹åºä¸æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ Kafkaã€RabbitMQï¼‰çš„æ¡¥æ¢ï¼Œå±è”½ä¸åŒä¸­é—´ä»¶çš„å®ç°å·®å¼‚ã€‚å¼€å‘è€…ä»…éœ€é…ç½® Binder ç±»å‹ï¼ˆå¦‚ `rabbit`æˆ– `kafka`ï¼‰ï¼Œå³å¯åŠ¨æ€åˆ‡æ¢ä¸­é—´ä»¶è€Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚
   - **å®ç°**ï¼šæ”¯æŒ RabbitMQï¼ˆ`spring-cloud-starter-stream-rabbit`ï¼‰å’Œ Kafkaï¼ˆ`spring-cloud-stream-binder-kafka`ï¼‰ç­‰ä¸»æµä¸­é—´ä»¶ã€‚
2. **Channelï¼ˆé€šé“ï¼‰**
   - **ç±»å‹**ï¼š
     - `Input Channel`ï¼šæ¥æ”¶æ¶ˆæ¯çš„é€šé“ï¼ˆæ¶ˆè´¹è€…ï¼‰ã€‚
     - `Output Channel`ï¼šå‘é€æ¶ˆæ¯çš„é€šé“ï¼ˆç”Ÿäº§è€…ï¼‰ã€‚
   - **æŠ½è±¡åŒ–**ï¼šé€šé“ä»£è¡¨æ¶ˆæ¯é˜Ÿåˆ—çš„é€»è¾‘æŠ½è±¡ï¼Œå¼€å‘è€…é€šè¿‡é…ç½®ç»‘å®šåˆ°å…·ä½“ä¸­é—´ä»¶çš„ Topic/Exchangeï¼Œè§£è€¦ä¸šåŠ¡ä»£ç ä¸ä¸­é—´ä»¶ç»†èŠ‚ã€‚
3. **æ¶ˆæ¯å¤„ç†å™¨ï¼ˆMessage Handlerï¼‰**
   - è´Ÿè´£æ¶ˆæ¯çš„è½¬æ¢ã€è·¯ç”±å’Œä¸šåŠ¡å¤„ç†ï¼Œæ”¯æŒè‡ªå®šä¹‰é€»è¾‘ï¼ˆå¦‚ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼‰ã€‚
4. **æ ¸å¿ƒè¯­ä¹‰æ”¯æŒ**
   - **å‘å¸ƒ-è®¢é˜…**ï¼šæ¶ˆæ¯å¹¿æ’­è‡³å¤šä¸ªæ¶ˆè´¹è€…ã€‚
   - **æ¶ˆè´¹ç»„ï¼ˆConsumer Groupï¼‰**ï¼šåŒç»„å†…ä»…ä¸€ä¸ªå®ä¾‹æ¶ˆè´¹æ¶ˆæ¯ï¼Œé¿å…é‡å¤å¤„ç†ï¼ˆé€šè¿‡ `group`é…ç½®å®ç°ï¼‰ã€‚
   - **åˆ†åŒºï¼ˆPartitioningï¼‰**ï¼šç¡®ä¿ç›¸åŒç‰¹å¾çš„æ¶ˆæ¯ç”±åŒä¸€å®ä¾‹å¤„ç†ï¼Œä¿éšœçŠ¶æ€ä¸€è‡´æ€§ï¼ˆå¦‚æŒ‰ç”¨æˆ· ID åˆ†åŒºï¼‰ã€‚

------

### äºŒã€æ¶æ„ä¸æ•°æ®æµå‘

1. **åˆ†å±‚æ¶æ„**

   - **åº”ç”¨å±‚**ï¼šç”Ÿäº§è€…/æ¶ˆè´¹è€…é€šè¿‡é€šé“æ”¶å‘æ¶ˆæ¯ã€‚
   - **ç»‘å®šå±‚ï¼ˆBinderï¼‰**ï¼šå°†é€šé“ä¸ä¸­é—´ä»¶è¿æ¥ï¼Œå¤„ç†æ¶ˆæ¯ç¼–è§£ç ã€è·¯ç”±ç­‰ã€‚
   - **æ¶ˆæ¯ä¸­é—´ä»¶å±‚**ï¼šå®é™…çš„æ¶ˆæ¯ä»£ç†ï¼ˆå¦‚ RabbitMQ/Kafkaï¼‰ã€‚

   ```
   graph LR
   A[ç”Ÿäº§è€…] -->|Output Channel| B[Binder]
   B -->|æ¶ˆæ¯| C[RabbitMQ/Kafka]
   C -->|Input Channel| D[Binder]
   D --> E[æ¶ˆè´¹è€…]
   ```

2. **æ•°æ®æµæ ‡å‡†åŒ–**

   - **Source**ï¼šå®šä¹‰è¾“å‡ºé€šé“ï¼ˆ`@Output`ï¼‰ï¼Œç”¨äºæ¶ˆæ¯å‘é€ã€‚
   - **Sink**ï¼šå®šä¹‰è¾“å…¥é€šé“ï¼ˆ`@Input`ï¼‰ï¼Œç”¨äºæ¶ˆæ¯æ¥æ”¶ã€‚
   - **Processor**ï¼šåŒæ—¶åŒ…å«è¾“å…¥å’Œè¾“å‡ºé€šé“ï¼ˆç»§æ‰¿ `Source`å’Œ `Sink`ï¼‰ã€‚

------

### ä¸‰ã€ç¼–ç¨‹æ¨¡å‹ä¸å…³é”®æ³¨è§£

1. **å¯ç”¨ç»‘å®š**

   - `@EnableBinding`ï¼šæ ‡è®°åœ¨é…ç½®ç±»ï¼Œå£°æ˜ä½¿ç”¨çš„é€šé“æ¥å£ï¼ˆå¦‚ `Source.class`, `Processor.class`ï¼‰ï¼Œè§¦å‘ Binder åˆå§‹åŒ–ã€‚

   ```
   @SpringBootApplication
   @EnableBinding(Processor.class)
   public class MyApp { ... }
   ```

2. **é€šé“å®šä¹‰**

   - è‡ªå®šä¹‰é€šé“æ¥å£ï¼š

     ```
     public interface CustomChannel {
         String OUTPUT = "customOutput";
         @Output(OUTPUT)
         MessageChannel customOutput();
     }
     ```

3. **æ¶ˆæ¯ç›‘å¬ä¸å‘é€**

   - `@StreamListener`ï¼šç›‘å¬è¾“å…¥é€šé“çš„æ¶ˆæ¯ã€‚
   - `@SendTo`ï¼šå°†å¤„ç†ç»“æœå‘é€è‡³è¾“å‡ºé€šé“ï¼ˆç”¨äºè¯·æ±‚-å“åº”æ¨¡å¼ï¼‰ã€‚

   ```
   @StreamListener(Processor.INPUT)
   @SendTo(Processor.OUTPUT)
   public String process(String message) {
       return "Processed: " + message;
   }
   ```

4. **é…ç½®ç¤ºä¾‹ï¼ˆRabbitMQï¼‰**

   ```
   spring:
     cloud:
       stream:
         binders:
           local_rabbit:
             type: rabbit
             environment: 
               spring.rabbitmq.host: localhost
         bindings:
           input:
             destination: orders.topic  # RabbitMQ Exchange
             binder: local_rabbit
             group: orderService        # æ¶ˆè´¹ç»„å
   ```

------

### å››ã€æ ¸å¿ƒä¼˜åŠ¿

1. **è§£è€¦ä¸çµæ´»æ€§**
   - **ä¸šåŠ¡ä¸ä¸­é—´ä»¶è§£è€¦**ï¼šé€šè¿‡ Binder æŠ½è±¡ï¼Œæ— ç¼åˆ‡æ¢ Kafka/RabbitMQ ç­‰ä¸­é—´ä»¶ï¼Œä»…éœ€ä¿®æ”¹é…ç½®ã€‚
   - **åŠ¨æ€æ‰©å±•**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•æ¶ˆè´¹è€…å®ä¾‹ï¼Œæ¶ˆè´¹ç»„è‡ªåŠ¨åˆ†é…æ¶ˆæ¯åˆ†åŒºã€‚
2. **å¼‚æ­¥é€šä¿¡ä¸å¯é æ€§**
   - **å‰Šå³°å¡«è°·**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²é«˜å¹¶å‘è¯·æ±‚ï¼Œé¿å…æœåŠ¡å´©æºƒã€‚
   - **æŒä¹…åŒ–ä¸é‡è¯•**ï¼šæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ã€æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰å’Œé‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚
3. **ç®€åŒ–å¼€å‘**
   - **å£°æ˜å¼ç¼–ç¨‹**ï¼šé€šè¿‡æ³¨è§£é…ç½®é€šé“ä¸ç›‘å¬ï¼Œå‡å°‘æ ·æ¿ä»£ç ã€‚
   - **å†…ç½®ç›‘æ§**ï¼šé›†æˆ Spring Boot Actuatorï¼Œæä¾›æ¶ˆæ¯æµé‡ã€é”™è¯¯ç‡ç­‰ç›‘æ§æŒ‡æ ‡ã€‚

------

### äº”ã€å…¸å‹åº”ç”¨åœºæ™¯

1. **å¼‚æ­¥å¤„ç†**
   - ç¤ºä¾‹ï¼šè®¢å•æ”¯ä»˜åï¼Œå¼‚æ­¥å‘é€é€šçŸ¥é‚®ä»¶/SMSï¼Œé¿å…é˜»å¡æ ¸å¿ƒæµç¨‹ã€‚
2. **äº‹ä»¶é©±åŠ¨æ¶æ„**
   - ç¤ºä¾‹ï¼šç”¨æˆ·æ³¨å†Œäº‹ä»¶è§¦å‘ç§¯åˆ†å‘æ”¾ã€æ•°æ®åŒæ­¥ç­‰å¤šæœåŠ¡åä½œã€‚
3. **æ—¥å¿—ä¸æµå¤„ç†**
   - ç¤ºä¾‹ï¼šå¾®æœåŠ¡æ—¥å¿—å‘é€è‡³ Kafkaï¼Œç”±æµå¤„ç†å¼•æ“å®æ—¶åˆ†æã€‚
4. **ç³»ç»Ÿè§£è€¦**
   - ç¤ºä¾‹ï¼šåº“å­˜æœåŠ¡ç›‘å¬è®¢å•æ¶ˆæ¯æ›´æ–°åº“å­˜ï¼Œæ— éœ€ç›´æ¥è°ƒç”¨è®¢å• APIã€‚

------

### å…­ã€æ€»ç»“

Spring Cloud Stream é€šè¿‡ **Binder æŠ½è±¡å±‚**ã€**æ ‡å‡†åŒ–é€šé“æ¨¡å‹**å’Œ**å£°æ˜å¼ç¼–ç¨‹**ï¼Œè§£å†³äº†å¾®æœåŠ¡é—´æ¶ˆæ¯é›†æˆçš„å¤æ‚æ€§ï¼ŒåŒæ—¶æä¾›**åŠ¨æ€æ‰©å±•**ã€**å¯é é€šä¿¡**å’Œ**ä¸­é—´ä»¶æ— æ„Ÿåˆ‡æ¢**èƒ½åŠ›ã€‚å…¶æ ¸å¿ƒä»·å€¼åœ¨äºå°†å¼€å‘è€…ä»åº•å±‚æ¶ˆæ¯åè®®ä¸­è§£æ”¾ï¼Œèšç„¦ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œæ˜¯æ„å»ºé«˜å¯ç”¨ã€æ¾è€¦åˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ã€‚

## å•ä½“åº”ç”¨

æ˜¯çš„ï¼Œå•ä½“åº”ç”¨å®Œå…¨å¯ä»¥é›†æˆå¹¶ä½¿ç”¨ **Spring Cloud Stream**ã€‚å°½ç®¡è¯¥æ¡†æ¶é€šå¸¸ä¸å¾®æœåŠ¡æ¶æ„å…³è”ï¼Œä½†å…¶æ ¸å¿ƒè®¾è®¡å¹¶ä¸é™åˆ¶åº”ç”¨ç±»å‹ï¼Œåªè¦åº”ç”¨åŸºäº **Spring Boot** å³å¯ã€‚ä»¥ä¸‹æ˜¯å…·ä½“åˆ†æåŠä½¿ç”¨åœºæ™¯ï¼š

------

### âœ… **ä¸€ã€æŠ€æœ¯å¯è¡Œæ€§**

1. **æ¡†æ¶ç‹¬ç«‹æ€§**

   Spring Cloud Stream çš„æ ¸å¿ƒæ˜¯**æ¶ˆæ¯æŠ½è±¡å±‚**ï¼Œé€šè¿‡ `Binder`å±è”½åº•å±‚æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQã€Kafkaï¼‰çš„å·®å¼‚ã€‚å•ä½“åº”ç”¨åªéœ€å¼•å…¥ç›¸å…³ä¾èµ–å¹¶é…ç½®é€šé“ï¼Œå³å¯åƒå¾®æœåŠ¡ä¸€æ ·æ”¶å‘æ¶ˆæ¯ï¼Œæ— éœ€æ”¹é€ æ¶æ„ã€‚

2. **è½»é‡é›†æˆ**

   å•ä½“åº”ç”¨å¯ä»…å¯ç”¨éƒ¨åˆ†æ¶ˆæ¯é€šé“ï¼ˆå¦‚ä»…ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼‰ï¼Œæ— éœ€å¼ºåˆ¶æ‹†åˆ†æœåŠ¡ã€‚ä¾‹å¦‚ï¼š

   ```
   @SpringBootApplication
   @EnableBinding(Source.class) // ä»…å¯ç”¨æ¶ˆæ¯å‘é€é€šé“
   public class MonolithicApp {
       public static void main(String[] args) {
           SpringApplication.run(MonolithicApp.class, args);
       }
   }
   ```

------

### âš™ï¸ **äºŒã€é€‚ç”¨åœºæ™¯**

1. **æ¨¡å—è§£è€¦**

   åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œä¸åŒæ¨¡å—å¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥é€šä¿¡ï¼Œé¿å…ç´§è€¦åˆã€‚ä¾‹å¦‚ï¼š

   - **è®¢å•æ¨¡å—** â†’ å‘é€è®¢å•æ¶ˆæ¯ â†’ **åº“å­˜æ¨¡å—**å¼‚æ­¥æ‰£å‡åº“å­˜ã€‚
   - **ç”¨æˆ·æ³¨å†Œ** â†’ è§¦å‘é‚®ä»¶é€šçŸ¥ â†’ **æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²è¯·æ±‚**ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹ã€‚

2. **å¼‚æ­¥ä»»åŠ¡å¤„ç†**

   è€—æ—¶æ“ä½œï¼ˆå¦‚æ–‡ä»¶å¯¼å‡ºã€æŠ¥è¡¨ç”Ÿæˆï¼‰å¯è½¬ä¸ºæ¶ˆæ¯é©±åŠ¨ï¼š

   ```
   @StreamListener("task-input")
   public void handleTask(TaskRequest request) {
       // å¼‚æ­¥å¤„ç†ä»»åŠ¡
       reportService.generateReport(request);
   }
   ```

3. **æŠ€æœ¯ç»Ÿä¸€è¿‡æ¸¡**

   è‹¥è®¡åˆ’æœªæ¥æ‹†åˆ†ä¸ºå¾®æœåŠ¡ï¼Œå…ˆåœ¨å•ä½“åº”ç”¨ä¸­å¼•å…¥ Spring Cloud Streamï¼Œå¯**æå‰ç»Ÿä¸€æ¶ˆæ¯ç¼–ç¨‹æ¨¡å‹**ï¼Œé™ä½åç»­è¿ç§»æˆæœ¬ã€‚

------

### âš ï¸ **ä¸‰ã€æ³¨æ„äº‹é¡¹**

1. **èµ„æºå¼€é”€**

   æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQ/Kafkaï¼‰éœ€ç‹¬ç«‹éƒ¨ç½²ï¼Œå•ä½“åº”ç”¨éœ€é¢å¤–ç»´æŠ¤ä¸­é—´ä»¶ï¼Œå¯èƒ½å¢åŠ è¿ç»´å¤æ‚åº¦ã€‚

2. **é€‚ç”¨æ€§è¯„ä¼°**

   - **ç®€å•åœºæ™¯**ï¼šè‹¥ä»…éœ€æœ¬åœ°å¼‚æ­¥ï¼Œå¯ç›´æ¥ç”¨ `@Async`+ çº¿ç¨‹æ± ï¼Œé¿å…å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚
   - **å¤æ‚åœºæ™¯**ï¼šæ¶‰åŠè·¨æ¨¡å—è§£è€¦ã€å‰Šå³°å¡«è°·ã€å¯é é‡è¯•æ—¶ï¼ŒSpring Cloud Stream æ›´æœ‰ä¼˜åŠ¿ã€‚

3. **ä¾èµ–ç®¡ç†**

   ç¡®ä¿ `pom.xml`å¼•å…¥æ­£ç¡®çš„ Binderï¼ˆå¦‚ RabbitMQ æˆ– Kafkaï¼‰ï¼š

   ```
   <dependency>
       <groupId>org.springframework.cloud</groupId>
       <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
   </dependency>
   ```

------

### ğŸ’ **æ€»ç»“**

Spring Cloud Stream **å¹¶éå¾®æœåŠ¡ä¸“å±**ï¼Œå•ä½“åº”ç”¨å¯é€šè¿‡å®ƒå®ç°ï¼š

1. **æ¨¡å—é—´å¼‚æ­¥è§£è€¦**
2. **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—åŒ–**
3. **ç»Ÿä¸€æ¶ˆæ¯æŠ€æœ¯æ ˆä¸ºæœªæ¥æ‹†åˆ†é“ºè·¯**

éœ€æ ¹æ®å®é™…éœ€æ±‚æƒè¡¡ï¼šè‹¥æ¶ˆæ¯é©±åŠ¨çš„æ”¶ç›Šï¼ˆè§£è€¦ã€å¯é æ€§ï¼‰å¤§äºè¿ç»´æˆæœ¬ï¼Œåˆ™å®Œå…¨é€‚ç”¨ï¼›è‹¥ä»…éœ€ç®€å•å¼‚æ­¥ï¼Œå¯é€‰ç”¨æ›´è½»é‡æ–¹æ¡ˆã€‚

## Kafka & Kafka Stream

Kafka Stream å’Œ Kafka è™½ç„¶åŒå± Apache Kafka ç”Ÿæ€ç³»ç»Ÿï¼Œä½†å®šä½ã€åŠŸèƒ½å’Œåº”ç”¨åœºæ™¯æœ‰æ˜¾è‘—åŒºåˆ«ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒå·®å¼‚çš„å¯¹æ¯”åˆ†æï¼š

------

### ğŸ“Œ **1. å®šä½ä¸è§’è‰²**

- **Kafka**
  - **æ ¸å¿ƒå®šä½**ï¼šåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œä¸“æ³¨äº**é«˜ååé‡çš„å®æ—¶æ¶ˆæ¯ä¼ é€’**ã€‚
  - **ä¸»è¦è§’è‰²**ï¼šæä¾›æ•°æ®ç®¡é“ï¼ˆç”Ÿäº§è€…â†’Brokerâ†’æ¶ˆè´¹è€…ï¼‰ï¼Œå®ç°æ¶ˆæ¯çš„å‘å¸ƒ/è®¢é˜…ã€æŒä¹…åŒ–å­˜å‚¨å’Œå®¹é”™ä¼ è¾“ã€‚
  - **æ ¸å¿ƒç»„ä»¶**ï¼š
    - **Producer**ï¼šå‘é€æ¶ˆæ¯åˆ° Topicã€‚
    - **Broker**ï¼šå­˜å‚¨æ¶ˆæ¯çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€‚
    - **Consumer**ï¼šä» Topic æ‹‰å–æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚
- **Kafka Stream**
  - **æ ¸å¿ƒå®šä½**ï¼šåŸºäº Kafka æ„å»ºçš„**æµå¤„ç†åº“**ï¼Œç”¨äºå®æ—¶æ•°æ®è½¬æ¢ä¸åˆ†æã€‚
  - **ä¸»è¦è§’è‰²**ï¼šåœ¨æ¶ˆè´¹ Kafka æ•°æ®çš„åŒæ—¶ï¼Œæ‰§è¡Œå¤æ‚è®¡ç®—ï¼ˆå¦‚è¿‡æ»¤ã€èšåˆã€è¿æ¥ï¼‰å¹¶å°†ç»“æœå†™å› Kafka æˆ–å…¶ä»–ç³»ç»Ÿã€‚

------

### âš™ï¸ **2. åŠŸèƒ½ç‰¹æ€§**

| **èƒ½åŠ›**       | **Kafka**                       | **Kafka Stream**                           |
| -------------- | ------------------------------- | ------------------------------------------ |
| **æ¶ˆæ¯ä¼ é€’**   | âœ… æ”¯æŒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹         | âŒ ä¾èµ– Kafka çš„åº•å±‚æ¶ˆæ¯ä¼ é€’                |
| **æµå¤„ç†èƒ½åŠ›** | âŒ ä»…æ”¯æŒåŸºç¡€æ¶ˆè´¹                | âœ… æ”¯æŒå¤æ‚æ“ä½œï¼ˆçª—å£èšåˆã€çŠ¶æ€ç®¡ç†ã€Joinï¼‰ |
| **çŠ¶æ€ç®¡ç†**   | âŒ æ— å†…ç½®çŠ¶æ€å­˜å‚¨                | âœ… å†…ç½®çŠ¶æ€å­˜å‚¨ï¼ˆå¦‚ RocksDBï¼‰ï¼Œæ”¯æŒå®æ—¶æ›´æ–° |
| **å¤„ç†è¯­ä¹‰**   | æ”¯æŒ At-least-once/At-most-once | âœ… æ”¯æŒ Exactly-onceï¼ˆç²¾ç¡®ä¸€æ¬¡å¤„ç†ï¼‰        |
| **æ—¶é—´å¤„ç†**   | âŒ ä»…æ”¯æŒäº‹ä»¶æ—¶é—´æˆ³              | âœ… æ”¯æŒäº‹ä»¶æ—¶é—´ã€å¤„ç†æ—¶é—´ã€çª—å£æ“ä½œ         |

------

### ğŸ› ï¸ **3. å¼€å‘å¤æ‚åº¦**

- **Kafka**
  - **ä½çº§åˆ« API**ï¼šå¼€å‘è€…éœ€æ‰‹åŠ¨ç®¡ç†åˆ†åŒºåˆ†é…ã€åç§»é‡æäº¤ã€æ•…éšœæ¢å¤ç­‰ç»†èŠ‚ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆç®€å•æ•°æ®ä¼ è¾“æˆ–ä¸å…¶ä»–ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“ã€Flinkï¼‰é›†æˆã€‚
- **Kafka Stream**
  - **é«˜çº§åˆ« API**ï¼šæä¾›å£°æ˜å¼ DSLï¼ˆå¦‚ `map`ã€`filter`ã€`groupBy`ï¼‰å’Œ Processor APIï¼Œç®€åŒ–æµå¤„ç†é€»è¾‘å¼€å‘ã€‚
  - **è‡ªåŠ¨å®¹é”™**ï¼šè‡ªåŠ¨å¤„ç†æ•…éšœè½¬ç§»ã€çŠ¶æ€æ¢å¤å’Œåˆ†åŒºå†å¹³è¡¡ã€‚

------

### ğŸ¯ **4. é€‚ç”¨åœºæ™¯**

| **åœºæ™¯**         | **Kafka**                | **Kafka Stream**                        |
| ---------------- | ------------------------ | --------------------------------------- |
| **æ—¥å¿—æ”¶é›†**     | âœ… é«˜æ•ˆæ”¶é›†åˆ†å¸ƒå¼ç³»ç»Ÿæ—¥å¿— | âŒ ä¸ç›´æ¥é€‚ç”¨                            |
| **æ¶ˆæ¯é˜Ÿåˆ—**     | âœ… å‰Šå³°å¡«è°·ã€å¼‚æ­¥è§£è€¦     | âŒ éæ ¸å¿ƒåŠŸèƒ½                            |
| **å®æ—¶æŒ‡æ ‡ç»Ÿè®¡** | âŒ éœ€é¢å¤–å¼€å‘é€»è¾‘         | âœ… æ»‘åŠ¨çª—å£è®¡ç®—ï¼ˆå¦‚æ¯åˆ†é’Ÿ PV/UVï¼‰        |
| **å¤æ‚äº‹ä»¶å¤„ç†** | âŒ ä¸æ”¯æŒ                 | âœ… å®æ—¶æ£€æµ‹å¼‚å¸¸æ¨¡å¼ï¼ˆå¦‚é‡‘èé£æ§ï¼‰        |
| **æ•°æ®æµ ETL**   | âŒ éœ€ç»“åˆå¤–éƒ¨å·¥å…·         | âœ… å®æ—¶è½¬æ¢å¹¶å†™å…¥ä¸‹æ¸¸ç³»ç»Ÿï¼ˆå¦‚ ESã€HDFSï¼‰ |

------

### ğŸ§© **5. æ¶æ„ä¾èµ–**

- **Kafka**
  - ä½œä¸ºç‹¬ç«‹é›†ç¾¤è¿è¡Œï¼Œä¾èµ– ZooKeeper ç®¡ç†å…ƒæ•°æ®ï¼ˆæ–°ç‰ˆæœ¬é€æ­¥ç§»é™¤ï¼‰ã€‚
- **Kafka Stream**
  - ä»¥**è½»é‡åº“**å½¢å¼åµŒå…¥ Java åº”ç”¨ï¼Œæ— é¢å¤–ä¸­é—´ä»¶ä¾èµ–ï¼Œç›´æ¥åˆ©ç”¨ Kafka é›†ç¾¤ã€‚

------

### ğŸ’ **æ€»ç»“ï¼šæŠ€æœ¯é€‰å‹å»ºè®®**

- **é€‰ Kafka**ï¼š

  éœ€è¦æ„å»º**é«˜å¯é æ¶ˆæ¯ç®¡é“**ï¼ˆå¦‚æ—¥å¿—æ”¶é›†ã€æœåŠ¡è§£è€¦ï¼‰ï¼Œæˆ–ä½œä¸ºå…¶ä»–æµå¤„ç†æ¡†æ¶ï¼ˆå¦‚ Flinkï¼‰çš„æ•°æ®æºã€‚

- **é€‰ Kafka Stream**ï¼š

  éœ€åœ¨ Kafka ä¸Šç›´æ¥å®ç°**å®æ—¶è®¡ç®—é€»è¾‘**ï¼ˆå¦‚èšåˆã€çª—å£åˆ†æï¼‰ï¼Œä¸”å¸Œæœ›é¿å…å¼•å…¥é¢å¤–æ¡†æ¶ï¼ˆå¦‚ Flink/Sparkï¼‰çš„å¤æ‚åº¦ã€‚

> ğŸ’¡ **å…³é”®å·®å¼‚ä¸€å¥è¯**ï¼š
>
> **Kafka æ˜¯â€œé«˜é€Ÿå…¬è·¯â€**ï¼ˆä¼ è¾“æ•°æ®ï¼‰ï¼Œ**Kafka Stream æ˜¯â€œåŠ å·¥å‚â€**ï¼ˆåœ¨ä¼ è¾“ä¸­å®æ—¶å¤„ç†æ•°æ®ï¼‰ã€‚

## binders

åœ¨ Spring Cloud Stream ä¸­ï¼Œ`spring.cloud.stream.binders`å’Œ `spring.cloud.stream.kafka.binder`æ˜¯ä¸¤ç§ä¸åŒç²’åº¦çš„é…ç½®æ–¹å¼ï¼Œåˆ†åˆ«ç”¨äº**å¤šæ¶ˆæ¯ä¸­é—´ä»¶åœºæ™¯**å’Œ**å•ä¸€ Kafka ç»‘å®šå™¨åœºæ™¯**ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒåŒºåˆ«åŠé€‚ç”¨åœºæ™¯ï¼š

------

### ğŸ“Œ **1. `spring.cloud.stream.binders`ï¼ˆå¤šç»‘å®šå™¨é…ç½®ï¼‰**

- **åŠŸèƒ½**ï¼š

  ç”¨äºå®šä¹‰**å¤šä¸ªæ¶ˆæ¯ä¸­é—´ä»¶ç»‘å®šå™¨**ï¼ˆå¦‚åŒæ—¶ä½¿ç”¨ Kafka å’Œ RabbitMQï¼‰ï¼Œæˆ–**åŒä¸€ç±»å‹ä¸­é—´ä»¶çš„å¤šä¸ªå®ä¾‹**ï¼ˆå¦‚ä¸¤ä¸ªç‹¬ç«‹çš„ Kafka é›†ç¾¤ï¼‰ã€‚

- **é…ç½®ç»“æ„**ï¼š

  ä»¥ Map å½¢å¼å£°æ˜ï¼Œæ¯ä¸ªç»‘å®šå™¨éœ€æŒ‡å®šå”¯ä¸€åç§°ã€ç±»å‹ï¼ˆ`type`ï¼‰åŠç¯å¢ƒå±æ€§ï¼ˆ`environment`ï¼‰ï¼š

  ```
  spring:
    cloud:
      stream:
        binders:
          kafkaBinder1:  # è‡ªå®šä¹‰ç»‘å®šå™¨åç§°
            type: kafka
            environment:
              spring:
                kafka:
                  bootstrap-servers: kafka1:9092
          kafkaBinder2:  # ç¬¬äºŒä¸ª Kafka ç»‘å®šå™¨
            type: kafka
            environment:
              spring:
                kafka:
                  bootstrap-servers: kafka2:9092
          rabbitBinder:  # RabbitMQ ç»‘å®šå™¨
            type: rabbit
            environment:
              spring:
                rabbitmq:
                  host: rabbit-host
  ```

- **é€‚ç”¨åœºæ™¯**ï¼š

  - åº”ç”¨éœ€åŒæ—¶è¿æ¥**å¤šä¸ªæ¶ˆæ¯ä¸­é—´ä»¶**ï¼ˆå¦‚éƒ¨åˆ†é€šé“ç”¨ Kafkaï¼Œéƒ¨åˆ†ç”¨ RabbitMQï¼‰ã€‚
  - éœ€åŒºåˆ†**åŒä¸€ä¸­é—´ä»¶çš„ä¸åŒå®ä¾‹**ï¼ˆå¦‚ç”Ÿäº§ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒçš„ç‹¬ç«‹ Kafka é›†ç¾¤ï¼‰ã€‚

------

### ğŸ“Œ **2. `spring.cloud.stream.kafka.binder`ï¼ˆå•ç»‘å®šå™¨ç®€åŒ–é…ç½®ï¼‰**

- **åŠŸèƒ½**ï¼š

  å½“åº”ç”¨**ä»…ä½¿ç”¨ä¸€ä¸ª Kafka ç»‘å®šå™¨**æ—¶ï¼Œç›´æ¥é…ç½® Kafka ç›¸å…³å‚æ•°ï¼Œæ— éœ€å£°æ˜ç»‘å®šå™¨åç§°ã€‚

- **é…ç½®ç»“æ„**ï¼š

  ç›´æ¥åœ¨ `kafka.binder`ä¸‹è®¾ç½® Kafka å®¢æˆ·ç«¯å±æ€§ï¼ˆå¦‚ brokersã€ç”Ÿäº§è€…/æ¶ˆè´¹è€…å‚æ•°ï¼‰ï¼š

  ```
  spring:
    cloud:
      stream:
        kafka:
          binder:
            brokers: kafka-single:9092  # Kafka é›†ç¾¤åœ°å€
            producer-properties:
              retries: 3               # ç”Ÿäº§è€…é‡è¯•æ¬¡æ•°
            consumer-properties:
              auto.offset.reset: earliest
  ```

- **åˆå¹¶è§„åˆ™**ï¼š

  æ­¤é…ç½®ä¼šä¸ Spring Boot çš„ `spring.kafka.*`å±æ€§**è‡ªåŠ¨åˆå¹¶**ï¼Œä¼˜å…ˆçº§é«˜äºåè€…ã€‚

  > ç¤ºä¾‹ï¼š`spring.cloud.stream.kafka.binder.brokers`ä¼šè¦†ç›– `spring.kafka.bootstrap-servers`ã€‚

------

### âš–ï¸ **3. æ ¸å¿ƒåŒºåˆ«æ€»ç»“**

| **ç‰¹æ€§**                  | `spring.cloud.stream.binders`        | `spring.cloud.stream.kafka.binder` |
| ------------------------- | ------------------------------------ | ---------------------------------- |
| **é…ç½®ç›®æ ‡**              | å¤šä¸­é—´ä»¶/å¤šå®ä¾‹åœºæ™¯                  | å•ä¸€ Kafka ç»‘å®šå™¨åœºæ™¯              |
| **ç»“æ„**                  | Map ç»“æ„ï¼Œéœ€å£°æ˜ç»‘å®šå™¨åç§°å’Œç±»å‹     | æ‰å¹³åŒ–é…ç½®ï¼Œç›´æ¥è®¾ç½® Kafka å‚æ•°    |
| **ä¸­é—´ä»¶æ”¯æŒ**            | æ”¯æŒæ··åˆç±»å‹ï¼ˆKafka + RabbitMQ ç­‰ï¼‰  | ä»… Kafka                           |
| **å‚æ•°ä½ç½®**              | åœ¨ `environment`ä¸‹åµŒå¥—ä¸­é—´ä»¶ä¸“å±é…ç½® | ç›´æ¥é…ç½® `binder`å­å±æ€§            |
| **ä¸ `spring.kafka`åˆå¹¶** | éœ€åœ¨ `environment`ä¸­æ˜¾å¼é…ç½®         | è‡ªåŠ¨åˆå¹¶ï¼Œä¼˜å…ˆçº§æ›´é«˜               |

------

### ğŸ› ï¸ **4. é…ç½®ç¤ºä¾‹å¯¹æ¯”**

#### **åœºæ™¯ 1ï¼šå¤š Kafka é›†ç¾¤**

```
spring:
  cloud:
    stream:
      binders:
        prodKafka:
          type: kafka
          environment:
            spring:
              kafka:
                bootstrap-servers: prod-kafka:9092
        testKafka:
          type: kafka
          environment:
            spring:
              kafka:
                bootstrap-servers: test-kafka:9092
      bindings:
        output:
          destination: orders
          binder: prodKafka  # æŒ‡å®šä½¿ç”¨ prodKafka ç»‘å®šå™¨
```

#### **åœºæ™¯ 2ï¼šå•ä¸€ Kafka é›†ç¾¤**

```
spring:
  cloud:
    stream:
      kafka:
        binder:
          brokers: single-kafka:9092
          producer:
            retries: 5
      bindings:
        output:
          destination: orders
```

------

### ğŸ’ **ç»“è®º**

- **ç”¨ `binders`**ï¼šå½“éœ€è¦**çµæ´»ç®¡ç†å¤šä¸ªæ¶ˆæ¯ä¸­é—´ä»¶æˆ–å®ä¾‹**æ—¶ï¼ˆå¦‚æ··åˆéƒ¨ç½²æˆ–ç¯å¢ƒéš”ç¦»ï¼‰ã€‚
- **ç”¨ `kafka.binder`**ï¼šå½“**ä»…ä¾èµ–å•ä¸€ Kafka é›†ç¾¤**ä¸”æ— éœ€å¤æ‚å£°æ˜æ—¶ï¼Œç®€åŒ–é…ç½®å¹¶å¤ç”¨ Spring Boot å±æ€§ã€‚

> âœ… **ä¼˜å…ˆçº§å»ºè®®**ï¼šå¤šæ•°å• Kafka åœºæ™¯æ¨è `kafka.binder`ï¼›å¤šä¸­é—´ä»¶åœºæ™¯å¿…é¡»ä½¿ç”¨ `binders`ã€‚

## Binder

åœ¨ Spring Cloud Stream ä¸­ï¼Œ`binders`çš„é€‰æ‹©ä¸»è¦é€šè¿‡**é…ç½®å£°æ˜**å’Œ**ç¼–ç¨‹æ³¨è§£**å®ç°ï¼Œå…·ä½“æ–¹å¼å–å†³äºåº”ç”¨æ˜¯å¦ä½¿ç”¨å¤šæ¶ˆæ¯ä¸­é—´ä»¶æˆ–éœ€åŠ¨æ€ç»‘å®šã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒæ–¹æ³•åŠç¤ºä¾‹ï¼š

------

### ğŸ”§ ä¸€ã€é…ç½®å£°æ˜å¼é€‰æ‹©ï¼ˆæ¨èï¼‰

é€šè¿‡ `application.yml`æˆ– `application.properties`é…ç½®æ–‡ä»¶æŒ‡å®šé€šé“çš„ç»‘å®šå™¨ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

#### **1. å• Binder åœºæ™¯**

è‹¥åº”ç”¨ä»…ä½¿ç”¨ä¸€ä¸ª Binderï¼ˆå¦‚ Kafkaï¼‰ï¼Œç›´æ¥é…ç½®å…¨å±€é»˜è®¤ Binderï¼š

```
spring:
  cloud:
    stream:
      default-binder: kafka  # æ‰€æœ‰é€šé“é»˜è®¤ä½¿ç”¨ Kafka
      bindings:
        output:
          destination: orders
        input:
          destination: orders
          group: order-group
```

#### **2. å¤š Binder åœºæ™¯**

å½“åŒæ—¶è¿æ¥å¤šä¸ªæ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQ å’Œ Kafkaï¼‰æ—¶ï¼Œéœ€æ˜¾å¼æŒ‡å®šæ¯ä¸ªé€šé“çš„ Binderï¼š

```
spring:
  cloud:
    stream:
      binders:
        rabbit1:
          type: rabbit
          environment:
            spring.rabbitmq.host: rabbit-host1
        kafka1:
          type: kafka
          environment:
            spring.kafka.bootstrap-servers: kafka-host:9092

      bindings:
        output:  # è¾“å‡ºé€šé“ä½¿ç”¨ RabbitMQ
          destination: orders
          binder: rabbit1
        input:   # è¾“å…¥é€šé“ä½¿ç”¨ Kafka
          destination: logs
          binder: kafka1
          group: log-group
```

- **å…³é”®é…ç½®**ï¼š

  `bindings.<channelName>.binder`æŒ‡å®šé€šé“çš„ Binder åç§°ï¼ˆéœ€ä¸ `binders`å®šä¹‰çš„åç§°åŒ¹é…ï¼‰ã€‚

------

### ğŸ’» äºŒã€ç¼–ç¨‹æ³¨è§£å¼é€‰æ‹©

åœ¨ä»£ç ä¸­é€šè¿‡æ³¨è§£åŠ¨æ€å…³è”é€šé“ä¸ Binderã€‚

#### **1. è‡ªå®šä¹‰é€šé“æ¥å£**

å®šä¹‰é€šé“æ—¶ï¼Œé€šè¿‡ `@Input`/`@Output`æ³¨è§£å£°æ˜é€»è¾‘é€šé“åï¼Œåç»­åœ¨é…ç½®ä¸­ç»‘å®š Binderï¼š

```
public interface CustomChannels {
    @Output("orderOutput")  // é€»è¾‘é€šé“å
    MessageChannel orderOutput();
}
```

é…ç½®æ–‡ä»¶ä¸­ç»‘å®š Binderï¼š

```
spring:
  cloud:
    stream:
      bindings:
        orderOutput:  # åŒ¹é…æ³¨è§£ä¸­çš„é€šé“å
          destination: orders
          binder: rabbit1  # æŒ‡å®š Binder
```

#### **2. åŠ¨æ€ç»‘å®šï¼ˆè¿è¡Œæ—¶é€‰æ‹©ï¼‰**

ä½¿ç”¨ `BinderAwareChannelResolver`åœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹© Binderï¼š

```
@Autowired
private BinderAwareChannelResolver channelResolver;

public void sendMessage(String binderName, String destination, String payload) {
    MessageChannel channel = channelResolver.resolveDestination(destination, binderName);
    channel.send(MessageBuilder.withPayload(payload).build());
}
```

- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æ ¹æ®ä¸šåŠ¡é€»è¾‘åŠ¨æ€åˆ‡æ¢æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚æŒ‰æ¶ˆæ¯ç±»å‹é€‰æ‹© Kafka æˆ– RabbitMQï¼‰ã€‚

------

### âš ï¸ ä¸‰ã€æ³¨æ„äº‹é¡¹

1. **Binder åç§°ä¸€è‡´æ€§**

   é…ç½®ä¸­çš„ `bindings.<channel>.binder`å¿…é¡»ä¸ `binders.<binderName>`å®šä¹‰çš„åç§°å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™æŠ›å‡º `NoSuchBeanDefinitionException`ã€‚

2. **é»˜è®¤ Binder æœºåˆ¶**

   è‹¥æœªæ˜¾å¼æŒ‡å®š `binder`ï¼Œåˆ™ä½¿ç”¨ `spring.cloud.stream.default-binder`çš„å€¼ï¼›è‹¥æœªé…ç½®é»˜è®¤å€¼ä¸”å­˜åœ¨å¤šä¸ª Binderï¼Œå¿…é¡»æ˜¾å¼æŒ‡å®šã€‚

3. **æ¶ˆè´¹è€…ç»„ä¸ Binder æ— å…³**

   `group`å±æ€§ä»…æ§åˆ¶æ¶ˆè´¹è€…ç»„å†…è´Ÿè½½å‡è¡¡ï¼Œä¸ Binder é€‰æ‹©æ— å…³ã€‚åŒä¸€ç»„å¯è·¨ä¸åŒ Binderï¼ˆä¸æ¨èï¼‰ã€‚

4. **é…ç½®ä¼˜å…ˆçº§**

   é€šé“çº§é…ç½®ï¼ˆ`bindings.<channel>.binder`ï¼‰ > å…¨å±€é»˜è®¤é…ç½®ï¼ˆ`default-binder`ï¼‰ã€‚

------

### ğŸ’ æ€»ç»“

- **é…ç½®é©±åŠ¨**ï¼šå¤šæ•°åœºæ™¯é€šè¿‡ YAML/Properties æ–‡ä»¶é™æ€ç»‘å®š Binderã€‚
- **ç¼–ç¨‹åŠ¨æ€ç»‘å®š**ï¼šéœ€è¿è¡Œæ—¶å†³ç­–æ—¶ç”¨ `BinderAwareChannelResolver`ã€‚
- **é¿å…åŒ¿å Binder**ï¼šå¤š Binder åœºæ™¯å¿…é¡»æ˜¾å¼å‘½åå¹¶å…³è”é€šé“ï¼Œå¦åˆ™å¯åŠ¨æŠ¥é”™ã€‚

> é€šè¿‡åˆç†é…ç½®ï¼Œå¯æ— ç¼é›†æˆ RabbitMQã€Kafka æˆ–è‡ªå®šä¹‰ Binderï¼Œå®ç°æ¶ˆæ¯ä¸­é—´ä»¶çš„çµæ´»åˆ‡æ¢ã€‚

## bindings

åœ¨ Spring Cloud Stream çš„é…ç½®ä½“ç³»ä¸­ï¼Œ`spring.cloud.stream.bindings`å’Œ `spring.cloud.stream.kafka.bindings`å±äºä¸åŒå±‚çº§çš„é…ç½®ï¼Œ**ä¸ä¼šå®Œå…¨ç›¸äº’è¦†ç›–**ï¼Œè€Œæ˜¯æŒ‰ä¼˜å…ˆçº§äº’è¡¥ä½œç”¨äºä¸åŒåœºæ™¯ã€‚ä»¥ä¸‹æ˜¯å…·ä½“åˆ†æï¼š

------

### âš–ï¸ **é…ç½®å±‚çº§ä¸ä¼˜å…ˆçº§è§„åˆ™**

1. **é€šç”¨é€šé“é…ç½® (`spring.cloud.stream.bindings`)**

   - **ä½œç”¨èŒƒå›´**ï¼šé€‚ç”¨äºæ‰€æœ‰ç»‘å®šå™¨ç±»å‹ï¼ˆå¦‚ Kafkaã€RabbitMQï¼‰ï¼Œå®šä¹‰é€šé“çš„åŸºç¡€å±æ€§ï¼ˆå¦‚ç›®æ ‡ä¸»é¢˜ã€æ¶ˆè´¹è€…ç»„ã€åºåˆ—åŒ–ç±»å‹ç­‰ï¼‰ã€‚

   - **ç¤ºä¾‹é…ç½®**ï¼š

     ```
     spring:
       cloud:
         stream:
           bindings:
             input:  # é€šé“é€»è¾‘å
               destination: orders-topic  # Kafka ä¸»é¢˜å
               group: order-group         # æ¶ˆè´¹è€…ç»„
               contentType: application/json  # æ¶ˆæ¯æ ¼å¼
     ```

2. **Kafka ä¸“å±é…ç½® (`spring.cloud.stream.kafka.bindings`)**

   - **ä½œç”¨èŒƒå›´**ï¼šä»…é’ˆå¯¹ Kafka ç»‘å®šå™¨ï¼Œç”¨äºé…ç½® Kafka ç‰¹æœ‰çš„é«˜çº§å‚æ•°ï¼ˆå¦‚åˆ†åŒºã€å‰¯æœ¬ã€ç”Ÿäº§è€…/æ¶ˆè´¹è€…å®¢æˆ·ç«¯å±æ€§ï¼‰ã€‚

   - **ç¤ºä¾‹é…ç½®**ï¼š

     ```
     spring:
       cloud:
         stream:
           kafka:
             bindings:
               input:  # é€šé“é€»è¾‘åï¼ˆéœ€ä¸é€šç”¨é…ç½®ä¸€è‡´ï¼‰
                 consumer:
                   autoCommitOffset: false  # å…³é—­è‡ªåŠ¨æäº¤åç§»é‡
                   startOffset: earliest    # ä»æœ€æ—©åç§»é‡æ¶ˆè´¹
                 producer:
                   partitionCount: 4        # åˆ†åŒºæ•°
     ```

3. **ä¼˜å…ˆçº§è§„åˆ™**

   - **Kafka ä¸“å±é…ç½® > é€šç”¨é…ç½®**ï¼šå½“ä¸¤è€…é…ç½®åŒä¸€é€šé“ï¼ˆå¦‚ `input`ï¼‰æ—¶ï¼ŒKafka ä¸“å±é…ç½®ä¼šè¦†ç›–é€šç”¨é…ç½®ä¸­çš„åŒåå±æ€§ã€‚
   - **äº’è¡¥è€Œéè¦†ç›–**ï¼šè‹¥é…ç½®é¡¹ä¸å†²çªï¼ˆä¾‹å¦‚é€šç”¨é…ç½®è®¾ç½® `destination`ï¼ŒKafka é…ç½®è®¾ç½® `partitionCount`ï¼‰ï¼Œåˆ™ä¸¤è€…åˆå¹¶ç”Ÿæ•ˆã€‚

------

### ğŸ› ï¸ **é…ç½®å†²çªç¤ºä¾‹ä¸è§£å†³**

- **å†²çªåœºæ™¯**ï¼ˆä»¥æ¶ˆè´¹è€…é‡è¯•æœºåˆ¶ä¸ºä¾‹ï¼‰ï¼š

  ```
  # é€šç”¨é…ç½®ï¼ˆä½œç”¨äºæ‰€æœ‰ç»‘å®šå™¨ï¼‰
  spring.cloud.stream.bindings.input.consumer.max-attempts=3
  
  # Kafka ä¸“å±é…ç½®
  spring.cloud.stream.kafka.bindings.input.consumer.max-attempts=5
  ```

  - **ç»“æœ**ï¼šKafka æ¶ˆè´¹è€…å®é™…ä½¿ç”¨ `max-attempts=5`ï¼ˆKafka ä¸“å±é…ç½®ä¼˜å…ˆçº§æ›´é«˜ï¼‰ã€‚

- **éå†²çªåœºæ™¯**ï¼ˆåˆå¹¶ç”Ÿæ•ˆï¼‰ï¼š

  ```
  # é€šç”¨é…ç½®
  spring.cloud.stream.bindings.input.destination=orders-topic
  
  # Kafka ä¸“å±é…ç½®
  spring.cloud.stream.kafka.bindings.input.consumer.startOffset=earliest
  ```

  - **ç»“æœ**ï¼šæ¶ˆè´¹è€…è®¢é˜… `orders-topic`ä¸»é¢˜ï¼Œå¹¶ä»æœ€æ—©åç§»é‡å¼€å§‹æ¶ˆè´¹ã€‚

------

### ğŸ“Š **å¸¸è§é…ç½®é¡¹å½’å±ä¸ä¼˜å…ˆçº§**

| **é…ç½®é¡¹**                 | **é€šç”¨é…ç½® (`bindings`)** | **Kafka ä¸“å±é…ç½® (`kafka.bindings`)** | **ç”Ÿæ•ˆä¼˜å…ˆçº§** |
| -------------------------- | ------------------------- | ------------------------------------- | -------------- |
| ç›®æ ‡ä¸»é¢˜ (`destination`)   | âœ…                         | âŒ                                     | é€šç”¨é…ç½®ç”Ÿæ•ˆ   |
| æ¶ˆè´¹è€…ç»„ (`group`)         | âœ…                         | âŒ                                     | é€šç”¨é…ç½®ç”Ÿæ•ˆ   |
| æ¶ˆæ¯æ ¼å¼ (`contentType`)   | âœ…                         | âŒ                                     | é€šç”¨é…ç½®ç”Ÿæ•ˆ   |
| åˆ†åŒºæ•° (`partitionCount`)  | âœ…ï¼ˆç”Ÿäº§è€…çº§ï¼‰             | âœ…ï¼ˆç”Ÿäº§è€…çº§ï¼‰                         | **Kafka ä¸“å±** |
| åç§»é‡ç­–ç•¥ (`startOffset`) | âŒ                         | âœ…ï¼ˆæ¶ˆè´¹è€…çº§ï¼‰                         | **Kafka ä¸“å±** |
| é‡è¯•æ¬¡æ•° (`max-attempts`)  | âœ…                         | âœ…                                     | **Kafka ä¸“å±** |

> ğŸ’¡ **æ³¨**ï¼šé€šç”¨é…ç½®ä¸­çš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…å±æ€§ï¼ˆå¦‚ `producer.partitionKeyExpression`ï¼‰å¯èƒ½è¢« Kafka çš„åŒåé…ç½®è¦†ç›–ã€‚

------

### ğŸ”§ **æœ€ä½³å®è·µå»ºè®®**

1. **åŸºç¡€å±æ€§ç”¨é€šç”¨é…ç½®**

   ä¸»é¢˜åã€æ¶ˆè´¹è€…ç»„ã€åºåˆ—åŒ–ç±»å‹ç­‰ä¸­é—´ä»¶æ— å…³çš„å±æ€§ï¼Œä¼˜å…ˆæ”¾åœ¨ `spring.cloud.stream.bindings`ä¸­ï¼Œæå‡é…ç½®å¯ç§»æ¤æ€§ï¼ˆå¦‚åˆ‡æ¢ RabbitMQ æ—¶æ— éœ€ä¿®æ”¹ï¼‰ã€‚

2. **Kafka ç‰¹æ€§ç”¨ä¸“å±é…ç½®**

   åˆ†åŒºã€å‰¯æœ¬ã€åç§»é‡ç­–ç•¥ç­‰ Kafka ä¸“å±å‚æ•°ï¼Œé€šè¿‡ `spring.cloud.stream.kafka.bindings`é…ç½®ï¼Œç¡®ä¿ç²¾ç»†æ§åˆ¶ã€‚

3. **é¿å…åŒåå±æ€§å†²çª**

   è‹¥éœ€è¦†ç›–é€šç”¨é…ç½®ä¸­çš„å±æ€§ï¼ˆå¦‚é‡è¯•æ¬¡æ•°ï¼‰ï¼Œåœ¨ Kafka ä¸“å±é…ç½®ä¸­æ˜¾å¼å£°æ˜åŒåå±æ€§å³å¯ï¼Œæ— éœ€åˆ é™¤é€šç”¨é…ç½®ã€‚

------

### ğŸ’ **æ€»ç»“**

- **ä¼˜å…ˆçº§**ï¼š`spring.cloud.stream.kafka.bindings`> `spring.cloud.stream.bindings`ï¼ˆåŒåå±æ€§å†²çªæ—¶ï¼‰ã€‚
- **äº’è¡¥æ€§**ï¼šä¸¤è€…å…±åŒæ„æˆå®Œæ•´é…ç½®ï¼Œéå†²çªé¡¹åˆå¹¶ç”Ÿæ•ˆã€‚
- **é…ç½®ç­–ç•¥**ï¼š
  - **é€šç”¨é…ç½®** â†’ å®šä¹‰ä¸­é—´ä»¶æ— å…³çš„åŸºç¡€å±æ€§ã€‚
  - **Kafka ä¸“å±é…ç½®** â†’ å®ç° Kafka ç‰¹æœ‰èƒ½åŠ›çš„ç²¾ç»†è°ƒä¼˜ã€‚

é€šè¿‡åˆç†åˆ†å±‚é…ç½®ï¼Œæ—¢èƒ½ä¿éšœä»£ç å¯ç§»æ¤æ€§ï¼Œåˆèƒ½å……åˆ†å‘æŒ¥ Kafka çš„é«˜çº§ç‰¹æ€§ã€‚

## Channel

åœ¨ Spring Cloud Stream ä¸­ï¼Œ`bindings`ä¸‹çš„æ¯ä¸ªé€šé“ï¼ˆChannelï¼‰é…ç½®ç”¨äºå®šä¹‰æ¶ˆæ¯ç”Ÿäº§æˆ–æ¶ˆè´¹çš„å…·ä½“è¡Œä¸ºï¼ŒåŒ…æ‹¬ç›®æ ‡ä¸»é¢˜ã€åºåˆ—åŒ–æ–¹å¼ã€æ¶ˆè´¹è€…ç»„ã€åˆ†åŒºç­–ç•¥ç­‰ã€‚ä»¥ä¸‹æ˜¯ **å•ä¸ªé€šé“** çš„é…ç½®è¯¦è§£ï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»è¯´æ˜ï¼š

------

### ğŸ”§ **ä¸€ã€åŸºç¡€é…ç½®ï¼ˆé€šç”¨ï¼‰**

ä»¥ä¸‹é…ç½®åŒæ—¶é€‚ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šé“ï¼š

| **é…ç½®é¡¹**    | **ä½œç”¨**                                                     | **ç¤ºä¾‹å€¼**            | **é»˜è®¤å€¼**         |
| ------------- | ------------------------------------------------------------ | --------------------- | ------------------ |
| `destination` | æ¶ˆæ¯ä¸­é—´ä»¶ä¸­çš„ç›®æ ‡åç§°ï¼ˆå¦‚ Kafka çš„ Topicã€RabbitMQ çš„ Exchangeï¼‰ | `orders-topic`        | æ— ï¼ˆå¿…å¡«ï¼‰         |
| `binder`      | æŒ‡å®šä½¿ç”¨çš„ Binder åç§°ï¼ˆéœ€åœ¨ `binders`ä¸­å®šä¹‰ï¼‰               | `kafka-binder1`       | `default-binder`   |
| `contentType` | æ¶ˆæ¯åºåˆ—åŒ–æ ¼å¼ï¼ˆå¦‚ `application/json`ï¼‰                      | `text/plain`          | `application/json` |
| `group`       | **æ¶ˆè´¹è€…ç»„å**ï¼ˆä»…æ¶ˆè´¹è€…æœ‰æ•ˆï¼‰ï¼ŒåŒç»„å†…ä»…ä¸€ä¸ªå®ä¾‹æ¶ˆè´¹æ¶ˆæ¯ï¼Œé¿å…é‡å¤æ¶ˆè´¹ | `order-service-group` | æ—                  |

> ğŸ’¡ **å…³é”®è¯´æ˜**ï¼š
>
> - `group`æ˜¯é¿å…æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€åœ¨æ¶ˆè´¹è€…é€šé“æ˜¾å¼æŒ‡å®šã€‚
> - `binder`ä»…åœ¨å¤šæ¶ˆæ¯ä¸­é—´ä»¶åœºæ™¯éœ€è¦ï¼ˆå¦‚åŒæ—¶ç”¨ Kafka + RabbitMQï¼‰ã€‚

------

### ğŸ‘‚ **äºŒã€æ¶ˆè´¹è€…ä¸“å±é…ç½®**

ä»¥ `spring.cloud.stream.bindings.<channel>.consumer.*`ä¸ºå‰ç¼€ï¼š

| **é…ç½®é¡¹**               | **ä½œç”¨**                                             | **ç¤ºä¾‹å€¼** | **é»˜è®¤å€¼** |
| ------------------------ | ---------------------------------------------------- | ---------- | ---------- |
| `concurrency`            | æ¶ˆè´¹è€…å¹¶å‘çº¿ç¨‹æ•°ï¼ˆå•å®ä¾‹å†…ï¼‰                         | `3`        | `1`        |
| `maxAttempts`            | æ¶ˆæ¯å¤„ç†å¤±è´¥æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆå«é¦–æ¬¡ï¼‰                   | `5`        | `3`        |
| `backOffInitialInterval` | é‡è¯•åˆå§‹é—´éš”ï¼ˆæ¯«ç§’ï¼‰                                 | `2000`     | `1000`     |
| `autoCommitOffset`       | æ˜¯å¦è‡ªåŠ¨æäº¤åç§»é‡ï¼ˆKafka åœºæ™¯ï¼‰                     | `false`    | `true`     |
| `partitioned`            | æ˜¯å¦ä»åˆ†åŒºç”Ÿäº§è€…æ¥æ”¶æ•°æ®                             | `true`     | `false`    |
| `instanceIndex`          | å½“å‰å®ä¾‹ç´¢å¼•ï¼ˆé…åˆ `instanceCount`å®ç°åˆ†åŒºè´Ÿè½½å‡è¡¡ï¼‰ | `0`        | `-1`       |
| `instanceCount`          | æ¶ˆè´¹è€…å®ä¾‹æ€»æ•°                                       | `3`        | `-1`       |

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
>
> - Kafka åœºæ™¯ä¸‹ï¼Œè‹¥ `autoCommitOffset=false`ï¼Œéœ€æ‰‹åŠ¨æäº¤åç§»é‡ï¼ˆå¦‚ `Acknowledgment.acknowledge()`ï¼‰ã€‚
> - `instanceIndex`+ `instanceCount`éœ€åœ¨åˆ†å¸ƒå¼éƒ¨ç½²ä¸­æ˜¾å¼é…ç½®ï¼Œç¡®ä¿åˆ†åŒºå‡åŒ€åˆ†é…ã€‚

------

### ğŸ“¤ **ä¸‰ã€ç”Ÿäº§è€…ä¸“å±é…ç½®**

ä»¥ `spring.cloud.stream.bindings.<channel>.producer.*`ä¸ºå‰ç¼€ï¼š

| **é…ç½®é¡¹**               | **ä½œç”¨**                                             | **ç¤ºä¾‹å€¼**                  | **é»˜è®¤å€¼** |
| ------------------------ | ---------------------------------------------------- | --------------------------- | ---------- |
| `partitionKeyExpression` | åˆ†åŒºé”® SpEL è¡¨è¾¾å¼ï¼ˆå¦‚æŒ‰æ¶ˆæ¯å¤´æˆ–è´Ÿè½½å­—æ®µåˆ†åŒºï¼‰       | `headers['orderId']`        | æ—          |
| `partitionCount`         | ç›®æ ‡åˆ†åŒºæ€»æ•°ï¼ˆä»…å¯¹åˆ†åŒºç”Ÿäº§è€…æœ‰æ•ˆï¼‰                   | `4`                         | `1`        |
| `requiredGroups`         | å¿…é¡»æ¶ˆè´¹æ­¤æ¶ˆæ¯çš„æ¶ˆè´¹è€…ç»„ï¼ˆç¡®ä¿ç»„å†…æ¶ˆè´¹è€…å°±ç»ªï¼‰       | `inventory-group,log-group` | æ—          |
| `headerMode`             | æ¶ˆæ¯å¤´å¤„ç†æ¨¡å¼ï¼ˆ`none`/`embeddedHeaders`/`headers`ï¼‰ | `embeddedHeaders`           | ä¾ Binder  |

> ğŸ’¡ **å…³é”®è¯´æ˜**ï¼š
>
> - `partitionKeyExpression`+ `partitionCount`å®ç°æ¶ˆæ¯åˆ†åŒºï¼Œç¡®ä¿ç›¸åŒé”®çš„æ¶ˆæ¯è½å…¥åŒä¸€åˆ†åŒºã€‚
> - `requiredGroups`ä¼šåœ¨æ¶ˆæ¯å‘é€å‰è‡ªåŠ¨åˆ›å»ºæ¶ˆè´¹è€…ç»„é˜Ÿåˆ—ï¼ˆRabbitMQï¼‰æˆ– Topicï¼ˆKafkaï¼‰ã€‚

------

### âš™ï¸ **å››ã€å…¸å‹é…ç½®æ¡ˆä¾‹**

#### åœºæ™¯ï¼šKafka ç”Ÿäº§è€…é€šé“ï¼ˆå‘é€è®¢å•æ¶ˆæ¯ï¼‰

```
spring:
  cloud:
    stream:
      bindings:
        orderOutput:  # é€šé“é€»è¾‘å
          destination: orders-topic  # Kafka Topic
          binder: kafka-binder1
          contentType: application/json
          producer:
            partitionKeyExpression: "payload.orderId"  # æŒ‰è®¢å•IDåˆ†åŒº
            partitionCount: 6                          # æ€»åˆ†åŒºæ•°
            requiredGroups: payment-group,inventory-group
```

#### åœºæ™¯ï¼šKafka æ¶ˆè´¹è€…é€šé“ï¼ˆå¤„ç†è®¢å•ï¼‰

```
spring:
  cloud:
    stream:
      bindings:
        orderInput:   # é€šé“é€»è¾‘å
          destination: orders-topic
          group: order-consumer-group  # æ¶ˆè´¹è€…ç»„
          consumer:
            concurrency: 4            # å¹¶å‘çº¿ç¨‹æ•°
            maxAttempts: 5             # æœ€å¤§é‡è¯•æ¬¡æ•°
            autoCommitOffset: false    # å…³é—­è‡ªåŠ¨æäº¤
```

------

### âš ï¸ **äº”ã€æ³¨æ„äº‹é¡¹**

1. **æ¶ˆè´¹è€…ç»„å¿…è¦æ€§**

   æœªé…ç½® `group`æ—¶ï¼Œæ¯æ¡æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰æ¶ˆè´¹è€…å®ä¾‹é‡å¤æ¶ˆè´¹ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒåŠ¡å¿…æŒ‡å®šç»„åã€‚

2. **åˆ†åŒºä¸€è‡´æ€§**

   ç”Ÿäº§è€… `partitionCount`åº”ä¸ Kafka Topic å®é™…åˆ†åŒºæ•°ä¸€è‡´ï¼Œå¦åˆ™å¯èƒ½è·¯ç”±å¤±è´¥ã€‚

3. **å¤š Binder åœºæ™¯**

   è‹¥é€šé“éœ€æŒ‡å®šéé»˜è®¤ Binderï¼Œéœ€åŒæ—¶é…ç½® `binders`å’Œ `binder`å‚æ•°ã€‚

4. **å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹**

   Spring Cloud Stream â‰¥3.0 æ¨èå‡½æ•°å¼ç¼–ç¨‹ï¼ˆ`Supplier`/`Consumer`Beanï¼‰ï¼Œæ­¤æ—¶é€šé“å‘½åæ ¼å¼ä¸º `<functionName>-in-0`/`<functionName>-out-0`ã€‚

é€šè¿‡åˆç†é…ç½®é€šé“å‚æ•°ï¼Œå¯å®ç°æ¶ˆæ¯é¡ºåºæ€§ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ç­‰é«˜çº§ç‰¹æ€§ï¼Œæ”¯æ’‘é«˜å¯é æ¶ˆæ¯é©±åŠ¨æ¶æ„ã€‚

## å•å·¥

åœ¨ Spring Cloud Stream åŠå…¶ä»–æ¶ˆæ¯é©±åŠ¨æ¡†æ¶ä¸­ï¼ŒChannelï¼ˆé€šé“ï¼‰è¢«è®¾è®¡ä¸ºå•å‘ï¼ˆä»…æ”¯æŒè¾“å…¥æˆ–è¾“å‡ºï¼‰è€ŒéåŒå‘ï¼Œä¸»è¦åŸºäºä»¥ä¸‹æ ¸å¿ƒè®¾è®¡æ€æƒ³å’Œå®é™…éœ€æ±‚ï¼š

------

### ğŸ”§ **ä¸€ã€èŒè´£éš”ç¦»ä¸è§£è€¦**

1. **ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…èŒè´£åˆ†ç¦»**
   - **ç”Ÿäº§è€…**ï¼šä»…è´Ÿè´£å‘é€æ¶ˆæ¯ï¼ˆ`Output Channel`ï¼‰ï¼Œæ— éœ€å…³å¿ƒæ¶ˆæ¯çš„æ¶ˆè´¹é€»è¾‘ã€‚
   - **æ¶ˆè´¹è€…**ï¼šä»…è´Ÿè´£æ¥æ”¶æ¶ˆæ¯ï¼ˆ`Input Channel`ï¼‰ï¼Œæ— éœ€æ„ŸçŸ¥æ¶ˆæ¯çš„ç”Ÿæˆè¿‡ç¨‹ã€‚
   - **ä¼˜åŠ¿**ï¼šè¿™ç§å•å‘è®¾è®¡å¼ºåˆ¶ç»„ä»¶èŒè´£å•ä¸€åŒ–ï¼Œé¿å…é€»è¾‘æ··æ‚ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§ã€‚ä¾‹å¦‚ï¼Œä¿®æ”¹ç”Ÿäº§è€…é€»è¾‘ä¸ä¼šå½±å“æ¶ˆè´¹è€…å®ç°ã€‚
2. **è§£è€¦æ¶ˆæ¯ä¸­é—´ä»¶å·®å¼‚**
   - ä¸åŒæ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQ çš„ Exchange å’Œ Kafka çš„ Topicï¼‰åº•å±‚å®ç°å·®å¼‚å¤§ã€‚å•å‘é€šé“é€šè¿‡ç»Ÿä¸€æŠ½è±¡ï¼ˆå¦‚ `destination`ï¼‰å±è”½åº•å±‚ç»†èŠ‚ï¼Œä½¿å¼€å‘è€…æ— éœ€å¤„ç†åŒå‘é€‚é…çš„å¤æ‚æ€§ã€‚

------

### âš™ï¸ **äºŒã€é€šä¿¡æ¨¡å¼åŒ¹é…**

1. **å‘å¸ƒ-è®¢é˜…æ¨¡å¼ä¸»å¯¼**
   - Spring Cloud Stream çš„æ ¸å¿ƒé€šä¿¡æ¨¡å¼æ˜¯**å‘å¸ƒ-è®¢é˜…**ï¼ˆPub/Subï¼‰ï¼Œå³ç”Ÿäº§è€…å¹¿æ’­æ¶ˆæ¯ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ç‹¬ç«‹è®¢é˜…ã€‚
   - **å•å‘é€šé“å¤©ç„¶å¥‘åˆ**ï¼š
     - `Output Channel`å¯¹åº”å‘å¸ƒè€…ï¼ˆç”Ÿäº§è€…ï¼‰ï¼Œ
     - `Input Channel`å¯¹åº”è®¢é˜…è€…ï¼ˆæ¶ˆè´¹è€…ï¼‰ã€‚
   - è‹¥è®¾è®¡åŒå‘é€šé“ï¼Œä¼šç ´åå‘å¸ƒ-è®¢é˜…çš„è¯­ä¹‰ï¼Œå¢åŠ æ¶ˆæ¯è·¯ç”±çš„å¤æ‚åº¦ã€‚
2. **é¿å…å¾ªç¯ä¾èµ–é£é™©**
   - åŒå‘é€šé“å¯èƒ½å¯¼è‡´ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ç›¸äº’ä¾èµ–ï¼Œå½¢æˆå¾ªç¯è°ƒç”¨ï¼ˆå¦‚ A ç­‰å¾… B çš„å“åº”ï¼ŒB åˆç­‰å¾… A çš„å“åº”ï¼‰ï¼Œæ˜“å¼•å‘æ­»é”æˆ–æ€§èƒ½ç“¶é¢ˆã€‚

------

### ğŸš€ **ä¸‰ã€æ€§èƒ½ä¸èµ„æºä¼˜åŒ–**

1. **å‡å°‘èµ„æºç«äº‰**
   - å•å‘é€šé“ä»…éœ€å•å‘æ•°æ®æµæ§åˆ¶ï¼ˆå¦‚èƒŒå‹æœºåˆ¶ä½œç”¨äºæ¶ˆè´¹è€…ï¼‰ï¼Œé¿å…åŒå‘é€šä¿¡ä¸­è¯»å†™é”çš„ç«äº‰ï¼Œæå‡ååé‡ã€‚
   - ä¾‹å¦‚ï¼ŒKafka çš„åˆ†åŒºè¯»å†™åˆ†ç¦»è®¾è®¡æ­£æ˜¯åŸºäºæ­¤ç†å¿µã€‚
2. **ç®€åŒ–é”™è¯¯å¤„ç†**
   - å•å‘é€šé“çš„å¼‚å¸¸å¤„ç†æ›´æ˜ç¡®ï¼šç”Ÿäº§è€…åªéœ€å…³æ³¨å‘é€å¤±è´¥ï¼ˆå¦‚ç½‘ç»œä¸­æ–­ï¼‰ï¼Œæ¶ˆè´¹è€…åªéœ€å¤„ç†æ¶ˆè´¹å¼‚å¸¸ï¼ˆå¦‚ååºåˆ—åŒ–é”™è¯¯ï¼‰ã€‚
   - åŒå‘é€šé“éœ€åŒæ—¶å¤„ç†æ”¶å‘é”™è¯¯ï¼Œå¢åŠ äº†çŠ¶æ€ç®¡ç†å¤æ‚åº¦ã€‚

------

### ğŸ›¡ï¸ **å››ã€å®‰å…¨ä¸åˆè§„æ€§**

1. **æ§åˆ¶æ•°æ®æµå‘**
   - å•å‘é€šé“å¤©ç„¶æ”¯æŒ**æ•°æ®å•å‘ä¼ è¾“**ï¼Œé€‚ç”¨äºå®‰å…¨æ•æ„Ÿåœºæ™¯ï¼ˆå¦‚é‡‘èæ•°æ®å¯¼å‡ºï¼‰ï¼Œé˜²æ­¢æœªæˆæƒçš„åå‘æ•°æ®æ¸—é€ã€‚
2. **æƒé™éš”ç¦»**
   - ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯é…ç½®ç‹¬ç«‹æƒé™ï¼ˆå¦‚ RabbitMQ çš„è¯»å†™æƒé™åˆ†ç¦»ï¼‰ï¼Œé¿å…è¶Šæƒæ“ä½œã€‚

------

### ğŸ”„ **äº”ã€æ‰©å±•æ€§ä¸çµæ´»æ€§**

1. **åŠ¨æ€ç»„åˆæ›¿ä»£åŒå‘é€šé“**
   - éœ€è¯·æ±‚-å“åº”æ¨¡å¼æ—¶ï¼Œå¯é€šè¿‡ç»„åˆå•å‘é€šé“å®ç°ï¼š
     - æœåŠ¡ A çš„ `Output`â†’ æœåŠ¡ B çš„ `Input`â†’ æœåŠ¡ B çš„ `Output`â†’ æœåŠ¡ A çš„ `Input`ã€‚
   - **ç¤ºä¾‹**ï¼šè®¢å•æœåŠ¡å‘é€è¯·æ±‚ï¼ˆ`order-request-out`ï¼‰ï¼Œåº“å­˜æœåŠ¡æ¶ˆè´¹å¹¶è¿”å›å“åº”ï¼ˆ`order-response-out`ï¼‰ã€‚
2. **æ”¯æŒå¼‚æ­¥ä¸åŒæ­¥çµæ´»åˆ‡æ¢**
   - å•å‘é€šé“é»˜è®¤å¼‚æ­¥é€šä¿¡ï¼ˆéé˜»å¡ï¼‰ï¼Œè‹¥éœ€åŒæ­¥å“åº”å¯é€šè¿‡ `@SendTo`æ³¨è§£æˆ–æ¶ˆæ¯å…³è” ID å®ç°ï¼Œè€Œä¸ç ´åé€šé“è®¾è®¡ã€‚

------

### ğŸ’ **æ€»ç»“ï¼šå•å‘è®¾è®¡çš„æœ¬è´¨ä¼˜åŠ¿**

| **ç»´åº¦**       | **å•å‘é€šé“**                | **åŒå‘é€šé“**                         |
| -------------- | --------------------------- | ------------------------------------ |
| **èŒè´£**       | ç”Ÿäº§è€…/æ¶ˆè´¹è€…è§£è€¦ï¼Œå„å¸å…¶èŒ | é€»è¾‘æ··æ‚ï¼Œæ˜“äº§ç”Ÿå¾ªç¯ä¾èµ–             |
| **æ€§èƒ½**       | æ— é”ç«äº‰ï¼Œååé‡é«˜          | éœ€åŒå‘é”ç®¡ç†ï¼Œæ€§èƒ½æŸè€—å¤§             |
| **æ‰©å±•æ€§**     | åŠ¨æ€ç»„åˆæ”¯æŒå¤æ‚åœºæ™¯        | è€¦åˆåº¦é«˜ï¼Œæ‰©å±•å›°éš¾                   |
| **å®‰å…¨æ€§**     | æ•°æ®æµå‘å¯æ§ï¼Œæƒé™åˆ†ç¦»      | å®‰å…¨è¾¹ç•Œæ¨¡ç³Š                         |
| **ä¸­é—´ä»¶é€‚é…** | ç»Ÿä¸€æŠ½è±¡ï¼Œå±è”½å·®å¼‚          | éœ€é€‚é…ä¸åŒä¸­é—´ä»¶çš„åŒå‘è¯­ä¹‰ï¼Œå®ç°å¤æ‚ |

> **æœ¬è´¨**ï¼šå•å‘é€šé“é€šè¿‡**çº¦æŸåˆ›é€ è‡ªç”±**â€”â€”ä»¥é™åˆ¶é€šä¿¡æ–¹å‘ä¸ºä»£ä»·ï¼Œæ¢å–äº†ç³»ç»Ÿç»“æ„æ¸…æ™°æ€§ã€æ€§èƒ½å¯é¢„æµ‹æ€§åŠè·¨ä¸­é—´ä»¶å…¼å®¹æ€§ï¼Œæ›´å¥‘åˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ¾è€¦åˆã€é«˜å†…èšçš„è®¾è®¡åŸåˆ™ã€‚

## å‡½æ•°å¼ç¼–ç¨‹

Spring Cloud Stream çš„å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ï¼ˆåŸºäº `Supplier`ã€`Consumer`å’Œ `Function`æ¥å£ï¼‰æ˜¯è‡ª **3.x ç‰ˆæœ¬**èµ·å®˜æ–¹æ¨èçš„æ ¸å¿ƒå¼€å‘æ–¹å¼ï¼Œå–ä»£äº†ä¼ ç»Ÿçš„æ³¨è§£é©±åŠ¨æ¨¡å‹ï¼ˆå¦‚ `@EnableBinding`ã€`@StreamListener`ï¼‰ã€‚è¯¥æ¨¡å‹é€šè¿‡å£°æ˜å¼å‡½æ•°ç®€åŒ–äº†æ¶ˆæ¯çš„ç”Ÿäº§ã€å¤„ç†å’Œæ¶ˆè´¹ï¼Œæå‡äº†ä»£ç çš„ç®€æ´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£æï¼š

------

### ğŸ”§ **ä¸€ã€æ ¸å¿ƒå‡½æ•°å¼æ¥å£**

#### 1. **`Supplier<T>`ï¼ˆç”Ÿäº§è€…ï¼‰**

- **ä½œç”¨**ï¼šæ— å…¥å‚ï¼Œè¿”å›æ¶ˆæ¯è´Ÿè½½ `T`ï¼Œè¡¨ç¤º**æ¶ˆæ¯æº**ï¼ˆåªå‡ºä¸è¿›ï¼‰ã€‚

- **è§¦å‘æ–¹å¼**ï¼š

  - **è‡ªåŠ¨è§¦å‘**ï¼šé»˜è®¤æ¯éš” 1 ç§’è°ƒç”¨ä¸€æ¬¡ï¼ˆå¯é€šè¿‡é…ç½®è°ƒæ•´é¢‘ç‡ï¼‰ã€‚
  - **æ‰‹åŠ¨è§¦å‘**ï¼šç»“åˆ `StreamBridge`åŠ¨æ€å‘é€æ¶ˆæ¯ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @Bean
  public Supplier<String> messageProducer() {
      return () -> "Hello, Spring Cloud Stream!";
  }
  ```

- **é…ç½®è°ƒæ•´è§¦å‘é¢‘ç‡**ï¼š

  ```
  spring:
    cloud:
      stream:
        poller:
          fixed-delay: 5000  # æ¯5ç§’è§¦å‘ä¸€æ¬¡
  ```

------

#### 2. **`Consumer<T>`ï¼ˆæ¶ˆè´¹è€…ï¼‰**

- **ä½œç”¨**ï¼šæ¥æ”¶æ¶ˆæ¯è´Ÿè½½ `T`ï¼Œæ— è¿”å›å€¼ï¼Œè¡¨ç¤º**æ¶ˆæ¯ç»ˆç‚¹**ï¼ˆåªè¿›ä¸å‡ºï¼‰ã€‚

- **è§¦å‘æ¡ä»¶**ï¼šæ¶ˆæ¯åˆ°è¾¾ç»‘å®šé€šé“æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @Bean
  public Consumer<String> messageConsumer() {
      return payload -> System.out.println("Received: " + payload);
  }
  ```

------

#### 3. **`Function<T, R>`ï¼ˆå¤„ç†å™¨ï¼‰**

- **ä½œç”¨**ï¼šæ¥æ”¶è¾“å…¥ `T`ï¼Œè¿”å›è¾“å‡º `R`ï¼Œè¡¨ç¤º**æ¶ˆæ¯å¤„ç†ç®¡é“**ï¼ˆæœ‰è¿›æœ‰å‡ºï¼‰ã€‚

- **é€‚ç”¨åœºæ™¯**ï¼šæ¶ˆæ¯è½¬æ¢ã€è¿‡æ»¤ã€èšåˆç­‰ä¸­é—´å¤„ç†ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @Bean
  public Function<String, String> uppercaseProcessor() {
      return input -> input.toUpperCase();
  }
  ```

------

### âš™ï¸ **äºŒã€é…ç½®ä¸ç»‘å®šè§„åˆ™**

#### 1. **å‡½æ•°å£°æ˜ä¸æ¿€æ´»**

- **å®šä¹‰å‡½æ•°**ï¼šé€šè¿‡ `@Bean`å£°æ˜ `Supplier`/`Consumer`/`Function`ã€‚

- **æ¿€æ´»å‡½æ•°**ï¼šåœ¨é…ç½®ä¸­åˆ—å‡ºå‡½æ•°åï¼ˆå¤šä¸ªç”¨åˆ†å·åˆ†éš”ï¼‰ï¼š

  ```
  spring:
    cloud:
      function:
        definition: messageProducer;uppercaseProcessor;messageConsumer  # æ¿€æ´»æ‰€æœ‰å‡½æ•°
  ```

#### 2. **é€šé“è‡ªåŠ¨ç»‘å®š**

- **å‘½åè§„åˆ™**ï¼šå‡½æ•°å + `-in-{index}`/`-out-{index}`ï¼ˆ`index`ä» 0 å¼€å§‹ï¼‰ã€‚

  | å‡½æ•°ç±»å‹        | è¾“å…¥é€šé“        | è¾“å‡ºé€šé“         |
  | --------------- | --------------- | ---------------- |
  | `Supplier<T>`   | æ—               | `{å‡½æ•°å}-out-0` |
  | `Consumer<T>`   | `{å‡½æ•°å}-in-0` | æ—                |
  | `Function<T,R>` | `{å‡½æ•°å}-in-0` | `{å‡½æ•°å}-out-0` |

- **é…ç½®ç»‘å®šç›®æ ‡**ï¼ˆå¦‚ Kafka Topicï¼‰ï¼š

  ```
  spring:
    cloud:
      stream:
        bindings:
          messageProducer-out-0:  # ç”Ÿäº§è€…é€šé“
            destination: orders-topic
          uppercaseProcessor-in-0: # å¤„ç†å™¨è¾“å…¥é€šé“
            destination: orders-topic
          uppercaseProcessor-out-0: # å¤„ç†å™¨è¾“å‡ºé€šé“
            destination: processed-orders-topic
          messageConsumer-in-0:    # æ¶ˆè´¹è€…é€šé“
            destination: processed-orders-topic
            group: order-group     # æ¶ˆè´¹è€…ç»„ï¼ˆé˜²é‡å¤æ¶ˆè´¹ï¼‰
  ```

------

### ğŸš€ **ä¸‰ã€é«˜çº§ç‰¹æ€§**

#### 1. **åŠ¨æ€å‘é€æ¶ˆæ¯ï¼ˆ`StreamBridge`ï¼‰**

- **åœºæ™¯**ï¼šéå‡½æ•°å¼è§¦å‘ï¼ˆå¦‚ HTTP è¯·æ±‚è§¦å‘æ¶ˆæ¯å‘é€ï¼‰ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @Autowired
  private StreamBridge streamBridge;
  
  @GetMapping("/send")
  public String sendOrder(String payload) {
      streamBridge.send("messageProducer-out-0", payload); // æŒ‡å®šé€šé“åå‘é€
      return "Sent!";
  }
  ```

#### 2. **å¤šè¾“å…¥/è¾“å‡ºé€šé“**

- **åœºæ™¯**ï¼šåˆå¹¶æˆ–æ‹†åˆ†å¤šä¸ªæ¶ˆæ¯æµï¼ˆå¦‚è®¢å•+åº“å­˜æ•°æ®åˆå¹¶å¤„ç†ï¼‰ã€‚

- **å®ç°**ï¼šä½¿ç”¨ `Tuple`åŒ…è£…å¤šä¸ª `Flux`æµï¼š

  ```
  @Bean
  public Function<Tuple2<Flux<String>, Flux<Integer>>, Flux<String>> mergeStreams() {
      return tuple -> {
          Flux<String> strings = tuple.getT1();
          Flux<String> numbers = tuple.getT2().map(i -> "Num-" + i);
          return Flux.merge(strings, numbers); // åˆå¹¶æµ
      };
  }
  ```

- **ç»‘å®šé…ç½®**ï¼š

  ```
  bindings:
    mergeStreams-in-0: destination: strings-topic
    mergeStreams-in-1: destination: numbers-topic
    mergeStreams-out-0: destination: merged-topic
  ```

#### 3. **å‡½æ•°ç»„åˆï¼ˆFunction Compositionï¼‰**

- **åœºæ™¯**ï¼šä¸²è”å¤šä¸ªå¤„ç†é€»è¾‘ï¼ˆå¦‚ï¼šè¿‡æ»¤ â†’ è½¬æ¢ â†’ å­˜å‚¨ï¼‰ã€‚

- **é…ç½®**ï¼š

  ```
  spring:
    cloud:
      function:
        definition: filter;transform;save  # ç»„åˆé¡ºåº
      stream:
        bindings:
          filter-in-0: destination: input-topic
          save-out-0: destination: output-topic
  ```

  - æ¶ˆæ¯æµå‘ï¼š`input-topic`â†’ `filter`â†’ `transform`â†’ `save`â†’ `output-topic`ã€‚

------

### âš ï¸ **å››ã€æ³¨æ„äº‹é¡¹**

1. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼š

   - Spring Cloud Stream â‰¥3.1.x ä»…æ”¯æŒå‡½æ•°å¼æ¨¡å‹ï¼Œæ—§æ³¨è§£ï¼ˆ`@StreamListener`ï¼‰å·²å¼ƒç”¨ã€‚

2. **ååº”å¼ç¼–ç¨‹æ”¯æŒ**ï¼š

   - ä½¿ç”¨ `Flux`/`Mono`å®ç°å¼‚æ­¥æµå¤„ç†ï¼ˆéœ€è¿”å› `Supplier<Flux<T>>`æˆ– `Function<Flux<T>, Flux<R>>`ï¼‰ã€‚

   - ç¤ºä¾‹ï¼š

     ```
     @Bean
     public Supplier<Flux<String>> reactiveProducer() {
         return () -> Flux.interval(Duration.ofSeconds(1)).map(i -> "Event-" + i);
     }
     ```

3. **æ¶ˆè´¹è€…ç»„ä¸åˆ†åŒº**ï¼š

   - é€šè¿‡ `group`é…ç½®æ¶ˆè´¹è€…ç»„é¿å…é‡å¤æ¶ˆè´¹ã€‚
   - é€šè¿‡ `partitionKeyExpression`å®ç°æ¶ˆæ¯åˆ†åŒºï¼ˆç¡®ä¿ç›¸åŒé”®çš„æ¶ˆæ¯ç”±åŒä¸€å®ä¾‹å¤„ç†ï¼‰ã€‚

------

### ğŸ’ **äº”ã€æ€»ç»“**

- **ä¼˜åŠ¿**ï¼š
  - **ä»£ç ç®€æ´**ï¼šæ¶ˆé™¤æ³¨è§£æ ·æ¿ä»£ç ï¼Œèšç„¦ä¸šåŠ¡é€»è¾‘ã€‚
  - **çµæ´»ç»„åˆ**ï¼šé€šè¿‡å‡½æ•°ä¸²è”å®ç°å¤æ‚æµå¤„ç†ã€‚
  - **åŠ¨æ€æ‰©å±•**ï¼šæ”¯æŒåŠ¨æ€é€šé“ç»‘å®šå’Œæ¶ˆæ¯è§¦å‘ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - å¾®æœåŠ¡é—´å¼‚æ­¥é€šä¿¡ï¼ˆè®¢å•â†’åº“å­˜â†’é€šçŸ¥ï¼‰ã€‚
  - å®æ—¶æ•°æ®æµæ°´çº¿ï¼ˆæ—¥å¿—æ”¶é›†â†’è¿‡æ»¤â†’å­˜å‚¨ï¼‰ã€‚
  - äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆç”¨æˆ·æ³¨å†Œè§¦å‘å¤šæœåŠ¡åä½œï¼‰ã€‚

> **è¿ç§»å»ºè®®**ï¼šæ–°é¡¹ç›®ç›´æ¥é‡‡ç”¨å‡½æ•°å¼æ¨¡å‹ï¼›æ—§é¡¹ç›®å‡çº§æ—¶é€æ­¥æ›¿æ¢æ³¨è§£ï¼Œä¼˜å…ˆä½¿ç”¨ `StreamBridge`è¿‡æ¸¡åŠ¨æ€å‘é€éœ€æ±‚ã€‚é€šè¿‡åˆç†é…ç½®é€šé“ä¸å‡½æ•°ç»‘å®šï¼Œå¯æ— ç¼å¯¹æ¥ Kafkaã€RabbitMQ ç­‰æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ç°é«˜æ•ˆè§£è€¦ã€‚

## Spring Cloud Function

Spring Cloud Function æ˜¯ä¸€ä¸ªåŸºäº Spring ç”Ÿæ€çš„å‡½æ•°å¼ç¼–ç¨‹æ¡†æ¶ï¼Œæ—¨åœ¨é€šè¿‡ **ä¸šåŠ¡é€»è¾‘ä¸è¿è¡Œæ—¶è§£è€¦**ï¼Œç®€åŒ–äº‘åŸç”Ÿåº”ç”¨çš„å¼€å‘ã€‚å®ƒå…è®¸å¼€å‘è€…ä½¿ç”¨æ ‡å‡† Java å‡½æ•°ï¼ˆ`Supplier`ã€`Function`ã€`Consumer`ï¼‰æ„å»ºæœåŠ¡ï¼Œå¹¶æ”¯æŒéƒ¨ç½²åˆ°å¤šç§ç¯å¢ƒï¼ˆHTTP æœåŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ— æœåŠ¡å™¨å¹³å°ç­‰ï¼‰ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒæ¦‚å¿µåˆ°åº”ç”¨åœºæ™¯çš„è¯¦ç»†è§£æï¼š

------

### ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€ç¼–ç¨‹æ¨¡å‹**

   å¼€å‘è€…åªéœ€ç¼–å†™æ™®é€š Java å‡½æ•°ï¼Œæ¡†æ¶è‡ªåŠ¨é€‚é…ä¸åŒè¿è¡Œç¯å¢ƒï¼ˆHTTPã€æ¶ˆæ¯é˜Ÿåˆ—ã€FaaS å¹³å°ï¼‰ï¼Œå®ç° **â€œä¸€æ¬¡ç¼–å†™ï¼Œå¤šç¯å¢ƒéƒ¨ç½²â€**ã€‚

   - **å…³é”®æ¥å£**ï¼š
     - `Supplier<T>`ï¼šæ— è¾“å…¥ï¼Œç”Ÿæˆæ•°æ®ï¼ˆç”Ÿäº§è€…ï¼‰
     - `Function<T, R>`ï¼šè¾“å…¥ â†’ è¾“å‡ºï¼ˆå¤„ç†å™¨ï¼‰
     - `Consumer<T>`ï¼šä»…æ¶ˆè´¹è¾“å…¥ï¼Œæ— è¾“å‡ºï¼ˆæ¶ˆè´¹è€…ï¼‰

2. **æ§åˆ¶åè½¬çš„å»¶ä¼¸**

   å°† Hollywood åŸåˆ™ï¼ˆâ€œä¸è¦è°ƒç”¨æˆ‘ä»¬ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ä½ â€ï¼‰æ¨è¿›åˆ°æ–°é«˜åº¦ï¼šå¼€å‘è€…èšç„¦ä¸šåŠ¡é€»è¾‘ï¼Œæ¡†æ¶å¤„ç†ä¼ è¾“åè®®ã€åºåˆ—åŒ–ç­‰åŸºç¡€è®¾æ–½ã€‚

------

### äºŒã€æ ¸å¿ƒåŠŸèƒ½ä¸æŠ€æœ¯ç»†èŠ‚

1. **å‡½æ•°å®šä¹‰ä¸æ³¨å†Œ**

   é€šè¿‡ `@Bean`å£°æ˜å‡½æ•°ï¼ŒSpring è‡ªåŠ¨å°†å…¶çº³å…¥ `FunctionCatalog`ç®¡ç†ï¼š

   ```
   @SpringBootApplication
   public class App {
       @Bean
       public Function<String, String> uppercase() {
           return String::toUpperCase; // ä¸šåŠ¡é€»è¾‘
       }
   }
   ```

2. **å‡½æ•°ç»„åˆä¸è·¯ç”±**

   - **ç»„åˆ**ï¼šå°†å¤šä¸ªå‡½æ•°ä¸²è”ä¸ºå¤„ç†ç®¡é“ï¼ˆå¦‚ `uppercase | reverse`ï¼‰ï¼š

     ```
     spring:
       cloud:
         function:
           definition: uppercase|reverse  # ç»„åˆå‡½æ•°
     ```

   - **è·¯ç”±**ï¼šåŠ¨æ€é€‰æ‹©æ‰§è¡Œå‡½æ•°ï¼ˆå¦‚æ ¹æ®æ¶ˆæ¯å¤´è·¯ç”±ï¼‰ï¼š

     ```
     @Bean
     public Function<String, String> router() {
         return input -> input.startsWith("upper:") ? "uppercase" : "reverse";
     }
     ```

3. **ååº”å¼ç¼–ç¨‹æ”¯æŒ**

   ä½¿ç”¨ Reactor çš„ `Flux`/`Mono`å¤„ç†æµæ•°æ®ï¼Œæ”¯æŒèƒŒå‹å’Œéé˜»å¡ I/Oï¼š

   ```
   @Bean
   public Function<Flux<String>, Flux<String>> reactiveProcessor() {
       return flux -> flux.map(String::toUpperCase);
   }
   ```

4. **é€æ˜ç±»å‹è½¬æ¢**

   æ¡†æ¶è‡ªåŠ¨å¤„ç†æ¶ˆæ¯ä¸ Java å¯¹è±¡çš„è½¬æ¢ï¼ˆå¦‚ JSON â†’ `Person`ç±»ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨åºåˆ—åŒ–ã€‚

------

### ä¸‰ã€é›†æˆä¸éƒ¨ç½²æ–¹æ¡ˆ

1. **HTTP æœåŠ¡**

   æ·»åŠ  `spring-cloud-function-web`ä¾èµ–ï¼Œå‡½æ•°è‡ªåŠ¨æš´éœ²ä¸º REST ç«¯ç‚¹ï¼š

   ```
   curl -X POST http://localhost:8080/uppercase -d "hello"  # è¾“å‡º "HELLO"
   ```

2. **æ¶ˆæ¯ç³»ç»Ÿé›†æˆï¼ˆSpring Cloud Streamï¼‰**

   ç»‘å®š Kafka/RabbitMQï¼Œå‡½æ•°è‡ªåŠ¨å¤„ç†æ¶ˆæ¯ï¼š

   ```
   spring:
     cloud:
       function:
         definition: processOrder
       stream:
         bindings:
           processOrder-in-0: destination: orders-topic  # è¾“å…¥ä¸»é¢˜
           processOrder-out-0: destination: processed-topic # è¾“å‡ºä¸»é¢˜
   ```

3. **æ— æœåŠ¡å™¨å¹³å°éƒ¨ç½²ï¼ˆFaaSï¼‰**

   é€‚é… AWS Lambdaã€Azure Functions ç­‰ï¼š

   - **é€‚é…å™¨ä¾èµ–**ï¼š`spring-cloud-function-adapter-aws`

   - **å¤„ç†å™¨ç¤ºä¾‹**ï¼š

     ```
     public class Handler extends SpringBootRequestHandler<String, String> {} // è‡ªåŠ¨è°ƒç”¨å‡½æ•°
     ```

------

### å››ã€é«˜çº§ç‰¹æ€§

1. **å¤šè¾“å…¥/è¾“å‡ºæµå¤„ç†**

   ä½¿ç”¨ `Tuple`åˆå¹¶æˆ–æ‹†åˆ†æµï¼š

   ```
   @Bean
   public Function<Tuple2<Flux<String>, Flux<Integer>>, Flux<String>> mergeStreams() {
       return tuple -> Flux.merge(tuple.getT1(), tuple.getT2().map(String::valueOf));
   }
   ```

2. **åŠ¨æ€å‡½æ•°ç¼–è¯‘**

   æ”¯æŒå°†å­—ç¬¦ä¸²å½¢å¼çš„ Lambda ç¼–è¯‘ä¸ºå¯æ‰§è¡Œå‡½æ•°ï¼Œä¾¿äºåŠ¨æ€é€»è¾‘æ‰©å±•ã€‚

3. **éš”ç¦»ç±»åŠ è½½å™¨**

   å…è®¸åŒä¸€ JVM ä¸­éƒ¨ç½²å¤šç‰ˆæœ¬å‡½æ•°ï¼Œé¿å…ä¾èµ–å†²çªã€‚

------

### äº”ã€ä¼ä¸šçº§åº”ç”¨åœºæ™¯

1. **äº‹ä»¶é©±åŠ¨æ¶æ„**

   **ç¤ºä¾‹**ï¼šè®¢å•å¤„ç†æµæ°´çº¿

   ```
   @Bean
   public Function<Flux<Order>, Flux<Void>> orderPipeline() {
       return orders -> orders
           .filter(order -> order.getAmount() > 100) // è¿‡æ»¤
           .map(orderEnricher::enrich)              // æ•°æ®å¢å¼º
           .doOnNext(notificationService::alert)    // å‘é€é€šçŸ¥
           .then(Mono.empty());
   }
   ```

2. **æ‰¹å¤„ç†ä¸ ETL**

   æ¶ˆè´¹æ‰¹é‡æ•°æ®å¹¶è½¬æ¢åå†™å…¥æ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—ã€‚

3. **æ— æœåŠ¡å™¨å‡½æ•°è®¡ç®—**

   åœ¨ AWS Lambda ç­‰å¹³å°éƒ¨ç½²å‡½æ•°ï¼ŒæŒ‰éœ€æ‰§è¡Œã€æŒ‰é‡è®¡è´¹ã€‚

------

### å…­ã€ä¼˜åŠ¿æ€»ç»“

| **ç»´åº¦**       | **ä¼ ç»Ÿæ–¹æ¡ˆ**                        | **Spring Cloud Function**          |
| -------------- | ----------------------------------- | ---------------------------------- |
| **ä¸šåŠ¡è€¦åˆåº¦** | ä¸ä¼ è¾“åè®®å¼ºç»‘å®šï¼ˆå¦‚ HTTP Servletï¼‰ | çº¯å‡½æ•°é€»è¾‘ï¼Œä¸åè®®æ— å…³             |
| **éƒ¨ç½²çµæ´»æ€§** | ç¯å¢ƒé€‚é…éœ€ä»£ç æ”¹é€                   | é…ç½®åˆ‡æ¢ç¯å¢ƒï¼ˆHTTPâ†’æ¶ˆæ¯é˜Ÿåˆ—â†’FaaSï¼‰ |
| **å¯æµ‹è¯•æ€§**   | éœ€ Mock å¤–éƒ¨ä¾èµ–                    | ç›´æ¥å•å…ƒæµ‹è¯•å‡½æ•°é€»è¾‘               |
| **èµ„æºæ¶ˆè€—**   | å¸¸é©»è¿›ç¨‹å ç”¨èµ„æº                    | æ— æœåŠ¡å™¨ç¯å¢ƒä¸‹æŒ‰éœ€å¯åŠ¨             |

> **æœ¬è´¨ä»·å€¼**ï¼šé€šè¿‡ **å‡½æ•°æŠ½è±¡å±‚** è§£è€¦ä¸šåŠ¡ä¸åŸºç¡€è®¾æ–½ï¼Œä½¿å¼€å‘è€…ä¸“æ³¨æ ¸å¿ƒé€»è¾‘ï¼ŒåŒæ—¶è·å¾— **äº‘åŸç”Ÿå¯ç§»æ¤æ€§** å’Œ **äº‹ä»¶é©±åŠ¨æ‰©å±•æ€§**ã€‚

## ä¾èµ–å…³ç³»

åœ¨ Spring Cloud Stream â‰¥3.0 ä¸­ï¼Œ**å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ï¼ˆ`Supplier`/`Function`/`Consumer`ï¼‰çš„å®ç°æœ¬è´¨ä¸Šæ˜¯ä¸ Spring Cloud Function æ·±åº¦é›†æˆçš„**ï¼Œä½†å¼€å‘è€…æ˜¯å¦éœ€è¦æ˜¾å¼å¼•å…¥å…¶ä¾èµ–ï¼Œéœ€æ ¹æ®å…·ä½“åœºæ™¯å’Œç‰ˆæœ¬è¦æ±‚åŒºåˆ†ï¼š

------

### âœ… **æ ¸å¿ƒç»“è®º**

1. **åŸºç¡€å‡½æ•°å¼ç¼–ç¨‹æ— éœ€æ˜¾å¼ä¾èµ–**

   - Spring Cloud Stream â‰¥3.0 **å†…ç½®äº†å¯¹å‡½æ•°å¼æ¥å£çš„æ”¯æŒ**ã€‚å¼€å‘è€…ä»…éœ€é€šè¿‡ `@Bean`å£°æ˜ `Supplier`/`Function`/`Consumer`ç±»å‹çš„ Beanï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨ç»‘å®šæ¶ˆæ¯é€šé“ï¼Œæ— éœ€é¢å¤–æ·»åŠ  `spring-cloud-function`ä¾èµ–ã€‚

   - **ç¤ºä¾‹é…ç½®**ï¼š

     ```
     spring:
       cloud:
         function:
           definition: myProducer;myProcessor  # å£°æ˜å‡½æ•°å
         stream:
           bindings:
             myProducer-out-0: destination: orders-topic  # è‡ªåŠ¨ç»‘å®šç”Ÿäº§è€…é€šé“
             myProcessor-in-0: destination: orders-topic   # ç»‘å®šå¤„ç†å™¨è¾“å…¥
             myProcessor-out-0: destination: processed-topic # ç»‘å®šå¤„ç†å™¨è¾“å‡º
     ```

2. **é«˜çº§ç‰¹æ€§éœ€æ˜¾å¼ä¾èµ– Spring Cloud Function**

   è‹¥éœ€ä½¿ç”¨ä»¥ä¸‹èƒ½åŠ›ï¼Œå¿…é¡»å¼•å…¥ `spring-cloud-function`ä¾èµ–ï¼š

   - **å‡½æ•°ç»„åˆ**ï¼ˆå¦‚ `uppercase|reverse`ï¼‰ï¼Œé€šè¿‡ç®¡é“ä¸²è”å¤šä¸ªå‡½æ•°ã€‚

   - **åŠ¨æ€è·¯ç”±**ï¼ˆRouting Functionï¼‰ï¼Œæ ¹æ®æ¶ˆæ¯å†…å®¹åŠ¨æ€é€‰æ‹©å¤„ç†å‡½æ•°ã€‚

   - **å“åº”å¼æµé«˜çº§æ“ä½œ**ï¼ˆå¦‚ `Flux`çš„çª—å£èšåˆã€èƒŒå‹æ§åˆ¶ï¼‰ã€‚

   - **ä¾èµ–é¡¹**ï¼š

     ```
     <dependency>
         <groupId>org.springframework.cloud</groupId>
         <artifactId>spring-cloud-function-context</artifactId>
     </dependency>
     ```

3. **ç‰ˆæœ¬æ¼”è¿›ä¸å¼ºåˆ¶ä¾èµ–**

   - **Spring Cloud Stream 3.1+**ï¼šå®Œå…¨åºŸå¼ƒæ³¨è§£æ¨¡å‹ï¼ˆ`@EnableBinding`ï¼‰ï¼Œ**å¼ºåˆ¶ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹**ï¼Œæ­¤æ—¶æ¡†æ¶åº•å±‚å·²æ·±åº¦æ•´åˆ Spring Cloud Functionï¼Œä½†åŸºç¡€ç”¨æ³•ä»å¯ä¸æ˜¾å¼æ·»åŠ ä¾èµ–ã€‚
   - **Spring Cloud Stream 4.0+**ï¼šå‡½æ•°å¼ç¼–ç¨‹æˆä¸ºå”¯ä¸€æ¨¡å‹ï¼ŒSpring Cloud Function æˆä¸ºéšå¼æ ¸å¿ƒç»„ä»¶ã€‚

------

### âš™ï¸ **ä½¿ç”¨å»ºè®®**

| **åœºæ™¯**           | **æ˜¯å¦éœ€è¦æ˜¾å¼ä¾èµ–** | **è¯´æ˜**                                                     |
| ------------------ | -------------------- | ------------------------------------------------------------ |
| åŸºç¡€æ¶ˆæ¯ç”Ÿäº§/æ¶ˆè´¹  | å¦                   | ä»…éœ€ `spring-cloud-stream`+ Binderï¼ˆå¦‚ `spring-cloud-stream-binder-kafka`ï¼‰ã€‚ |
| å‡½æ•°ç»„åˆã€åŠ¨æ€è·¯ç”± | æ˜¯                   | éœ€æ·»åŠ  `spring-cloud-function-context`å®ç°å¤æ‚æµå¤„ç†ã€‚       |
| å“åº”å¼æµé«˜çº§æ“ä½œ   | æ˜¯                   | éœ€ Reactor å’Œ Spring Cloud Function ååŒæ”¯æŒã€‚               |
| è¿ç§»æ—§ç‰ˆæ³¨è§£æ¨¡å‹   | å¦                   | å‡½æ•°å¼æ¨¡å‹å¯ç›´æ¥æ›¿ä»£ï¼Œæ— éœ€é¢å¤–ä¾èµ–ã€‚                         |

------

### ğŸ’¡ **æŠ€æœ¯åŸç†**

- **è‡ªåŠ¨ç»‘å®šæœºåˆ¶**ï¼šSpring Cloud Stream é€šè¿‡ `FunctionCatalog`è‡ªåŠ¨å‘ç°å‡½æ•° Beanï¼ŒæŒ‰å‘½åè§„åˆ™ï¼ˆå¦‚ `å‡½æ•°å-in-0`ï¼‰ç»‘å®šé€šé“ã€‚
- **å‡½æ•°ç»„åˆå®ç°**ï¼šSpring Cloud Function æä¾› `FunctionRegistry`å’Œ `FunctionType`ï¼ŒåŠ¨æ€ç»„è£…å‡½æ•°ç®¡é“ï¼ˆå¦‚ `f1|f2`ï¼‰ã€‚
- **ç»Ÿä¸€ç¼–ç¨‹æ¨¡å‹**ï¼šæ— è®ºæ˜¯å¦æ˜¾å¼ä¾èµ–ï¼Œå‡½æ•°å¼ç¼–ç¨‹å‡åŸºäº Spring Cloud Function çš„åº•å±‚æŠ½è±¡ï¼Œä½†æ¡†æ¶å·²å†…ç½®æœ€å°åŒ–æ”¯æŒã€‚

------

### ğŸ”§ **é…ç½®ç¤ºä¾‹**

#### 1. æ— æ˜¾å¼ä¾èµ–ï¼ˆåŸºç¡€åœºæ™¯ï¼‰

```
@SpringBootApplication
public class App {
    @Bean
    public Supplier<String> myProducer() { // è‡ªåŠ¨ç»‘å®šåˆ° myProducer-out-0
        return () -> "New order";
    }

    @Bean
    public Consumer<String> myConsumer() { // è‡ªåŠ¨ç»‘å®šåˆ° myConsumer-in-0
        return msg -> System.out.println("Received: " + msg);
    }
}
```

#### 2. éœ€æ˜¾å¼ä¾èµ–ï¼ˆå‡½æ•°ç»„åˆï¼‰

```
# application.yml
spring:
  cloud:
    function:
      definition: validateOrder|processPayment|sendNotification # ç»„åˆå‡½æ•°
    stream:
      bindings:
        validateOrder-in-0: destination: orders-topic
        sendNotification-out-0: destination: notifications-topic
<!-- pom.xml éœ€æ˜¾å¼æ·»åŠ  -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-function-context</artifactId>
</dependency>
```

------

### ğŸ’ **æ€»ç»“**

- **å¤šæ•°åœºæ™¯æ— éœ€æ˜¾å¼ä¾èµ–**ï¼šSpring Cloud Stream â‰¥3.0 çš„å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹å·²å†…ç½®åŸºç¡€æ”¯æŒï¼Œå¯ç›´æ¥ä½¿ç”¨ `Supplier`/`Consumer`Beanã€‚
- **é«˜çº§åŠŸèƒ½å¼ºåˆ¶ä¾èµ–**ï¼šå‡½æ•°ç»„åˆã€åŠ¨æ€è·¯ç”±ç­‰éœ€æ˜¾å¼å¼•å…¥ `spring-cloud-function`ã€‚
- **æ¼”è¿›æ–¹å‘**ï¼šéšç€ç‰ˆæœ¬å‡çº§ï¼ŒSpring Cloud Function å·²æˆä¸ºå‡½æ•°å¼æ¶ˆæ¯å¤„ç†çš„**äº‹å®æ ‡å‡†åº•å±‚**ï¼Œæ˜¾å¼ä¾èµ–ä»…ç”¨äºæ‰©å±•èƒ½åŠ›ã€‚

> **æ¨èå®è·µ**ï¼šæ–°é¡¹ç›®å»ºè®®ç›´æ¥æ·»åŠ  `spring-cloud-function`ä¾èµ–ä»¥æ”¯æŒæœªæ¥æ‰©å±•ï¼Œé¿å…å› åŠŸèƒ½å‡çº§å¯¼è‡´é‡æ„ã€‚

## definition

Spring Cloud Function åœ¨ç»‘å®šå‡½æ•°æ—¶ï¼Œå…¶è¡Œä¸ºå–å†³äº **`spring.cloud.function.definition`** é…ç½®å±æ€§ã€‚ä»¥ä¸‹æ˜¯å…·ä½“è§„åˆ™ï¼š

------

### ğŸ”§ **ä¸€ã€ç»‘å®šè§„åˆ™**

1. **æœªé…ç½® `definition`å±æ€§**

   - **é»˜è®¤è¡Œä¸º**ï¼šSpring Cloud Function ä¼šè‡ªåŠ¨ç»‘å®š **æ‰€æœ‰** å£°æ˜ä¸º `@Bean`çš„ `Supplier`ã€`Function`ã€`Consumer`ç±»å‹ç»„ä»¶ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @Bean
     public Function<String, String> uppercase() { ... } // è‡ªåŠ¨ç»‘å®š
     @Bean
     public Consumer<String> logger() { ... }            // è‡ªåŠ¨ç»‘å®š
     ```

   - **é€šé“å‘½å**ï¼šå‡½æ•°å + `-in-0`ï¼ˆè¾“å…¥é€šé“ï¼‰æˆ– `-out-0`ï¼ˆè¾“å‡ºé€šé“ï¼‰ï¼Œå¦‚ `uppercase-in-0`ã€‚

2. **é…ç½® `definition`å±æ€§**

   - **é€‰æ‹©æ€§ç»‘å®š**ï¼šä»…ç»‘å®š `definition`ä¸­åˆ—å‡ºçš„å‡½æ•°ï¼ˆå¤šä¸ªå‡½æ•°ç”¨åˆ†å·æˆ–é€—å·åˆ†éš”ï¼‰ã€‚

   - **ç¤ºä¾‹é…ç½®**ï¼š

     ```
     spring:
       cloud:
         function:
           definition: uppercase;logger  # ä»…ç»‘å®š uppercase å’Œ logger
     ```

   - **æœªåˆ—å‡ºçš„å‡½æ•°**ï¼šä¸ä¼šè¢«æ³¨å†Œåˆ° `FunctionCatalog`ï¼Œæ— æ³•é€šè¿‡æ¶ˆæ¯æˆ– HTTP è®¿é—® ã€‚

------

### âš™ï¸ **äºŒã€å‡½æ•°ç»„åˆä¸åŠ¨æ€è·¯ç”±**

1. **å‡½æ•°ç»„åˆ**

   - é€šè¿‡ `definition`å°†å¤šä¸ªå‡½æ•°ä¸²è”ï¼ˆå¦‚ `f1|f2`ï¼‰ï¼Œå½¢æˆå¤„ç†ç®¡é“ï¼š

     ```
     spring:
       cloud:
         function:
           definition: validateOrder|processPayment  # ç»„åˆå‡½æ•°
     ```

   - ä»…ç»„åˆå‡½æ•°ä¼šè¢«ç»‘å®šï¼Œå•å‡½æ•°éœ€æ˜¾å¼åˆ—å‡º ã€‚

2. **åŠ¨æ€è·¯ç”±**

   - é€šè¿‡ `MessageRoutingCallback`æˆ– HTTP å¤´åŠ¨æ€é€‰æ‹©å‡½æ•°ï¼Œä½†è·¯ç”±ç›®æ ‡å‡½æ•°ä»éœ€åœ¨ `definition`ä¸­å£°æ˜ ã€‚

------

### âš ï¸ **ä¸‰ã€æ³¨æ„äº‹é¡¹**

1. **å‡½æ•°å‘½åå†²çª**
   - è‹¥å¤šä¸ªå‡½æ•°åŒåï¼Œå¯åŠ¨æ—¶ä¼šæŠ¥ `BeanDefinition`å†²çªï¼Œéœ€é€šè¿‡ `@Bean(name="customName")`æ˜¾å¼å‘½åã€‚
2. **ååº”å¼å‡½æ•°ç»‘å®š**
   - ååº”å¼å‡½æ•°ï¼ˆå¦‚ `Function<Flux<String>, Flux<String>>`ï¼‰ç»‘å®šè§„åˆ™ä¸å‘½ä»¤å¼ä¸€è‡´ï¼Œä½†éœ€æ³¨æ„è®¢é˜…æœºåˆ¶ï¼š
     - `Consumer<Flux<T>>`éœ€ä¸»åŠ¨è®¢é˜…ï¼ˆå¦‚ `flux.subscribe()`ï¼‰ã€‚
3. **HTTP ç«¯ç‚¹æ˜ å°„**
   - å½“ä½¿ç”¨ `spring-cloud-function-web`æ—¶ï¼š
     - æœªé…ç½® `definition`ï¼šæ‰€æœ‰å‡½æ•°æ˜ å°„ä¸º HTTP ç«¯ç‚¹ï¼ˆå¦‚ `/uppercase`ï¼‰ã€‚
     - é…ç½® `definition`ï¼šä»…åˆ—å‡ºçš„å‡½æ•°å¯è®¿é—®ï¼Œæœªåˆ—å‡ºçš„è¿”å› 404 ã€‚

------

### ğŸ’ **å››ã€æœ€ä½³å®è·µ**

| **åœºæ™¯**         | **é…ç½®å»ºè®®**                                                 |
| ---------------- | ------------------------------------------------------------ |
| **ç®€å•å¾®æœåŠ¡**   | ä¸é…ç½® `definition`ï¼Œè‡ªåŠ¨ç»‘å®šæ‰€æœ‰å‡½æ•°ã€‚                      |
| **å¤æ‚æµå¤„ç†**   | é…ç½® `definition`ç»„åˆå‡½æ•°ï¼ˆå¦‚ `filter                        |
| **å®‰å…¨æ§åˆ¶**     | é€šè¿‡ `definition`é™åˆ¶æš´éœ²çš„å‡½æ•°ï¼Œé¿å…æœªæˆæƒè®¿é—®ã€‚            |
| **åŠ¨æ€ç¯å¢ƒéƒ¨ç½²** | ç»“åˆ `FunctionCatalog`ç¼–ç¨‹å¼ç®¡ç†å‡½æ•°ï¼ˆå¦‚åŠ¨æ€åŠ è½½å¤–éƒ¨å‡½æ•°ï¼‰ã€‚ |

> **æ€»ç»“**ï¼š
>
> - **é»˜è®¤ç»‘å®šæ‰€æœ‰**ï¼šæœªé…ç½® `spring.cloud.function.definition`æ—¶ï¼Œæ‰€æœ‰å‡½æ•°å‡è¢«ç»‘å®šã€‚
>
> - **é€‰æ‹©æ€§ç»‘å®š**ï¼šé…ç½® `definition`åï¼Œä»…åˆ—å‡ºçš„å‡½æ•°ä¼šè¢«æ³¨å†Œå’Œæš´éœ²ã€‚
>
>   é€šè¿‡åˆç†é…ç½® `definition`ï¼Œå¯ç²¾å‡†æ§åˆ¶å‡½æ•°æš´éœ²èŒƒå›´ï¼Œæå‡å®‰å…¨æ€§ä¸å¯ç»´æŠ¤æ€§ ã€‚

## ç»„åˆå‡½æ•°

åœ¨ Spring Cloud Function ä¸­ï¼Œç»„åˆå‡½æ•°ï¼ˆFunction Compositionï¼‰æ˜¯ä¸€ç§å°†å¤šä¸ªç®€å•å‡½æ•°ä¸²è”æˆå¤æ‚å¤„ç†ç®¡é“çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œå®ƒé€šè¿‡å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹æ˜¾è‘—æå‡ä»£ç å¤ç”¨æ€§å’Œä¸šåŠ¡é€»è¾‘çš„çµæ´»æ€§ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ–¹æ³•å’Œæœ€ä½³å®è·µï¼š

------

### ğŸ”§ **ä¸€ã€ç»„åˆå‡½æ•°çš„æ ¸å¿ƒå®ç°æ–¹å¼**

#### **1. ç¼–ç¨‹å¼ç»„åˆï¼ˆJava ä»£ç çº§ï¼‰**

é€šè¿‡ `.andThen()`æˆ– `.compose()`æ–¹æ³•åœ¨ä»£ç ä¸­æ˜¾å¼ä¸²è”å‡½æ•°ï¼š

```
@Bean
public Function<String, String> addPrefix() {
    return input -> "Hello, " + input;
}

@Bean
public Function<String, String> addSuffix() {
    return input -> input + "!";
}

// ç»„åˆå‡½æ•°ï¼šå…ˆæ·»åŠ å‰ç¼€ï¼Œå†æ·»åŠ åç¼€
@Bean
public Function<String, String> greet() {
    return addPrefix().andThen(addSuffix());
}
```

- **æ‰§è¡Œé¡ºåº**ï¼š`è¾“å…¥ â†’ addPrefix â†’ addSuffix â†’ è¾“å‡º`
- **è°ƒç”¨ç»“æœ**ï¼š`greet.apply("World")`è¿”å› `"Hello, World!"`

------

#### **2. å£°æ˜å¼ç»„åˆï¼ˆé…ç½®çº§ï¼‰**

é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€ç»„åˆå‡½æ•°ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼š

```
spring:
  cloud:
    function:
      definition: uppercase|reverse  # ç”¨ç«–çº¿ | åˆ†éš”å‡½æ•°å
```

- **æ‰§è¡Œé¡ºåº**ï¼šè¾“å…¥å…ˆç»è¿‡ `uppercase`å‡½æ•°å¤„ç†ï¼Œå†ç»è¿‡ `reverse`å‡½æ•°å¤„ç†

- **ç¤ºä¾‹**ï¼š

  - å®šä¹‰å‡½æ•°ï¼š

    ```
    @Bean
    public Function<String, String> uppercase() {
        return String::toUpperCase;
    }
    @Bean
    public Function<String, String> reverse() {
        return s -> new StringBuilder(s).reverse().toString();
    }
    ```

  - è¾“å…¥ `"hello"`çš„å¤„ç†æµç¨‹ï¼š

    `"hello" â†’ "HELLO"ï¼ˆuppercaseï¼‰ â†’ "OLLEH"ï¼ˆreverseï¼‰`

------

### âš™ï¸ **äºŒã€ç»„åˆå‡½æ•°çš„è¿›é˜¶åº”ç”¨**

#### **1. æ··åˆå‘½ä»¤å¼ä¸å“åº”å¼å‡½æ•°**

ç»„åˆå‡½æ•°å¯åŒæ—¶åŒ…å«åŒæ­¥ï¼ˆå‘½ä»¤å¼ï¼‰å’Œå¼‚æ­¥ï¼ˆå“åº”å¼ï¼‰å¤„ç†é€»è¾‘ï¼š

```
@Bean
public Function<String, String> syncTask() {
    return s -> s.replace(" ", "_");
}

@Bean
public Function<Flux<String>, Flux<String>> asyncTask() {
    return flux -> flux.delayElements(Duration.ofMillis(100));
}

// é…ç½®ç»„åˆï¼šå…ˆåŒæ­¥å¤„ç†ï¼Œå†å¼‚æ­¥æµå¤„ç†
spring:
  cloud:
    function:
      definition: syncTask|asyncTask
```

- **ä¼˜åŠ¿**ï¼šåŒæ­¥å‡½æ•°å¤„ç†é˜»å¡æ“ä½œï¼ˆå¦‚æ•°æ®æ¸…æ´—ï¼‰ï¼Œå¼‚æ­¥å‡½æ•°å¤„ç†é«˜å¹¶å‘æµï¼ˆå¦‚æ¶ˆæ¯ç¼“å†²ï¼‰

#### **2. æ¡ä»¶è·¯ç”±ç»„åˆ**

é€šè¿‡è·¯ç”±å‡½æ•°åŠ¨æ€é€‰æ‹©å¤„ç†åˆ†æ”¯ï¼š

```
@Bean
public Function<String, String> router() {
    return input -> {
        if (input.startsWith("A")) return "uppercase";
        else return "reverse";
    };
}

// é…ç½®ä¸­å£°æ˜ç»„åˆé“¾
spring:
  cloud:
    function:
      definition: router|uppercase,router|reverse  # æŒ‰æ¡ä»¶é€‰æ‹©åˆ†æ”¯
```

- **é€»è¾‘è§£é‡Š**ï¼š
  - è¾“å…¥ä»¥ `"A"`å¼€å¤´ â†’ æ‰§è¡Œ `router â†’ uppercase`
  - å…¶ä»–è¾“å…¥ â†’ æ‰§è¡Œ `router â†’ reverse`

------

### ğŸ› ï¸ **ä¸‰ã€ä¼ä¸šçº§åœºæ™¯å®è·µ**

#### **1. è®¢å•å¤„ç†æµæ°´çº¿**

```
@Bean
public Function<Order, Order> validateOrder() {
    return order -> {
        if (order.getAmount() <= 0) throw new IllegalArgumentException("é‡‘é¢æ— æ•ˆ");
        return order;
    };
}

@Bean
public Function<Order, PaymentRequest> createPayment() {
    return order -> new PaymentRequest(order.getId(), order.getAmount());
}

@Bean
public Function<PaymentRequest, String> processPayment() {
    return req -> paymentService.execute(req);
}

// é…ç½®ç»„åˆï¼šéªŒè¯ â†’ åˆ›å»ºæ”¯ä»˜ â†’ æ‰§è¡Œæ”¯ä»˜
spring:
  cloud:
    function:
      definition: validateOrder|createPayment|processPayment
```

- **å¼‚å¸¸å¤„ç†**ï¼šåœ¨ç»„åˆä¸­åµŒå…¥å¼‚å¸¸æ•è·å‡½æ•°ï¼Œé¿å…ç®¡é“ä¸­æ–­

#### **2. å®æ—¶äº‹ä»¶å¤„ç†ç³»ç»Ÿ**

```
spring:
  cloud:
    function:
      definition: filterEvents|enrichMetadata|sendNotification
```

- å‡½æ•°åˆ†å·¥ï¼š
  - `filterEvents`ï¼šè¿‡æ»¤ä½ä¼˜å…ˆçº§äº‹ä»¶
  - `enrichMetadata`ï¼šæ·»åŠ æ—¶é—´æˆ³ã€æ¥æºç­‰å…ƒæ•°æ®
  - `sendNotification`ï¼šè°ƒç”¨æ¶ˆæ¯æœåŠ¡æ¨é€å‘Šè­¦

------

### âš ï¸ **å››ã€æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ**

1. **å‡½æ•°å‘½åå”¯ä¸€æ€§**

   ç»„åˆä¸­æ¯ä¸ªå‡½æ•°åå¿…é¡»å”¯ä¸€ï¼Œé¿å…å› é‡åå¯¼è‡´è·¯ç”±æ··ä¹±ã€‚

2. **è¾“å…¥/è¾“å‡ºç±»å‹å…¼å®¹**

   ç›¸é‚»å‡½æ•°çš„è¾“å‡ºç±»å‹å¿…é¡»ä¸ä¸‹ä¸€å‡½æ•°çš„è¾“å…¥ç±»å‹åŒ¹é…ï¼Œä¾‹å¦‚ï¼š

   ```
   @Bean
   public Function<String, Integer> strToInt() { ... }  // è¾“å‡º Integer
   @Bean
   public Function<Integer, String> intToHex() { ... } // è¾“å…¥å¿…é¡»ä¸º Integer
   ```

3. **å¼‚å¸¸å¤„ç†ç­–ç•¥**

   åœ¨æ˜“å‡ºé”™çš„å‡½æ•°ä¸­å†…ç½® `try-catch`ï¼Œæˆ–é€šè¿‡ `@Bean`å®šä¹‰å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼š

   ```
   @Bean
   public Function<String, String> safeFunction() {
       return input -> {
           try { /* ä¸šåŠ¡é€»è¾‘ */ }
           catch (Exception e) { return "Fallback Value"; }
       };
   }
   ```

4. **æ€§èƒ½ä¼˜åŒ–**

   - é¿å…åœ¨ç»„åˆé“¾ä¸­åµŒå…¥é˜»å¡æ“ä½œï¼ˆå¦‚åŒæ­¥æ•°æ®åº“æŸ¥è¯¢ï¼‰ï¼Œæ”¹ç”¨å“åº”å¼å¼‚æ­¥å¤„ç†ã€‚
   - ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—ï¼ˆå¦‚ `Supplier`æä¾›é™æ€é…ç½®æ•°æ®ï¼‰ã€‚

------

### ğŸ’ **æ€»ç»“**

ç»„åˆå‡½æ•°çš„æ ¸å¿ƒä»·å€¼åœ¨äº**è§£è€¦ä¸šåŠ¡é€»è¾‘**å’Œ**æå‡å¤ç”¨æ€§**ã€‚é€šè¿‡ä¸¤ç§æ–¹å¼çµæ´»é€‰æ‹©ï¼š

- **ç¼–ç¨‹å¼ç»„åˆ**ï¼šé€‚åˆé€»è¾‘å›ºå®šã€éœ€å¼ºç±»å‹æ£€æŸ¥çš„åœºæ™¯ã€‚
- **å£°æ˜å¼ç»„åˆ**ï¼šé€‚åˆåŠ¨æ€è°ƒæ•´æµç¨‹ã€æ”¯æŒçƒ­æ›´æ–°çš„åœºæ™¯ã€‚

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆå¦‚å¾®æœåŠ¡ã€Serverlessï¼‰ä¸­ï¼Œç»„åˆå‡½æ•°å¯æ— ç¼è¡”æ¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka/RabbitMQï¼‰ã€HTTP ç«¯ç‚¹åŠäº‘å‡½æ•°ï¼Œå®ç° **â€œä¸€æ¬¡å¼€å‘ï¼Œå¤šç¯å¢ƒè¿è¡Œâ€** çš„äº‘åŸç”Ÿæ¶æ„ã€‚

## ç»„åˆé“¾

åœ¨ Spring Cloud Function çš„å‡½æ•°ç»„åˆæ¨¡å‹ä¸­ï¼Œ**ä¸éœ€è¦ä¸ºæ¯ä¸ªä¸­é—´å‡½æ•°å•ç‹¬å®šä¹‰é€šé“**ï¼Œåªéœ€è¦ä¸ºæ•´ä¸ªç»„åˆç®¡é“çš„è¾“å…¥ï¼ˆç¬¬ä¸€ä¸ªå‡½æ•°çš„è¾“å…¥ï¼‰å’Œè¾“å‡ºï¼ˆæœ€åä¸€ä¸ªå‡½æ•°çš„è¾“å‡ºï¼‰å®šä¹‰é€šé“å³å¯ã€‚ä¸­é—´å‡½æ•°çš„è¿æ¥ç”±æ¡†æ¶è‡ªåŠ¨å¤„ç†ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è¯´æ˜ï¼š

------

### âš™ï¸ **ç»„åˆå‡½æ•°çš„é€šé“ç»‘å®šè§„åˆ™**

1. **åªéœ€é¦–å°¾å®šä¹‰é€šé“**

   - **è¾“å…¥é€šé“**ï¼šç»‘å®šåˆ°ç»„åˆç®¡é“ä¸­çš„**ç¬¬ä¸€ä¸ªå‡½æ•°**çš„è¾“å…¥ã€‚

   - **è¾“å‡ºé€šé“**ï¼šç»‘å®šåˆ°ç»„åˆç®¡é“ä¸­çš„**æœ€åä¸€ä¸ªå‡½æ•°**çš„è¾“å‡ºã€‚

   - **ä¸­é—´å‡½æ•°**ï¼šæ— éœ€æ˜¾å¼å®šä¹‰é€šé“ï¼Œæ¡†æ¶è‡ªåŠ¨é€šè¿‡å†…å­˜ä¼ é€’æ•°æ®ã€‚

   - **ç¤ºä¾‹é…ç½®**ï¼š

     ```
     spring:
       cloud:
         function:
           definition: validateOrder|processPayment|sendNotification  # ç»„åˆå‡½æ•°é“¾
         stream:
           bindings:
             # ä»…éœ€å®šä¹‰æ•´ä¸ªç®¡é“çš„è¾“å…¥/è¾“å‡ºé€šé“
             validateOrder-in-0: destination: orders-topic    # ç¬¬ä¸€ä¸ªå‡½æ•°çš„è¾“å…¥
             sendNotification-out-0: destination: results   # æœ€åä¸€ä¸ªå‡½æ•°çš„è¾“å‡º
     ```

2. **é€šé“å‘½åè§„èŒƒ**

   - è¾“å…¥é€šé“ï¼š`{ç»„åˆé“¾åç§°}-in-0`ï¼ˆå¦‚ `validateOrder-in-0`ï¼‰ã€‚
   - è¾“å‡ºé€šé“ï¼š`{ç»„åˆé“¾åç§°}-out-0`ï¼ˆå¦‚ `sendNotification-out-0`ï¼‰ã€‚
   - ç»„åˆåç§°ç”± `definition`ä¸­çš„å‡½æ•°åé€šè¿‡ `|`è¿æ¥ï¼ˆå¦‚ `validateOrder|processPayment|sendNotification`ï¼‰ã€‚

------

### ğŸ”§ **é…ç½®ç¤ºä¾‹ä¸æ•°æ®æµå‘**

å‡è®¾ç»„åˆå‡½æ•°é“¾ï¼š`filter -> transform -> save`

- **YAML é…ç½®**ï¼š

  ```
  spring:
    cloud:
      function:
        definition: filter|transform|save  # ç»„åˆå‡½æ•°
      stream:
        bindings:
          filter-in-0: destination: input-data  # è¾“å…¥é€šé“ï¼ˆç»‘å®šåˆ° filterï¼‰
          save-out-0: destination: output-data   # è¾“å‡ºé€šé“ï¼ˆç»‘å®šåˆ° saveï¼‰
  ```

- **æ•°æ®æµ**ï¼š

  ```
  graph LR
  A[input-data Topic] --> B(filter) --> C(transform) --> D(save) --> E[output-data Topic]
  ```

  æ¶ˆæ¯ä» `input-data`ä¸»é¢˜è¿›å…¥ `filter`å‡½æ•°ï¼Œç»å†…å­˜ä¼ é€’ä¾æ¬¡æ‰§è¡Œ `transform`å’Œ `save`ï¼Œæœ€ç»ˆç»“æœå‘é€åˆ° `output-data`ä¸»é¢˜ã€‚

------

### âš ï¸ **æ³¨æ„äº‹é¡¹**

1. **å‡½æ•°è¾“å…¥/è¾“å‡ºç±»å‹å¿…é¡»å…¼å®¹**

   ç›¸é‚»å‡½æ•°çš„è¾“å‡ºç±»å‹éœ€ä¸ä¸‹ä¸€å‡½æ•°çš„è¾“å…¥ç±»å‹åŒ¹é…ï¼Œå¦åˆ™è¿è¡Œæ—¶æŠ›å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼š

   ```
   @Bean
   public Function<String, Integer> strToInt() { ... }  // è¾“å‡º Integer
   @Bean
   public Function<Integer, String> intToStr() { ... } // è¾“å…¥å¿…é¡»ä¸º Integer
   ```

2. **åŠ¨æ€ç»„åˆéœ€é¿å…å¾ªç¯ä¾èµ–**

   è‹¥ç»„åˆé“¾ä¸­å‡½æ•°å­˜åœ¨å¾ªç¯è°ƒç”¨ï¼ˆå¦‚ `A -> B -> A`ï¼‰ï¼Œéœ€é€šè¿‡æ¡ä»¶è·¯ç”±æ‹†åˆ†é€»è¾‘ã€‚

3. **é€šé“ç»‘å®šçš„è¦†ç›–è§„åˆ™**

   è‹¥æ˜¾å¼ä¸ºä¸­é—´å‡½æ•°å®šä¹‰é€šé“ï¼ˆå¦‚ `transform-in-0`ï¼‰ï¼Œè¯¥é…ç½®**æ— æ•ˆ**ï¼Œå› æ¡†æ¶ä¼šå¿½ç•¥ä¸­é—´å‡½æ•°çš„ç‹¬ç«‹ç»‘å®šã€‚

------

### ğŸ’ **æ€»ç»“**

- **å¿…é¡»é…ç½®**ï¼šç»„åˆç®¡é“çš„**è¾“å…¥é€šé“**ï¼ˆé¦–å‡½æ•°è¾“å…¥ï¼‰å’Œ**è¾“å‡ºé€šé“**ï¼ˆæœ«å‡½æ•°è¾“å‡ºï¼‰ã€‚
- **æ— éœ€é…ç½®**ï¼šä¸­é—´å‡½æ•°çš„é€šé“ï¼ˆæ¡†æ¶è‡ªåŠ¨è¿æ¥ï¼‰ã€‚
- **æœ€ä½³å®è·µ**ï¼š
  - ä½¿ç”¨ `spring.cloud.function.definition`å£°æ˜ç»„åˆé“¾ï¼ˆå¦‚ `f1|f2|f3`ï¼‰ã€‚
  - ä»…é€šè¿‡ `bindings.{ç»„åˆé“¾å}-in-0`å’Œ `bindings.{ç»„åˆé“¾å}-out-0`å®šä¹‰é€šé“ã€‚

> é€šè¿‡å‡½æ•°ç»„åˆï¼Œå¼€å‘è€…å¯èšç„¦ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€å…³æ³¨ä¸­é—´ä¼ è¾“ç»†èŠ‚ï¼Œæ˜¾è‘—æå‡ä»£ç ç®€æ´æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

## é€šé“ç´¢å¼•

åœ¨ Spring Cloud Streamï¼ˆå°¤å…¶æ˜¯ 3.x åŠä¹‹åçš„ç‰ˆæœ¬ï¼‰ä¸­ï¼Œ**Bindings åç§°ä¸­çš„ `-0`åç¼€æ˜¯å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹å¼•å…¥çš„ç´¢å¼•æ ‡è¯†**ï¼Œä¸»è¦ç”¨äºè§£å†³å¤šè¾“å…¥/è¾“å‡ºé€šé“çš„å‘½åé—®é¢˜ï¼Œç¡®ä¿ç»‘å®šçš„å”¯ä¸€æ€§å’Œæ˜ç¡®æ€§ã€‚ä»¥ä¸‹æ˜¯å…·ä½“åŸå› å’Œè®¾è®¡é€»è¾‘ï¼š

------

### âš™ï¸ **1. æ”¯æŒå¤šè¾“å…¥/è¾“å‡ºé€šé“çš„å‡½æ•°**

åœ¨å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªå‡½æ•°å¯èƒ½æœ‰**å¤šä¸ªè¾“å…¥æˆ–è¾“å‡ºé€šé“**ã€‚ä¾‹å¦‚ï¼š

- **å¤šä¸ªè¾“å…¥**ï¼š`Function<Tuple2<Flux<String>, Flux<Integer>>, Flux<String>>`éœ€è¦ä¸¤ä¸ªè¾“å…¥é€šé“ï¼ˆ`in-0`å’Œ `in-1`ï¼‰ã€‚
- **å¤šä¸ªè¾“å‡º**ï¼š`Function<String, Tuple2<String, Integer>>`éœ€è¦ä¸¤ä¸ªè¾“å‡ºé€šé“ï¼ˆ`out-0`å’Œ `out-1`ï¼‰ã€‚

`-0`ä¸­çš„æ•°å­—ï¼ˆå¦‚ `0`ï¼‰è¡¨ç¤º**é€šé“çš„ç´¢å¼•å·**ï¼Œç”¨äºåŒºåˆ†åŒä¸€å‡½æ•°çš„å¤šä¸ªè¾“å…¥æˆ–è¾“å‡ºä½ç½®ã€‚

------

### ğŸ”§ **2. é€šé“å‘½åè§„èŒƒ**

Spring Cloud Stream ä¸ºå‡½æ•°è‡ªåŠ¨ç”Ÿæˆçš„é€šé“åç§°éµå¾ªå›ºå®šæ ¼å¼ï¼š

- **è¾“å…¥é€šé“**ï¼š`{å‡½æ•°å}-in-{ç´¢å¼•}`
- **è¾“å‡ºé€šé“**ï¼š`{å‡½æ•°å}-out-{ç´¢å¼•}`

å…¶ä¸­ï¼š

- **ç´¢å¼•ä» `0`å¼€å§‹**ï¼šé¦–ä¸ªè¾“å…¥/è¾“å‡ºé€šé“çš„ç´¢å¼•ä¸º `0`ï¼ˆå¦‚ `myFunction-in-0`ï¼‰ã€‚
- **æ‰©å±•æ€§**ï¼šè‹¥å‡½æ•°æœ‰ç¬¬äºŒä¸ªè¾“å…¥é€šé“ï¼Œåˆ™å‘½åä¸º `myFunction-in-1`ï¼Œä¾æ­¤ç±»æ¨ã€‚

> **ç¤ºä¾‹é…ç½®**ï¼š
>
> ```
> spring:
>   cloud:
>     stream:
>       bindings:
>         myFunction-in-0:  # ç¬¬ä¸€ä¸ªè¾“å…¥é€šé“
>           destination: input-topic
>         myFunction-out-0: # ç¬¬ä¸€ä¸ªè¾“å‡ºé€šé“
>           destination: output-topic
> ```

------

### âš ï¸ **3. ä¼ ç»Ÿæ³¨è§£æ¨¡å‹ vs å‡½æ•°å¼æ¨¡å‹**

- **ä¼ ç»Ÿæ³¨è§£æ¨¡å‹**ï¼ˆå¦‚ `@Input`/`@Output`ï¼‰ï¼š

  é€šé“åç§°ç”±å¼€å‘è€…è‡ªå®šä¹‰ï¼ˆå¦‚ `@Input("orders")`ï¼‰ï¼Œæ— éœ€ç´¢å¼•åç¼€ã€‚

- **å‡½æ•°å¼æ¨¡å‹**ï¼ˆ`Supplier`/`Function`/`Consumer`ï¼‰ï¼š

  æ¡†æ¶è‡ªåŠ¨ç”Ÿæˆå¸¦ç´¢å¼•çš„é€šé“åï¼Œ**å¼ºåˆ¶ç»Ÿä¸€å‘½åè§„åˆ™**ä»¥é¿å…å†²çªã€‚

------

### ğŸ’¡ **4. ä¸ºä½•ç´¢å¼•ä» `0`å¼€å§‹ï¼Ÿ**

- **æŠ€æœ¯ä¸€è‡´æ€§**ï¼šç´¢å¼•ä» `0`å¼€å§‹ç¬¦åˆç¼–ç¨‹è¯­è¨€ä¸­æ•°ç»„/é›†åˆçš„é€šç”¨è§„èŒƒï¼ˆå¦‚ Java æ•°ç»„ä¸‹æ ‡ï¼‰ã€‚
- **ç®€åŒ–é»˜è®¤åœºæ™¯**ï¼šå¯¹äºå•è¾“å…¥/è¾“å‡ºçš„å‡½æ•°ï¼ˆå å¤§å¤šæ•°åœºæ™¯ï¼‰ï¼Œåªéœ€ä½¿ç”¨ `-in-0`å’Œ `-out-0`ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

------

### âœ… **5. å®é™…é…ç½®è¦æ±‚**

åœ¨é…ç½®æ–‡ä»¶ä¸­å¿…é¡»ä¸¥æ ¼åŒ¹é…å¸¦ç´¢å¼•çš„é€šé“åï¼Œå¦åˆ™ç»‘å®šå¤±è´¥ï¼š

```
# æ­£ç¡® âœ…
spring.cloud.stream.bindings.myConsumer-in-0.destination=orders

# é”™è¯¯ âŒï¼ˆç¼ºå°‘ç´¢å¼•ï¼‰
spring.cloud.stream.bindings.myConsumer-in.destination=orders
```

è‹¥æœªæ­£ç¡®æ·»åŠ  `-0`ï¼ŒSpring Cloud Stream ä¼šæç¤ºæ— æ³•æ‰¾åˆ°é€šé“ç»‘å®šã€‚

------

### ğŸ’ **æ€»ç»“**

- **`-0`æ˜¯é€šé“ç´¢å¼•**ï¼šæ ‡è¯†å‡½æ•°çš„ç¬¬ä¸€è¾“å…¥/è¾“å‡ºä½ç½®ï¼Œæ”¯æŒæ‰©å±•å¤šé€šé“åœºæ™¯ã€‚
- **å¼ºåˆ¶å‘½åè§„åˆ™**ï¼šå‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ä¸­æ¡†æ¶è‡ªåŠ¨ç”Ÿæˆçš„é€šé“åå¿…é¡»åŒ…å«ç´¢å¼•ï¼Œå¼€å‘è€…éœ€åœ¨é…ç½®ä¸­æ˜¾å¼ä½¿ç”¨ `{å‡½æ•°å}-in-0`æˆ– `{å‡½æ•°å}-out-0`ã€‚
- **è®¾è®¡ç›®æ ‡**ï¼šé€šè¿‡æ ‡å‡†åŒ–å‘½åï¼Œç®€åŒ–å¤šé€šé“ç»‘å®šé€»è¾‘ï¼Œé¿å…æ‰‹åŠ¨ç®¡ç†åç§°å†²çªã€‚

## æ³¨è§£

Spring Cloud Stream é€šè¿‡ä¸€ç³»åˆ—æ³¨è§£ç®€åŒ–äº†æ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡çš„å¼€å‘ï¼Œä»¥ä¸‹æ˜¯ä¸æ ¸å¿ƒåŠŸèƒ½ç›¸å…³çš„å…³é”®æ³¨è§£åŠå…¶è¯¦ç»†è¯´æ˜ï¼š

------

### ğŸ§± **ä¸€ã€æ ¸å¿ƒç»‘å®šæ³¨è§£**

1. **`@EnableBinding`**

   - **åŠŸèƒ½**ï¼šæ¿€æ´»é€šé“ç»‘å®šï¼Œå°† Spring åº”ç”¨è½¬æ¢ä¸º Stream åº”ç”¨ã€‚å£°æ˜éœ€ç»‘å®šçš„é€šé“æ¥å£ï¼ˆå¦‚ `Source.class`, `Sink.class`ï¼‰ã€‚

   - **åœºæ™¯**ï¼šç”¨äºå¯åŠ¨ç±»æˆ–é…ç½®ç±»ï¼Œè§¦å‘ Binder åˆå§‹åŒ–åŠé€šé“ä¸ä¸­é—´ä»¶çš„è¿æ¥ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @SpringBootApplication
     @EnableBinding(Source.class) // ç»‘å®šå‘é€é€šé“
     public class ProducerApp { ... }
     ```

2. **`@Input`**

   - **åŠŸèƒ½**ï¼šå®šä¹‰**è¾“å…¥é€šé“**ï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼Œæ–¹æ³•è¿”å› `SubscribableChannel`ç±»å‹ã€‚

   - **åœºæ™¯**ï¼šåœ¨è‡ªå®šä¹‰é€šé“æ¥å£ä¸­æ ‡è®°æ¶ˆè´¹æ¶ˆæ¯çš„é€šé“ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     public interface CustomChannel {
         @Input("orderInput") // é€šé“é€»è¾‘å
         SubscribableChannel orderInput();
     }
     ```

3. **`@Output`**

   - **åŠŸèƒ½**ï¼šå®šä¹‰**è¾“å‡ºé€šé“**ï¼ˆç”Ÿäº§è€…ï¼‰ï¼Œæ–¹æ³•è¿”å› `MessageChannel`ç±»å‹ã€‚

   - **åœºæ™¯**ï¼šåœ¨è‡ªå®šä¹‰é€šé“æ¥å£ä¸­æ ‡è®°å‘é€æ¶ˆæ¯çš„é€šé“ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     public interface CustomChannel {
         @Output("notificationOutput")
         MessageChannel notificationOutput();
     }
     ```

------

### ğŸ“¨ **äºŒã€æ¶ˆæ¯ç›‘å¬ä¸å‘é€æ³¨è§£**

1. **`@StreamListener`**

   - **åŠŸèƒ½**ï¼šç›‘å¬è¾“å…¥é€šé“çš„æ¶ˆæ¯ï¼Œè§¦å‘æŒ‡å®šæ–¹æ³•å¤„ç†æ¶ˆæ¯ã€‚

   - **åœºæ™¯**ï¼šæ›¿ä»£ä¼ ç»Ÿæ¶ˆæ¯ç›‘å¬å™¨ï¼Œç®€åŒ–æ¶ˆè´¹é€»è¾‘ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @StreamListener(Sink.INPUT)
     public void handleMessage(String payload) {
         System.out.println("Received: " + payload);
     }
     ```

2. **`@SendTo`**

   - **åŠŸèƒ½**ï¼šå°†æ–¹æ³•è¿”å›å€¼å‘é€åˆ°æŒ‡å®šè¾“å‡ºé€šé“ï¼Œå®ç°è¯·æ±‚-å“åº”æ¨¡å¼ã€‚

   - **åœºæ™¯**ï¼šæ¶ˆæ¯å¤„ç†åéœ€å›å¤ç»“æœæ—¶ä½¿ç”¨ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @StreamListener(Processor.INPUT)
     @SendTo(Processor.OUTPUT) // è¿”å›ç»“æœåˆ°è¾“å‡ºé€šé“
     public String process(String message) {
         return "Processed: " + message;
     }
     ```

------

### ğŸ”„ **ä¸‰ã€å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹æ³¨è§£ï¼ˆSpring Cloud Stream â‰¥2.0ï¼‰**

1. **`@Bean`+ å‡½æ•°å¼æ¥å£**

   - **åŠŸèƒ½**ï¼šé€šè¿‡å£°æ˜ `Supplier`ã€`Consumer`æˆ– `Function`ç±»å‹çš„ Bean æ›¿ä»£æ³¨è§£ç»‘å®šã€‚

   - **åœºæ™¯**ï¼šç®€åŒ–é…ç½®ï¼Œé¿å…æ˜¾å¼ä½¿ç”¨ `@EnableBinding`ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @Bean
     public Supplier<String> producer() { // è‡ªåŠ¨ç»‘å®šåˆ° output é€šé“
         return () -> "Hello";
     }
     
     @Bean
     public Consumer<String> consumer() { // è‡ªåŠ¨ç»‘å®šåˆ° input é€šé“
         return msg -> System.out.println(msg);
     }
     ```

2. **åŠ¨æ€å‘é€ï¼š`StreamBridge`**

   - **éæ³¨è§£**ï¼šåŠ¨æ€å‘é€æ¶ˆæ¯åˆ°ä»»æ„é€šé“ï¼Œæ— éœ€é¢„å®šä¹‰è¾“å‡ºæ¥å£ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @Autowired
     private StreamBridge streamBridge;
     
     public void sendNotification(String message) {
         streamBridge.send("notificationOutput", message); // é€šé“åéœ€åœ¨é…ç½®ä¸­å®šä¹‰
     }
     ```

------

### âš™ï¸ **å››ã€é«˜çº§é…ç½®æ³¨è§£**

1. **`@ServiceActivator`**

   - **åŠŸèƒ½**ï¼šé›†æˆ Spring Integrationï¼Œå¤„ç†é€šé“æ¶ˆæ¯å¹¶æ”¯æŒè‡ªå®šä¹‰é€»è¾‘ï¼ˆå¦‚é”™è¯¯å¤„ç†ï¼‰ã€‚

   - **åœºæ™¯**ï¼šéœ€ç²¾ç»†æ§åˆ¶æ¶ˆæ¯å¤„ç†æµç¨‹æ—¶ä½¿ç”¨ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @ServiceActivator(inputChannel = Sink.INPUT)
     public void handleError(Message<?> message) {
         // å¤„ç†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯
     }
     ```

2. **`@Binder`**

   - **åŠŸèƒ½**ï¼šä¸ºç‰¹å®šé€šé“æ˜¾å¼æŒ‡å®š Binder å®ç°ï¼ˆå¤šä¸­é—´ä»¶åœºæ™¯ï¼‰ã€‚

   - **åœºæ™¯**ï¼šåŠ¨æ€åˆ‡æ¢ä¸åŒä¸­é—´ä»¶å®ä¾‹ã€‚

   - **é…ç½®å…³è”**ï¼š

     ```
     spring:
       cloud:
         stream:
           bindings:
             orderOutput:
               binder: kafkaBinder1  # å¯¹åº” binders é…ç½®ä¸­çš„åç§°
     ```

------

### ğŸ’¡ **äº”ã€ä½¿ç”¨æŠ€å·§ä¸æ³¨æ„äº‹é¡¹**

1. **é€šé“å‘½åä¸€è‡´æ€§**
   - ä»£ç ä¸­çš„é€šé“åï¼ˆå¦‚ `@Input("orderInput")`ï¼‰å¿…é¡»ä¸é…ç½®ä¸­çš„ `bindings`é”®åï¼ˆ`orderInput-in-0`ï¼‰åŒ¹é…ã€‚
2. **æ–°æ—§æ¨¡å‹å…¼å®¹**
   - å‡½æ•°å¼æ¨¡å‹ï¼ˆ`Supplier`/`Consumer`ï¼‰ä¸æ³¨è§£æ¨¡å‹ï¼ˆ`@StreamListener`ï¼‰**ä¸å¯æ··ç”¨**ï¼Œéœ€ç»Ÿä¸€é£æ ¼ã€‚
3. **é…ç½®è¦†ç›–ä¼˜å…ˆçº§**
   - é€šé“çº§é…ç½®ï¼ˆ`bindings.<channelName>`ï¼‰ > å…¨å±€é»˜è®¤é…ç½®ï¼ˆ`default-binder`ï¼‰ã€‚

------

### ğŸ’ **æ€»ç»“ï¼šæ³¨è§£é€‰æ‹©å»ºè®®**

| **åœºæ™¯**             | **æ¨èæ³¨è§£**                                            |
| -------------------- | ------------------------------------------------------- |
| **ä¼ ç»Ÿç»‘å®š**         | `@EnableBinding`+ `@Input`/`@Output`+ `@StreamListener` |
| **ç®€åŒ–çš„å‡½æ•°å¼ç¼–ç¨‹** | `@Bean`+ `Supplier`/`Consumer`+ `StreamBridge`          |
| **åŠ¨æ€æ¶ˆæ¯å‘é€**     | `StreamBridge.send()`                                   |
| **å¤šä¸­é—´ä»¶ç®¡ç†**     | `@Binder`+ å¤š `binders`YAML é…ç½®                        |

> **è¿ç§»æç¤º**ï¼šæ–°é¡¹ç›®å»ºè®®ä½¿ç”¨å‡½æ•°å¼æ¨¡å‹ï¼ˆSpring Cloud Stream â‰¥3.0ï¼‰ï¼Œå‡å°‘æ ·æ¿ä»£ç ï¼›æ—§é¡¹ç›®å‡çº§æ—¶å¯é€æ­¥æ›¿æ¢ `@StreamListener`ã€‚

## StreamBridge Hybrid

åœ¨ Spring Cloud Stream ä¸­ï¼Œ`@Bean`+ `Supplier`/`Consumer`ä¸ `StreamBridge`çš„ç»“åˆä½¿ç”¨ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯**é¿å… `Supplier`çš„å®šæ—¶è§¦å‘æœºåˆ¶**ï¼Œæ”¹ä¸ºé€šè¿‡å¤–éƒ¨äº‹ä»¶ï¼ˆå¦‚ HTTP è¯·æ±‚ï¼‰åŠ¨æ€å‘é€æ¶ˆæ¯ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ–¹æ³•å’Œé…ç½®æ­¥éª¤ï¼š

------

### ğŸ”§ **ä¸€ã€æ ¸å¿ƒå®ç°é€»è¾‘**

#### **1. ä½¿ç”¨ `StreamBridge`æ›¿ä»£ `Supplier`çš„è‡ªåŠ¨è§¦å‘**

- **é—®é¢˜**ï¼š`Supplier<T>`é»˜è®¤ä¼šå®šæ—¶è§¦å‘ï¼ˆå‘½ä»¤å¼æ¨¡å¼æ¯ç§’ä¸€æ¬¡ï¼‰ï¼Œæ— æ³•æŒ‰éœ€å‘é€æ¶ˆæ¯ã€‚

- **è§£å†³æ–¹æ¡ˆ**ï¼šç”¨ `StreamBridge.send()`åŠ¨æ€å‘é€æ¶ˆæ¯ï¼Œæ— éœ€å®šä¹‰ `Supplier`Beanã€‚

- **ç¤ºä¾‹ä»£ç **ï¼š

  ```
  @RestController
  public class MessageController {
      @Autowired
      private StreamBridge streamBridge;  // æ³¨å…¥ StreamBridge
  
      @PostMapping("/send")
      public String sendMessage(@RequestBody String payload) {
          // åŠ¨æ€å‘é€åˆ°æŒ‡å®šé€šé“
          boolean success = streamBridge.send("order-out-0", payload); 
          return success ? "Sent!" : "Failed";
      }
  }
  ```

------

### âš™ï¸ **äºŒã€ä¿ç•™ `Consumer`çš„å£°æ˜å¼æ¶ˆè´¹**

#### **1. å®šä¹‰ `Consumer`å¤„ç†æ¶ˆæ¯**

- **ä½œç”¨**ï¼šç›‘å¬æ¶ˆæ¯å¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€è§¦å‘æœºåˆ¶ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @Configuration
  public class ConsumerConfig {
      @Bean
      public Consumer<String> orderConsumer() {
          return payload -> System.out.println("Received: " + payload);
      }
  }
  ```

#### **2. é…ç½®ç»‘å®šå…³ç³»**

```
spring:
  cloud:
    function:
      definition: orderConsumer  # æ¿€æ´» Consumer
    stream:
      bindings:
        orderConsumer-in-0:  # è¾“å…¥é€šé“åï¼ˆå‡½æ•°å + -in-0ï¼‰
          destination: orders-topic  # æ¶ˆæ¯ç›®æ ‡
          group: order-group         # æ¶ˆè´¹è€…ç»„ï¼ˆé˜²é‡å¤æ¶ˆè´¹ï¼‰
```

------

### ğŸ› ï¸ **ä¸‰ã€åŠ¨æ€å‘é€çš„å®Œæ•´æµç¨‹**

1. **å‘é€ç«¯**ï¼š

   - é€šè¿‡ `StreamBridge.send("channel-name", payload)`å‘é€æ¶ˆæ¯ã€‚
   - `channel-name`éœ€ä¸é…ç½®ä¸­çš„é€»è¾‘é€šé“åä¸€è‡´ï¼ˆå¦‚ `order-out-0`ï¼‰ã€‚

2. **é…ç½®åŠ¨æ€é€šé“**ï¼š

   ```
   spring:
     cloud:
       stream:
         bindings:
           # åŠ¨æ€å‘é€é€šé“ï¼ˆæ— éœ€æå‰å£°æ˜ Supplierï¼‰
           order-out-0:  
             destination: orders-topic  # å®é™…æ¶ˆæ¯ç›®æ ‡ï¼ˆKafka Topic/RabbitMQ Exchangeï¼‰
   ```

3. **æ¶ˆè´¹ç«¯**ï¼š

   - æ¶ˆæ¯è‡ªåŠ¨è·¯ç”±åˆ° `orderConsumer-in-0`é€šé“ï¼Œè§¦å‘ `orderConsumer`é€»è¾‘ã€‚

------

### âš ï¸ **å››ã€å…³é”®æ³¨æ„äº‹é¡¹**

1. **é¿å…åŠ¨æ€é€šé“å†…å­˜æº¢å‡º**

   é¢‘ç¹åŠ¨æ€åˆ›å»ºé€šé“å¯èƒ½å¯¼è‡´ OOMï¼Œéœ€é™åˆ¶ç¼“å­˜å¤§å°ï¼š

   ```
   spring:
     cloud:
       stream:
         dynamic-destination-cache-size: 10  # é™åˆ¶åŠ¨æ€é€šé“ç¼“å­˜æ•°é‡
   ```

2. **é€šé“å‘½åä¸€è‡´æ€§**

   `StreamBridge.send()`çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸é…ç½®ä¸­çš„ `bindings`é”®åä¸¥æ ¼åŒ¹é…ï¼ˆå¦‚ `order-out-0`ï¼‰ã€‚

3. **æ¶ˆæ¯åºåˆ—åŒ–æ§åˆ¶**

   é»˜è®¤ä½¿ç”¨ JSON åºåˆ—åŒ–ï¼Œå¯é€šè¿‡é…ç½®ä¿®æ”¹ï¼š

   ```
   spring:
     cloud:
       stream:
         bindings:
           order-out-0:
             content-type: application/avro  # æŒ‡å®šåºåˆ—åŒ–æ ¼å¼
   ```

4. **æ€§èƒ½ä¼˜åŒ–**

   - **å¼‚æ­¥å‘é€**ï¼š`StreamBridge`é»˜è®¤éé˜»å¡ï¼Œä½†é«˜å¹¶å‘æ—¶éœ€ç›‘æ§èƒŒå‹ã€‚
   - **äº‹åŠ¡æ”¯æŒ**ï¼šç»“åˆ `@Transactional`æˆ– Kafka äº‹åŠ¡ ID ä¿éšœç²¾ç¡®ä¸€æ¬¡å‘é€ ã€‚

------

### ğŸ’¡ **äº”ã€é€‚ç”¨åœºæ™¯**

- **HTTP è§¦å‘æ¶ˆæ¯**ï¼šå¦‚ç”¨æˆ·ä¸‹å•åå‘é€è®¢å•æ¶ˆæ¯ã€‚
- **äº‹ä»¶é©±åŠ¨**ï¼šæ•°æ®åº“å˜æ›´æ—¶è§¦å‘é€šçŸ¥ã€‚
- **æ¡ä»¶æ€§å‘é€**ï¼šæ ¹æ®ä¸šåŠ¡çŠ¶æ€é€‰æ‹©ä¸åŒé€šé“ï¼ˆå¦‚ `priority-out-0`æˆ– `normal-out-0`ï¼‰ã€‚

------

### ğŸ’ **æ€»ç»“**

- **å¼ƒç”¨ `Supplier`**ï¼šæ”¹ç”¨ `StreamBridge`å®ç°æŒ‰éœ€å‘é€ï¼Œé¿å…å®šæ—¶è§¦å‘ã€‚
- **ä¿ç•™ `Consumer`**ï¼šé€šè¿‡å£°æ˜å¼ Bean æ¶ˆè´¹æ¶ˆæ¯ã€‚
- **é…ç½®æ ¸å¿ƒç‚¹**ï¼š
  1. åŠ¨æ€é€šé“åï¼ˆå¦‚ `order-out-0`ï¼‰ä¸ `StreamBridge.send()`åŒ¹é…ã€‚
  2. æ¶ˆè´¹è€…ç»„ï¼ˆ`group`ï¼‰ä¿éšœæ¶ˆæ¯å¯é æ€§ã€‚
  3. é™åˆ¶åŠ¨æ€é€šé“ç¼“å­˜é˜²æº¢å‡ºã€‚

> **ä¼˜åŠ¿**ï¼šè§£è€¦æ¶ˆæ¯å‘é€ä¸ä¸šåŠ¡è§¦å‘ï¼Œå…¼é¡¾çµæ´»æ€§ä¸èµ„æºå¯æ§æ€§ã€‚é€šè¿‡æ­¤æ¨¡å¼ï¼Œå¯æ— ç¼é›†æˆ REST APIã€å®šæ—¶ä»»åŠ¡æˆ–äº‹ä»¶ç›‘å¬å™¨ä½œä¸ºæ¶ˆæ¯ç”Ÿäº§è€… ã€‚

## StreamBridge

StreamBridge æ˜¯ Spring Cloud Stream æ¡†æ¶ä¸­çš„æ ¸å¿ƒåŠ¨æ€æ¶ˆæ¯å‘é€ç»„ä»¶ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨ä¸é¢„å®šä¹‰ç»‘å®šé…ç½®çš„æƒ…å†µä¸‹ï¼Œ**çµæ´»ã€æŒ‰éœ€åœ°å‘æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆå¦‚ Kafkaã€RabbitMQï¼‰å‘é€æ¶ˆæ¯**ã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§å’Œä½¿ç”¨è¯¦è§£ï¼š

------

### ä¸€ã€æ ¸å¿ƒåŠŸèƒ½ä¸è®¾è®¡ç›®æ ‡

1. **åŠ¨æ€æ¶ˆæ¯å‘é€**
   - **æ— éœ€é¢„å£°æ˜ç»‘å®š**ï¼šä¼ ç»Ÿæ–¹å¼éœ€æå‰åœ¨é…ç½®ä¸­å®šä¹‰ `@Output`é€šé“ï¼Œè€Œ StreamBridge å¯åœ¨è¿è¡Œæ—¶åŠ¨æ€æŒ‡å®šç›®æ ‡é€šé“ï¼Œé€‚åˆæ¡ä»¶æ€§å‘é€ï¼ˆå¦‚æ ¹æ®ä¸šåŠ¡çŠ¶æ€é€‰æ‹©ä¸åŒ Topicï¼‰ã€‚
   - **ç®€åŒ–ä»£ç **ï¼šé¿å…ä¸ºæ¯ä¸ªå‘é€ç›®æ ‡åˆ›å»ºæ¥å£å’Œæ³¨è§£ï¼ˆå¦‚ `@EnableBinding`ï¼‰ï¼Œå‡å°‘æ ·æ¿ä»£ç ã€‚
2. **ç»Ÿä¸€ç¼–ç¨‹æ¨¡å‹**
   - **åè®®æ— å…³æ€§**ï¼šé€šè¿‡ Binder æŠ½è±¡å±‚ï¼ŒåŒä¸€å¥— API æ”¯æŒ Kafkaã€RabbitMQ ç­‰ä¸­é—´ä»¶ï¼Œåˆ‡æ¢æ—¶æ— éœ€ä¿®æ”¹å‘é€é€»è¾‘ã€‚
   - **è‡ªåŠ¨åºåˆ—åŒ–**ï¼šæ”¯æŒå¯¹è±¡ã€å­—ç¬¦ä¸²ç­‰è´Ÿè½½ç±»å‹ï¼Œé»˜è®¤ä½¿ç”¨ JSON åºåˆ—åŒ–ï¼ˆå¯é…ç½®ä¸º Avroã€æ–‡æœ¬ç­‰ï¼‰ã€‚

------

### äºŒã€åŸºæœ¬ä½¿ç”¨æ–¹å¼

#### **1. ä¾èµ–æ³¨å…¥ä¸åŸºç¡€å‘é€**

```
@Autowired
private StreamBridge streamBridge;  // æ³¨å…¥ç»„ä»¶

// å‘é€ç®€å•æ¶ˆæ¯
public void sendNotification(String payload) {
    boolean success = streamBridge.send("notification-topic", payload);
    if (!success) {
        log.error("æ¶ˆæ¯å‘é€å¤±è´¥");  // å¤±è´¥å¤„ç†é€»è¾‘
    }
}
```

- **å‚æ•°è¯´æ˜**ï¼š
  - `topic`ï¼šé€»è¾‘é€šé“åï¼ˆå¦‚ `"notification-topic"`ï¼‰ï¼Œéœ€åœ¨é…ç½®ä¸­ç»‘å®šå®é™…ä¸­é—´ä»¶ç›®æ ‡ã€‚
  - `message`ï¼šæ¶ˆæ¯è´Ÿè½½ï¼Œæ”¯æŒä»»æ„å¯¹è±¡ï¼ˆå¦‚ `String`ã€`Order`å®ä½“ï¼‰ã€‚

#### **2. åŠ¨æ€é€šé“é…ç½®**

åœ¨ `application.yml`ä¸­ç»‘å®šé€»è¾‘é€šé“ä¸ç‰©ç†ç›®æ ‡ï¼š

```
spring:
  cloud:
    stream:
      bindings:
        notification-topic:  # é€»è¾‘é€šé“å
          destination: orders-exchange  # RabbitMQ Exchange æˆ– Kafka Topic
          binder: rabbit-binder          # æŒ‡å®š Binder
      binders:
        rabbit-binder:
          type: rabbit                   # ä¸­é—´ä»¶ç±»å‹
          environment: 
            spring.rabbitmq.host: localhost
```

> **æ³¨**ï¼šæœªé…ç½®çš„é€šé“åé¦–æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œä½†éœ€é˜²èŒƒå†…å­˜æº¢å‡ºï¼ˆé€šè¿‡ `spring.cloud.stream.dynamic-destination-cache-size`é™åˆ¶ç¼“å­˜æ•°é‡ï¼‰ã€‚

------

### ä¸‰ã€é«˜çº§åº”ç”¨æŠ€å·§

#### **1. è‡ªå®šä¹‰æ¶ˆæ¯å¤´**

é€šè¿‡ `MessageBuilder`æ·»åŠ æ¶ˆæ¯å¤´ï¼ˆå¦‚ä¼˜å…ˆçº§ã€å»¶è¿Ÿæ ‡è®°ï¼‰ï¼š

```
Message<String> message = MessageBuilder
    .withPayload("ç´§æ€¥è®¢å•")
    .setHeader("priority", "high")
    .setHeader("x-delay", 5000)  // RabbitMQ å»¶è¿Ÿæ¶ˆæ¯ï¼ˆæ¯«ç§’ï¼‰
    .build();
streamBridge.send("order-topic", message);
```

> **é€‚ç”¨åœºæ™¯**ï¼šæ¶ˆæ¯è·¯ç”±ã€å»¶è¿ŸæŠ•é€’ã€æ­»ä¿¡æ§åˆ¶ç­‰ã€‚

#### **2. å¤šç§Ÿæˆ·ä¸åŠ¨æ€è·¯ç”±**

æ ¹æ®ä¸šåŠ¡å‚æ•°åŠ¨æ€é€‰æ‹©ç›®æ ‡ï¼š

```
public void sendByTenant(String tenantId, Order order) {
    String topic = "orders-" + tenantId;  // åŠ¨æ€é€šé“å
    streamBridge.send(topic, order);
}
```

- **é…ç½®å…³è”**ï¼š

  ```
  spring.cloud.stream.bindings.orders-${tenantId}.destination: orders-${tenantId}
  ```

> **ä¼˜åŠ¿**ï¼šæ— éœ€ä¸ºæ¯ä¸ªç§Ÿæˆ·å•ç‹¬ç¼–ç ï¼Œé…ç½®é©±åŠ¨ã€‚

#### **3. æ‹¦æˆªå™¨é›†æˆ**

å®ç° `ChannelInterceptor`æ‹¦æˆªæ¶ˆæ¯å‘é€è¿‡ç¨‹ï¼š

```
@Component
@GlobalChannelInterceptor(patterns = "*")  // æ‹¦æˆªæ‰€æœ‰é€šé“
public class LoggingInterceptor implements ChannelInterceptor {
    @Override
    public Message<?> preSend(Message<?> message, MessageChannel channel) {
        log.info("å‘é€æ¶ˆæ¯å¤´: {}", message.getHeaders());
        return message;
    }
}
```

> **ç”¨é€”**ï¼šæ—¥å¿—å®¡è®¡ã€æ¶ˆæ¯åŠ å¯†ã€æµé‡ç›‘æ§ã€‚

------

### å››ã€æ€§èƒ½ä¸å¯é æ€§ä¿éšœ

1. **å¼‚æ­¥ä¸éé˜»å¡**
   - é»˜è®¤å¼‚æ­¥å‘é€ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œé«˜å¹¶å‘æ—¶éœ€ç›‘æ§èƒŒå‹ï¼ˆå¦‚ RabbitMQ çš„ `publisher-confirms`ï¼‰ã€‚
2. **äº‹åŠ¡æ”¯æŒ**
   - **æœ¬åœ°äº‹åŠ¡**ï¼šç»“åˆ `@Transactional`ç¡®ä¿æ•°æ®åº“æ“ä½œä¸æ¶ˆæ¯å‘é€åŸå­æ€§ã€‚
   - **Kafka äº‹åŠ¡**ï¼šé…ç½® `spring.kafka.producer.transaction-id-prefix`å®ç°ç²¾ç¡®ä¸€æ¬¡æŠ•é€’ã€‚
3. **å¤±è´¥å¤„ç†**
   - **è¿”å›å€¼æ£€æŸ¥**ï¼š`send()`è¿”å› `false`æ—¶éœ€é‡è¯•æˆ–è®°å½•æ­»ä¿¡é˜Ÿåˆ—ã€‚
   - **é‡è¯•æœºåˆ¶**ï¼šé€šè¿‡ä¸­é—´ä»¶é‡è¯•ï¼ˆå¦‚ Kafka çš„ `retries`ï¼‰æˆ–åº”ç”¨å±‚é‡è¯•ï¼ˆå¦‚ Spring Retryï¼‰ã€‚

------

### äº”ã€å…¸å‹åº”ç”¨åœºæ™¯

| **åœºæ™¯**          | **å®ç°æ–¹å¼**                                                 |
| ----------------- | ------------------------------------------------------------ |
| **HTTP è§¦å‘æ¶ˆæ¯** | REST æ¥å£ä¸­è°ƒç”¨ `streamBridge.send()`ã€‚                      |
| **å®šæ—¶ä»»åŠ¡å‘é€**  | åœ¨ `@Scheduled`æ–¹æ³•ä¸­åŠ¨æ€å‘é€ï¼ˆæ›¿ä»£ `Supplier`çš„å›ºå®šè½®è¯¢ï¼‰ã€‚ |
| **äº‹ä»¶é©±åŠ¨æ¶æ„**  | æ•°æ®åº“å˜æ›´ç›‘å¬ï¼ˆå¦‚ `EntityListener`ï¼‰è§¦å‘æ¶ˆæ¯é€šçŸ¥ã€‚          |
| **å¤šæ­¥éª¤æµç¨‹**    | ç»„åˆå¤šä¸ªé€šé“å‘é€ï¼ˆå¦‚è®¢å•åˆ›å»º â†’ åº“å­˜æ‰£å‡ â†’ æ”¯ä»˜é€šçŸ¥ï¼‰ã€‚       |

------

### å…­ã€ä¸ä¼ ç»Ÿæ–¹å¼çš„å¯¹æ¯”

| **ç‰¹æ€§**       | **ä¼ ç»Ÿæ³¨è§£æ¨¡å‹ï¼ˆ@Outputï¼‰**   | **StreamBridge**                     |
| -------------- | ----------------------------- | ------------------------------------ |
| **ç»‘å®šçµæ´»æ€§** | éœ€é¢„å®šä¹‰é€šé“æ¥å£              | åŠ¨æ€æŒ‡å®šé€šé“åï¼Œæ— éœ€é¢„å£°æ˜           |
| **ä»£ç å…¥ä¾µæ€§** | éœ€ `@EnableBinding`å’Œé€šé“æ¥å£ | æ— ä¾µå…¥ï¼Œç›´æ¥æ³¨å…¥ä½¿ç”¨                 |
| **å¤šç›®æ ‡æ”¯æŒ** | æ¯ä¸ªé€šé“éœ€ç‹¬ç«‹æ¥å£            | å•ç»„ä»¶æ”¯æŒä»»æ„é€šé“                   |
| **é€‚ç”¨åœºæ™¯**   | å›ºå®šç›®æ ‡ã€ç»“æ„ç®€å•åœºæ™¯        | åŠ¨æ€è·¯ç”±ã€æ¡ä»¶å‘é€ã€å¤šç§Ÿæˆ·ç­‰å¤æ‚åœºæ™¯ |

> **æ€»ç»“**ï¼š
>
> StreamBridge çš„æ ¸å¿ƒä»·å€¼åœ¨äº**è§£è€¦æ¶ˆæ¯å‘é€ä¸ä¸šåŠ¡é€»è¾‘**ï¼Œé€šè¿‡åŠ¨æ€é€šé“å’Œç®€åŒ– API å®ç°çµæ´»çš„æ¶ˆæ¯æŠ•é€’ã€‚ä½¿ç”¨æ—¶éœ€æ³¨æ„ï¼š
>
> - **é€šé“å‘½åè§„èŒƒ**ï¼ˆå¦‚ä¸šåŠ¡è¯­ä¹‰åŒ–ï¼‰ï¼Œé¿å…æ··ä¹±ï¼›
>
> - **æ€§èƒ½ä¼˜åŒ–**ï¼šé™åˆ¶åŠ¨æ€é€šé“ç¼“å­˜ã€å¯ç”¨ä¸­é—´ä»¶äº‹åŠ¡ï¼›
>
> - **é”™è¯¯å…œåº•**ï¼šåŠ¡å¿…æ£€æŸ¥è¿”å›å€¼å¹¶è®¾è®¡é‡è¯•æœºåˆ¶ã€‚
>
>   åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå®ƒå·²æˆä¸ºå¼‚æ­¥é€šä¿¡ã€äº‹ä»¶é©±åŠ¨å’Œå®æ—¶æ•°æ®ç®¡é“çš„é¦–é€‰å·¥å…·ã€‚

## å››æ³¨è§£

åœ¨ Spring Cloud Stream ä¸­ï¼Œ`@Input`ã€`@Output`ã€`@StreamListener`å’Œ `@SendTo`æ˜¯æ ¸å¿ƒæ³¨è§£ï¼Œåˆ†åˆ«æ‰¿æ‹…**é€šé“å£°æ˜**ä¸**æ¶ˆæ¯å¤„ç†**ä¸¤ç±»è§’è‰²ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„åŒºåˆ«ä¸å…³è”ï¼š

------

### **1. `@Input`ä¸ `@Output`ï¼ˆé€šé“å£°æ˜ï¼‰**

- **ä½œç”¨**ï¼šå£°æ˜æ¶ˆæ¯é€šé“ï¼ˆChannelï¼‰ï¼Œå®šä¹‰æ¶ˆæ¯å…¥å£ï¼ˆæ¶ˆè´¹ï¼‰å’Œå‡ºå£ï¼ˆç”Ÿäº§ï¼‰ã€‚

- **ä½¿ç”¨åœºæ™¯**ï¼š

  - `@Input`ï¼šæ ‡è®°åœ¨æ¥å£æ–¹æ³•ä¸Šï¼Œå®šä¹‰**è¾“å…¥é€šé“**ï¼ˆå¦‚ `SubscribableChannel`ï¼‰ï¼Œç”¨äºæ¥æ”¶æ¶ˆæ¯ã€‚
  - `@Output`ï¼šæ ‡è®°åœ¨æ¥å£æ–¹æ³•ä¸Šï¼Œå®šä¹‰**è¾“å‡ºé€šé“**ï¼ˆå¦‚ `MessageChannel`ï¼‰ï¼Œç”¨äºå‘é€æ¶ˆæ¯ã€‚

- **é…ç½®æ–¹å¼**ï¼šéœ€é…åˆ `@EnableBinding`æ¿€æ´»é€šé“æ¥å£ã€‚

  ```
  public interface CustomChannels {
      @Input("orderInput")  // å£°æ˜è¾“å…¥é€šé“
      SubscribableChannel orderInput();
  
      @Output("notificationOutput")  // å£°æ˜è¾“å‡ºé€šé“
      MessageChannel notificationOutput();
  }
  
  @EnableBinding(CustomChannels.class)  // æ¿€æ´»é€šé“
  public class AppConfig { ... }
  ```

- **æœ¬è´¨**ï¼šåœ¨ Spring å®¹å™¨ä¸­æ³¨å†Œé€šé“ Beanï¼Œä¾›åç»­ç»‘å®šæ¶ˆæ¯ä¸­é—´ä»¶ã€‚

------

### **2. `@StreamListener`ï¼ˆæ¶ˆæ¯æ¶ˆè´¹ï¼‰**

- **ä½œç”¨**ï¼šæ ‡è®°æ¶ˆæ¯å¤„ç†æ–¹æ³•ï¼Œç›‘å¬è¾“å…¥é€šé“çš„æ¶ˆæ¯å¹¶è§¦å‘ä¸šåŠ¡é€»è¾‘ã€‚

- **ç‰¹æ€§**ï¼š

  - æ”¯æŒ **SpEL æ¡ä»¶è¿‡æ»¤**ï¼ˆ`condition`å±æ€§ï¼‰ã€‚
  - è‡ªåŠ¨å¤„ç†æ¶ˆæ¯ååºåˆ—åŒ–ï¼ˆå¦‚ JSON â†’ å¯¹è±¡ï¼‰ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @StreamListener(target = CustomChannels.ORDER_INPUT, condition = "headers['type']=='urgent'")
  public void handleUrgentOrder(Order order) {
      // å¤„ç†ç´§æ€¥è®¢å•
  }
  ```

- **é™åˆ¶**ï¼š

  - ä»…æ”¯æŒ**æ— è¿”å›å€¼**æ–¹æ³•ï¼ˆè‹¥æœ‰è¿”å›å€¼éœ€ç”¨ `@SendTo`ï¼‰ã€‚
  - æ–°ç‰ˆæœ¬æ¨èä½¿ç”¨å‡½æ•°å¼æ¨¡å‹ï¼ˆ`Consumer`ï¼‰æ›¿ä»£ã€‚

------

### **3. `@SendTo`ï¼ˆæ¶ˆæ¯ç”Ÿäº§ï¼‰**

- **ä½œç”¨**ï¼šå°†æ–¹æ³•è¿”å›å€¼å‘é€åˆ°æŒ‡å®šè¾“å‡ºé€šé“ï¼Œå®ç°**è¯·æ±‚-å“åº”**æ¨¡å¼ã€‚

- **ä¾èµ–**ï¼šå¿…é¡»ä¸ `@StreamListener`æ­é…ä½¿ç”¨ã€‚

- **ç¤ºä¾‹**ï¼š

  ```
  @StreamListener(Processor.INPUT)
  @SendTo(Processor.OUTPUT)  // è¿”å›å€¼å‘é€åˆ° OUTPUT é€šé“
  public String process(String msg) {
      return "Processed: " + msg;
  }
  ```

- **æœ¬è´¨**ï¼šå°†æ–¹æ³•è¿”å›å€¼å°è£…ä¸ºæ¶ˆæ¯ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°ç›®æ ‡é€šé“ã€‚

------

### **å››è€…å¯¹æ¯”æ€»ç»“**

| **æ³¨è§£**          | **ç±»åˆ«** | **ä½œç”¨**               | **ä¾èµ–å…³ç³»**             | **å…¸å‹ä½¿ç”¨åœºæ™¯**        |
| ----------------- | -------- | ---------------------- | ------------------------ | ----------------------- |
| `@Input`          | é€šé“å£°æ˜ | å®šä¹‰è¾“å…¥é€šé“           | éœ€ `@EnableBinding`      | å£°æ˜æ¶ˆæ¯å…¥å£            |
| `@Output`         | é€šé“å£°æ˜ | å®šä¹‰è¾“å‡ºé€šé“           | éœ€ `@EnableBinding`      | å£°æ˜æ¶ˆæ¯å‡ºå£            |
| `@StreamListener` | æ¶ˆæ¯å¤„ç† | ç›‘å¬å¹¶å¤„ç†è¾“å…¥é€šé“æ¶ˆæ¯ | éœ€å·²å£°æ˜ `@Input`é€šé“    | æ¶ˆè´¹æ¶ˆæ¯ã€æ¡ä»¶è¿‡æ»¤      |
| `@SendTo`         | æ¶ˆæ¯å¤„ç† | å°†è¿”å›å€¼å‘é€åˆ°è¾“å‡ºé€šé“ | éœ€é…åˆ `@StreamListener` | è¯·æ±‚-å“åº”æ¨¡å¼çš„æ¶ˆæ¯å›å¤ |

------

### **å…³é”®å·®å¼‚è¯´æ˜**

1. **å£°æ˜ vs è¿è¡Œæ—¶**ï¼š
   - `@Input`/`@Output`**å£°æ˜é€šé“**ï¼ˆé™æ€é…ç½®ï¼‰ï¼Œè€Œ `@StreamListener`/`@SendTo`**å¤„ç†æ¶ˆæ¯**ï¼ˆåŠ¨æ€é€»è¾‘ï¼‰ã€‚
2. **æ¡ä»¶è¿‡æ»¤èƒ½åŠ›**ï¼š
   - ä»… `@StreamListener`æ”¯æŒ `condition`å®ç°æ¶ˆæ¯åŠ¨æ€è·¯ç”±ï¼ˆå¦‚æŒ‰æ¶ˆæ¯å¤´åˆ†æµï¼‰ã€‚
3. **è¿”å›å€¼å¤„ç†**ï¼š
   - `@SendTo`æ˜¯å”¯ä¸€æ”¯æŒ**è¿”å›æ•°æ®åˆ°é€šé“**çš„æ³¨è§£ï¼Œä¾èµ–æ–¹æ³•è¿”å›å€¼ã€‚
4. **ç‰ˆæœ¬æ¼”è¿›**ï¼š
   - Spring Cloud Stream â‰¥3.x æ¨èå‡½æ•°å¼æ¨¡å‹ï¼ˆ`Supplier`/`Function`/`Consumer`ï¼‰ï¼Œé€æ­¥æ›¿ä»£ `@StreamListener`å’Œ `@SendTo`ã€‚

------

### **å…¸å‹å·¥ä½œæµç¤ºä¾‹**

```
@EnableBinding(Processor.class)  // å£°æ˜é€šé“
public class MessageService {

    // ç›‘å¬è¾“å…¥é€šé“ï¼Œæ¡ä»¶è¿‡æ»¤
    @StreamListener(
        target = Processor.INPUT, 
        condition = "headers['priority']=='high'"
    )
    @SendTo(Processor.OUTPUT)  // è¿”å›ç»“æœåˆ°è¾“å‡ºé€šé“
    public String handleHighPriority(String msg) {
        return "URGENT: " + msg;
    }
}
```

- **æµç¨‹**ï¼š

  è¾“å…¥æ¶ˆæ¯ â†’ `@StreamListener`æ¡ä»¶è¿‡æ»¤ â†’ å¤„ç†é€»è¾‘ â†’ `@SendTo`è¿”å›ç»“æœ â†’ è¾“å‡ºé€šé“ã€‚

é€šè¿‡åˆç†ç»„åˆè¿™äº›æ³¨è§£ï¼Œå¯å®ç°çµæ´»çš„æ¶ˆæ¯è·¯ç”±ã€è¿‡æ»¤ä¸å“åº”æœºåˆ¶ï¼Œä½†æ–°é¡¹ç›®å»ºè®®ä¼˜å…ˆé‡‡ç”¨å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ç®€åŒ–ä»£ç ã€‚

## @SendTo

åœ¨ Spring Cloud Stream ä¸­ï¼Œ`@SendTo`å¿…é¡»é…åˆ `@StreamListener`ä½¿ç”¨ï¼Œ**ä¸èƒ½å•ç‹¬ä½¿ç”¨**ã€‚è¿™ç§è®¾è®¡æ˜¯ç”±ä¸¤è€…çš„åŠŸèƒ½å®šä½å’Œæ¡†æ¶çš„æ¶ˆæ¯å¤„ç†æœºåˆ¶å…±åŒå†³å®šçš„ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†è§£æï¼š

------

### **ä¸€ã€æ³¨è§£èŒè´£ä¸åä½œåŸç†**

1. **`@StreamListener`çš„æ ¸å¿ƒä½œç”¨**

   - **æ¶ˆæ¯æ¶ˆè´¹å…¥å£**ï¼šæ ‡è®°ä¸€ä¸ªæ–¹æ³•ä½œä¸ºæ¶ˆæ¯ç›‘å¬å™¨ï¼Œå£°æ˜è¯¥æ–¹æ³•è´Ÿè´£å¤„ç†æ¥è‡ªæŒ‡å®šè¾“å…¥é€šé“çš„æ¶ˆæ¯ã€‚
   - **è§¦å‘æ‰§è¡Œ**ï¼šå½“æ¶ˆæ¯åˆ°è¾¾ç»‘å®šçš„è¾“å…¥é€šé“æ—¶ï¼Œæ¡†æ¶è‡ªåŠ¨è°ƒç”¨è¢«æ³¨è§£çš„æ–¹æ³•ã€‚
   - **ä¸Šä¸‹æ–‡æä¾›**ï¼šä¸º `@SendTo`æä¾›æ–¹æ³•æ‰§è¡Œçš„è¿”å›å€¼ä½œä¸ºå‘é€æ¶ˆæ¯çš„æ¥æºã€‚

2. **`@SendTo`çš„ä¾èµ–å‰æ**

   - **è¿”å›å€¼è·¯ç”±**ï¼š`@SendTo`çš„ä½œç”¨æ˜¯å°†æ–¹æ³•çš„**è¿”å›å€¼**å‘é€åˆ°æŒ‡å®šçš„è¾“å‡ºé€šé“ã€‚

   - **æ— ç‹¬ç«‹è§¦å‘èƒ½åŠ›**ï¼šå®ƒä¸ç›‘å¬æ¶ˆæ¯ã€ä¸ä¸»åŠ¨æ‰§è¡Œé€»è¾‘ï¼Œä»…ä¾èµ–æ–¹æ³•çš„è¿”å›å€¼ä½œä¸ºæ•°æ®æºã€‚

   - **æ¡†æ¶åä½œé€»è¾‘**ï¼š

     ```
     @StreamListener(Processor.INPUT)  // 1. ç›‘å¬è¾“å…¥é€šé“
     @SendTo(Processor.OUTPUT)         // 2. å°†è¿”å›å€¼è·¯ç”±åˆ°è¾“å‡ºé€šé“
     public String process(String msg) {
         return "Processed: " + msg;    // 3. è¿”å›å€¼æˆä¸ºè¾“å‡ºæ¶ˆæ¯
     }
     ```

     è‹¥ç¼ºå°‘ `@StreamListener`ï¼Œæ¡†æ¶æ— æ³•è¯†åˆ«ä½•æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¹Ÿæ— æ³•è·å–è¿”å›å€¼ã€‚

------

### **äºŒã€å•ç‹¬ä½¿ç”¨ `@SendTo`ä¸ºä½•æ— æ•ˆï¼Ÿ**

1. **ç¼ºå°‘æ‰§è¡Œä¸Šä¸‹æ–‡**
   - `@SendTo`ä»…å®šä¹‰**æ¶ˆæ¯è·¯ç”±è§„åˆ™**ï¼ˆå³â€œå‘é€åˆ°å“ªé‡Œâ€ï¼‰ï¼Œä½†æœªå®šä¹‰**ä½•æ—¶å‘é€**æˆ–**å‘é€ä»€ä¹ˆæ•°æ®**ã€‚
   - æ²¡æœ‰ `@StreamListener`æä¾›çš„æ–¹æ³•æ‰§è¡Œï¼Œè¿”å›å€¼æ— ä»äº§ç”Ÿï¼Œè·¯ç”±è§„åˆ™æ— æ³•ç”Ÿæ•ˆã€‚
2. **æ¡†æ¶çš„è¿è¡Œæ—¶è¡Œä¸º**
   - Spring Cloud Stream é€šè¿‡ `@StreamListener`å°†æ–¹æ³•æ³¨å†Œä¸ºæ¶ˆæ¯ç›‘å¬å™¨ï¼Œé›†æˆåˆ°æ¶ˆæ¯å¤„ç†ç®¡é“ä¸­ã€‚
   - `@SendTo`ä½œä¸ºè¯¥ç®¡é“çš„**åç»­ç¯èŠ‚**ï¼Œä¾èµ–å‰åºç¯èŠ‚ï¼ˆæ¶ˆæ¯æ¶ˆè´¹+è¿”å›å€¼ç”Ÿæˆï¼‰çš„è¾“å‡ºã€‚

------

### **ä¸‰ã€æ›¿ä»£æ–¹æ¡ˆï¼šæ— éœ€ `@StreamListener`çš„æ¶ˆæ¯å‘é€æ–¹å¼**

è‹¥éœ€ç‹¬ç«‹å‘é€æ¶ˆæ¯ï¼ˆä¸ä¾èµ–ç›‘å¬å™¨è¿”å›å€¼ï¼‰ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ›¿ä»£ `@SendTo`ï¼š

1. **`StreamBridge`åŠ¨æ€å‘é€**

   ç›´æ¥æ³¨å…¥ `StreamBridge`åŠ¨æ€å‘é€æ¶ˆæ¯åˆ°ä»»æ„é€šé“ï¼Œæ— éœ€é¢„å®šä¹‰è¾“å‡ºæ¥å£ï¼š

   ```
   @Autowired
   private StreamBridge streamBridge;
   
   public void sendMessage(String payload) {
       streamBridge.send("notificationOutput", payload); // é€šé“åéœ€åœ¨é…ç½®ä¸­å®šä¹‰
   }
   ```

   é…ç½®ç¤ºä¾‹ï¼š

   ```
   spring.cloud.stream.bindings.notificationOutput.destination: orders-topic
   ```

2. **é¢„å£°æ˜è¾“å‡ºé€šé“**

   é€šè¿‡ `@Output`å®šä¹‰é€šé“å¹¶æ‰‹åŠ¨å‘é€ï¼š

   ```
   public interface CustomChannels {
       @Output("notificationOutput")
       MessageChannel notificationChannel();
   }
   
   @Autowired
   private CustomChannels channels;
   
   public void send(String payload) {
       channels.notificationChannel().send(MessageBuilder.withPayload(payload).build());
   }
   ```

------

### **å››ã€æ³¨è§£åŠŸèƒ½å¯¹æ¯”**

| **æ³¨è§£**          | **ä¾èµ–**                   | **ä½œç”¨**                   | **é€‚ç”¨åœºæ™¯**                   |
| ----------------- | -------------------------- | -------------------------- | ------------------------------ |
| `@StreamListener` | æ— ï¼ˆå¯ç‹¬ç«‹ä½¿ç”¨ï¼‰           | ç›‘å¬æ¶ˆæ¯å¹¶è§¦å‘æ–¹æ³•æ‰§è¡Œ     | æ¶ˆè´¹æ¶ˆæ¯ã€æ‰§è¡Œä¸šåŠ¡é€»è¾‘         |
| `@SendTo`         | å¿…é¡»é…åˆ `@StreamListener` | å°†æ–¹æ³•è¿”å›å€¼å‘é€åˆ°è¾“å‡ºé€šé“ | è¯·æ±‚-å“åº”æ¨¡å¼çš„æ¶ˆæ¯å›å¤        |
| `StreamBridge`    | æ— ï¼ˆå¯ç‹¬ç«‹ä½¿ç”¨ï¼‰           | åŠ¨æ€å‘é€æ¶ˆæ¯åˆ°ä»»æ„é€šé“     | æ¡ä»¶æ€§å‘é€ã€éè¿”å›å€¼è§¦å‘çš„åœºæ™¯ |

------

### **äº”ã€æ€»ç»“**

- **å¼ºä¾èµ–å…³ç³»**ï¼š`@SendTo`æœ¬è´¨æ˜¯ `@StreamListener`çš„**æ‰©å±•å¢å¼º**ï¼Œé€šè¿‡æ–¹æ³•è¿”å›å€¼å®ç°è½»é‡çº§å“åº”å¼æ¶ˆæ¯æµï¼Œä¸¤è€…å…±åŒæ„æˆâ€œ**æ¶ˆè´¹-å¤„ç†-å“åº”**â€é—­ç¯ã€‚
- **è®¾è®¡æ„å›¾**ï¼šè¿™ç§è®¾è®¡ç¡®ä¿æ¶ˆæ¯ç”Ÿäº§è¡Œä¸ºç´§å¯†ç»‘å®šåˆ°æ¶ˆè´¹é€»è¾‘ä¸­ï¼Œé¿å…æ— æ¥æºçš„å‘é€åŠ¨ä½œï¼Œç¬¦åˆç®¡é“å¼å¤„ç†çš„æ€æƒ³ã€‚
- **çµæ´»æ›¿ä»£**ï¼šè‹¥éœ€è§£è€¦å‘é€åŠ¨ä½œï¼Œä¼˜å…ˆé€‰æ‹© `StreamBridge`æˆ–é¢„å®šä¹‰é€šé“çš„æ‰‹åŠ¨å‘é€æ–¹å¼ï¼Œè€Œéå¼ºåˆ¶ç»„åˆæ³¨è§£ã€‚

## åä½œ

Spring Cloud Stream ä¸­çš„ `@Input`/`@Output`å’Œ `@StreamListener`/`@SendTo`å¹¶éä¸åŒç‰ˆæœ¬æ¨å‡ºçš„ç‹¬ç«‹æ³¨è§£ç»„åˆï¼Œè€Œæ˜¯**åŒä¸€æ—¶æœŸï¼ˆæ—©æœŸç‰ˆæœ¬ï¼‰ååŒå·¥ä½œçš„æ³¨è§£**ï¼Œå…±åŒæ„å»ºäº†æ³¨è§£é©±åŠ¨çš„ç¼–ç¨‹æ¨¡å‹ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£æï¼š

------

### **ä¸€ã€æ³¨è§£çš„å®šä½ä¸åä½œå…³ç³»**

1. **`@Input`å’Œ `@Output`ï¼ˆé€šé“å£°æ˜å±‚ï¼‰**

   - **ä½œç”¨**ï¼šå®šä¹‰æ¶ˆæ¯é€šé“çš„æŠ½è±¡æ¥å£ï¼Œæ ‡è¯†æ¶ˆæ¯çš„å…¥å£ï¼ˆè¾“å…¥é€šé“ï¼‰å’Œå‡ºå£ï¼ˆè¾“å‡ºé€šé“ï¼‰ã€‚

   - **ä½¿ç”¨åœºæ™¯**ï¼š

     - å£°æ˜é€šé“æ¥å£ï¼ˆå¦‚ `Source`ã€`Sink`æˆ–è‡ªå®šä¹‰æ¥å£ï¼‰ï¼Œé€šè¿‡ `@EnableBinding`æ¿€æ´»ç»‘å®šã€‚

     - ä¾‹å¦‚ï¼š

       ```
       public interface CustomChannel {
           @Input("orderInput")
           SubscribableChannel input();
           @Output("notificationOutput")
           MessageChannel output();
       }
       ```

   - **æœ¬è´¨**ï¼šåœ¨ Spring å®¹å™¨ä¸­æ³¨å†Œé€šé“ Beanï¼Œè¿æ¥ä¸šåŠ¡ä»£ç ä¸æ¶ˆæ¯ä¸­é—´ä»¶ã€‚

2. **`@StreamListener`å’Œ `@SendTo`ï¼ˆæ¶ˆæ¯å¤„ç†å±‚ï¼‰**

   - **ä½œç”¨**ï¼š

     - `@StreamListener`ï¼šç›‘å¬è¾“å…¥é€šé“çš„æ¶ˆæ¯ï¼Œè§¦å‘æ¶ˆè´¹é€»è¾‘ã€‚
     - `@SendTo`ï¼šå°†æ–¹æ³•è¿”å›å€¼è·¯ç”±åˆ°è¾“å‡ºé€šé“ï¼ˆéœ€é…åˆ `@StreamListener`ä½¿ç”¨ï¼‰ã€‚

   - **ä¾èµ–å…³ç³»**ï¼š

     - `@StreamListener`ä¾èµ– `@Input`å®šä¹‰çš„é€šé“ï¼ˆå¦‚ `Sink.INPUT`ï¼‰ã€‚
     - `@SendTo`ä¾èµ– `@Output`å®šä¹‰çš„é€šé“ï¼ˆå¦‚ `Source.OUTPUT`ï¼‰ã€‚

   - **ç¤ºä¾‹**ï¼š

     ```
     @StreamListener(Sink.INPUT)
     @SendTo(Source.OUTPUT)
     public String process(String payload) {
         return payload.toUpperCase();
     }
     ```

------

### **äºŒã€ç‰ˆæœ¬æ¼”è¿›ä¸å¼ƒç”¨**

1. **æ—©æœŸç‰ˆæœ¬ï¼ˆV2-V3.0ï¼‰çš„å®Œæ•´å·¥ä½œæµ**

   - **é€šé“å£°æ˜**ï¼š`@Input`+ `@Output`+ `@EnableBinding`

   - **æ¶ˆæ¯å¤„ç†**ï¼š`@StreamListener`+ `@SendTo`

   - **åä½œæµç¨‹**ï¼š

     ```
     graph LR
     A[é€šé“å£°æ˜] --> B[æ¶ˆæ¯ç›‘å¬]
     B --> C[å¤„ç†æ¶ˆæ¯]
     C --> D[å‘é€å“åº”]
     ```

     è¿™ä¸€ç»„åˆåœ¨ Spring Cloud Stream V2 è‡³ V3.0 æ˜¯ä¸»æµæ–¹æ¡ˆã€‚

2. **V3.1+ ç‰ˆæœ¬çš„å˜é©**

   - **å¼ƒç”¨æ³¨è§£æ¨¡å‹**ï¼š
     - `@EnableBinding`ã€`@Input`ã€`@Output`ã€`@StreamListener`å’Œ `@SendTo`**å…¨éƒ¨è¢«æ ‡è®°ä¸º `@Deprecated`**ã€‚
     - åŸå› ï¼šå‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ï¼ˆ`Supplier`/`Function`/`Consumer`ï¼‰æ›´ç®€æ´ä¸”è§£è€¦ã€‚
   - **æ›¿ä»£æ–¹æ¡ˆ**ï¼š
     - **é€šé“ç»‘å®š**ï¼šé€šè¿‡é…ç½®è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚ `å‡½æ•°å-in-0`ï¼‰ã€‚
     - **æ¶ˆæ¯å¤„ç†**ï¼šç”¨ `StreamBridge`åŠ¨æ€å‘é€ï¼Œæˆ–å£°æ˜ `Consumer`/`Function`Bean æ¶ˆè´¹æ¶ˆæ¯ã€‚

------

### **ä¸‰ã€æ ¸å¿ƒå·®å¼‚æ€»ç»“**

| **æ³¨è§£ç±»å‹**       | **è§’è‰²**           | **ç‰ˆæœ¬æ”¯æŒ**      | **æ›¿ä»£æ–¹æ¡ˆ**                     |
| ------------------ | ------------------ | ----------------- | -------------------------------- |
| `@Input`/`@Output` | å®šä¹‰é€šé“æŠ½è±¡       | V2-V3.0ï¼ˆå·²å¼ƒç”¨ï¼‰ | å‡½æ•°å¼æ¨¡å‹ï¼ˆè‡ªåŠ¨ç»‘å®šé€šé“ï¼‰       |
| `@StreamListener`  | ç›‘å¬å¹¶æ¶ˆè´¹æ¶ˆæ¯     | V2-V3.0ï¼ˆå·²å¼ƒç”¨ï¼‰ | `Consumer<T>`Bean                |
| `@SendTo`          | å°†è¿”å›å€¼å‘é€åˆ°é€šé“ | V2-V3.0ï¼ˆå·²å¼ƒç”¨ï¼‰ | `Function<T,R>`æˆ– `StreamBridge` |

------

### **å››ã€è¿ç§»å»ºè®®**

1. **æ–°é¡¹ç›®ç›´æ¥ä½¿ç”¨å‡½æ•°å¼æ¨¡å‹**ï¼š
   - **ç”Ÿäº§è€…**ï¼š`StreamBridge.send("channel-out-0", payload)`ã€‚
   - **æ¶ˆè´¹è€…**ï¼šå£°æ˜ `Consumer<T>`Bean è‡ªåŠ¨ç»‘å®šè¾“å…¥é€šé“ã€‚
2. **æ—§é¡¹ç›®è¿ç§»æ­¥éª¤**ï¼š
   - ç§»é™¤ `@EnableBinding`å’Œé€šé“æ¥å£ã€‚
   - æ›¿æ¢ `@StreamListener`ä¸º `Consumer`Beanã€‚
   - ç”¨ `StreamBridge`æ›¿ä»£ `@SendTo`çš„æ¶ˆæ¯å‘é€é€»è¾‘ã€‚

> **æœ¬è´¨æ¼”è¿›é€»è¾‘**ï¼š
>
> - **æ³¨è§£æ¨¡å‹**ï¼šé€šè¿‡åˆ†å±‚æ³¨è§£ï¼ˆé€šé“å£°æ˜ + æ¶ˆæ¯å¤„ç†ï¼‰å®ç°è§£è€¦ï¼Œä½†éœ€æ˜¾å¼å®šä¹‰æ¥å£ã€‚
> - **å‡½æ•°å¼æ¨¡å‹**ï¼šé€šè¿‡çº¦å®šä¼˜äºé…ç½®ï¼ˆå¦‚é€šé“å‘½åè§„åˆ™ï¼‰å’Œ Lambda è¡¨è¾¾å¼ï¼Œè¿›ä¸€æ­¥å‡å°‘æ ·æ¿ä»£ç ï¼Œæå‡çµæ´»æ€§ã€‚

é€šè¿‡ç†è§£æ³¨è§£çš„åä½œä¸æ¼”è¿›ï¼Œå¯æ›´é«˜æ•ˆåœ°æ„å»ºå’Œç»´æŠ¤æ¶ˆæ¯é©±åŠ¨æ¶æ„ã€‚
