---
title: ã€MongoDBã€‘Fundamentals
date: 2025-08-06 00:00:00+0000
categories: [nutrition, willow]
tags: [DB]
---

## Introduction

A record in MongoDB is a document, which is a data structure composed of field and value pairs. MongoDB documents are similar to JSON objects. The values of fields may include other documents, arrays, and arrays of documents.

The advantages of using documents are:

- Documents correspond to **native data types** in many programming languages.
- Embedded documents and arrays **reduce need for expensive joins**.
- **Dynamic schema** supports fluent polymorphism.

MongoDB stores documents in [collections](https://www.mongodb.com/docs/manual/core/databases-and-collections/#std-label-collections). Collections are analogous to tables in relational databases.

### Query API

The MongoDB Query API supports [read and write operations (CRUD)](https://www.mongodb.com/docs/manual/crud/#std-label-crud) as well as:

- [Data Aggregation](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/#std-label-aggregation-pipeline)
- [Text Search](https://www.mongodb.com/docs/manual/text-search/#std-label-text-search) and [Geospatial Queries.](https://www.mongodb.com/docs/manual/tutorial/geospatial-tutorial/)

## æ¶æ„

MongoDB Atlas æ˜¯ MongoDB å…¬å¸æ¨å‡ºçš„**å…¨æ‰˜ç®¡äº‘æ•°æ®åº“æœåŠ¡**ï¼Œè€Œ MongoDB é€šå¸¸æŒ‡å¼€æºã€éœ€è‡ªæ‰˜ç®¡çš„æ•°æ®åº“ç³»ç»Ÿã€‚ä¸¤è€…æ ¸å¿ƒåŒºåˆ«åœ¨äº**éƒ¨ç½²æ¨¡å¼ã€è¿ç»´å¤æ‚åº¦åŠåŠŸèƒ½æ‰©å±•æ€§**ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†å¯¹æ¯”ï¼š

------

### ğŸš€ **ä¸€ã€MongoDB Atlas çš„æ ¸å¿ƒç‰¹æ€§**

1. **å®Œå…¨æ‰˜ç®¡æœåŠ¡**
   - Atlas è‡ªåŠ¨å¤„ç†æ•°æ®åº“çš„éƒ¨ç½²ã€å¤‡ä»½ã€ç›‘æ§ã€æ‰©å±•ã€å®‰å…¨æ›´æ–°ç­‰è¿ç»´ä»»åŠ¡ï¼Œç”¨æˆ·æ— éœ€ç®¡ç†åº•å±‚åŸºç¡€è®¾æ–½ã€‚
   - æ”¯æŒå¤šäº‘éƒ¨ç½²ï¼ˆAWS/Azure/GCPï¼‰ï¼Œå¯è·¨åŒºåŸŸå¤åˆ¶æ•°æ®ï¼Œå®ç°å…¨çƒä½å»¶è¿Ÿè®¿é—®å’Œé«˜å¯ç”¨æ€§ã€‚
2. **å¼€ç®±å³ç”¨çš„é«˜çº§åŠŸèƒ½**
   - **å†…ç½®å‘é‡æœç´¢**ï¼šæ”¯æŒè¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æœç´¢ï¼Œé€‚ç”¨äºAIåœºæ™¯ï¼ˆå¦‚è¯­ä¹‰æœç´¢ã€æ¨èç³»ç»Ÿï¼‰ã€‚
   - **è‡ªåŠ¨åŒ–å¼¹æ€§æ‰©å±•**ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´è®¡ç®—å’Œå­˜å‚¨èµ„æºï¼Œæ— éœ€åœæœºã€‚
   - **ä¼ä¸šçº§å®‰å…¨**ï¼šé»˜è®¤å¯ç”¨TLSåŠ å¯†ã€VPCç½‘ç»œéš”ç¦»ã€RBACæƒé™æ§åˆ¶ï¼Œç¬¦åˆGDPRç­‰åˆè§„è¦æ±‚ã€‚
3. **ç®€åŒ–å¼€å‘ä¸è¿ç»´**
   - æä¾›å…è´¹å¥—é¤å’ŒæŒ‰éœ€è®¡è´¹æ¨¡å¼ï¼Œé™ä½åˆå§‹æˆæœ¬ã€‚
   - é›†æˆç›‘æ§å‘Šè­¦ã€è‡ªåŠ¨åŒ–å¤‡ä»½ï¼ˆæ”¯æŒæ—¶é—´ç‚¹æ¢å¤ï¼‰å’ŒæŸ¥è¯¢åˆ†æå·¥å…·ã€‚

------

### âš™ï¸ **äºŒã€MongoDB Atlas ä¸è‡ªæ‰˜ç®¡ MongoDB çš„å…³é”®åŒºåˆ«**

| **ç»´åº¦**     | **MongoDB Atlas**                         | **è‡ªæ‰˜ç®¡ MongoDB**                 |
| ------------ | ----------------------------------------- | ---------------------------------- |
| **è¿ç»´ç®¡ç†** | å…¨è‡ªåŠ¨è¿ç»´ï¼ˆå¤‡ä»½ã€ç›‘æ§ã€æ‰©ç¼©å®¹ï¼‰          | éœ€æ‰‹åŠ¨éƒ¨ç½²ã€å‡çº§ã€ç»´æŠ¤ç¡¬ä»¶ä¸è½¯ä»¶   |
| **é«˜å¯ç”¨æ€§** | å†…ç½®å¤šåŒºåŸŸå‰¯æœ¬é›†ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»            | éœ€æ‰‹åŠ¨é…ç½®å‰¯æœ¬é›†å’Œåˆ†ç‰‡é›†ç¾¤         |
| **å®‰å…¨æ€§**   | é»˜è®¤TLSåŠ å¯†ã€IPç™½åå•ã€VPCéš”ç¦»            | éœ€è‡ªè¡Œé…ç½®ç½‘ç»œé˜²ç«å¢™å’ŒåŠ å¯†æœºåˆ¶     |
| **æ‰©å±•æ€§**   | ä¸€é”®æ¨ªå‘åˆ†ç‰‡/çºµå‘æ‰©å±•ï¼Œæ”¯æŒå…¨çƒåˆ†å‘       | éœ€æ‰‹åŠ¨åˆ†ç‰‡ï¼Œæ‰©å±•è¿‡ç¨‹å¤æ‚ä¸”å¯èƒ½åœæœº |
| **æˆæœ¬æ¨¡å‹** | æŒ‰ä½¿ç”¨é‡ä»˜è´¹ï¼ˆå«å…è´¹å¥—é¤ï¼‰                | éœ€é‡‡è´­ç¡¬ä»¶ï¼Œé•¿æœŸè¿ç»´æˆæœ¬è¾ƒé«˜       |
| **é«˜çº§åŠŸèƒ½** | åŸç”Ÿæ”¯æŒå‘é‡æœç´¢ã€Data Lakeé›†æˆã€AIå·¥å…·é“¾ | éœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“æˆ–è‡ªå»ºè§£å†³æ–¹æ¡ˆ       |

------

### ğŸ’¡ **ä¸‰ã€å…¸å‹ä½¿ç”¨åœºæ™¯å¯¹æ¯”**

- **é€‚åˆ Atlas çš„åœºæ™¯**
  - å¿«é€ŸåŸå‹å¼€å‘ï¼šåˆ†é’Ÿçº§éƒ¨ç½²æ•°æ®åº“ï¼ŒåŠ é€Ÿäº§å“è¿­ä»£ã€‚
  - å…¨çƒåŒ–åº”ç”¨ï¼šéœ€è·¨åŒºåŸŸä½å»¶è¿Ÿè®¿é—®ï¼ˆå¦‚ç”µå•†ã€æ¸¸æˆï¼‰ã€‚
  - AIé©±åŠ¨å‹åº”ç”¨ï¼šç›´æ¥è°ƒç”¨å†…ç½®å‘é‡æœç´¢ä¸LLMé›†æˆï¼ˆå¦‚LangChainï¼‰ã€‚
- **é€‚åˆè‡ªæ‰˜ç®¡çš„åœºæ™¯**
  - æ•°æ®ä¸»æƒè¦æ±‚ä¸¥æ ¼ï¼šéœ€å®Œå…¨æŒæ§æœ¬åœ°ç¡¬ä»¶å’Œç½‘ç»œã€‚
  - è¶…ä½æˆæœ¬æ•æ„Ÿåœºæ™¯ï¼šé•¿æœŸå›ºå®šè´Ÿè½½ä¸”å…·å¤‡ä¸“ä¸šè¿ç»´å›¢é˜Ÿã€‚

------

### ğŸ”Œ **å››ã€è¿æ¥ä¸å¼€å‘å·®å¼‚**

- **è¿æ¥æ–¹å¼**
  - Atlasï¼šä½¿ç”¨äº‘æœåŠ¡ä¸“å±URIï¼ˆå¦‚ `mongodb+srv://`ï¼‰ï¼Œéœ€é…ç½®IPç™½åå•å’Œæ•°æ®åº“ç”¨æˆ·ã€‚
  - è‡ªæ‰˜ç®¡ï¼šé€šè¿‡æœ¬åœ°è¿æ¥å­—ç¬¦ä¸²ï¼ˆå¦‚ `mongodb://localhost:27017`ï¼‰ç›´æ¥è®¿é—®ã€‚
- **å¼€å‘é€‚é…æ€§**
  - Atlas æä¾›ä¸å¼€æºMongoDBç›¸åŒçš„é©±åŠ¨ï¼ˆNode.js/Python/Javaç­‰ï¼‰ï¼Œä½†éœ€è°ƒç”¨äº‘æœåŠ¡ç‰¹å®šAPIï¼ˆå¦‚å‘é‡æœç´¢èšåˆç®¡é“ï¼‰ã€‚

------

### ğŸ’ **æ€»ç»“**

- **MongoDB Atlas** = **MongoDB æ ¸å¿ƒåŠŸèƒ½ + å…¨æ‰˜ç®¡äº‘æœåŠ¡ + é«˜çº§æ‰©å±•èƒ½åŠ›**ï¼Œé€‚åˆè¿½æ±‚æ•ˆç‡ã€å…¨çƒåŒ–éƒ¨ç½²åŠAIé›†æˆçš„å›¢é˜Ÿã€‚
- **è‡ªæ‰˜ç®¡ MongoDB** æ›´é€‚åˆéœ€è¦å®Œå…¨æ§åˆ¶åŸºç¡€è®¾æ–½æˆ–æˆæœ¬æåº¦å—é™çš„åœºæ™¯ï¼Œä½†éœ€æ‰¿æ‹…è¿ç»´å¤æ‚æ€§ã€‚

å»ºè®®ä¼˜å…ˆä½¿ç”¨ Atlas ä»¥èšç„¦ä¸šåŠ¡å¼€å‘ï¼Œä»…åœ¨ç‰¹æ®Šéœ€æ±‚æ—¶é€‰æ‹©è‡ªæ‰˜ç®¡æ–¹æ¡ˆã€‚

## B æ ‘ç´¢å¼•

MongoDB é€‰æ‹© B æ ‘è€Œé B+ æ ‘ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä¸»è¦ä¸å…¶è®¾è®¡ç›®æ ‡å’Œåº”ç”¨åœºæ™¯ç›¸å…³ï¼Œè€Œâ€œèŒƒå›´æŸ¥è¯¢éœ€æ±‚å·®å¼‚â€åªæ˜¯åŸå› ä¹‹ä¸€ã€‚ä»¥ä¸‹ä»å¤šä¸ªç»´åº¦åˆ†æå…¶è®¾è®¡é€»è¾‘ï¼Œå¹¶ç»“åˆæŠ€æœ¯åŸç†è¯´æ˜ï¼š

------

### ğŸ§  **ä¸€ã€æ ¸å¿ƒè®¾è®¡ç†å¿µå·®å¼‚**

1. **æ•°æ®æ¨¡å‹å®šä½ä¸åŒ**
   - **MySQLï¼ˆB+æ ‘ï¼‰**ï¼šå¼ºè°ƒæŸ¥è¯¢å…³è”æ•°æ®ä¸èŒƒå›´éå†ï¼ˆå¦‚æ—¶é—´èŒƒå›´ã€å¤–é”®å…³è”æŸ¥è¯¢ï¼‰ï¼ŒB+æ ‘çš„å¶å­èŠ‚ç‚¹é“¾è¡¨ç»“æ„å¤©ç„¶æ”¯æŒé«˜æ•ˆé¡ºåºè®¿é—®ã€‚
   - **MongoDBï¼ˆBæ ‘ï¼‰**ï¼šä»¥æ–‡æ¡£ä¸ºèšåˆå•å…ƒï¼Œç›®æ ‡åœºæ™¯æ˜¯**å¿«é€Ÿå®šä½å•ä¸ªæ–‡æ¡£**ï¼ˆå¦‚é€šè¿‡ `_id` è·å–ç”¨æˆ·å®Œæ•´ä¿¡æ¯ï¼‰ï¼ŒBæ ‘çš„éå¶å­èŠ‚ç‚¹ç›´æ¥å­˜å‚¨æ•°æ®å¯å‡å°‘ç£ç›˜ I/O æ¬¡æ•°ï¼Œå•ç‚¹æŸ¥è¯¢å¹³å‡æ›´å¿«ã€‚
2. **æŸ¥è¯¢æ¨¡å¼ä¼˜å…ˆçº§**
   - MongoDB å‡è®¾**å•æ–‡æ¡£æŸ¥è¯¢é¢‘ç‡è¿œé«˜äºèŒƒå›´éå†**ã€‚B æ ‘åœ¨éšæœºæŸ¥è¯¢æ—¶å¯èƒ½ä»…éœ€è®¿é—®å°‘æ•°èŠ‚ç‚¹å³å¯è¿”å›æ•°æ®ï¼ˆæœ€ä¼˜ O(1)ï¼‰ï¼Œè€Œ B+æ ‘å¿…é¡»è®¿é—®å¶å­èŠ‚ç‚¹ï¼ˆå›ºå®š O(log n)ï¼‰ã€‚
   - *åä¾‹è¯´æ˜*ï¼šè‹¥é›†åˆè®¾è®¡æœªéµå¾ªæ–‡æ¡£èšåˆåŸåˆ™ï¼ˆå¦‚å°†è¯„è®ºç‹¬ç«‹å­˜å‚¨å¹¶é€šè¿‡ `post_id` å…³è”æŸ¥è¯¢ï¼‰ï¼ŒèŒƒå›´æŸ¥è¯¢æ€§èƒ½ç¡®å®å¼±äº MySQLï¼Œä½†è¿™æ˜¯åæ¨¡å¼è®¾è®¡ï¼Œé MongoDB æ¨èç”¨æ³•ã€‚

------

### âš™ï¸ **äºŒã€B æ ‘ vs B+ æ ‘çš„æŠ€æœ¯æƒè¡¡**

| **ç‰¹æ€§**         | **B æ ‘ï¼ˆMongoDBï¼‰**             | **B+ æ ‘ï¼ˆMySQLï¼‰**               |
| ---------------- | ------------------------------- | -------------------------------- |
| **èŠ‚ç‚¹æ•°æ®å­˜å‚¨** | éå¶èŠ‚ç‚¹å­˜å‚¨é”®å€¼+æ•°æ®ï¼ˆDataåŸŸï¼‰ | éå¶èŠ‚ç‚¹ä»…å­˜ç´¢å¼•é”®ï¼Œæ•°æ®åœ¨å¶èŠ‚ç‚¹ |
| **å•ç‚¹æŸ¥è¯¢æ€§èƒ½** | å¹³å‡æ›´ä¼˜ï¼ˆå¯èƒ½ä¸­é€”å‘½ä¸­æ•°æ®ï¼‰    | ç¨³å®šä½†éœ€è®¿é—®å¶èŠ‚ç‚¹               |
| **èŒƒå›´æŸ¥è¯¢æ€§èƒ½** | éœ€å¤šæ¬¡å›æº¯éå¶èŠ‚ç‚¹ï¼Œæ•ˆç‡è¾ƒä½    | å¶èŠ‚ç‚¹é“¾è¡¨ç›´æ¥é¡ºåºéå†ï¼Œæ•ˆç‡é«˜   |
| **ç©ºé—´åˆ©ç”¨ç‡**   | éå¶èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œç´¢å¼•ä½“ç§¯è¾ƒå°  | éå¶èŠ‚ç‚¹å†—ä½™ç´¢å¼•é”®ï¼Œç´¢å¼•ä½“ç§¯è¾ƒå¤§ |

------

### ğŸ” **ä¸‰ã€èŒƒå›´æŸ¥è¯¢åœ¨ MongoDB ä¸­çš„å®é™…æ”¯æŒ**

1. **MongoDB ä»æ”¯æŒèŒƒå›´æŸ¥è¯¢**
   - ä¾‹å¦‚æŒ‰æ—¶é—´æˆ³æˆ– `ObjectId` èŒƒå›´è¿‡æ»¤ï¼ˆå¦‚ `db.collection.find({_id: {$gt: startId}})`ï¼‰ã€‚
   - ä½†æ€§èƒ½å¼±äº MySQLï¼šB æ ‘éœ€å¤šæ¬¡è®¿é—®éè¿ç»­èŠ‚ç‚¹ï¼Œè€Œ B+ æ ‘é€šè¿‡å¶èŠ‚ç‚¹é“¾è¡¨é¡ºåºæ‰«æã€‚
2. **ä¼˜åŒ–æ‰‹æ®µ**
   - **å¤åˆç´¢å¼•è®¾è®¡**ï¼šå°†é«˜åŒºåˆ†åº¦å­—æ®µï¼ˆå¦‚ç”¨æˆ·IDï¼‰ç½®äºç´¢å¼•å·¦ä¾§ï¼Œç¼©å°æ‰«æèŒƒå›´ã€‚
   - **åˆ†ç‰‡é”®ç­–ç•¥**ï¼šå“ˆå¸Œåˆ†ç‰‡å¯é¿å…çƒ­ç‚¹ï¼Œä½†ç‰ºç‰²èŒƒå›´æŸ¥è¯¢ï¼›èŒƒå›´åˆ†ç‰‡ç›´æ¥ä¼˜åŒ–è¿ç»­æŸ¥è¯¢ã€‚
   - **èšåˆç®¡é“**ï¼šé€šè¿‡ `$match` æå‰è¿‡æ»¤æ•°æ®ï¼Œå‡å°‘å†…å­˜å¤„ç†é‡ã€‚

------

### âš–ï¸ **å››ã€å…¶ä»–å½±å“å› ç´ **

1. **å†™å…¥æ€§èƒ½è€ƒé‡**
   - B æ ‘çš„éšæœºå†™æ€§èƒ½ä¼˜äº LSM æ ‘ï¼ˆå†™æ”¾å¤§ä½ï¼‰ï¼Œä¸”è¯»å–æ€§èƒ½è¿œèƒœ LSM æ ‘ï¼ˆLSM è¯»éœ€åˆå¹¶å¤šå±‚çº§æ–‡ä»¶ï¼‰ã€‚MongoDB çš„è¯»å¤šå†™å°‘åœºæ™¯æ›´å€¾å‘ B æ ‘ã€‚
2. **å­˜å‚¨å¼•æ“ä¼˜åŒ–**
   - WiredTiger å¼•æ“çš„**æ–‡æ¡£çº§é”**å’Œ **MVCC** æœºåˆ¶å¼¥è¡¥äº† B æ ‘å¹¶å‘çŸ­æ¿ï¼Œè€Œå‹ç¼©æŠ€æœ¯ï¼ˆSnappy/Zstdï¼‰ç¼“è§£äº† B æ ‘ç©ºé—´é—®é¢˜ã€‚

------

### ğŸ’ **æ€»ç»“ï¼šMongoDB é€‰æ‹© B æ ‘çš„æœ¬è´¨åŸå› **

1. **åœºæ™¯é©±åŠ¨**ï¼šæ–‡æ¡£å‹æ•°æ®åº“çš„æ ¸å¿ƒæ“ä½œæ˜¯**åŸºäºé”®çš„å¿«é€Ÿæ–‡æ¡£è·å–**ï¼Œè€Œéè¡¨å…³è”éå†ã€‚
2. **æ€§èƒ½æŠ˜è¡·**ï¼šç‰ºç‰²èŒƒå›´æŸ¥è¯¢æ•ˆç‡ï¼Œæ¢å–æ›´é«˜çš„å•ç‚¹æŸ¥è¯¢æ€§èƒ½å’Œæ›´ç¨³å®šçš„è¯»å†™ååã€‚
3. **ç”Ÿæ€é€‚é…**ï¼šé€šè¿‡èšåˆæ–‡æ¡£æ¨¡å‹ã€åˆ†ç‰‡ç­–ç•¥å’Œç´¢å¼•ä¼˜åŒ–ï¼Œè§„é¿ B æ ‘åœ¨èŒƒå›´æŸ¥è¯¢ä¸Šçš„åŠ£åŠ¿ã€‚

> è‹¥ä¸šåŠ¡å¼ºä¾èµ–èŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚æ—¥å¿—åˆ†æï¼‰ï¼Œå»ºè®®ï¼š
> âœ… ä½¿ç”¨èŒƒå›´åˆ†ç‰‡é”® + å¤åˆç´¢å¼•ï¼ˆé«˜åŒºåˆ†åº¦å­—æ®µåœ¨å‰ï¼‰
> âœ… å¿…è¦æ—¶æ”¹ç”¨ ClickHouse æˆ– Elasticsearch ç­‰ä¸“ç”¨å¼•æ“ã€‚

## Change Stream

MongoDB Change Streams æ˜¯ä¸€ç§åŸºäº **oplogï¼ˆæ“ä½œæ—¥å¿—ï¼‰** çš„å®æ—¶æ•°æ®å˜æ›´ç›‘å¬æœºåˆ¶ï¼Œè‡ª 3.6 ç‰ˆæœ¬å¼•å…¥ï¼Œé€‚ç”¨äºå‰¯æœ¬é›†æˆ–åˆ†ç‰‡é›†ç¾¤ç¯å¢ƒã€‚å®ƒé€šè¿‡æ¨é€æ¨¡å¼å°†æ•°æ®åº“çš„å¢é‡å˜æ›´ï¼ˆå¦‚æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰ä»¥äº‹ä»¶æµçš„å½¢å¼ä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼Œæ— éœ€è½®è¯¢æŸ¥è¯¢ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒæœºåˆ¶ã€åº”ç”¨åœºæ™¯ã€æŠ€æœ¯å®ç°åŠä¼˜åŒ–ç­–ç•¥å±•å¼€è¯¦è§£ï¼š

------

### ğŸ”§ **ä¸€ã€æ ¸å¿ƒæœºåˆ¶ä¸å·¥ä½œåŸç†**

1. **ä¾èµ– Oplog å®ç°**

   - Change Streams åœ¨ MongoDB çš„ **oplog é›†åˆ**ä¸Šå¼€å¯ä¸€ä¸ªå¯è¿½åŠ æ¸¸æ ‡ï¼ˆtailable cursorï¼‰ï¼Œå®æ—¶æ•è·æ‰€æœ‰å‰¯æœ¬é›†æˆ–åˆ†ç‰‡é›†ç¾¤çš„å˜æ›´æ“ä½œã€‚
   - å˜æ›´äº‹ä»¶åŒ…æ‹¬ï¼š`insert`ã€`update`ã€`delete`ã€`drop`ï¼ˆé›†åˆåˆ é™¤ï¼‰ã€`rename`ï¼ˆé›†åˆé‡å‘½åï¼‰åŠ `invalidate`ï¼ˆé›†åˆå¤±æ•ˆäº‹ä»¶ï¼‰ã€‚

2. **æ•°æ®ä¸€è‡´æ€§ä¸å¯é æ€§**

   - é‡‡ç”¨ **`readConcern: "majority"`** çº§åˆ«ï¼Œç¡®ä¿å˜æ›´äº‹ä»¶ä»…åœ¨æ•°æ®å†™å…¥å¤šæ•°èŠ‚ç‚¹åè§¦å‘ï¼Œé¿å…å›æ»šå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚
   - **æ–­ç‚¹æ¢å¤æœºåˆ¶**ï¼šæ¯ä¸ªäº‹ä»¶è¿”å›å”¯ä¸€çš„ `resumeToken`ï¼ˆå­˜å‚¨åœ¨ `_id` å­—æ®µï¼‰ï¼Œæ”¯æŒé€šè¿‡ `resumeAfter` å‚æ•°ä»ä¸­æ–­ç‚¹æ¢å¤ç›‘å¬ã€‚

3. **äº‹ä»¶è¿‡æ»¤ä¸å®šåˆ¶**

   - ä½¿ç”¨ **èšåˆç®¡é“** è¿‡æ»¤ç‰¹å®šäº‹ä»¶ç±»å‹ï¼ˆå¦‚ä»…ç›‘å¬æ’å…¥å’Œåˆ é™¤ï¼‰ï¼š

     ```
     db.collection.watch([{ $match: { operationType: { $in: ["insert", "delete"] } } }]);
     ```

   - æ›´æ–°æ“ä½œé»˜è®¤è¿”å›**å¢é‡å­—æ®µ**ï¼ˆä»…å˜æ›´éƒ¨åˆ†ï¼‰ï¼Œè‹¥éœ€è·å–å®Œæ•´æ–‡æ¡£ï¼Œéœ€è®¾ç½® `fullDocument: "updateLookup"`ã€‚

------

### âš¡ **äºŒã€é€‚ç”¨åœºæ™¯ä¸å…¸å‹æ–¹æ¡ˆ**

| **åœºæ™¯**           | **å®ç°æ–¹æ¡ˆ**                                            | **æ¡ˆä¾‹è¯´æ˜**                        |
| ------------------ | ------------------------------------------------------- | ----------------------------------- |
| **è·¨é›†ç¾¤æ•°æ®åŒæ­¥** | è®¢é˜…æºé›†ç¾¤å˜æ›´æµï¼Œå®æ—¶å†™å…¥ç›®æ ‡é›†ç¾¤                      | å¼‚åœ°å®¹ç¾å¤‡ä»½ï¼ˆå¦‚åŒ—äº¬â†’ä¸Šæµ·é›†ç¾¤åŒæ­¥ï¼‰ |
| **å®æ—¶ç›‘æ§ä¸å®¡è®¡** | ç›‘å¬é«˜é£é™©æ“ä½œï¼ˆå¦‚ `dropDatabase`ï¼‰ï¼Œè§¦å‘å‘Šè­¦æˆ–æ—¥å¿—è®°å½• | å®¡è®¡åˆ åº“è¡Œä¸ºï¼Œæ»¡è¶³åˆè§„è¦æ±‚          |
| **äº‹ä»¶é©±åŠ¨æ¶æ„**   | å¾®æœåŠ¡é—´æ•°æ®å˜æ›´è”åŠ¨ï¼ˆå¦‚è®¢å•çŠ¶æ€æ›´æ–°è§¦å‘åº“å­˜æ‰£å‡ï¼‰      | ç”µå•†ç³»ç»Ÿä¸­è®¢å•-åº“å­˜æœåŠ¡è§£è€¦         |
| **å®æ—¶åˆ†æè®¡ç®—**   | å°†å˜æ›´äº‹ä»¶æ¨é€è‡³ Flink/Spark æµå¤„ç†å¹³å°                 | ç”¨æˆ·è¡Œä¸ºå®æ—¶åˆ†æï¼ˆå¦‚ç‚¹å‡»æµç»Ÿè®¡ï¼‰    |
| **åŠ¨æ€æ¶ˆæ¯æ¨é€**   | ç›‘å¬æ•°æ®å˜æ›´ï¼ˆå¦‚å…¬äº¤è½¦ GPS åæ ‡ï¼‰ï¼Œæ¨é€è‡³å®¢æˆ·ç«¯         | å…¬äº¤åˆ°ç«™å®æ—¶æé†’ç³»ç»Ÿ                |

------

### ğŸ› ï¸ **ä¸‰ã€æŠ€æœ¯å®ç°ä¸ä¼˜åŒ–ç­–ç•¥**

1. **åŸºç¡€ä»£ç ç¤ºä¾‹ï¼ˆNode.jsï¼‰**

   ```
   const changeStream = db.collection('users').watch();
   changeStream.on('change', (change) => {
     if (change.operationType === 'update') {
       console.log('æ›´æ–°åçš„å®Œæ•´æ–‡æ¡£ï¼š', change.fullDocument);
     }
   });
   ```

2. **Spring Boot æ•´åˆï¼ˆJavaï¼‰**

   - é…ç½®

      

     ```
     MessageListenerContainer
     ```

      

     ç›‘å¬æŒ‡å®šé›†åˆï¼Œè¿‡æ»¤äº‹ä»¶ç±»å‹å¹¶å¯ç”¨å…¨æ–‡æ¡£è¿”å›ï¼š

     ```
     ChangeStreamRequest.builder(listener)
       .collection("orders")
       .filter(Aggregation.match(Criteria.where("operationType").in("insert", "update")))
       .fullDocumentLookup(FullDocument.UPDATE_LOOKUP)
       .build();
     ```

3. **æ€§èƒ½ä¼˜åŒ–å®è·µ**

   - **èµ„æºæ§åˆ¶**ï¼šé€šè¿‡ `maxAwaitTimeMS` é™åˆ¶äº‹ä»¶ç­‰å¾…æ—¶é—´ï¼ˆå¦‚ `5000ms`ï¼‰ï¼Œé¿å…é•¿è¿æ¥é˜»å¡ã€‚
   - **ç´¢å¼•ä¼˜åŒ–**ï¼šå¯¹é«˜é¢‘æŸ¥è¯¢çš„å­—æ®µï¼ˆå¦‚ `_id` æˆ–åˆ†ç‰‡é”®ï¼‰åˆ›å»ºç´¢å¼•ï¼Œæå‡å˜æ›´äº‹ä»¶ç”Ÿæˆæ•ˆç‡ã€‚
   - **ç½‘ç»œå¸¦å®½ç®¡ç†**ï¼šåœ¨è·¨æ•°æ®ä¸­å¿ƒåœºæ™¯ä¸­å‹ç¼©äº‹ä»¶æ•°æ®ï¼ˆå¦‚ä½¿ç”¨ Snappy ç®—æ³•ï¼‰ã€‚

------

### âš ï¸ **å››ã€æ³¨æ„äº‹é¡¹ä¸é™åˆ¶**

1. **ç¯å¢ƒä¾èµ–**
   - ä»…æ”¯æŒå‰¯æœ¬é›†æˆ–åˆ†ç‰‡é›†ç¾¤ï¼Œå•æœº MongoDB ä¸å¯ç”¨ã€‚
   - Oplog çª—å£é™åˆ¶ï¼šä¸­æ–­æ—¶é—´è¶…è¿‡ oplog ä¿ç•™å‘¨æœŸï¼ˆé»˜è®¤ 24 å°æ—¶ï¼‰å°†å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚
2. **äº‹ä»¶ç‰¹æ€§**
   - åˆ é™¤æ“ä½œä»…è¿”å›æ–‡æ¡£ `_id`ï¼Œæ— æ³•è·å–å®Œæ•´å†…å®¹ã€‚
   - DDL äº‹ä»¶ï¼ˆå¦‚ç´¢å¼•åˆ›å»ºï¼‰ä»… MongoDB 6.0+ æ”¯æŒã€‚
3. **èµ„æºæ¶ˆè€—**
   - **é«˜å¹¶å‘åœºæ™¯**ï¼šéœ€ç›‘æ§ CPU/å†…å­˜å ç”¨ï¼Œå»ºè®®åˆ†ç¦»ç›‘å¬èŠ‚ç‚¹ä¸æ•°æ®èŠ‚ç‚¹ã€‚
   - **ç½‘ç»œå‹åŠ›**ï¼šæµ·é‡å˜æ›´äº‹ä»¶å¯èƒ½å æ»¡å¸¦å®½ï¼Œéœ€è®¾è®¡èƒŒå‹æœºåˆ¶ï¼ˆå¦‚ Kafka ç¼“å†²ï¼‰ã€‚

------

### ğŸ’ **æ€»ç»“**

Change Streams æ˜¯ MongoDB å®æ—¶æ•°æ®ç”Ÿæ€çš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡ **oplog ç›‘å¬ + äº‹ä»¶æµæ¨é€** æœºåˆ¶ï¼Œé«˜æ•ˆæ”¯æ’‘äº†æ•°æ®åŒæ­¥ã€å¾®æœåŠ¡åä½œã€å®æ—¶åˆ†æç­‰åœºæ™¯ã€‚å¼€å‘ä¸­éœ€æ³¨æ„ï¼š
âœ… â€‹**ä¼˜å…ˆä½¿ç”¨èšåˆç®¡é“æ›¿ä»£ MapReduce**ï¼Œé¿å… JS å¼•æ“æ€§èƒ½ç“¶é¢ˆï¼›
âœ… â€‹**ç»“åˆæ–­ç‚¹æ¢å¤ä¸è¿‡æ»¤æœºåˆ¶**ï¼Œæå‡äº‹ä»¶å¤„ç†å¯é æ€§ï¼›
âœ… â€‹**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åˆ†ç‰‡é›†ç¾¤**ï¼Œä¿éšœé«˜å¯ç”¨æ€§ä¸æ‰©å±•æ€§ã€‚

> å¯¹äºéœ€è¦å†å²æ•°æ®å¤„ç†æˆ–å¤æ‚å…³è”åˆ†æçš„åœºæ™¯ï¼Œå»ºè®®æ­é… **CDC å·¥å…·ï¼ˆå¦‚ Debeziumï¼‰** æˆ– **æµå¼è®¡ç®—å¼•æ“ï¼ˆå¦‚ Flinkï¼‰** æ„å»ºæ›´å¥å£®çš„æµæ°´çº¿ã€‚

## Aggregation Pipeline

MongoDB çš„èšåˆç®¡é“ï¼ˆAggregation Pipelineï¼‰æ˜¯ä¸€ç§åŸºäº**æ•°æ®å¤„ç†æµæ°´çº¿æ¨¡å‹**çš„æ¡†æ¶ï¼Œç”¨äºå¯¹é›†åˆä¸­çš„æ–‡æ¡£è¿›è¡Œå¤šé˜¶æ®µè½¬æ¢ã€è¿‡æ»¤ã€åˆ†ç»„å’Œè®¡ç®—ï¼Œæœ€ç»ˆè¾“å‡ºèšåˆç»“æœã€‚å…¶æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯å°†æ•°æ®åƒåœ¨ç®¡é“ä¸­æµåŠ¨ä¸€æ ·ï¼Œä¾æ¬¡ç»è¿‡å¤šä¸ªå¤„ç†é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µæ‰§è¡Œç‰¹å®šæ“ä½œå¹¶ä¼ é€’ç»™ä¸‹ä¸€é˜¶æ®µã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£æï¼š

------

### ğŸ”§ **ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œæœºåˆ¶**

1. **ç®¡é“ä¸é˜¶æ®µï¼ˆPipeline & Stageï¼‰**
   - **ç®¡é“**ï¼šç”±å¤šä¸ª**é˜¶æ®µï¼ˆStageï¼‰** ç»„æˆçš„åºåˆ—ï¼Œæ¯ä¸ªé˜¶æ®µæ¥æ”¶ä¸Šä¸€é˜¶æ®µçš„è¾“å‡ºæ–‡æ¡£ï¼Œæ‰§è¡Œæ“ä½œåè¾“å‡ºæ–°æ–‡æ¡£ã€‚
   - **é˜¶æ®µç±»å‹**ï¼šåŒ…æ‹¬ `$match`ï¼ˆè¿‡æ»¤ï¼‰ã€`$project`ï¼ˆæŠ•å½±ï¼‰ã€`$group`ï¼ˆåˆ†ç»„ï¼‰ã€`$sort`ï¼ˆæ’åºï¼‰ç­‰ï¼Œæ”¯æŒé“¾å¼ç»„åˆã€‚
   - **æ‰§è¡Œé¡ºåº**ï¼šä¸¥æ ¼æŒ‰å®šä¹‰é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚å…ˆè¿‡æ»¤å†åˆ†ç»„å¯æ˜¾è‘—æå‡æ€§èƒ½ã€‚
2. **è¾“å…¥ä¸è¾“å‡º**
   - **è¾“å…¥**ï¼šé›†åˆä¸­çš„æ‰€æœ‰æ–‡æ¡£ï¼ˆæˆ–é€šè¿‡ `$match` ç­›é€‰çš„å­é›†ï¼‰ã€‚
   - **è¾“å‡º**ï¼šæœ€ç»ˆé˜¶æ®µçš„å¤„ç†ç»“æœï¼Œå¯ä»¥æ˜¯æ–‡æ¡£ã€ç»Ÿè®¡å€¼æˆ–å†™å…¥æ–°é›†åˆï¼ˆé€šè¿‡ `$out` æˆ– `$merge`ï¼‰ã€‚

------

### âš™ï¸ **äºŒã€æ ¸å¿ƒé˜¶æ®µè¯¦è§£ä¸ç¤ºä¾‹**

ä»¥ä¸‹æ˜¯å¸¸ç”¨é˜¶æ®µçš„åŠŸèƒ½å’Œè¯­æ³•ç¤ºä¾‹ï¼š

| **é˜¶æ®µ**       | **åŠŸèƒ½**                                       | **è¯­æ³•ç¤ºä¾‹**                                                 | **åº”ç”¨åœºæ™¯**                    |
| -------------- | ---------------------------------------------- | ------------------------------------------------------------ | ------------------------------- |
| **`$match`**   | ç­›é€‰ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£ï¼Œç±»ä¼¼ SQL çš„ `WHERE`        | `{ $match: { status: "A", quantity: { $gt: 20 } } }`         | æå‰è¿‡æ»¤æ•°æ®ï¼Œå‡å°‘åç»­è®¡ç®—é‡    |
| **`$project`** | é‡å‘½åã€å¢åˆ å­—æ®µï¼Œæˆ–è®¡ç®—æ–°å­—æ®µ                 | `{ $project: { name: 1, discount: { $multiply: ["$price", 0.9] } } }` | æ•°æ®æ ¼å¼è½¬æ¢æˆ–å­—æ®µåŠ å·¥          |
| **`$group`**   | æŒ‰å­—æ®µåˆ†ç»„å¹¶è®¡ç®—èšåˆå€¼ï¼ˆå¦‚æ±‚å’Œã€å‡å€¼ï¼‰         | `{ $group: { _id: "$category", total: { $sum: "$quantity" } } }` | ç»Ÿè®¡åˆ†ç±»é”€å”®é¢æˆ–ç”¨æˆ·è¡Œä¸º        |
| **`$unwind`**  | å°†æ•°ç»„å­—æ®µæ‹†åˆ†ä¸ºå¤šæ¡ç‹¬ç«‹æ–‡æ¡£ï¼ˆæ¯ä¸ªå…ƒç´ ä¸€æ–‡æ¡£ï¼‰ | `{ $unwind: "$tags" }`                                       | åˆ†ææ ‡ç­¾ã€è¯„è®ºç­‰æ•°ç»„æ•°æ®        |
| **`$sort`**    | æŒ‰å­—æ®µæ’åº                                     | `{ $sort: { total: -1 } }` ï¼ˆ`-1` é™åºï¼Œ`1` å‡åºï¼‰           | ç»“æœæ’åºæˆ–åˆ†é¡µé¢„å¤„ç†            |
| **`$lookup`**  | è·¨é›†åˆå·¦å¤–è¿æ¥ï¼ˆç±»ä¼¼ SQL `LEFT JOIN`ï¼‰         | `{ $lookup: { from: "orders", localField: "user_id", foreignField: "_id", as: "orders" } }` | å…³è”ç”¨æˆ·è®¢å•ä¿¡æ¯                |
| **`$facet`**   | åœ¨åŒä¸€é˜¶æ®µæ‰§è¡Œå¤šä¸ªå­ç®¡é“ï¼Œè¾“å‡ºå¤šç»´ç»Ÿè®¡ç»“æœ     | `{ $facet: { sales: [{ $group: { _id: null, total: { $sum: "$price" } }], topItems: [{ $limit: 5 }] } }` | å¤šç»´åº¦åˆ†æï¼ˆå¦‚é”€å”®é¢+çƒ­é—¨å•†å“ï¼‰ |

------

### âš¡ **ä¸‰ã€é«˜çº§åŠŸèƒ½ä¸å¤æ‚æ“ä½œ**

1. **è¡¨è¾¾å¼æ“ä½œç¬¦**

   - **æ•°å­¦è®¡ç®—**ï¼š`$add`ã€`$multiply`ï¼ˆä¾‹ï¼š`{ $multiply: ["$price", "$quantity"] }` è®¡ç®—æ€»ä»·ï¼‰ã€‚

   - 

     æ¡ä»¶é€»è¾‘

     ï¼š

     ```
     $cond
     ```

      

     å®ç°

      

     ```
     IF-ELSE
     ```

     ï¼Œä¾‹å¦‚æ ¹æ®ä»·æ ¼è®¾ç½®æŠ˜æ‰£ï¼š

     ```
     { $project: { discount: { $cond: { if: { $gt: ["$price", 100] }, then: 10, else: 0 } } } }
     ```

   - **æ—¥æœŸ/å­—ç¬¦ä¸²å¤„ç†**ï¼š`$dateFromString` è½¬æ¢æ—¥æœŸæ ¼å¼ï¼Œ`$substr` æˆªå–å­—ç¬¦ä¸² ã€‚

2. **å¤šé˜¶æ®µç»„åˆæ¡ˆä¾‹**
   â€‹**åœºæ™¯**â€‹ï¼šç»Ÿè®¡ 2024 å¹´ Q1 å„å“ç±»é”€å”®é¢ Top 3ï¼š

   ```
   db.sales.aggregate([
     { $match: { date: { $gte: "2024-01-01", $lt: "2024-04-01" } } },  // è¿‡æ»¤æ—¥æœŸ
     { $group: { _id: "$category", total: { $sum: { $multiply: ["$price", "$quantity"] } } } }, // åˆ†ç»„è®¡ç®—
     { $sort: { total: -1 } },  // æŒ‰é”€å”®é¢é™åº
     { $limit: 3 }               // å–å‰ä¸‰
   ])
   ```

   **æ‰§è¡Œé¡ºåº**ï¼š`$match` â†’ `$group` â†’ `$sort` â†’ `$limit`ã€‚

------

### ğŸ› ï¸ **å››ã€æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹**

1. **é˜¶æ®µé¡ºåºä¼˜åŒ–**
   - **å‰ç½®è¿‡æ»¤**ï¼šå°† `$match` å’Œ `$project` æ”¾åœ¨ç®¡é“å‰ç«¯ï¼Œå‡å°‘åç»­å¤„ç†çš„æ•°æ®é‡ã€‚
   - **ç´¢å¼•åˆ©ç”¨**ï¼š`$match` å’Œ `$sort` è‹¥åœ¨ç®¡é“å¼€å¤´ï¼Œå¯å‘½ä¸­ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ã€‚
2. **å†…å­˜ä¸èµ„æºç®¡ç†**
   - **å†…å­˜é™åˆ¶**ï¼š`$group` å’Œ `$sort` é»˜è®¤å†…å­˜ä¸Šé™ 100MBï¼Œè¶…é™éœ€å¯ç”¨ `allowDiskUse: true` å†™å…¥ä¸´æ—¶æ–‡ä»¶ã€‚
   - **åˆ†ç‰‡é›†ç¾¤ä¼˜åŒ–**ï¼šåœ¨ `$group` å‰ä½¿ç”¨ `$match` å‡å°‘è·¨åˆ†ç‰‡æ•°æ®ä¼ è¾“ã€‚
3. **æ›¿ä»£ MapReduce**
   - èšåˆç®¡é“**åŸç”Ÿä½¿ç”¨ C++ å®ç°**ï¼Œæ¯”åŸºäº JavaScript çš„ MapReduce **æ€§èƒ½æå‡ 10 å€ä»¥ä¸Š**ï¼ŒMongoDB 5.0+ å·²å¼ƒç”¨ MapReduceã€‚

------

### ğŸ’¡ **äº”ã€å…¸å‹åº”ç”¨åœºæ™¯**

| **åœºæ™¯**         | **å®ç°æ–¹æ¡ˆ**                                                 | **æ¡ˆä¾‹**           |
| ---------------- | ------------------------------------------------------------ | ------------------ |
| **å®æ—¶æŠ¥è¡¨**     | `$group` + `$project` è®¡ç®—é”€å”®æ€»é¢ã€å‡å€¼ç­‰                   | æ¯æ—¥é”€å”®ç»Ÿè®¡çœ‹æ¿   |
| **æ•°æ®æ¸…æ´—**     | `$project` é‡å‘½åå­—æ®µ + `$unwind` å±•å¼€æ•°ç»„ + `$match` è¿‡æ»¤å¼‚å¸¸å€¼ | ç”¨æˆ·è¡Œä¸ºæ—¥å¿—é¢„å¤„ç† |
| **å¤šè¡¨å…³è”åˆ†æ** | `$lookup` è¿æ¥è®¢å•è¡¨ä¸ç”¨æˆ·è¡¨ï¼Œ`$group` æŒ‰ç”¨æˆ·åˆ†ç»„ç»Ÿè®¡        | é«˜ä»·å€¼ç”¨æˆ·è¯†åˆ«     |
| **åˆ†é¡µæŸ¥è¯¢**     | `$skip` + `$limit` ç»„åˆå®ç°ï¼ˆéœ€é…åˆ `$sort` ä¿è¯é¡ºåºï¼‰       | å•†å“åˆ—è¡¨åˆ†é¡µå±•ç¤º   |

------

### âš ï¸ **å…­ã€å¸¸è§é”™è¯¯ä¸è§„é¿æªæ–½**

1. **æ•°ç»„å¤„ç†é™·é˜±**

   - ```
     $unwind
     ```

      

     éæ•°ç»„å­—æ®µä¼šæŠ¥é”™ï¼Œéœ€å…ˆç”¨

      

     ```
     $ifNull
     ```

      

     è®¾ç½®é»˜è®¤å€¼ï¼š

     ```
     { $project: { tags: { $ifNull: ["$tags", []] } } }, 
     { $unwind: "$tags" }
     ```

   - ç©ºæ•°ç»„ç» `$unwind` åæ–‡æ¡£ä¼šè¢«ä¸¢å¼ƒï¼Œéœ€è®¾ `preserveNullAndEmptyArrays: true` ä¿ç•™ã€‚

2. **åˆ†ç»„æ€§èƒ½ç“¶é¢ˆ**

   - é¿å…å¯¹é«˜åŸºæ•°å­—æ®µï¼ˆå¦‚ç”¨æˆ·IDï¼‰ç›´æ¥ `$group`ï¼Œæ”¹ç”¨ `$bucket` åˆ†æ¡¶ç»Ÿè®¡ã€‚
   - åˆ†ç‰‡é›†ç¾¤ä¸­ï¼Œç¡®ä¿ `$group` çš„ `_id` åŒ…å«åˆ†ç‰‡é”®ä»¥é¿å…è·¨åˆ†ç‰‡åˆå¹¶ã€‚

------

### ğŸ’ **æ€»ç»“**

èšåˆç®¡é“æ˜¯ MongoDB **æœ€å¼ºå¤§çš„æ•°æ®åˆ†æå·¥å…·**ï¼Œé€šè¿‡çµæ´»çš„é˜¶æ®µç»„åˆå¯å®ç°ï¼š

- **é«˜æ•ˆæ•°æ®è½¬æ¢**ï¼š`$project` é‡å¡‘ç»“æ„ï¼Œ`$unwind` è§£æ„æ•°ç»„ï¼›
- **å¤æ‚èšåˆè®¡ç®—**ï¼š`$group` åˆ†ç»„ç»Ÿè®¡ï¼Œ`$facet` å¤šç»´åº¦åˆ†æï¼›
- **è·¨é›†åˆå…³è”**ï¼š`$lookup` æ›¿ä»£å…³è”æŸ¥è¯¢ï¼›
- **èµ„æºå¯æ§æ€§**ï¼š`allowDiskUse` çªç ´å†…å­˜é™åˆ¶ï¼Œåˆ†ç‰‡é›†ç¾¤ä¼˜åŒ–åˆ†å¸ƒå¼è®¡ç®—ã€‚

> **æœ€ä½³å®è·µ**ï¼šå§‹ç»ˆå°† `$match` å‰ç½®ä»¥å‡å°‘æ•°æ®é‡ï¼›é¿å… JavaScript è¡¨è¾¾å¼ï¼›ä¼˜å…ˆä½¿ç”¨èšåˆç®¡é“è€Œéå·²å¼ƒç”¨çš„ MapReduceã€‚ å…·ä½“è¯­æ³•è¯¦è§ [MongoDB èšåˆç®¡é“æ–‡æ¡£](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/)ã€‚

## MapReduce

åœ¨ MongoDB ä¸­ï¼Œèšåˆç®¡é“ï¼ˆAggregation Pipelineï¼‰å’Œ MapReduce æ˜¯ä¸¤ç§æ ¸å¿ƒçš„æ•°æ®å¤„ç†æ¨¡å‹ï¼Œå®ƒä»¬åœ¨æ€§èƒ½ä¸Šå­˜åœ¨æ˜¾è‘—å·®å¼‚ã€‚ä»¥ä¸‹ä»æ‰§è¡Œæœºåˆ¶ã€èµ„æºæ¶ˆè€—ã€æ‰©å±•æ€§ç­‰ç»´åº¦è¯¦ç»†åˆ†æä¸¤è€…çš„å…·ä½“å·®å¼‚ï¼š

------

### âš™ï¸ **ä¸€ã€æ‰§è¡Œæœºåˆ¶ä¸æ€§èƒ½å·®å¼‚**

| **ç‰¹æ€§**         | **èšåˆç®¡é“**                                              | **MapReduce**                                                |
| ---------------- | --------------------------------------------------------- | ------------------------------------------------------------ |
| **æ‰§è¡Œå¼•æ“**     | **åŸç”Ÿ C++ å®ç°**ï¼Œç›´æ¥æ“ä½œ BSON æ•°æ®ï¼Œæ— è§£é‡Šå™¨å¼€é”€ã€‚     | **JavaScript å¼•æ“æ‰§è¡Œ**ï¼Œéœ€è§£æ JS ä»£ç ï¼Œæ€§èƒ½æŸè€—é«˜ã€‚        |
| **æ•°æ®å¤„ç†æ–¹å¼** | **æµå¼ç®¡é“å¤„ç†**ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­é€é˜¶æ®µä¼ é€’ï¼Œå‡å°‘ I/O å¼€é”€ã€‚ | **åˆ†é˜¶æ®µè¯»å†™ç£ç›˜**ï¼šMap è¾“å‡ºä¸­é—´ç»“æœè½ç›˜ï¼ŒReduce é˜¶æ®µå†è¯»å–ï¼ŒI/O å‹åŠ›å¤§ã€‚ |
| **å†…å­˜é™åˆ¶**     | å•é˜¶æ®µé»˜è®¤ 100MB å†…å­˜é™åˆ¶ï¼Œå¯é€šè¿‡ `allowDiskUse` çªç ´ã€‚   | æ— æ˜ç¡®å†…å­˜é™åˆ¶ï¼Œä½†é¢‘ç¹ç£ç›˜æº¢å†™å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚                 |
| **ç´¢å¼•æ”¯æŒ**     | **å¼ºä¾èµ–ç´¢å¼•**ï¼š`$match`ã€`$sort` ç­‰é˜¶æ®µå¯å‘½ä¸­ç´¢å¼•åŠ é€Ÿã€‚  | ä»…è¾“å…¥é˜¶æ®µæ”¯æŒç´¢å¼•ï¼ŒReduce é˜¶æ®µæ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚                |

> **æ€§èƒ½å®æµ‹å¯¹æ¯”**ï¼šç›¸åŒèšåˆä»»åŠ¡ï¼ˆå¦‚åˆ†ç»„ç»Ÿè®¡ï¼‰ï¼Œèšåˆç®¡é“çš„é€Ÿåº¦é€šå¸¸æ¯” MapReduce **å¿« 5â€“10 å€**ï¼Œå°¤å…¶åœ¨ TB çº§æ•°æ®ä¸‹å·®å¼‚æ›´æ˜¾è‘—ã€‚

------

### ğŸ“Š **äºŒã€èµ„æºæ¶ˆè€—å¯¹æ¯”**

1. **CPU ä¸å†…å­˜**
   - **èšåˆç®¡é“**ï¼šCPU å¼€é”€ä½ï¼Œå†…å­˜å ç”¨å¯æ§ï¼ˆé€šè¿‡ `$project` æå‰è¿‡æ»¤å­—æ®µï¼‰ã€‚
   - **MapReduce**ï¼šJS å¼•æ“è§£ææ¶ˆè€—å¤§é‡ CPUï¼Œä¸” Map/Reduce é—´æ•°æ®äº¤æ¢æ˜“å¯¼è‡´å†…å­˜æº¢å‡ºã€‚
2. **ç£ç›˜ I/O**
   - **èšåˆç®¡é“**ï¼šä»…åœ¨ `allowDiskUse` å¯ç”¨æ—¶å†™ä¸´æ—¶æ–‡ä»¶ã€‚
   - **MapReduce**ï¼š**å¼ºåˆ¶å†™ç£ç›˜**ï¼šMap è¾“å‡ºã€Reduce è¾“å…¥/è¾“å‡ºå‡éœ€è½ç›˜ï¼ŒI/O ç“¶é¢ˆæ˜æ˜¾ã€‚
3. **ç½‘ç»œå¼€é”€**
   - MapReduce éœ€è·¨åˆ†ç‰‡ä¼ è¾“å¤§é‡ä¸­é—´æ•°æ®ï¼Œè€Œèšåˆç®¡é“å¯é€šè¿‡åˆ†ç‰‡é”®ä¸‹æ¨è®¡ç®—ï¼ˆå¦‚ `$match` æå‰è¿‡æ»¤ï¼‰å‡å°‘è·¨èŠ‚ç‚¹æµé‡ã€‚

------

### ğŸ”§ **ä¸‰ã€æ‰©å±•æ€§ä¸å¹¶å‘èƒ½åŠ›**

| **ç»´åº¦**         | **èšåˆç®¡é“**                                            | **MapReduce**                                             |
| ---------------- | ------------------------------------------------------- | --------------------------------------------------------- |
| **åˆ†ç‰‡é›†ç¾¤ä¼˜åŒ–** | æ”¯æŒ**åˆ†ç‰‡æ„ŸçŸ¥**ï¼š`$group` è‡ªåŠ¨å¹¶è¡ŒåŒ–ï¼Œå‡è¡¡å™¨åˆ†é…ä»»åŠ¡ã€‚ | éœ€æ‰‹åŠ¨å¤„ç†åˆ†ç‰‡æ•°æ®åˆå¹¶ï¼Œæ˜“å‡ºç°è®¡ç®—å€¾æ–œã€‚                  |
| **é”æœºåˆ¶**       | **æ–‡æ¡£çº§é”**ï¼Œè¯»å†™å¹¶å‘åº¦é«˜ã€‚                            | **å…¨å±€å†™é”**ï¼šReduce è¾“å‡ºé˜¶æ®µé”æ•´ä¸ªæ•°æ®åº“ï¼Œé˜»å¡å…¶ä»–æ“ä½œã€‚ |
| **å®æ—¶æ€§**       | é€‚åˆ**å®æ—¶æŸ¥è¯¢**ï¼ˆæ¯«ç§’çº§å“åº”ï¼‰ã€‚                        | ä»…é€‚åˆ**ç¦»çº¿æ‰¹å¤„ç†**ï¼ˆåˆ†é’Ÿçº§å»¶è¿Ÿï¼‰ã€‚                      |

------

### âš–ï¸ **å››ã€é€‚ç”¨åœºæ™¯å¯¹æ¯”**

| **åœºæ™¯**           | **æ¨èæ–¹æ¡ˆ**        | **åŸå› **                                               |
| ------------------ | ------------------- | ------------------------------------------------------ |
| **å®æ—¶æ•°æ®åˆ†æ**   | èšåˆç®¡é“            | ä½å»¶è¿Ÿå“åº”ï¼Œæ”¯æŒå¤æ‚æµæ°´çº¿ï¼ˆå¦‚ `$facet` å¤šç»´åº¦ç»Ÿè®¡ï¼‰ã€‚ |
| **å¤§è§„æ¨¡ç¦»çº¿è®¡ç®—** | MapReduce           | å¯å¤„ç†è¶…å¤§æ•°æ®é›†ï¼ˆPB çº§ï¼‰ï¼Œä½†éœ€å®¹å¿é«˜å»¶è¿Ÿã€‚            |
| **è‡ªå®šä¹‰èšåˆé€»è¾‘** | MapReduce           | æ”¯æŒ JavaScript ç¼–å†™å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è¿­ä»£è®¡ç®—ï¼‰ã€‚       |
| **é«˜é¢‘å¢é‡æ›´æ–°**   | èšåˆç®¡é“ + `$merge` | æ”¯æŒç»“æœé›†å¢é‡æ›´æ–°ï¼Œé¿å…å…¨é‡é‡ç®—ã€‚                     |

------

### ğŸ› ï¸ **äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å·®å¼‚**

1. **èšåˆç®¡é“ä¼˜åŒ–**
   - **é˜¶æ®µé¡ºåº**ï¼š`$match` â†’ `$project` â†’ `$sort`ï¼ˆåˆ©ç”¨ ESR ç´¢å¼•åŸåˆ™ï¼‰ã€‚
   - **ç´¢å¼•è®¾è®¡**ï¼šä¸º `$match` å­—æ®µåˆ›å»ºå¤åˆç´¢å¼•ï¼ˆå¦‚ `status + created_at`ï¼‰ã€‚
   - **åˆ†é¡µæŠ€å·§**ï¼šç”¨ `$facet` åŒæ—¶è¿”å›æ•°æ®å’Œæ€»æ•°ï¼Œé¿å…äºŒæ¬¡æŸ¥è¯¢ã€‚
2. **MapReduce ä¼˜åŒ–**
   - **Combiner é¢„èšåˆ**ï¼šåœ¨ Map ç«¯å±€éƒ¨åˆå¹¶æ•°æ®ï¼Œå‡å°‘ Reduce è´Ÿè½½ã€‚
   - **è¾“å‡ºå®šå‘**ï¼šç»“æœå†™å…¥åˆ†ç‰‡é›†åˆï¼Œå¹¶è¡Œå†™å…¥åŠ é€Ÿã€‚

------

### ğŸ’ **æ€»ç»“ï¼šæ ¸å¿ƒå·®å¼‚ä¸é€‰å‹å»ºè®®**

| **å¯¹æ¯”ç»´åº¦** | **èšåˆç®¡é“**       | **MapReduce**      |
| ------------ | ------------------ | ------------------ |
| **æ€§èƒ½**     | â­â­â­â­â­ï¼ˆé«˜æ•ˆå®æ—¶ï¼‰  | â­â­ï¼ˆé«˜å»¶è¿Ÿç¦»çº¿ï¼‰   |
| **å¼€å‘æ•ˆç‡** | â­â­â­â­ï¼ˆå£°æ˜å¼è¯­æ³•ï¼‰ | â­â­ï¼ˆéœ€å†™ JS å‡½æ•°ï¼‰ |
| **èµ„æºæ¶ˆè€—** | â­â­â­â­ï¼ˆä½ I/Oï¼‰     | â­ï¼ˆé«˜ç£ç›˜/CPUï¼‰    |
| **çµæ´»æ€§**   | â­â­â­ï¼ˆå›ºå®šæ“ä½œç¬¦ï¼‰  | â­â­â­â­ï¼ˆè‡ªå®šä¹‰é€»è¾‘ï¼‰ |

**é€‰å‹å»ºè®®**ï¼š
âœ… â€‹**é»˜è®¤é€‰æ‹©èšåˆç®¡é“**â€‹ï¼šé€‚ç”¨äº 90% çš„åœºæ™¯ï¼ˆå®æ—¶ç»Ÿè®¡ã€æ•°æ®è½¬æ¢ã€å…³è”åˆ†æï¼‰ã€‚
âš ï¸ â€‹**ä»…å½“ä»¥ä¸‹æƒ…å†µç”¨ MapReduce**â€‹ï¼š

- éœ€è‡ªå®šä¹‰å¤æ‚ç®—æ³•ï¼ˆå¦‚æœºå™¨å­¦ä¹ ç‰¹å¾å·¥ç¨‹ï¼‰ã€‚
- å¤„ç†è¶…å¤§æ•°æ®é›†ä¸”å¯æ¥å—å°æ—¶çº§å»¶è¿Ÿã€‚
- å†å²ç³»ç»Ÿå…¼å®¹æ€§è¦æ±‚ã€‚

> å¯é€šè¿‡ `explain()` åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œæˆ–ä½¿ç”¨ MongoDB Compass å¯è§†åŒ–éªŒè¯ç®¡é“æ€§èƒ½ã€‚

## Operations

[Learn MongoDB in 1 hour ğŸƒ](https://www.youtube.com/watch?v=c2M-rlkkT5o)
