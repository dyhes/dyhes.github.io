<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='todo for now\n智能总结 微服务改造 参考\nSpring Boot + Vue3 Post SSE + WebFlux 实现流式 AI 对话 SSE流 在Spring Boot服务端中，通过CURL发送请求并处理SSE（Server-Sent Events）流式返回给客户端，需要结合服务端SSE实现与客户端请求转发机制。以下是具体实现步骤和代码示例：\n服务端实现SSE推送 使用SseEmitter创建SSE接口 通过SseEmitter实现服务端推送能力，每个客户端请求会创建一个长连接，支持流式返回数据。\n@RestController public class SseController { private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>(); @GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE) public SseEmitter streamData() { SseEmitter emitter = new SseEmitter(-1L); // 设置无限超时 String clientId = UUID.randomUUID().toString(); emitters.put(clientId, emitter); // 监听连接关闭或超时事件 emitter.onCompletion(() -> emitters.remove(clientId)); emitter.onTimeout(() -> emitters.remove(clientId)); return emitter; } } 转发外部SSE流到客户端 服务端作为客户端，通过OkHttp请求外部SSE服务，并将接收到的数据转发给前端：\n'><title>【Postopia Dev Log】Week 13</title><link rel=canonical href=https://dyhes.github.io/p/postopia-dev-logweek-13/><link rel=stylesheet href=/scss/style.min.f7091bff8043bd3e53b22be6c05dd86b506e8dec4d0d75d249d2dfb0fe074a46.css><meta property='og:title' content="【Postopia Dev Log】Week 13"><meta property='og:description' content='todo for now\n智能总结 微服务改造 参考\nSpring Boot + Vue3 Post SSE + WebFlux 实现流式 AI 对话 SSE流 在Spring Boot服务端中，通过CURL发送请求并处理SSE（Server-Sent Events）流式返回给客户端，需要结合服务端SSE实现与客户端请求转发机制。以下是具体实现步骤和代码示例：\n服务端实现SSE推送 使用SseEmitter创建SSE接口 通过SseEmitter实现服务端推送能力，每个客户端请求会创建一个长连接，支持流式返回数据。\n@RestController public class SseController { private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>(); @GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE) public SseEmitter streamData() { SseEmitter emitter = new SseEmitter(-1L); // 设置无限超时 String clientId = UUID.randomUUID().toString(); emitters.put(clientId, emitter); // 监听连接关闭或超时事件 emitter.onCompletion(() -> emitters.remove(clientId)); emitter.onTimeout(() -> emitters.remove(clientId)); return emitter; } } 转发外部SSE流到客户端 服务端作为客户端，通过OkHttp请求外部SSE服务，并将接收到的数据转发给前端：\n'><meta property='og:url' content='https://dyhes.github.io/p/postopia-dev-logweek-13/'><meta property='og:site_name' content='飞鸿踏雪泥'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Postopia'><meta property='article:published_time' content='2025-05-05T00:00:00+00:00'><meta property='article:modified_time' content='2025-10-22T16:27:30+08:00'><meta name=twitter:title content="【Postopia Dev Log】Week 13"><meta name=twitter:description content='todo for now\n智能总结 微服务改造 参考\nSpring Boot + Vue3 Post SSE + WebFlux 实现流式 AI 对话 SSE流 在Spring Boot服务端中，通过CURL发送请求并处理SSE（Server-Sent Events）流式返回给客户端，需要结合服务端SSE实现与客户端请求转发机制。以下是具体实现步骤和代码示例：\n服务端实现SSE推送 使用SseEmitter创建SSE接口 通过SseEmitter实现服务端推送能力，每个客户端请求会创建一个长连接，支持流式返回数据。\n@RestController public class SseController { private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>(); @GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE) public SseEmitter streamData() { SseEmitter emitter = new SseEmitter(-1L); // 设置无限超时 String clientId = UUID.randomUUID().toString(); emitters.put(clientId, emitter); // 监听连接关闭或超时事件 emitter.onCompletion(() -> emitters.remove(clientId)); emitter.onTimeout(() -> emitters.remove(clientId)); return emitter; } } 转发外部SSE流到客户端 服务端作为客户端，通过OkHttp请求外部SSE服务，并将接收到的数据转发给前端：\n'><link rel="shortcut icon" href=/github.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b567f26f71c49c33.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>飞鸿踏雪泥</a></h1><h2 class=site-description>没有记录，就没有发生</h2></div></header><ol class=menu-social><li><a href=https://leetcode.cn/u/dyhes/ target=_blank title=LeetCode rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg></a></li><li><a href=https://github.com/dyhes target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:dyheslin@gmail.com target=_blank title=Gmail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-gmail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li><li><a href=mailto:1325574784@qq.com target=_blank title=Mail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 19H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v5.5"/><path d="M3 7l9 6 9-6"/><path d="M19 16l-2 3h4l-2 3"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/categories/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/tags/><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Tags</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#sse流>SSE流</a><ol><li><a href=#服务端实现sse推送>服务端实现SSE推送</a><ol><li><a href=#使用sseemitter创建sse接口>使用<code>SseEmitter</code>创建SSE接口</a></li><li><a href=#转发外部sse流到客户端>转发外部SSE流到客户端</a></li></ol></li><li><a href=#客户端通过curl测试>客户端通过CURL测试</a><ol><li><a href=#发送curl请求>发送CURL请求</a></li><li><a href=#处理流式响应>处理流式响应</a></li></ol></li><li><a href=#关键配置与注意事项>关键配置与注意事项</a></li><li><a href=#完整流程示例>完整流程示例</a></li><li><a href=#优化建议>优化建议</a></li></ol></li><li><a href=#webflux与sseemitter>WebFlux与SseEmitter</a><ol><li><ol><li><a href=#底层技术与编程模型><strong>底层技术与编程模型</strong></a></li><li><a href=#并发能力与资源消耗><strong>并发能力与资源消耗</strong></a></li><li><a href=#协议支持与扩展性><strong>协议支持与扩展性</strong></a></li><li><a href=#错误处理与背压机制><strong>错误处理与背压机制</strong></a></li><li><a href=#适用场景><strong>适用场景</strong></a></li></ol></li><li><a href=#总结对比表>总结对比表</a></li><li><a href=#选择建议>选择建议</a></li></ol></li><li><a href=#server-sent-eventssse结合-spring-security>Server-Sent Events（SSE）结合 Spring Security</a><ol><li><a href=#错误原因分析>错误原因分析</a><ol><li><a href=#响应提前提交><strong>响应提前提交</strong></a></li><li><a href=#spring-security默认行为冲突><strong>Spring Security默认行为冲突</strong></a></li></ol></li><li><a href=#解决方案>解决方案</a><ol><li><a href=#配置spring-security以兼容sse><strong>配置Spring Security以兼容SSE</strong></a></li><li><a href=#调整异步处理逻辑><strong>调整异步处理逻辑</strong></a></li><li><a href=#使用响应式编程模型推荐><strong>使用响应式编程模型（推荐）</strong></a></li><li><a href=#处理sse流的异常><strong>处理SSE流的异常</strong></a></li></ol></li><li><a href=#验证与调试>验证与调试</a></li><li><a href=#扩展建议>扩展建议</a></li></ol></li><li><a href=#spring-boot-请求>Spring boot 请求</a><ol><li><a href=#使用resttemplate同步请求><strong>使用RestTemplate（同步请求）</strong></a></li><li><a href=#使用webclient异步响应式请求><strong>使用WebClient（异步/响应式请求）</strong></a></li><li><a href=#使用feign声明式http客户端><strong>使用Feign（声明式HTTP客户端）</strong></a></li><li><a href=#第三方http客户端灵活扩展><strong>第三方HTTP客户端（灵活扩展）</strong></a><ol><li><a href=#apache-httpclient><strong>Apache HttpClient</strong></a></li><li><a href=#okhttp><strong>OkHttp</strong></a></li></ol></li><li><a href=#选择建议-1><strong>选择建议</strong></a></li></ol></li><li><a href=#applicationyaml更新问题>Application.yaml更新问题</a><ol><li><a href=#仅修改外部配置文件并重启><strong>仅修改外部配置文件并重启</strong></a></li><li><a href=#动态刷新配置无需重启><strong>动态刷新配置（无需重启）</strong></a></li><li><a href=#开发环境热部署自动重启><strong>开发环境热部署（自动重启）</strong></a></li><li><a href=#总结><strong>总结</strong></a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/moon/ style=background-color:#b7ae8f;color:>月满西楼
</a><a href=/categories/snow/ style=background-color:#aa6a4c;color:>踏雪泥</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/postopia-dev-logweek-13/>【Postopia Dev Log】Week 13</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 05, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>todo for now</p><ul><li><del>智能总结</del></li><li>微服务改造</li></ul><p>参考</p><ul><li><a class=link href="http://mp.weixin.qq.com/s?__biz=MzA4MDc3MzE1NQ==&amp;mid=2653999326&amp;idx=3&amp;sn=1bdd6fa1a24f8b21edc120309eee1bd5&amp;chksm=85e9ad7e7cf0c40642f302b82e270295d3752e45cd74c8839503bf94b05f6a4a256978021edc#rd" target=_blank rel=noopener>Spring Boot + Vue3 Post SSE + WebFlux 实现流式 AI 对话</a></li></ul><h2 id=sse流>SSE流</h2><p>在Spring Boot服务端中，通过CURL发送请求并处理SSE（Server-Sent Events）流式返回给客户端，需要结合<strong>服务端SSE实现</strong>与<strong>客户端请求转发机制</strong>。以下是具体实现步骤和代码示例：</p><hr><h3 id=服务端实现sse推送>服务端实现SSE推送</h3><h4 id=使用sseemitter创建sse接口>使用<code>SseEmitter</code>创建SSE接口</h4><p>通过<code>SseEmitter</code>实现服务端推送能力，每个客户端请求会创建一个长连接，支持流式返回数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SseController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>SseEmitter</span><span class=o>&gt;</span><span class=w> </span><span class=n>emitters</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;/stream&#34;</span><span class=p>,</span><span class=w> </span><span class=n>produces</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaType</span><span class=p>.</span><span class=na>TEXT_EVENT_STREAM_VALUE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SseEmitter</span><span class=w> </span><span class=nf>streamData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SseEmitter</span><span class=w> </span><span class=n>emitter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SseEmitter</span><span class=p>(</span><span class=o>-</span><span class=n>1L</span><span class=p>);</span><span class=w> </span><span class=c1>// 设置无限超时</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>clientId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emitters</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>clientId</span><span class=p>,</span><span class=w> </span><span class=n>emitter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 监听连接关闭或超时事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emitter</span><span class=p>.</span><span class=na>onCompletion</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>emitters</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>clientId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emitter</span><span class=p>.</span><span class=na>onTimeout</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>emitters</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>clientId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>emitter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=转发外部sse流到客户端>转发外部SSE流到客户端</h4><p>服务端作为客户端，通过<code>OkHttp</code>请求外部SSE服务，并将接收到的数据转发给前端：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>forwardExternalSSE</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>externalUrl</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>clientId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>OkHttpClient</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OkHttpClient</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>.</span><span class=na>Builder</span><span class=p>().</span><span class=na>url</span><span class=p>(</span><span class=n>externalUrl</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EventSource</span><span class=w> </span><span class=n>eventSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EventSources</span><span class=p>.</span><span class=na>createFactory</span><span class=p>(</span><span class=n>client</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>newEventSource</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EventSourceListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onEvent</span><span class=p>(</span><span class=n>EventSource</span><span class=w> </span><span class=n>eventSource</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>type</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SseEmitter</span><span class=w> </span><span class=n>emitter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>emitters</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>clientId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>emitter</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>emitter</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>SseEmitter</span><span class=p>.</span><span class=na>event</span><span class=p>().</span><span class=na>data</span><span class=p>(</span><span class=n>data</span><span class=p>));</span><span class=w> </span><span class=c1>// 转发数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>emitter</span><span class=p>.</span><span class=na>completeWithError</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onFailure</span><span class=p>(</span><span class=n>EventSource</span><span class=w> </span><span class=n>eventSource</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>emitters</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>clientId</span><span class=p>).</span><span class=na>completeWithError</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=客户端通过curl测试>客户端通过CURL测试</h3><h4 id=发送curl请求>发送CURL请求</h4><p>客户端通过以下命令订阅服务端的SSE流：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -v http://localhost:8080/stream
</span></span></code></pre></div><p>服务端会返回<code>text/event-stream</code>格式的响应头，并持续推送数据。</p><h4 id=处理流式响应>处理流式响应</h4><p>客户端会以事件流形式接收数据，格式示例：</p><pre tabindex=0><code>data: {&#34;message&#34;: &#34;Event 1&#34;}

data: {&#34;message&#34;: &#34;Event 2&#34;}
</code></pre><hr><h3 id=关键配置与注意事项>关键配置与注意事项</h3><ol><li><p><strong>依赖配置</strong><br>需添加<code>spring-boot-starter-web</code>和<code>OkHttp</code>相关依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.squareup.okhttp3<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>okhttp-sse<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>4.10.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><p><strong>超时管理</strong></p><ul><li>若外部SSE服务中断，需通过<code>SseEmitter.onError()</code>通知客户端。</li><li>使用<code>SseEmitter(-1L)</code>禁用默认超时，避免因长时间无数据触发<code>AsyncRequestTimeoutException</code>。</li></ul></li><li><p><strong>多客户端支持</strong><br>通过<code>ConcurrentHashMap</code>管理多个<code>SseEmitter</code>实例，确保线程安全。</p></li><li><p><strong>错误处理</strong></p><ul><li>外部SSE连接失败时，调用<code>emitter.completeWithError()</code>终止客户端连接。</li><li>客户端主动断开时，触发<code>onCompletion()</code>清理资源。</li></ul></li></ol><hr><h3 id=完整流程示例>完整流程示例</h3><ol><li><p><strong>客户端发起请求</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/stream
</span></span></code></pre></div></li><li><p><strong>服务端行为</strong></p><ul><li>创建<code>SseEmitter</code>并注册到管理器。</li><li>启动<code>OkHttp</code>订阅外部SSE服务（如大模型API）。</li><li>将外部事件实时转发至客户端。</li></ul></li><li><p><strong>数据流传递</strong></p><pre tabindex=0><code>外部服务 -&gt; Spring Boot服务端 -&gt; 客户端
</code></pre></li></ol><hr><h3 id=优化建议>优化建议</h3><ul><li><strong>异步非阻塞</strong>：使用<code>WebFlux</code>的<code>Flux&lt;ServerSentEvent></code>替代<code>SseEmitter</code>，实现响应式流处理。</li><li><strong>消息压缩</strong>：对高频数据启用GZIP压缩，减少网络负载。</li><li><strong>心跳机制</strong>：定期发送空事件保持连接活跃，避免被代理服务器中断。</li></ul><p>通过上述方案，可实现在Spring Boot中通过CURL请求触发服务端SSE推送，并完成流式数据的中转。具体实现需结合业务场景调整超时和错误处理逻辑。</p><h2 id=webflux与sseemitter>WebFlux与SseEmitter</h2><p>在Spring生态中，<strong>WebFlux</strong>和<strong>SseEmitter</strong>均能实现服务器推送事件（SSE），但两者在技术实现、性能表现及适用场景上存在显著差异。以下是具体对比：</p><hr><h4 id=底层技术与编程模型><strong>底层技术与编程模型</strong></h4><ul><li><p><strong>WebFlux</strong><br>基于Reactor响应式编程模型，采用<strong>非阻塞I/O</strong>（如Netty或Reactor-Netty），通过<code>Flux&lt;ServerSentEvent></code>处理数据流。开发者通过声明式代码组合流操作（如<code>map</code>、<code>filter</code>），无需手动管理线程，天然支持背压（Backpressure）机制，避免数据过载。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/sse-flux&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>ServerSentEvent</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>handleSseFlux</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>interval</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMillis</span><span class=p>(</span><span class=n>100</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>sequence</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ServerSentEvent</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=s>&#34;SSE in WebFlux - &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sequence</span><span class=p>).</span><span class=na>build</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>SseEmitter</strong><br>属于Spring MVC框架，依赖<strong>Servlet的异步处理机制</strong>（阻塞I/O模型），需手动创建线程池或异步任务推送数据。编程模型为同步模式，开发者需自行处理线程调度与资源释放。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/sse-mvc&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>SseEmitter</span><span class=w> </span><span class=nf>handleSse</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SseEmitter</span><span class=w> </span><span class=n>emitter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SseEmitter</span><span class=p>(</span><span class=n>30_000L</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>emitter</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=s>&#34;Event &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>emitter</span><span class=p>.</span><span class=na>complete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* 异常处理 */</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>emitter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul><hr><h4 id=并发能力与资源消耗><strong>并发能力与资源消耗</strong></h4><ul><li><p><strong>WebFlux</strong></p><ul><li><strong>高并发</strong>：基于EventLoop线程模型，单线程可处理数万连接，适合IoT、实时聊天等高并发场景。</li><li><strong>低资源消耗</strong>：占用少量线程（如CPU核心数），减少上下文切换开销。</li></ul></li><li><p><strong>SseEmitter</strong></p><ul><li><strong>低并发</strong>：每个连接占用一个线程，线程池容量限制导致并发上限低（通常数百至数千）。</li><li><strong>高资源消耗</strong>：线程数随连接数线性增长，易引发资源耗尽问题。</li></ul></li></ul><hr><h4 id=协议支持与扩展性><strong>协议支持与扩展性</strong></h4><ul><li><p><strong>WebFlux</strong><br>支持多种协议：<strong>SSE</strong>、<strong>WebSocket</strong>、HTTP/2等，可灵活适配不同实时通信需求。此外，无缝集成响应式生态组件（如R2DBC、WebClient）。</p></li><li><p><strong>SseEmitter</strong><br>仅支持SSE协议，功能单一，扩展性受限。</p></li></ul><hr><h4 id=错误处理与背压机制><strong>错误处理与背压机制</strong></h4><ul><li><p><strong>WebFlux</strong></p><ul><li><strong>背压支持</strong>：通过<code>Flux</code>自动调节数据流速，防止客户端过载。</li><li><strong>健壮的错误处理</strong>：提供<code>onErrorResume</code>等操作符，可链式定义异常恢复逻辑。</li></ul></li><li><p><strong>SseEmitter</strong></p><ul><li><strong>无背压控制</strong>：需开发者自行实现流量限制逻辑。</li><li><strong>手动错误处理</strong>：依赖<code>try-catch</code>捕获异常并通过<code>emitter.completeWithError()</code>通知客户端。</li></ul></li></ul><hr><h4 id=适用场景><strong>适用场景</strong></h4><ul><li><p><strong>WebFlux</strong></p><ul><li>高并发实时应用（如股票行情、AI对话）。</li><li>微服务架构下的流式数据处理（如日志推送、实时监控）。</li></ul></li><li><p><strong>SseEmitter</strong></p><ul><li>传统Spring MVC项目中的简单推送需求（如低频率通知、小型应用）。</li></ul></li></ul><hr><h3 id=总结对比表>总结对比表</h3><div class=table-wrapper><table><thead><tr><th>特性</th><th>WebFlux (<code>Flux</code>)</th><th>SseEmitter</th></tr></thead><tbody><tr><td><strong>底层技术</strong></td><td>非阻塞I/O（Reactor-Netty）</td><td>阻塞I/O（Servlet异步）</td></tr><tr><td><strong>编程模型</strong></td><td>声明式响应式编程</td><td>同步编程，需手动管理线程</td></tr><tr><td><strong>并发能力</strong></td><td>支持10K+连接</td><td>受限于线程池容量（通常&lt;1K）</td></tr><tr><td><strong>资源消耗</strong></td><td>低（少量EventLoop线程）</td><td>高（每个连接占用一个线程）</td></tr><tr><td><strong>协议支持</strong></td><td>SSE、WebSocket、HTTP/2等</td><td>仅SSE</td></tr><tr><td><strong>背压控制</strong></td><td>原生支持</td><td>需自行实现</td></tr><tr><td><strong>适用场景</strong></td><td>高并发实时系统、响应式微服务</td><td>传统MVC应用、低频推送需求</td></tr></tbody></table></div><hr><h3 id=选择建议>选择建议</h3><ul><li><strong>优先WebFlux</strong>：若项目需要高并发、低延迟，或已采用响应式架构（如Spring Cloud Gateway）。</li><li><strong>使用SseEmitter</strong>：仅需简单SSE功能且无法迁移至WebFlux的传统Spring MVC项目。</li></ul><p>通过以上对比，开发者可根据具体需求选择合适技术方案，优化系统性能与开发效率。</p><h2 id=server-sent-eventssse结合-spring-security>Server-Sent Events（SSE）结合 Spring Security</h2><p>在Spring Boot应用中，当使用Server-Sent Events（SSE）并结合Spring Security时，遇到<code>Unable to handle the Spring Security Exception because the response is already committed</code>错误，通常是由<strong>响应提前提交导致安全异常处理冲突</strong>引起的。以下是具体原因及解决方案：</p><hr><h3 id=错误原因分析>错误原因分析</h3><h4 id=响应提前提交><strong>响应提前提交</strong></h4><ul><li>你的代码中使用了<code>Flux.create</code>和<code>CompletableFuture.runAsync</code>开启异步线程处理SSE流。<strong>若异步线程中已经通过<code>sink</code>开始发送数据（即响应体已开始写入），而Spring Security在过滤器链中检测到未认证/未授权的请求并尝试抛出异常</strong>（如<code>AccessDeniedException</code>），此时响应头可能已部分提交，导致无法修改状态码或重定向。</li><li><strong>安全拦截器与异步线程的竞争条件</strong>：主线程的Spring Security过滤器（如<code>FilterSecurityInterceptor</code>）可能在异步线程发送数据后才抛出异常，此时响应已不可修改。</li></ul><h4 id=spring-security默认行为冲突><strong>Spring Security默认行为冲突</strong></h4><ul><li>默认情况下，Spring Security对未认证请求会重定向到登录页（状态码302），而SSE需要保持长连接（状态码200）。<strong>响应头的冲突会导致异常无法正确处理</strong>。</li></ul><hr><h3 id=解决方案>解决方案</h3><h4 id=配置spring-security以兼容sse><strong>配置Spring Security以兼容SSE</strong></h4><p>禁用默认的重定向逻辑，改用<strong>直接返回HTTP状态码</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableWebSecurity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SecurityFilterChain</span><span class=w> </span><span class=nf>securityFilterChain</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>authorizeHttpRequests</span><span class=p>(</span><span class=n>auth</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>requestMatchers</span><span class=p>(</span><span class=s>&#34;/summary&#34;</span><span class=p>).</span><span class=na>permitAll</span><span class=p>()</span><span class=w> </span><span class=c1>// 根据需求调整权限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>exceptionHandling</span><span class=p>(</span><span class=n>ex</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 禁用重定向，直接返回401/403状态码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authenticationEntryPoint</span><span class=p>((</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>authException</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=p>.</span><span class=na>sendError</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>.</span><span class=na>value</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;Unauthorized&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>accessDeniedHandler</span><span class=p>((</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>accessDeniedException</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=p>.</span><span class=na>sendError</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>FORBIDDEN</span><span class=p>.</span><span class=na>value</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;Forbidden&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>csrf</span><span class=p>(</span><span class=n>csrf</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>csrf</span><span class=p>.</span><span class=na>disable</span><span class=p>());</span><span class=w> </span><span class=c1>// 根据需求决定是否禁用CSRF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>http</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=调整异步处理逻辑><strong>调整异步处理逻辑</strong></h4><p>确保<strong>安全验证完成后再启动异步任务</strong>，避免响应提前提交：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;summary&#34;</span><span class=p>,</span><span class=w> </span><span class=n>produces</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaType</span><span class=p>.</span><span class=na>TEXT_EVENT_STREAM_VALUE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>ServerSentEvent</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>summary</span><span class=p>(</span><span class=nd>@RequestParam</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>postId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>sink</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 在主线程完成安全验证后再启动异步任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getAuthentication</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!</span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getAuthentication</span><span class=p>().</span><span class=na>isAuthenticated</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sink</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ResponseStatusException</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>UNAUTHORIZED</span><span class=p>,</span><span class=w> </span><span class=s>&#34;未认证&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>runAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>intelligenceService</span><span class=p>.</span><span class=na>summary</span><span class=p>(</span><span class=n>sink</span><span class=p>,</span><span class=w> </span><span class=n>postId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=使用响应式编程模型推荐><strong>使用响应式编程模型（推荐）</strong></h4><p>避免混合阻塞式线程（如<code>CompletableFuture</code>）与响应式流（<code>Flux</code>），改用<code>Schedulers</code>控制线程：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;summary&#34;</span><span class=p>,</span><span class=w> </span><span class=n>produces</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaType</span><span class=p>.</span><span class=na>TEXT_EVENT_STREAM_VALUE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>ServerSentEvent</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>summary</span><span class=p>(</span><span class=nd>@RequestParam</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>postId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>using</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>intelligenceService</span><span class=p>.</span><span class=na>initSummary</span><span class=p>(</span><span class=n>postId</span><span class=p>),</span><span class=w> </span><span class=c1>// 初始化资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>resource</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>fromIterable</span><span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>getEvents</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>publishOn</span><span class=p>(</span><span class=n>Schedulers</span><span class=p>.</span><span class=na>boundedElastic</span><span class=p>())</span><span class=w> </span><span class=c1>// 异步处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>event</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ServerSentEvent</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=n>event</span><span class=p>).</span><span class=na>build</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>resource</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>.</span><span class=na>close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>).</span><span class=na>doOnError</span><span class=p>(</span><span class=n>ex</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;SSE流异常&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=处理sse流的异常><strong>处理SSE流的异常</strong></h4><p>通过<code>doOnError</code>捕获并处理异步操作中的异常，避免响应提前关闭：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>summary</span><span class=p>(</span><span class=n>Sink</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>sink</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>postId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 模拟业务逻辑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sink</span><span class=p>.</span><span class=na>isCancelled</span><span class=p>())</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w> </span><span class=c1>// 检查sink是否已关闭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sink</span><span class=p>.</span><span class=na>next</span><span class=p>(</span><span class=s>&#34;Event &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sink</span><span class=p>.</span><span class=na>complete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sink</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ResponseStatusException</span><span class=p>(</span><span class=n>HttpStatus</span><span class=p>.</span><span class=na>INTERNAL_SERVER_ERROR</span><span class=p>,</span><span class=w> </span><span class=s>&#34;处理失败&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=验证与调试>验证与调试</h3><ol><li><strong>测试未认证场景</strong>：直接访问<code>/summary</code>接口应返回401状态码，而非触发SSE流。</li><li><strong>检查线程模型</strong>：确保异步操作在安全验证通过后执行（可通过日志或断点验证）。</li><li><strong>监控响应头</strong>：使用工具（如Postman）确认SSE响应头为<code>Content-Type: text/event-stream</code>且状态码为200。</li></ol><hr><h3 id=扩展建议>扩展建议</h3><ul><li><strong>统一异常处理</strong>：结合<code>@ControllerAdvice</code>全局捕获SSE相关异常。</li><li><strong>响应式安全配置</strong>：若使用WebFlux，需配置<code>ReactiveSecurityWebFilterChain</code>。</li><li><strong>性能优化</strong>：使用背压（Backpressure）控制事件流速，避免资源耗尽。</li></ul><p>通过上述方案，可解决SSE与Spring Security的响应提交冲突问题，同时保持流式数据的高效传输。</p><h2 id=spring-boot-请求>Spring boot 请求</h2><p>在Spring Boot应用中建立网络请求，可以通过多种方式实现。以下是常用的几种方法及其实现步骤，结合官方推荐和第三方库进行说明：</p><hr><h3 id=使用resttemplate同步请求><strong>使用RestTemplate（同步请求）</strong></h3><p><strong>适用场景</strong>：传统同步HTTP请求，适合简单接口调用。<br><strong>步骤</strong>：</p><ol><li><strong>添加依赖</strong>：确保<code>spring-boot-starter-web</code>已引入（默认包含）。</li><li><strong>配置Bean</strong>：在配置类中定义<code>RestTemplate</code>的Bean：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RestTemplateConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RestTemplate</span><span class=w> </span><span class=nf>restTemplate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RestTemplate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>发送请求</strong>：<ul><li><strong>GET请求</strong>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>RestTemplate</span><span class=w> </span><span class=n>restTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;https://api.example.com/data&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>POST请求</strong>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>postData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;https://api.example.com/post&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>requestBody</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>requestBody</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;key&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;value&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>restTemplate</span><span class=p>.</span><span class=na>postForObject</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>requestBody</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul></li></ol><p><strong>注意</strong>：RestTemplate在Spring 5后虽仍可用，但官方推荐WebClient作为替代。</p><hr><h3 id=使用webclient异步响应式请求><strong>使用WebClient（异步/响应式请求）</strong></h3><p><strong>适用场景</strong>：非阻塞、响应式编程，支持同步/异步调用。<br><strong>步骤</strong>：</p><ol><li><strong>添加依赖</strong>：引入<code>spring-boot-starter-webflux</code>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><strong>配置Bean</strong>：通过Builder自定义超时、连接池等：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>WebClient</span><span class=w> </span><span class=nf>webClient</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>WebClient</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>baseUrl</span><span class=p>(</span><span class=s>&#34;https://api.example.com&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>defaultHeader</span><span class=p>(</span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>CONTENT_TYPE</span><span class=p>,</span><span class=w> </span><span class=n>MediaType</span><span class=p>.</span><span class=na>APPLICATION_JSON_VALUE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>发送请求</strong>：<ul><li><strong>同步调用</strong>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>syncGet</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>webClient</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>uri</span><span class=p>(</span><span class=s>&#34;/data&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>retrieve</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>bodyToMono</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>block</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>异步调用</strong>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>asyncGet</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>webClient</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>uri</span><span class=p>(</span><span class=s>&#34;/data&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>retrieve</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>bodyToMono</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul></li></ol><hr><h3 id=使用feign声明式http客户端><strong>使用Feign（声明式HTTP客户端）</strong></h3><p><strong>适用场景</strong>：简化RESTful服务调用，适合微服务架构。<br><strong>步骤</strong>：</p><ol><li><strong>添加依赖</strong>：引入OpenFeign：<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><strong>启用Feign</strong>：在启动类添加<code>@EnableFeignClients</code>。</li><li><strong>定义接口</strong>：声明式调用外部API：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@FeignClient</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;externalApi&#34;</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;https://api.example.com&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>ExternalApiClient</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/data&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>getData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>注入使用</strong>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>ExternalApiClient</span><span class=w> </span><span class=n>client</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>fetchData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>getData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ol><hr><h3 id=第三方http客户端灵活扩展><strong>第三方HTTP客户端（灵活扩展）</strong></h3><h4 id=apache-httpclient><strong>Apache HttpClient</strong></h4><p><strong>适用场景</strong>：高度可配置，支持复杂请求（如连接池、重试机制）。<br><strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CloseableHttpClient</span><span class=w> </span><span class=n>httpClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HttpClients</span><span class=p>.</span><span class=na>createDefault</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HttpGet</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpGet</span><span class=p>(</span><span class=s>&#34;https://api.example.com&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CloseableHttpResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>httpClient</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EntityUtils</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>getEntity</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></div><h4 id=okhttp><strong>OkHttp</strong></h4><p><strong>适用场景</strong>：高性能，支持HTTP/2和WebSocket。<br><strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>OkHttpClient</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OkHttpClient</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>.</span><span class=na>Builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>url</span><span class=p>(</span><span class=s>&#34;https://api.example.com&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>client</span><span class=p>.</span><span class=na>newCall</span><span class=p>(</span><span class=n>request</span><span class=p>).</span><span class=na>enqueue</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Callback</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResponse</span><span class=p>(</span><span class=n>Call</span><span class=w> </span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>body</span><span class=p>().</span><span class=na>string</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=选择建议-1><strong>选择建议</strong></h3><ul><li><strong>同步场景</strong>：优先使用WebClient或RestTemplate。</li><li><strong>响应式/高并发</strong>：WebClient（支持非阻塞）。</li><li><strong>微服务调用</strong>：Feign（声明式简化）。</li><li><strong>复杂配置需求</strong>：Apache HttpClient或OkHttp。</li></ul><p>更多配置细节（如超时设置、拦截器）可参考官方文档或相关搜索来源。</p><p>假设你是一个论坛帖子内容总结助手，用户将会以形如{“postTitle”:“帖子名”,content:“帖子引言”,comments:[“评论内容1”,“评论内容2”]}的序列化JSON形式发送帖子，请你帮助总结整个帖子（包括内容和评论），并总结内容与评论的情感态度，并给出各态度的百分比，请以形如{“altitudes”:[{altitude: “开心”, percentage: “50%”}, {altitude: “愤怒”, percentage: “20%”},…], “summary”: “这篇帖子讨论了…”}的序列化JSON格式返回字段</p><h2 id=applicationyaml更新问题>Application.yaml更新问题</h2><p>在Spring Boot应用部署后，修改<code>application.yaml</code>是否需要重新编译或重启，取决于具体的配置管理方式。以下是不同场景下的解决方案和对应操作：</p><hr><h3 id=仅修改外部配置文件并重启><strong>仅修改外部配置文件并重启</strong></h3><p>如果将配置文件放在<strong>外部目录</strong>（如与Jar包同级目录的<code>config</code>文件夹或自定义路径），并在启动时通过<code>--spring.config.location</code>参数指定其位置，则修改后只需<strong>重启应用</strong>即可生效，无需重新编译打包。<br><strong>操作步骤</strong>：</p><ol><li>将<code>application.yaml</code>移动到Jar包外部（如<code>/opt/app/config/</code>）。</li><li>启动命令中添加参数：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java -jar your-app.jar --spring.config.location<span class=o>=</span>file:/opt/app/config/
</span></span></code></pre></div></li><li>修改配置文件后，重启应用即可。</li></ol><hr><h3 id=动态刷新配置无需重启><strong>动态刷新配置（无需重启）</strong></h3><p>通过集成<strong>Spring Cloud Config</strong>或<strong>Spring Boot Actuator</strong>，可实现配置的<strong>动态刷新</strong>，无需重启应用。<br><strong>实现方式</strong>：</p><ul><li><strong>Spring Cloud Config</strong>：<br>将配置集中存储在Git等版本库中，通过<code>@RefreshScope</code>注解刷新Bean，调用<code>/actuator/refresh</code>接口触发更新。</li><li><strong>手动刷新</strong>：<br>使用<code>ContextRefresher</code>类主动刷新配置（需引入<code>spring-cloud-context</code>依赖）：<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>ContextRefresher</span><span class=w> </span><span class=n>contextRefresher</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateConfig</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 修改外部配置文件内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>contextRefresher</span><span class=p>.</span><span class=na>refresh</span><span class=p>();</span><span class=w> </span><span class=c1>// 触发配置刷新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul><hr><h3 id=开发环境热部署自动重启><strong>开发环境热部署（自动重启）</strong></h3><p>在开发阶段，使用<code>spring-boot-devtools</code>工具可实现<strong>修改后自动重启</strong>（非生产环境适用）：</p><ol><li>添加依赖：<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-devtools<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li>修改配置文件后，IDEA会自动触发应用重启。</li></ol><hr><h3 id=总结><strong>总结</strong></h3><ul><li><strong>是否需要重新编译</strong>：<br><strong>不需要</strong>。无论采用外部配置还是动态刷新，均无需重新编译代码。</li><li><strong>是否需要重启</strong>：<ul><li>若使用外部配置文件但未集成动态刷新，需<strong>手动重启应用</strong>。</li><li>若通过动态刷新或热部署工具，则<strong>无需重启</strong>。</li></ul></li></ul><p>建议根据实际场景选择方案：生产环境推荐<strong>外部配置+动态刷新</strong>，开发环境可使用热部署工具简化流程。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/postopia/>Postopia</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Oct 22, 2025 16:27 CST</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/postopia-dev-logweek-17/><div class=article-details><h2 class=article-title>【Postopia Dev Log】Week 17</h2></div></a></article><article><a href=/p/postopia-dev-logweek-16/><div class=article-details><h2 class=article-title>【Postopia Dev Log】Week 16</h2></div></a></article><article><a href=/p/postopia-dev-logweek-15/><div class=article-details><h2 class=article-title>【Postopia Dev Log】Week 15</h2></div></a></article><article><a href=/p/postopia-dev-logweek-14/><div class=article-details><h2 class=article-title>【Postopia Dev Log】Week 14</h2></div></a></article><article><a href=/p/postopia-dev-logweek-12/><div class=article-details><h2 class=article-title>【Postopia Dev Log】Week 12</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 飞鸿踏雪泥</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>