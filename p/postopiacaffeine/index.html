<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Caffeine Caffeine æ˜¯ä¸€æ¬¾åŸºäº Java 8 çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜åº“ï¼Œç”± Google Guava Cache æ”¹è¿›è€Œæ¥ï¼Œç°å·²æˆä¸º Spring Boot é»˜è®¤çš„æœ¬åœ°ç¼“å­˜å®ç°ã€‚å…¶è®¾è®¡ä¸“æ³¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œé€šè¿‡åˆ›æ–°çš„ç®—æ³•å’Œçµæ´»çš„é…ç½®ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡ä¸å†…å­˜ç®¡ç†ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒç‰¹æ€§ã€å·¥ä½œåŸç†ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢å±•å¼€è¯¦ç»†ä»‹ç»ï¼š\nğŸ”¥ æ ¸å¿ƒç‰¹æ€§ é«˜æ€§èƒ½ä¸é«˜å‘½ä¸­ç‡ Window TinyLFU ç®—æ³•ï¼šCaffeine é‡‡ç”¨æ··åˆäº† LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰å’Œ LFUï¼ˆæœ€ä¸å¸¸ä½¿ç”¨ï¼‰ä¼˜åŠ¿çš„ç®—æ³•ï¼Œé€šè¿‡é¢‘ç‡ç»Ÿè®¡æ™ºèƒ½ä¿ç•™çƒ­ç‚¹æ•°æ®ï¼Œå‘½ä¸­ç‡æ¥è¿‘ç†è®ºæœ€ä¼˜å€¼ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¾è‘—ä¼˜äºä¼ ç»Ÿ LRU ç®—æ³•3,4,5ã€‚ æ— é”å¹¶å‘è®¾è®¡ï¼šåŸºäº Java 8 çš„ StampedLock å’Œåˆ†æ®µé”æŠ€æœ¯ï¼Œå‡å°‘çº¿ç¨‹ç«äº‰ï¼Œæ”¯æŒé«˜ååé‡è®¿é—®ï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰3,5ã€‚ çµæ´»çš„ç¼“å­˜ç­–ç•¥ åŸºäºå®¹é‡ï¼šé€šè¿‡ maximumSize é™åˆ¶æ¡ç›®æ•°é‡ï¼Œæˆ–é€šè¿‡ maximumWeight ç»“åˆæƒé‡å‡½æ•°ï¼ˆå¦‚æ•°æ®å¤§å°ï¼‰æ§åˆ¶å†…å­˜å ç”¨3,6ã€‚ åŸºäºæ—¶é—´ï¼š expireAfterWriteï¼šå†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ï¼› expireAfterAccessï¼šæœ€åä¸€æ¬¡è®¿é—®/å†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼› refreshAfterWriteï¼šå†™å…¥åå®šæ—¶åˆ·æ–°ï¼ˆå¼‚æ­¥åŠ è½½æ–°å€¼ï¼Œä¸é˜»å¡è¯·æ±‚ï¼‰3,5,6ã€‚ åŸºäºå¼•ç”¨ï¼šæ”¯æŒå¼±å¼•ç”¨ï¼ˆweakKeys/weakValuesï¼‰æˆ–è½¯å¼•ç”¨ï¼ˆsoftValuesï¼‰ï¼Œå…è®¸ JVM åœ¨å†…å­˜ä¸è¶³æ—¶å›æ”¶ç¼“å­˜5,6ã€‚ å¼‚æ­¥ä¸è‡ªåŠ¨åŠ è½½ å¼‚æ­¥åŠ è½½ï¼ˆAsyncCacheï¼‰ï¼šè¿”å› CompletableFutureï¼Œé€‚ç”¨äºéé˜»å¡ç¼–ç¨‹æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ ForkJoinPool æ‰§è¡ŒåŠ è½½ä»»åŠ¡3,7ã€‚ åŒæ­¥åŠ è½½ï¼ˆLoadingCacheï¼‰ï¼šé€šè¿‡ CacheLoader å®ç°ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œé¿å…æ‰‹åŠ¨å¤„ç†é€»è¾‘5,7ã€‚ æ‰©å±•åŠŸèƒ½ æ·˜æ±°ç›‘å¬ï¼šremovalListener å¯æ•è·æ¡ç›®ç§»é™¤äº‹ä»¶ï¼ˆå¦‚è¿‡æœŸã€æ‰‹åŠ¨åˆ é™¤ï¼‰ï¼Œä¾¿äºæ—¥å¿—æˆ–èµ„æºæ¸…ç†3,5ã€‚ ç»Ÿè®¡ç›‘æ§ï¼šrecordStats() å¯ç”¨å‘½ä¸­ç‡ã€åŠ è½½è€—æ—¶ç­‰ç»Ÿè®¡ï¼Œè¾…åŠ©æ€§èƒ½ä¼˜åŒ–3,7ã€‚ âš™ï¸ å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯ ç¼“å­˜æ·˜æ±°æœºåˆ¶ é‡‡ç”¨æƒ°æ€§åˆ é™¤ä¸å®šæœŸæ‰¹é‡æ¸…ç†ç»“åˆçš„ç­–ç•¥ï¼š è¯»/å†™æ“ä½œæ—¶æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œå¼‚æ­¥å›æ”¶è¿‡æœŸæ¡ç›®ï¼› åå°çº¿ç¨‹å®šæœŸæ‰§è¡Œæ¸…ç†ä»»åŠ¡ï¼Œå‡å°‘ä¸»çº¿ç¨‹é˜»å¡3,6ã€‚ å†…å­˜ç®¡ç†ä¼˜åŒ– æƒé‡æ§åˆ¶ï¼šé€šè¿‡ Weigher æ¥å£ä¸ºä¸åŒæ¡ç›®åˆ†é…æƒé‡ï¼Œé¿å…å¤§å¯¹è±¡å ç”¨è¿‡å¤šå†…å­˜6ã€‚ æ™ºèƒ½é©±é€ï¼šç»“åˆå®¹é‡ã€æ—¶é—´ã€å¼•ç”¨ç­–ç•¥ï¼Œç¡®ä¿å†…å­˜å ç”¨å¯æ§ï¼ˆä¾‹å¦‚ maximumWeight ä¸ weigher é…åˆï¼‰5,6ã€‚ åˆ·æ–°ä¸è¿‡æœŸåŒºåˆ« ç­–ç•¥ è§¦å‘æ¡ä»¶ è¡Œä¸º é€‚ç”¨åœºæ™¯ expireAfterWrite å†™å…¥åè¶…æ—¶ é˜»å¡è¯·æ±‚ç›´è‡³æ–°å€¼åŠ è½½å®Œæˆ å¼ºä¸€è‡´æ€§åœºæ™¯ï¼ˆå¦‚é…ç½®æ•°æ®ï¼‰ refreshAfterWrite å†™å…¥åè¶…æ—¶ è¿”å›æ—§å€¼å¹¶å¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡è¯·æ±‚ é«˜å¹¶å‘è¯»åœºæ™¯ï¼ˆå¦‚çƒ­ç‚¹æ•°æ®ï¼‰ ğŸš€ é€‚ç”¨åœºæ™¯ é«˜é¢‘è®¿é—®æ•°æ®ç¼“å­˜ Web è¯·æ±‚ç»“æœã€ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€å•†å“è¯¦æƒ…ç­‰ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæå‡å“åº”é€Ÿåº¦ï¼ˆå¦‚ç”µå•†é¦–é¡µçƒ­ç‚¹å•†å“ï¼‰4,7ã€‚ è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¼˜åŒ– ç¼“å­˜å›¾åƒå¤„ç†ç»“æœã€å¤§æ•°æ®åˆ†æä¸­é—´å€¼ï¼Œé¿å…é‡å¤è®¡ç®—ï¼ˆå¦‚å®æ—¶æŠ¥è¡¨ç”Ÿæˆï¼‰4,6ã€‚ å¾®æœåŠ¡æ¶æ„ä¸­çš„æœ¬åœ°ç¼“å­˜å±‚ ä½œä¸ºä¸‰çº§ç¼“å­˜ï¼ˆL1ï¼‰ä¸ Redisï¼ˆL2ï¼‰ã€æ•°æ®åº“ï¼ˆL3ï¼‰ååŒï¼š L1ï¼ˆCaffeineï¼‰ï¼šè¿›ç¨‹å†…ç¼“å­˜ï¼Œçº³ç§’çº§è®¿é—®ï¼› L2ï¼ˆRedisï¼‰ï¼šè·¨è¿›ç¨‹å…±äº«ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼› æ•°æ®ä¸€è‡´æ€§é€šè¿‡ TTL æˆ–æ¶ˆæ¯é€šçŸ¥ä¿éšœ4,6ã€‚ é«˜å¹¶å‘ç³»ç»Ÿ å¦‚ç§’æ€ç³»ç»Ÿåº“å­˜ç¼“å­˜ï¼Œé€šè¿‡ refreshAfterWrite å¼‚æ­¥æ›´æ–°ï¼Œé¿å…ç¼“å­˜å‡»ç©¿3,4ã€‚ âš–ï¸ ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯” ç‰¹æ€§ Caffeine Guava Cache Redis ç®—æ³• Window TinyLFU LRU å¤šç§ï¼ˆå¦‚ LRUï¼‰ å¹¶å‘æ€§èƒ½ â­â­â­â­ï¼ˆæ— é”ä¼˜åŒ–ï¼‰ â­â­ï¼ˆé”ç«äº‰ï¼‰ â­â­â­ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰ å†…å­˜ç®¡ç† çµæ´»ï¼ˆæƒé‡/å¤§å°ï¼‰ åŸºç¡€ ä¾èµ–å¤–éƒ¨é…ç½® é€‚ç”¨åœºæ™¯ æœ¬åœ°ç¼“å­˜ å°è§„æ¨¡æœ¬åœ°ç¼“å­˜ åˆ†å¸ƒå¼ç¼“å­˜ ğŸ’» åŸºç¡€ä»£ç ç¤ºä¾‹ // åŒæ­¥åŠ è½½ç¼“å­˜ï¼ˆè‡ªåŠ¨åŠ è½½æ•°æ®ï¼‰ LoadingCache<String, User> cache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(10, TimeUnit.MINUTES) .refreshAfterWrite(1, TimeUnit.MINUTES) .recordStats() .build(key -> userDao.getUserById(key)); // è·å–æ•°æ®ï¼ˆè‡ªåŠ¨åŠ è½½æœªå‘½ä¸­æ¡ç›®ï¼‰ User user = cache.get("user123"); // å¼‚æ­¥åŠ è½½ç¼“å­˜ AsyncLoadingCache<String, User> asyncCache = Caffeine.newBuilder() .buildAsync((key, executor) -> userDao.getUserAsync(key)); CompletableFuture<User> future = asyncCache.get("user456"); âš ï¸ å¸¸è§é—®é¢˜ä¸ä¼˜åŒ– ç¼“å­˜å‘½ä¸­ç‡ä½ ä¼˜åŒ–ï¼šå¢å¤§ maximumSizeã€è°ƒæ•´è¿‡æœŸæ—¶é—´ï¼ˆå¦‚å»¶é•¿ expireAfterAccessï¼‰ã€æ£€æŸ¥æ•°æ®åŠ è½½é€»è¾‘2,6ã€‚ å†…å­˜å ç”¨è¿‡é«˜ ä¼˜åŒ–ï¼šä½¿ç”¨ maximumWeight é™åˆ¶æƒé‡ã€å¯ç”¨ weakValues æˆ– softValues2,6ã€‚ ç¼“å­˜é›ªå´© é¢„é˜²ï¼šåˆ†æ•£è¿‡æœŸæ—¶é—´ï¼ˆå¦‚éšæœº TTLï¼‰ã€ç»“åˆ refreshAfterWrite å¼‚æ­¥åˆ·æ–°3,4ã€‚ ğŸ’ æ€»ç»“ Caffeine å‡­å€Ÿ Window TinyLFU ç®—æ³•ã€æ— é”å¹¶å‘å’Œçµæ´»çš„ç­–ç•¥ç»„åˆï¼Œæˆä¸º Java æœ¬åœ°ç¼“å­˜çš„æ ‡æ†ã€‚å…¶é€‚ç”¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œå¦‚å¾®æœåŠ¡ç¼“å­˜å±‚ã€çƒ­ç‚¹æ•°æ®åŠ é€Ÿç­‰ã€‚é€šè¿‡ä¸åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰ç»„æˆå¤šçº§ç¼“å­˜ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚å¼€å‘è€…å¯é€šè¿‡ä¸°å¯Œçš„é…ç½®ï¼ˆå®¹é‡ã€æ—¶é—´ã€æƒé‡ï¼‰å’Œç›‘æ§åŠŸèƒ½ï¼ˆrecordStatsï¼‰å®ç°ç²¾ç»†åŒ–è°ƒä¼˜3,4,5ã€‚\n'><title>ã€Postopiaã€‘caffeine</title><link rel=canonical href=https://dyhes.github.io/p/postopiacaffeine/><link rel=stylesheet href=/scss/style.min.f7091bff8043bd3e53b22be6c05dd86b506e8dec4d0d75d249d2dfb0fe074a46.css><meta property='og:title' content="ã€Postopiaã€‘caffeine"><meta property='og:description' content='Caffeine Caffeine æ˜¯ä¸€æ¬¾åŸºäº Java 8 çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜åº“ï¼Œç”± Google Guava Cache æ”¹è¿›è€Œæ¥ï¼Œç°å·²æˆä¸º Spring Boot é»˜è®¤çš„æœ¬åœ°ç¼“å­˜å®ç°ã€‚å…¶è®¾è®¡ä¸“æ³¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œé€šè¿‡åˆ›æ–°çš„ç®—æ³•å’Œçµæ´»çš„é…ç½®ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡ä¸å†…å­˜ç®¡ç†ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒç‰¹æ€§ã€å·¥ä½œåŸç†ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢å±•å¼€è¯¦ç»†ä»‹ç»ï¼š\nğŸ”¥ æ ¸å¿ƒç‰¹æ€§ é«˜æ€§èƒ½ä¸é«˜å‘½ä¸­ç‡ Window TinyLFU ç®—æ³•ï¼šCaffeine é‡‡ç”¨æ··åˆäº† LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰å’Œ LFUï¼ˆæœ€ä¸å¸¸ä½¿ç”¨ï¼‰ä¼˜åŠ¿çš„ç®—æ³•ï¼Œé€šè¿‡é¢‘ç‡ç»Ÿè®¡æ™ºèƒ½ä¿ç•™çƒ­ç‚¹æ•°æ®ï¼Œå‘½ä¸­ç‡æ¥è¿‘ç†è®ºæœ€ä¼˜å€¼ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¾è‘—ä¼˜äºä¼ ç»Ÿ LRU ç®—æ³•3,4,5ã€‚ æ— é”å¹¶å‘è®¾è®¡ï¼šåŸºäº Java 8 çš„ StampedLock å’Œåˆ†æ®µé”æŠ€æœ¯ï¼Œå‡å°‘çº¿ç¨‹ç«äº‰ï¼Œæ”¯æŒé«˜ååé‡è®¿é—®ï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰3,5ã€‚ çµæ´»çš„ç¼“å­˜ç­–ç•¥ åŸºäºå®¹é‡ï¼šé€šè¿‡ maximumSize é™åˆ¶æ¡ç›®æ•°é‡ï¼Œæˆ–é€šè¿‡ maximumWeight ç»“åˆæƒé‡å‡½æ•°ï¼ˆå¦‚æ•°æ®å¤§å°ï¼‰æ§åˆ¶å†…å­˜å ç”¨3,6ã€‚ åŸºäºæ—¶é—´ï¼š expireAfterWriteï¼šå†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ï¼› expireAfterAccessï¼šæœ€åä¸€æ¬¡è®¿é—®/å†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼› refreshAfterWriteï¼šå†™å…¥åå®šæ—¶åˆ·æ–°ï¼ˆå¼‚æ­¥åŠ è½½æ–°å€¼ï¼Œä¸é˜»å¡è¯·æ±‚ï¼‰3,5,6ã€‚ åŸºäºå¼•ç”¨ï¼šæ”¯æŒå¼±å¼•ç”¨ï¼ˆweakKeys/weakValuesï¼‰æˆ–è½¯å¼•ç”¨ï¼ˆsoftValuesï¼‰ï¼Œå…è®¸ JVM åœ¨å†…å­˜ä¸è¶³æ—¶å›æ”¶ç¼“å­˜5,6ã€‚ å¼‚æ­¥ä¸è‡ªåŠ¨åŠ è½½ å¼‚æ­¥åŠ è½½ï¼ˆAsyncCacheï¼‰ï¼šè¿”å› CompletableFutureï¼Œé€‚ç”¨äºéé˜»å¡ç¼–ç¨‹æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ ForkJoinPool æ‰§è¡ŒåŠ è½½ä»»åŠ¡3,7ã€‚ åŒæ­¥åŠ è½½ï¼ˆLoadingCacheï¼‰ï¼šé€šè¿‡ CacheLoader å®ç°ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œé¿å…æ‰‹åŠ¨å¤„ç†é€»è¾‘5,7ã€‚ æ‰©å±•åŠŸèƒ½ æ·˜æ±°ç›‘å¬ï¼šremovalListener å¯æ•è·æ¡ç›®ç§»é™¤äº‹ä»¶ï¼ˆå¦‚è¿‡æœŸã€æ‰‹åŠ¨åˆ é™¤ï¼‰ï¼Œä¾¿äºæ—¥å¿—æˆ–èµ„æºæ¸…ç†3,5ã€‚ ç»Ÿè®¡ç›‘æ§ï¼šrecordStats() å¯ç”¨å‘½ä¸­ç‡ã€åŠ è½½è€—æ—¶ç­‰ç»Ÿè®¡ï¼Œè¾…åŠ©æ€§èƒ½ä¼˜åŒ–3,7ã€‚ âš™ï¸ å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯ ç¼“å­˜æ·˜æ±°æœºåˆ¶ é‡‡ç”¨æƒ°æ€§åˆ é™¤ä¸å®šæœŸæ‰¹é‡æ¸…ç†ç»“åˆçš„ç­–ç•¥ï¼š è¯»/å†™æ“ä½œæ—¶æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œå¼‚æ­¥å›æ”¶è¿‡æœŸæ¡ç›®ï¼› åå°çº¿ç¨‹å®šæœŸæ‰§è¡Œæ¸…ç†ä»»åŠ¡ï¼Œå‡å°‘ä¸»çº¿ç¨‹é˜»å¡3,6ã€‚ å†…å­˜ç®¡ç†ä¼˜åŒ– æƒé‡æ§åˆ¶ï¼šé€šè¿‡ Weigher æ¥å£ä¸ºä¸åŒæ¡ç›®åˆ†é…æƒé‡ï¼Œé¿å…å¤§å¯¹è±¡å ç”¨è¿‡å¤šå†…å­˜6ã€‚ æ™ºèƒ½é©±é€ï¼šç»“åˆå®¹é‡ã€æ—¶é—´ã€å¼•ç”¨ç­–ç•¥ï¼Œç¡®ä¿å†…å­˜å ç”¨å¯æ§ï¼ˆä¾‹å¦‚ maximumWeight ä¸ weigher é…åˆï¼‰5,6ã€‚ åˆ·æ–°ä¸è¿‡æœŸåŒºåˆ« ç­–ç•¥ è§¦å‘æ¡ä»¶ è¡Œä¸º é€‚ç”¨åœºæ™¯ expireAfterWrite å†™å…¥åè¶…æ—¶ é˜»å¡è¯·æ±‚ç›´è‡³æ–°å€¼åŠ è½½å®Œæˆ å¼ºä¸€è‡´æ€§åœºæ™¯ï¼ˆå¦‚é…ç½®æ•°æ®ï¼‰ refreshAfterWrite å†™å…¥åè¶…æ—¶ è¿”å›æ—§å€¼å¹¶å¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡è¯·æ±‚ é«˜å¹¶å‘è¯»åœºæ™¯ï¼ˆå¦‚çƒ­ç‚¹æ•°æ®ï¼‰ ğŸš€ é€‚ç”¨åœºæ™¯ é«˜é¢‘è®¿é—®æ•°æ®ç¼“å­˜ Web è¯·æ±‚ç»“æœã€ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€å•†å“è¯¦æƒ…ç­‰ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæå‡å“åº”é€Ÿåº¦ï¼ˆå¦‚ç”µå•†é¦–é¡µçƒ­ç‚¹å•†å“ï¼‰4,7ã€‚ è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¼˜åŒ– ç¼“å­˜å›¾åƒå¤„ç†ç»“æœã€å¤§æ•°æ®åˆ†æä¸­é—´å€¼ï¼Œé¿å…é‡å¤è®¡ç®—ï¼ˆå¦‚å®æ—¶æŠ¥è¡¨ç”Ÿæˆï¼‰4,6ã€‚ å¾®æœåŠ¡æ¶æ„ä¸­çš„æœ¬åœ°ç¼“å­˜å±‚ ä½œä¸ºä¸‰çº§ç¼“å­˜ï¼ˆL1ï¼‰ä¸ Redisï¼ˆL2ï¼‰ã€æ•°æ®åº“ï¼ˆL3ï¼‰ååŒï¼š L1ï¼ˆCaffeineï¼‰ï¼šè¿›ç¨‹å†…ç¼“å­˜ï¼Œçº³ç§’çº§è®¿é—®ï¼› L2ï¼ˆRedisï¼‰ï¼šè·¨è¿›ç¨‹å…±äº«ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼› æ•°æ®ä¸€è‡´æ€§é€šè¿‡ TTL æˆ–æ¶ˆæ¯é€šçŸ¥ä¿éšœ4,6ã€‚ é«˜å¹¶å‘ç³»ç»Ÿ å¦‚ç§’æ€ç³»ç»Ÿåº“å­˜ç¼“å­˜ï¼Œé€šè¿‡ refreshAfterWrite å¼‚æ­¥æ›´æ–°ï¼Œé¿å…ç¼“å­˜å‡»ç©¿3,4ã€‚ âš–ï¸ ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯” ç‰¹æ€§ Caffeine Guava Cache Redis ç®—æ³• Window TinyLFU LRU å¤šç§ï¼ˆå¦‚ LRUï¼‰ å¹¶å‘æ€§èƒ½ â­â­â­â­ï¼ˆæ— é”ä¼˜åŒ–ï¼‰ â­â­ï¼ˆé”ç«äº‰ï¼‰ â­â­â­ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰ å†…å­˜ç®¡ç† çµæ´»ï¼ˆæƒé‡/å¤§å°ï¼‰ åŸºç¡€ ä¾èµ–å¤–éƒ¨é…ç½® é€‚ç”¨åœºæ™¯ æœ¬åœ°ç¼“å­˜ å°è§„æ¨¡æœ¬åœ°ç¼“å­˜ åˆ†å¸ƒå¼ç¼“å­˜ ğŸ’» åŸºç¡€ä»£ç ç¤ºä¾‹ // åŒæ­¥åŠ è½½ç¼“å­˜ï¼ˆè‡ªåŠ¨åŠ è½½æ•°æ®ï¼‰ LoadingCache<String, User> cache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(10, TimeUnit.MINUTES) .refreshAfterWrite(1, TimeUnit.MINUTES) .recordStats() .build(key -> userDao.getUserById(key)); // è·å–æ•°æ®ï¼ˆè‡ªåŠ¨åŠ è½½æœªå‘½ä¸­æ¡ç›®ï¼‰ User user = cache.get("user123"); // å¼‚æ­¥åŠ è½½ç¼“å­˜ AsyncLoadingCache<String, User> asyncCache = Caffeine.newBuilder() .buildAsync((key, executor) -> userDao.getUserAsync(key)); CompletableFuture<User> future = asyncCache.get("user456"); âš ï¸ å¸¸è§é—®é¢˜ä¸ä¼˜åŒ– ç¼“å­˜å‘½ä¸­ç‡ä½ ä¼˜åŒ–ï¼šå¢å¤§ maximumSizeã€è°ƒæ•´è¿‡æœŸæ—¶é—´ï¼ˆå¦‚å»¶é•¿ expireAfterAccessï¼‰ã€æ£€æŸ¥æ•°æ®åŠ è½½é€»è¾‘2,6ã€‚ å†…å­˜å ç”¨è¿‡é«˜ ä¼˜åŒ–ï¼šä½¿ç”¨ maximumWeight é™åˆ¶æƒé‡ã€å¯ç”¨ weakValues æˆ– softValues2,6ã€‚ ç¼“å­˜é›ªå´© é¢„é˜²ï¼šåˆ†æ•£è¿‡æœŸæ—¶é—´ï¼ˆå¦‚éšæœº TTLï¼‰ã€ç»“åˆ refreshAfterWrite å¼‚æ­¥åˆ·æ–°3,4ã€‚ ğŸ’ æ€»ç»“ Caffeine å‡­å€Ÿ Window TinyLFU ç®—æ³•ã€æ— é”å¹¶å‘å’Œçµæ´»çš„ç­–ç•¥ç»„åˆï¼Œæˆä¸º Java æœ¬åœ°ç¼“å­˜çš„æ ‡æ†ã€‚å…¶é€‚ç”¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œå¦‚å¾®æœåŠ¡ç¼“å­˜å±‚ã€çƒ­ç‚¹æ•°æ®åŠ é€Ÿç­‰ã€‚é€šè¿‡ä¸åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰ç»„æˆå¤šçº§ç¼“å­˜ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚å¼€å‘è€…å¯é€šè¿‡ä¸°å¯Œçš„é…ç½®ï¼ˆå®¹é‡ã€æ—¶é—´ã€æƒé‡ï¼‰å’Œç›‘æ§åŠŸèƒ½ï¼ˆrecordStatsï¼‰å®ç°ç²¾ç»†åŒ–è°ƒä¼˜3,4,5ã€‚\n'><meta property='og:url' content='https://dyhes.github.io/p/postopiacaffeine/'><meta property='og:site_name' content='é£é¸¿è¸é›ªæ³¥'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Postopia'><meta property='article:published_time' content='2025-07-02T00:00:00+00:00'><meta property='article:modified_time' content='2025-10-22T16:26:59+08:00'><meta name=twitter:title content="ã€Postopiaã€‘caffeine"><meta name=twitter:description content='Caffeine Caffeine æ˜¯ä¸€æ¬¾åŸºäº Java 8 çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜åº“ï¼Œç”± Google Guava Cache æ”¹è¿›è€Œæ¥ï¼Œç°å·²æˆä¸º Spring Boot é»˜è®¤çš„æœ¬åœ°ç¼“å­˜å®ç°ã€‚å…¶è®¾è®¡ä¸“æ³¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œé€šè¿‡åˆ›æ–°çš„ç®—æ³•å’Œçµæ´»çš„é…ç½®ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡ä¸å†…å­˜ç®¡ç†ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒç‰¹æ€§ã€å·¥ä½œåŸç†ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢å±•å¼€è¯¦ç»†ä»‹ç»ï¼š\nğŸ”¥ æ ¸å¿ƒç‰¹æ€§ é«˜æ€§èƒ½ä¸é«˜å‘½ä¸­ç‡ Window TinyLFU ç®—æ³•ï¼šCaffeine é‡‡ç”¨æ··åˆäº† LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰å’Œ LFUï¼ˆæœ€ä¸å¸¸ä½¿ç”¨ï¼‰ä¼˜åŠ¿çš„ç®—æ³•ï¼Œé€šè¿‡é¢‘ç‡ç»Ÿè®¡æ™ºèƒ½ä¿ç•™çƒ­ç‚¹æ•°æ®ï¼Œå‘½ä¸­ç‡æ¥è¿‘ç†è®ºæœ€ä¼˜å€¼ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¾è‘—ä¼˜äºä¼ ç»Ÿ LRU ç®—æ³•3,4,5ã€‚ æ— é”å¹¶å‘è®¾è®¡ï¼šåŸºäº Java 8 çš„ StampedLock å’Œåˆ†æ®µé”æŠ€æœ¯ï¼Œå‡å°‘çº¿ç¨‹ç«äº‰ï¼Œæ”¯æŒé«˜ååé‡è®¿é—®ï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰3,5ã€‚ çµæ´»çš„ç¼“å­˜ç­–ç•¥ åŸºäºå®¹é‡ï¼šé€šè¿‡ maximumSize é™åˆ¶æ¡ç›®æ•°é‡ï¼Œæˆ–é€šè¿‡ maximumWeight ç»“åˆæƒé‡å‡½æ•°ï¼ˆå¦‚æ•°æ®å¤§å°ï¼‰æ§åˆ¶å†…å­˜å ç”¨3,6ã€‚ åŸºäºæ—¶é—´ï¼š expireAfterWriteï¼šå†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ï¼› expireAfterAccessï¼šæœ€åä¸€æ¬¡è®¿é—®/å†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼› refreshAfterWriteï¼šå†™å…¥åå®šæ—¶åˆ·æ–°ï¼ˆå¼‚æ­¥åŠ è½½æ–°å€¼ï¼Œä¸é˜»å¡è¯·æ±‚ï¼‰3,5,6ã€‚ åŸºäºå¼•ç”¨ï¼šæ”¯æŒå¼±å¼•ç”¨ï¼ˆweakKeys/weakValuesï¼‰æˆ–è½¯å¼•ç”¨ï¼ˆsoftValuesï¼‰ï¼Œå…è®¸ JVM åœ¨å†…å­˜ä¸è¶³æ—¶å›æ”¶ç¼“å­˜5,6ã€‚ å¼‚æ­¥ä¸è‡ªåŠ¨åŠ è½½ å¼‚æ­¥åŠ è½½ï¼ˆAsyncCacheï¼‰ï¼šè¿”å› CompletableFutureï¼Œé€‚ç”¨äºéé˜»å¡ç¼–ç¨‹æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ ForkJoinPool æ‰§è¡ŒåŠ è½½ä»»åŠ¡3,7ã€‚ åŒæ­¥åŠ è½½ï¼ˆLoadingCacheï¼‰ï¼šé€šè¿‡ CacheLoader å®ç°ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œé¿å…æ‰‹åŠ¨å¤„ç†é€»è¾‘5,7ã€‚ æ‰©å±•åŠŸèƒ½ æ·˜æ±°ç›‘å¬ï¼šremovalListener å¯æ•è·æ¡ç›®ç§»é™¤äº‹ä»¶ï¼ˆå¦‚è¿‡æœŸã€æ‰‹åŠ¨åˆ é™¤ï¼‰ï¼Œä¾¿äºæ—¥å¿—æˆ–èµ„æºæ¸…ç†3,5ã€‚ ç»Ÿè®¡ç›‘æ§ï¼šrecordStats() å¯ç”¨å‘½ä¸­ç‡ã€åŠ è½½è€—æ—¶ç­‰ç»Ÿè®¡ï¼Œè¾…åŠ©æ€§èƒ½ä¼˜åŒ–3,7ã€‚ âš™ï¸ å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯ ç¼“å­˜æ·˜æ±°æœºåˆ¶ é‡‡ç”¨æƒ°æ€§åˆ é™¤ä¸å®šæœŸæ‰¹é‡æ¸…ç†ç»“åˆçš„ç­–ç•¥ï¼š è¯»/å†™æ“ä½œæ—¶æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œå¼‚æ­¥å›æ”¶è¿‡æœŸæ¡ç›®ï¼› åå°çº¿ç¨‹å®šæœŸæ‰§è¡Œæ¸…ç†ä»»åŠ¡ï¼Œå‡å°‘ä¸»çº¿ç¨‹é˜»å¡3,6ã€‚ å†…å­˜ç®¡ç†ä¼˜åŒ– æƒé‡æ§åˆ¶ï¼šé€šè¿‡ Weigher æ¥å£ä¸ºä¸åŒæ¡ç›®åˆ†é…æƒé‡ï¼Œé¿å…å¤§å¯¹è±¡å ç”¨è¿‡å¤šå†…å­˜6ã€‚ æ™ºèƒ½é©±é€ï¼šç»“åˆå®¹é‡ã€æ—¶é—´ã€å¼•ç”¨ç­–ç•¥ï¼Œç¡®ä¿å†…å­˜å ç”¨å¯æ§ï¼ˆä¾‹å¦‚ maximumWeight ä¸ weigher é…åˆï¼‰5,6ã€‚ åˆ·æ–°ä¸è¿‡æœŸåŒºåˆ« ç­–ç•¥ è§¦å‘æ¡ä»¶ è¡Œä¸º é€‚ç”¨åœºæ™¯ expireAfterWrite å†™å…¥åè¶…æ—¶ é˜»å¡è¯·æ±‚ç›´è‡³æ–°å€¼åŠ è½½å®Œæˆ å¼ºä¸€è‡´æ€§åœºæ™¯ï¼ˆå¦‚é…ç½®æ•°æ®ï¼‰ refreshAfterWrite å†™å…¥åè¶…æ—¶ è¿”å›æ—§å€¼å¹¶å¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡è¯·æ±‚ é«˜å¹¶å‘è¯»åœºæ™¯ï¼ˆå¦‚çƒ­ç‚¹æ•°æ®ï¼‰ ğŸš€ é€‚ç”¨åœºæ™¯ é«˜é¢‘è®¿é—®æ•°æ®ç¼“å­˜ Web è¯·æ±‚ç»“æœã€ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€å•†å“è¯¦æƒ…ç­‰ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæå‡å“åº”é€Ÿåº¦ï¼ˆå¦‚ç”µå•†é¦–é¡µçƒ­ç‚¹å•†å“ï¼‰4,7ã€‚ è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¼˜åŒ– ç¼“å­˜å›¾åƒå¤„ç†ç»“æœã€å¤§æ•°æ®åˆ†æä¸­é—´å€¼ï¼Œé¿å…é‡å¤è®¡ç®—ï¼ˆå¦‚å®æ—¶æŠ¥è¡¨ç”Ÿæˆï¼‰4,6ã€‚ å¾®æœåŠ¡æ¶æ„ä¸­çš„æœ¬åœ°ç¼“å­˜å±‚ ä½œä¸ºä¸‰çº§ç¼“å­˜ï¼ˆL1ï¼‰ä¸ Redisï¼ˆL2ï¼‰ã€æ•°æ®åº“ï¼ˆL3ï¼‰ååŒï¼š L1ï¼ˆCaffeineï¼‰ï¼šè¿›ç¨‹å†…ç¼“å­˜ï¼Œçº³ç§’çº§è®¿é—®ï¼› L2ï¼ˆRedisï¼‰ï¼šè·¨è¿›ç¨‹å…±äº«ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼› æ•°æ®ä¸€è‡´æ€§é€šè¿‡ TTL æˆ–æ¶ˆæ¯é€šçŸ¥ä¿éšœ4,6ã€‚ é«˜å¹¶å‘ç³»ç»Ÿ å¦‚ç§’æ€ç³»ç»Ÿåº“å­˜ç¼“å­˜ï¼Œé€šè¿‡ refreshAfterWrite å¼‚æ­¥æ›´æ–°ï¼Œé¿å…ç¼“å­˜å‡»ç©¿3,4ã€‚ âš–ï¸ ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯” ç‰¹æ€§ Caffeine Guava Cache Redis ç®—æ³• Window TinyLFU LRU å¤šç§ï¼ˆå¦‚ LRUï¼‰ å¹¶å‘æ€§èƒ½ â­â­â­â­ï¼ˆæ— é”ä¼˜åŒ–ï¼‰ â­â­ï¼ˆé”ç«äº‰ï¼‰ â­â­â­ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰ å†…å­˜ç®¡ç† çµæ´»ï¼ˆæƒé‡/å¤§å°ï¼‰ åŸºç¡€ ä¾èµ–å¤–éƒ¨é…ç½® é€‚ç”¨åœºæ™¯ æœ¬åœ°ç¼“å­˜ å°è§„æ¨¡æœ¬åœ°ç¼“å­˜ åˆ†å¸ƒå¼ç¼“å­˜ ğŸ’» åŸºç¡€ä»£ç ç¤ºä¾‹ // åŒæ­¥åŠ è½½ç¼“å­˜ï¼ˆè‡ªåŠ¨åŠ è½½æ•°æ®ï¼‰ LoadingCache<String, User> cache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(10, TimeUnit.MINUTES) .refreshAfterWrite(1, TimeUnit.MINUTES) .recordStats() .build(key -> userDao.getUserById(key)); // è·å–æ•°æ®ï¼ˆè‡ªåŠ¨åŠ è½½æœªå‘½ä¸­æ¡ç›®ï¼‰ User user = cache.get("user123"); // å¼‚æ­¥åŠ è½½ç¼“å­˜ AsyncLoadingCache<String, User> asyncCache = Caffeine.newBuilder() .buildAsync((key, executor) -> userDao.getUserAsync(key)); CompletableFuture<User> future = asyncCache.get("user456"); âš ï¸ å¸¸è§é—®é¢˜ä¸ä¼˜åŒ– ç¼“å­˜å‘½ä¸­ç‡ä½ ä¼˜åŒ–ï¼šå¢å¤§ maximumSizeã€è°ƒæ•´è¿‡æœŸæ—¶é—´ï¼ˆå¦‚å»¶é•¿ expireAfterAccessï¼‰ã€æ£€æŸ¥æ•°æ®åŠ è½½é€»è¾‘2,6ã€‚ å†…å­˜å ç”¨è¿‡é«˜ ä¼˜åŒ–ï¼šä½¿ç”¨ maximumWeight é™åˆ¶æƒé‡ã€å¯ç”¨ weakValues æˆ– softValues2,6ã€‚ ç¼“å­˜é›ªå´© é¢„é˜²ï¼šåˆ†æ•£è¿‡æœŸæ—¶é—´ï¼ˆå¦‚éšæœº TTLï¼‰ã€ç»“åˆ refreshAfterWrite å¼‚æ­¥åˆ·æ–°3,4ã€‚ ğŸ’ æ€»ç»“ Caffeine å‡­å€Ÿ Window TinyLFU ç®—æ³•ã€æ— é”å¹¶å‘å’Œçµæ´»çš„ç­–ç•¥ç»„åˆï¼Œæˆä¸º Java æœ¬åœ°ç¼“å­˜çš„æ ‡æ†ã€‚å…¶é€‚ç”¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œå¦‚å¾®æœåŠ¡ç¼“å­˜å±‚ã€çƒ­ç‚¹æ•°æ®åŠ é€Ÿç­‰ã€‚é€šè¿‡ä¸åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰ç»„æˆå¤šçº§ç¼“å­˜ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚å¼€å‘è€…å¯é€šè¿‡ä¸°å¯Œçš„é…ç½®ï¼ˆå®¹é‡ã€æ—¶é—´ã€æƒé‡ï¼‰å’Œç›‘æ§åŠŸèƒ½ï¼ˆrecordStatsï¼‰å®ç°ç²¾ç»†åŒ–è°ƒä¼˜3,4,5ã€‚\n'><link rel="shortcut icon" href=/github.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b567f26f71c49c33.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>é£é¸¿è¸é›ªæ³¥</a></h1><h2 class=site-description>æ²¡æœ‰è®°å½•ï¼Œå°±æ²¡æœ‰å‘ç”Ÿ</h2></div></header><ol class=menu-social><li><a href=https://leetcode.cn/u/dyhes/ target=_blank title=LeetCode rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg></a></li><li><a href=https://github.com/dyhes target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:dyheslin@gmail.com target=_blank title=Gmail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-gmail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li><li><a href=mailto:1325574784@qq.com target=_blank title=Mail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 19H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v5.5"/><path d="M3 7l9 6 9-6"/><path d="M19 16l-2 3h4l-2 3"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/categories/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/tags/><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Tags</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#caffeine>Caffeine</a><ol><li><a href=#-æ ¸å¿ƒç‰¹æ€§>ğŸ”¥ <strong>æ ¸å¿ƒç‰¹æ€§</strong></a></li><li><a href=#-å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯>âš™ï¸ <strong>å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯</strong></a></li><li><a href=#-é€‚ç”¨åœºæ™¯>ğŸš€ <strong>é€‚ç”¨åœºæ™¯</strong></a></li><li><a href=#-ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯”>âš–ï¸ <strong>ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯”</strong></a></li><li><a href=#-åŸºç¡€ä»£ç ç¤ºä¾‹>ğŸ’» <strong>åŸºç¡€ä»£ç ç¤ºä¾‹</strong></a></li><li><a href=#-å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–>âš ï¸ <strong>å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–</strong></a></li><li><a href=#-æ€»ç»“>ğŸ’ <strong>æ€»ç»“</strong></a></li></ol></li><li><a href=#å¤šçº§ç¼“å­˜>å¤šçº§ç¼“å­˜</a><ol><li><a href=#-å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡>ğŸ“ <strong>å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡</strong></a></li><li><a href=#-ä¾èµ–é…ç½®pomxml>âš™ï¸ <strong>ä¾èµ–é…ç½®ï¼ˆpom.xmlï¼‰</strong></a></li><li><a href=#-å¤šçº§ç¼“å­˜é…ç½®ç±»>ğŸ”§ <strong>å¤šçº§ç¼“å­˜é…ç½®ç±»</strong></a></li><li><a href=#-å¤šçº§ç¼“å­˜ç®¡ç†å™¨å®ç°>ğŸ§© <strong>å¤šçº§ç¼“å­˜ç®¡ç†å™¨å®ç°</strong></a></li><li><a href=#-ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹>ğŸ› ï¸ <strong>ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹</strong></a></li><li><a href=#-å…³é”®ä¼˜åŒ–ç­–ç•¥>ğŸ›¡ï¸ <strong>å…³é”®ä¼˜åŒ–ç­–ç•¥</strong></a></li><li><a href=#-é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½å¯¹æ¯”>ğŸ’ <strong>é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½å¯¹æ¯”</strong></a></li></ol></li><li><a href=#å·®å¼‚åŒ–å¤šçº§ç¼“å­˜>å·®å¼‚åŒ–å¤šçº§ç¼“å­˜</a><ol><li><a href=#-æ ¸å¿ƒé…ç½®åˆ›å»ºä¸¤ç±»ç¼“å­˜ç®¡ç†å™¨>ğŸ”§ <strong>æ ¸å¿ƒé…ç½®ï¼šåˆ›å»ºä¸¤ç±»ç¼“å­˜ç®¡ç†å™¨</strong></a><ol><li><a href=#å¤šçº§ç¼“å­˜ç®¡ç†å™¨caffeine--redis><strong>å¤šçº§ç¼“å­˜ç®¡ç†å™¨</strong>ï¼ˆCaffeine + Redisï¼‰</a></li><li><a href=#å•çº§redisç¼“å­˜ç®¡ç†å™¨ç‹¬ç«‹é…ç½®><strong>å•çº§Redisç¼“å­˜ç®¡ç†å™¨</strong>ï¼ˆç‹¬ç«‹é…ç½®ï¼‰</a></li></ol></li><li><a href=#-ä¸šåŠ¡å±‚ä½¿ç”¨æŒ‰æ¥å£æŒ‡å®šç¼“å­˜ç­–ç•¥>ğŸ› ï¸ <strong>ä¸šåŠ¡å±‚ä½¿ç”¨ï¼šæŒ‰æ¥å£æŒ‡å®šç¼“å­˜ç­–ç•¥</strong></a><ol><li><a href=#å¤šçº§ç¼“å­˜æ¥å£çƒ­ç‚¹æ•°æ®><strong>å¤šçº§ç¼“å­˜æ¥å£</strong>ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰</a></li><li><a href=#å•çº§redisç¼“å­˜æ¥å£æ™®é€šæ•°æ®><strong>å•çº§Redisç¼“å­˜æ¥å£</strong>ï¼ˆæ™®é€šæ•°æ®ï¼‰</a></li><li><a href=#åŠ¨æ€æ¡ä»¶æ§åˆ¶æ›´ç²¾ç»†çš„ç²’åº¦><strong>åŠ¨æ€æ¡ä»¶æ§åˆ¶</strong>ï¼ˆæ›´ç²¾ç»†çš„ç²’åº¦ï¼‰</a></li></ol></li><li><a href=#-é«˜çº§åœºæ™¯è‡ªå®šä¹‰æ³¨è§£ç®€åŒ–é…ç½®>âš™ï¸ <strong>é«˜çº§åœºæ™¯ï¼šè‡ªå®šä¹‰æ³¨è§£ç®€åŒ–é…ç½®</strong></a><ol><li><a href=#å®šä¹‰æ³¨è§£-multilevelcache>å®šä¹‰æ³¨è§£ <code>@MultiLevelCache</code></a></li><li><a href=#åœ¨ç›®æ ‡æ¥å£ä¸Šä½¿ç”¨>åœ¨ç›®æ ‡æ¥å£ä¸Šä½¿ç”¨</a></li></ol></li><li><a href=#-æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–>âš ï¸ <strong>æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–</strong></a></li><li><a href=#-æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹>ğŸ’ <strong>æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹</strong></a></li><li><a href=#-æ‰©å±•è§£å†³å¤šçº§ç¼“å­˜çš„å…¸å‹é—®é¢˜>ğŸ” <strong>æ‰©å±•ï¼šè§£å†³å¤šçº§ç¼“å­˜çš„å…¸å‹é—®é¢˜</strong></a></li></ol></li><li><a href=#è‡ªå®šä¹‰ttl>è‡ªå®šä¹‰TTL</a><ol><li><a href=#-è‡ªå®šä¹‰cachemanageræ¨è>â³ <strong>è‡ªå®šä¹‰CacheManagerï¼ˆæ¨èï¼‰</strong></a></li><li><a href=#-è‡ªå®šä¹‰æ³¨è§£aop>âœ¨ <strong>è‡ªå®šä¹‰æ³¨è§£+AOP</strong></a></li><li><a href=#-ç¼“å­˜æä¾›è€…åŸç”Ÿé…ç½®>âš™ï¸ <strong>ç¼“å­˜æä¾›è€…åŸç”Ÿé…ç½®</strong></a></li><li><a href=#-æ³¨æ„äº‹é¡¹>âš ï¸ <strong>æ³¨æ„äº‹é¡¹</strong></a></li><li><a href=#-æ–¹æ³•å¯¹æ¯”>ğŸ”„ <strong>æ–¹æ³•å¯¹æ¯”</strong></a></li></ol></li><li><a href=#å»¶è¿ŸåŒåˆ >å»¶è¿ŸåŒåˆ </a><ol><li><a href=#-å»¶è¿ŸåŒåˆ çš„æ ¸å¿ƒåŸç†>âš™ï¸ <strong>å»¶è¿ŸåŒåˆ çš„æ ¸å¿ƒåŸç†</strong></a></li><li><a href=#-å®ç°æ–¹æ¡ˆä¸€åŸºäºaopåˆ‡é¢--è‡ªå®šä¹‰æ³¨è§£>ğŸ› ï¸ <strong>å®ç°æ–¹æ¡ˆä¸€ï¼šåŸºäºAOPåˆ‡é¢ + è‡ªå®šä¹‰æ³¨è§£</strong></a><ol><li><a href=#å®šä¹‰è‡ªå®šä¹‰æ³¨è§£><strong>å®šä¹‰è‡ªå®šä¹‰æ³¨è§£</strong></a></li><li><a href=#å®ç°aopåˆ‡é¢æ ¸å¿ƒé€»è¾‘><strong>å®ç°AOPåˆ‡é¢ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰</strong></a></li><li><a href=#ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹><strong>ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹</strong></a></li></ol></li><li><a href=#-å®ç°æ–¹æ¡ˆäºŒå¢å¼ºcachemanageréä¾µå…¥å¼>ğŸ”Œ <strong>å®ç°æ–¹æ¡ˆäºŒï¼šå¢å¼ºCacheManagerï¼ˆéä¾µå…¥å¼ï¼‰</strong></a><ol><li><a href=#åŒ…è£…cacheä¸cachemanager><strong>åŒ…è£…Cacheä¸CacheManager</strong></a></li><li><a href=#æ³¨å†Œå¢å¼ºcachemanagerè‡³springå®¹å™¨><strong>æ³¨å†Œå¢å¼ºCacheManagerè‡³Springå®¹å™¨</strong></a></li></ol></li><li><a href=#-å…³é”®æ³¨æ„äº‹é¡¹>âš ï¸ <strong>å…³é”®æ³¨æ„äº‹é¡¹</strong></a></li><li><a href=#-æ–¹æ¡ˆå¯¹æ¯”>ğŸ“Š <strong>æ–¹æ¡ˆå¯¹æ¯”</strong></a></li><li><a href=#-æ€»ç»“-1>ğŸ’ <strong>æ€»ç»“</strong></a></li></ol></li><li><a href=#cachemanager-å¢å¼º>CacheManager å¢å¼º</a><ol><li><a href=#-é—®é¢˜æ ¹æº>âš ï¸ <strong>é—®é¢˜æ ¹æº</strong></a></li><li><a href=#-è§£å†³æ–¹æ¡ˆç»‘å®šäºŒæ¬¡åˆ é™¤åˆ°äº‹åŠ¡æäº¤>ğŸ”§ <strong>è§£å†³æ–¹æ¡ˆï¼šç»‘å®šäºŒæ¬¡åˆ é™¤åˆ°äº‹åŠ¡æäº¤</strong></a><ol><li><a href=#æ ¸å¿ƒæ”¹é€ æ€è·¯><strong>æ ¸å¿ƒæ”¹é€ æ€è·¯</strong></a></li><li><a href=#å¤„ç†æ— äº‹åŠ¡åœºæ™¯><strong>å¤„ç†æ— äº‹åŠ¡åœºæ™¯</strong></a></li></ol></li><li><a href=#-å¢å¼ºå¥å£®æ€§>âš™ï¸ <strong>å¢å¼ºå¥å£®æ€§</strong></a><ol><li><a href=#çº¿ç¨‹æ± éš”ç¦»><strong>çº¿ç¨‹æ± éš”ç¦»</strong></a></li><li><a href=#äº‹åŠ¡å›æ»šè¡¥å¿><strong>äº‹åŠ¡å›æ»šè¡¥å¿</strong></a></li></ol></li><li><a href=#-æ–¹æ¡ˆå¯¹æ¯”-1>ğŸ“Š <strong>æ–¹æ¡ˆå¯¹æ¯”</strong></a></li><li><a href=#-æ€»ç»“-2>ğŸ’ <strong>æ€»ç»“</strong></a></li></ol></li><li><a href=#aop>AOP</a><ol><li><a href=#-æ ¸å¿ƒå®ç°æ–¹æ¡ˆ>ğŸ” æ ¸å¿ƒå®ç°æ–¹æ¡ˆ</a><ol><li><a href=#é€šè¿‡><strong>é€šè¿‡ <code>TransactionSynchronizationManager</code> ä¸»åŠ¨æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€</strong></a></li><li><a href=#æ³¨å†Œäº‹åŠ¡åŒæ­¥å›è°ƒæ¨è><strong>æ³¨å†Œäº‹åŠ¡åŒæ­¥å›è°ƒï¼ˆæ¨èï¼‰</strong></a></li><li><a href=#åœ¨åˆ‡é¢ä¸­ç›´æ¥è·å–><strong>åœ¨åˆ‡é¢ä¸­ç›´æ¥è·å– <code>TransactionStatus</code></strong></a></li></ol></li><li><a href=#-æ³¨æ„äº‹é¡¹-1>âš ï¸ æ³¨æ„äº‹é¡¹</a><ol><li><a href=#åˆ‡é¢æ‰§è¡Œé¡ºåº><strong>åˆ‡é¢æ‰§è¡Œé¡ºåº</strong></a></li><li><a href=#æ— äº‹åŠ¡åœºæ™¯><strong>æ— äº‹åŠ¡åœºæ™¯</strong></a></li><li><a href=#å¼‚æ­¥çº¿ç¨‹é—®é¢˜><strong>å¼‚æ­¥çº¿ç¨‹é—®é¢˜</strong></a></li></ol></li><li><a href=#-æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©>ğŸ’ æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©</a></li><li><a href=#-æ‰©å±•ç¼–ç¨‹å¼æ ‡è®°å›æ»š>ğŸ› ï¸ æ‰©å±•ï¼šç¼–ç¨‹å¼æ ‡è®°å›æ»š</a></li><li><a href=#-æ€»ç»“-3>ğŸ’ <strong>æ€»ç»“</strong></a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/nutrition/ style=background-color:#93b5cf;color:>ç§¯é›ªç²®
</a><a href=/categories/willow/ style=background-color:#dc9123;color:>æ»¡åŸé£çµ®
</a><a href=/categories/moon/ style=background-color:#b7ae8f;color:>æœˆæ»¡è¥¿æ¥¼</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/postopiacaffeine/>ã€Postopiaã€‘caffeine</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 02, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>10 minute read</time></div></footer></div></header><section class=article-content><h2 id=caffeine>Caffeine</h2><p>Caffeine æ˜¯ä¸€æ¬¾åŸºäº Java 8 çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜åº“ï¼Œç”± Google Guava Cache æ”¹è¿›è€Œæ¥ï¼Œç°å·²æˆä¸º Spring Boot é»˜è®¤çš„æœ¬åœ°ç¼“å­˜å®ç°ã€‚å…¶è®¾è®¡ä¸“æ³¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œé€šè¿‡åˆ›æ–°çš„ç®—æ³•å’Œçµæ´»çš„é…ç½®ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡ä¸å†…å­˜ç®¡ç†ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒç‰¹æ€§ã€å·¥ä½œåŸç†ã€ä½¿ç”¨åœºæ™¯ç­‰æ–¹é¢å±•å¼€è¯¦ç»†ä»‹ç»ï¼š</p><hr><h3 id=-æ ¸å¿ƒç‰¹æ€§>ğŸ”¥ <strong>æ ¸å¿ƒç‰¹æ€§</strong></h3><ol><li><strong>é«˜æ€§èƒ½ä¸é«˜å‘½ä¸­ç‡</strong><ul><li><strong>Window TinyLFU ç®—æ³•</strong>ï¼šCaffeine é‡‡ç”¨æ··åˆäº† LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰å’Œ LFUï¼ˆæœ€ä¸å¸¸ä½¿ç”¨ï¼‰ä¼˜åŠ¿çš„ç®—æ³•ï¼Œé€šè¿‡é¢‘ç‡ç»Ÿè®¡æ™ºèƒ½ä¿ç•™çƒ­ç‚¹æ•°æ®ï¼Œå‘½ä¸­ç‡æ¥è¿‘ç†è®ºæœ€ä¼˜å€¼ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¾è‘—ä¼˜äºä¼ ç»Ÿ LRU ç®—æ³•<a class=link href=@ref>3,4,5</a>ã€‚</li><li><strong>æ— é”å¹¶å‘è®¾è®¡</strong>ï¼šåŸºäº Java 8 çš„ <code>StampedLock</code> å’Œåˆ†æ®µé”æŠ€æœ¯ï¼Œå‡å°‘çº¿ç¨‹ç«äº‰ï¼Œæ”¯æŒé«˜ååé‡è®¿é—®ï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰<a class=link href=@ref>3,5</a>ã€‚</li></ul></li><li><strong>çµæ´»çš„ç¼“å­˜ç­–ç•¥</strong><ul><li><strong>åŸºäºå®¹é‡</strong>ï¼šé€šè¿‡ <code>maximumSize</code> é™åˆ¶æ¡ç›®æ•°é‡ï¼Œæˆ–é€šè¿‡ <code>maximumWeight</code> ç»“åˆæƒé‡å‡½æ•°ï¼ˆå¦‚æ•°æ®å¤§å°ï¼‰æ§åˆ¶å†…å­˜å ç”¨<a class=link href=@ref>3,6</a>ã€‚</li><li>åŸºäºæ—¶é—´ï¼š<ul><li><code>expireAfterWrite</code>ï¼šå†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼ˆå¦‚ 10 åˆ†é’Ÿï¼‰ï¼›</li></ul></li><li><code>expireAfterAccess</code>ï¼šæœ€åä¸€æ¬¡è®¿é—®/å†™å…¥åå›ºå®šæ—¶é—´è¿‡æœŸï¼›<ul><li><code>refreshAfterWrite</code>ï¼šå†™å…¥åå®šæ—¶åˆ·æ–°ï¼ˆå¼‚æ­¥åŠ è½½æ–°å€¼ï¼Œä¸é˜»å¡è¯·æ±‚ï¼‰<a class=link href=@ref>3,5,6</a>ã€‚</li></ul></li><li><strong>åŸºäºå¼•ç”¨</strong>ï¼šæ”¯æŒå¼±å¼•ç”¨ï¼ˆ<code>weakKeys</code>/<code>weakValues</code>ï¼‰æˆ–è½¯å¼•ç”¨ï¼ˆ<code>softValues</code>ï¼‰ï¼Œå…è®¸ JVM åœ¨å†…å­˜ä¸è¶³æ—¶å›æ”¶ç¼“å­˜<a class=link href=@ref>5,6</a>ã€‚</li></ul></li><li><strong>å¼‚æ­¥ä¸è‡ªåŠ¨åŠ è½½</strong><ul><li><strong>å¼‚æ­¥åŠ è½½ï¼ˆAsyncCacheï¼‰</strong>ï¼šè¿”å› <code>CompletableFuture</code>ï¼Œé€‚ç”¨äºéé˜»å¡ç¼–ç¨‹æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ <code>ForkJoinPool</code> æ‰§è¡ŒåŠ è½½ä»»åŠ¡<a class=link href=@ref>3,7</a>ã€‚</li><li><strong>åŒæ­¥åŠ è½½ï¼ˆLoadingCacheï¼‰</strong>ï¼šé€šè¿‡ <code>CacheLoader</code> å®ç°ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®ï¼Œé¿å…æ‰‹åŠ¨å¤„ç†é€»è¾‘<a class=link href=@ref>5,7</a>ã€‚</li></ul></li><li><strong>æ‰©å±•åŠŸèƒ½</strong><ul><li><strong>æ·˜æ±°ç›‘å¬</strong>ï¼š<code>removalListener</code> å¯æ•è·æ¡ç›®ç§»é™¤äº‹ä»¶ï¼ˆå¦‚è¿‡æœŸã€æ‰‹åŠ¨åˆ é™¤ï¼‰ï¼Œä¾¿äºæ—¥å¿—æˆ–èµ„æºæ¸…ç†<a class=link href=@ref>3,5</a>ã€‚</li><li><strong>ç»Ÿè®¡ç›‘æ§</strong>ï¼š<code>recordStats()</code> å¯ç”¨å‘½ä¸­ç‡ã€åŠ è½½è€—æ—¶ç­‰ç»Ÿè®¡ï¼Œè¾…åŠ©æ€§èƒ½ä¼˜åŒ–<a class=link href=@ref>3,7</a>ã€‚</li></ul></li></ol><hr><h3 id=-å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯>âš™ï¸ <strong>å·¥ä½œåŸç†ä¸å…³é”®æŠ€æœ¯</strong></h3><ol><li><strong>ç¼“å­˜æ·˜æ±°æœºåˆ¶</strong><ul><li>é‡‡ç”¨æƒ°æ€§åˆ é™¤ä¸å®šæœŸæ‰¹é‡æ¸…ç†ç»“åˆçš„ç­–ç•¥ï¼š<ul><li>è¯»/å†™æ“ä½œæ—¶æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œå¼‚æ­¥å›æ”¶è¿‡æœŸæ¡ç›®ï¼›</li><li>åå°çº¿ç¨‹å®šæœŸæ‰§è¡Œæ¸…ç†ä»»åŠ¡ï¼Œå‡å°‘ä¸»çº¿ç¨‹é˜»å¡<a class=link href=@ref>3,6</a>ã€‚</li></ul></li></ul></li><li><strong>å†…å­˜ç®¡ç†ä¼˜åŒ–</strong><ul><li><strong>æƒé‡æ§åˆ¶</strong>ï¼šé€šè¿‡ <code>Weigher</code> æ¥å£ä¸ºä¸åŒæ¡ç›®åˆ†é…æƒé‡ï¼Œé¿å…å¤§å¯¹è±¡å ç”¨è¿‡å¤šå†…å­˜<a class=link href=@ref>6</a>ã€‚</li><li><strong>æ™ºèƒ½é©±é€</strong>ï¼šç»“åˆå®¹é‡ã€æ—¶é—´ã€å¼•ç”¨ç­–ç•¥ï¼Œç¡®ä¿å†…å­˜å ç”¨å¯æ§ï¼ˆä¾‹å¦‚ <code>maximumWeight</code> ä¸ <code>weigher</code> é…åˆï¼‰<a class=link href=@ref>5,6</a>ã€‚</li></ul></li><li><strong>åˆ·æ–°ä¸è¿‡æœŸåŒºåˆ«</strong><div class=table-wrapper><table><thead><tr><th><strong>ç­–ç•¥</strong></th><th><strong>è§¦å‘æ¡ä»¶</strong></th><th><strong>è¡Œä¸º</strong></th><th><strong>é€‚ç”¨åœºæ™¯</strong></th></tr></thead><tbody><tr><td><code>expireAfterWrite</code></td><td>å†™å…¥åè¶…æ—¶</td><td>é˜»å¡è¯·æ±‚ç›´è‡³æ–°å€¼åŠ è½½å®Œæˆ</td><td>å¼ºä¸€è‡´æ€§åœºæ™¯ï¼ˆå¦‚é…ç½®æ•°æ®ï¼‰</td></tr><tr><td><code>refreshAfterWrite</code></td><td>å†™å…¥åè¶…æ—¶</td><td>è¿”å›æ—§å€¼å¹¶å¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡è¯·æ±‚</td><td>é«˜å¹¶å‘è¯»åœºæ™¯ï¼ˆå¦‚çƒ­ç‚¹æ•°æ®ï¼‰</td></tr></tbody></table></div></li></ol><hr><h3 id=-é€‚ç”¨åœºæ™¯>ğŸš€ <strong>é€‚ç”¨åœºæ™¯</strong></h3><ol><li><strong>é«˜é¢‘è®¿é—®æ•°æ®ç¼“å­˜</strong><ul><li>Web è¯·æ±‚ç»“æœã€ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€å•†å“è¯¦æƒ…ç­‰ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæå‡å“åº”é€Ÿåº¦ï¼ˆå¦‚ç”µå•†é¦–é¡µçƒ­ç‚¹å•†å“ï¼‰<a class=link href=@ref>4,7</a>ã€‚</li></ul></li><li><strong>è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¼˜åŒ–</strong><ul><li>ç¼“å­˜å›¾åƒå¤„ç†ç»“æœã€å¤§æ•°æ®åˆ†æä¸­é—´å€¼ï¼Œé¿å…é‡å¤è®¡ç®—ï¼ˆå¦‚å®æ—¶æŠ¥è¡¨ç”Ÿæˆï¼‰<a class=link href=@ref>4,6</a>ã€‚</li></ul></li><li><strong>å¾®æœåŠ¡æ¶æ„ä¸­çš„æœ¬åœ°ç¼“å­˜å±‚</strong><ul><li>ä½œä¸ºä¸‰çº§ç¼“å­˜ï¼ˆL1ï¼‰ä¸ Redisï¼ˆL2ï¼‰ã€æ•°æ®åº“ï¼ˆL3ï¼‰ååŒï¼š<ul><li>L1ï¼ˆCaffeineï¼‰ï¼šè¿›ç¨‹å†…ç¼“å­˜ï¼Œçº³ç§’çº§è®¿é—®ï¼›</li><li>L2ï¼ˆRedisï¼‰ï¼šè·¨è¿›ç¨‹å…±äº«ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼›</li><li>æ•°æ®ä¸€è‡´æ€§é€šè¿‡ TTL æˆ–æ¶ˆæ¯é€šçŸ¥ä¿éšœ<a class=link href=@ref>4,6</a>ã€‚</li></ul></li></ul></li><li><strong>é«˜å¹¶å‘ç³»ç»Ÿ</strong><ul><li>å¦‚ç§’æ€ç³»ç»Ÿåº“å­˜ç¼“å­˜ï¼Œé€šè¿‡ <code>refreshAfterWrite</code> å¼‚æ­¥æ›´æ–°ï¼Œé¿å…ç¼“å­˜å‡»ç©¿<a class=link href=@ref>3,4</a>ã€‚</li></ul></li></ol><hr><h3 id=-ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯”>âš–ï¸ <strong>ä¸å…¶ä»–ç¼“å­˜åº“å¯¹æ¯”</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>ç‰¹æ€§</strong></th><th><strong>Caffeine</strong></th><th><strong>Guava Cache</strong></th><th><strong>Redis</strong></th></tr></thead><tbody><tr><td><strong>ç®—æ³•</strong></td><td>Window TinyLFU</td><td>LRU</td><td>å¤šç§ï¼ˆå¦‚ LRUï¼‰</td></tr><tr><td><strong>å¹¶å‘æ€§èƒ½</strong></td><td>â­â­â­â­ï¼ˆæ— é”ä¼˜åŒ–ï¼‰</td><td>â­â­ï¼ˆé”ç«äº‰ï¼‰</td><td>â­â­â­ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰</td></tr><tr><td><strong>å†…å­˜ç®¡ç†</strong></td><td>çµæ´»ï¼ˆæƒé‡/å¤§å°ï¼‰</td><td>åŸºç¡€</td><td>ä¾èµ–å¤–éƒ¨é…ç½®</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>æœ¬åœ°ç¼“å­˜</td><td>å°è§„æ¨¡æœ¬åœ°ç¼“å­˜</td><td>åˆ†å¸ƒå¼ç¼“å­˜</td></tr></tbody></table></div><hr><h3 id=-åŸºç¡€ä»£ç ç¤ºä¾‹>ğŸ’» <strong>åŸºç¡€ä»£ç ç¤ºä¾‹</strong></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// åŒæ­¥åŠ è½½ç¼“å­˜ï¼ˆè‡ªåŠ¨åŠ è½½æ•°æ®ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LoadingCache</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Caffeine</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>maximumSize</span><span class=p>(</span><span class=n>1000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>expireAfterWrite</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MINUTES</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>refreshAfterWrite</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MINUTES</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>recordStats</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>userDao</span><span class=p>.</span><span class=na>getUserById</span><span class=p>(</span><span class=n>key</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// è·å–æ•°æ®ï¼ˆè‡ªåŠ¨åŠ è½½æœªå‘½ä¸­æ¡ç›®ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;user123&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// å¼‚æ­¥åŠ è½½ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>AsyncLoadingCache</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>asyncCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Caffeine</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>buildAsync</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>executor</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>userDao</span><span class=p>.</span><span class=na>getUserAsync</span><span class=p>(</span><span class=n>key</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>asyncCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;user456&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–>âš ï¸ <strong>å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–</strong></h3><ol><li><strong>ç¼“å­˜å‘½ä¸­ç‡ä½</strong><ul><li><strong>ä¼˜åŒ–</strong>ï¼šå¢å¤§ <code>maximumSize</code>ã€è°ƒæ•´è¿‡æœŸæ—¶é—´ï¼ˆå¦‚å»¶é•¿ <code>expireAfterAccess</code>ï¼‰ã€æ£€æŸ¥æ•°æ®åŠ è½½é€»è¾‘<a class=link href=@ref>2,6</a>ã€‚</li></ul></li><li><strong>å†…å­˜å ç”¨è¿‡é«˜</strong><ul><li><strong>ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ <code>maximumWeight</code> é™åˆ¶æƒé‡ã€å¯ç”¨ <code>weakValues</code> æˆ– <code>softValues</code><a class=link href=@ref>2,6</a>ã€‚</li></ul></li><li><strong>ç¼“å­˜é›ªå´©</strong><ul><li><strong>é¢„é˜²</strong>ï¼šåˆ†æ•£è¿‡æœŸæ—¶é—´ï¼ˆå¦‚éšæœº TTLï¼‰ã€ç»“åˆ <code>refreshAfterWrite</code> å¼‚æ­¥åˆ·æ–°<a class=link href=@ref>3,4</a>ã€‚</li></ul></li></ol><hr><h3 id=-æ€»ç»“>ğŸ’ <strong>æ€»ç»“</strong></h3><p>Caffeine å‡­å€Ÿ <strong>Window TinyLFU ç®—æ³•</strong>ã€<strong>æ— é”å¹¶å‘</strong>å’Œ<strong>çµæ´»çš„ç­–ç•¥ç»„åˆ</strong>ï¼Œæˆä¸º Java æœ¬åœ°ç¼“å­˜çš„æ ‡æ†ã€‚å…¶é€‚ç”¨äºé«˜å¹¶å‘ã€ä½å»¶è¿Ÿåœºæ™¯ï¼Œå¦‚å¾®æœåŠ¡ç¼“å­˜å±‚ã€çƒ­ç‚¹æ•°æ®åŠ é€Ÿç­‰ã€‚é€šè¿‡ä¸åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰ç»„æˆå¤šçº§ç¼“å­˜ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ã€‚å¼€å‘è€…å¯é€šè¿‡ä¸°å¯Œçš„é…ç½®ï¼ˆå®¹é‡ã€æ—¶é—´ã€æƒé‡ï¼‰å’Œç›‘æ§åŠŸèƒ½ï¼ˆ<code>recordStats</code>ï¼‰å®ç°ç²¾ç»†åŒ–è°ƒä¼˜<a class=link href=@ref>3,4,5</a>ã€‚</p><h2 id=å¤šçº§ç¼“å­˜>å¤šçº§ç¼“å­˜</h2><p>Spring Boot ç»“åˆ Caffeineï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰å’Œ Redisï¼ˆåˆ†å¸ƒå¼ç¼“å­˜ï¼‰å®ç°å¤šçº§ç¼“å­˜ï¼Œèƒ½æ˜¾è‘—æå‡é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç³»ç»Ÿæ€§èƒ½ã€‚ä»¥ä¸‹åŸºäºå®æˆ˜ç»éªŒï¼Œè¯¦ç»†è¯´æ˜å®ç°æ­¥éª¤å’Œå®Œæ•´ä»£ç ç¤ºä¾‹ï¼š</p><hr><h3 id=-å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡>ğŸ“ <strong>å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡</strong></h3><ol><li>è¯·æ±‚æµç¨‹<pre tabindex=0><code>è¯·æ±‚ â†’ Caffeineï¼ˆL1ï¼Œè¿›ç¨‹å†…ï¼‰â†’ å‘½ä¸­åˆ™è¿”å›  
       â†“ æœªå‘½ä¸­  
       Redisï¼ˆL2ï¼Œåˆ†å¸ƒå¼ï¼‰â†’ å‘½ä¸­åˆ™å›å¡«L1å¹¶è¿”å›  
       â†“ æœªå‘½ä¸­  
       æ•°æ®åº“ â†’ å›å¡«Rediså’ŒCaffeine
</code></pre></li><li>æ ¸å¿ƒä¼˜åŠ¿<ul><li><strong>é«˜æ€§èƒ½</strong>ï¼šCaffeine æä¾›çº³ç§’çº§è®¿é—®ï¼Œæ‰¿è½½ 80% ä»¥ä¸Šçƒ­ç‚¹è¯·æ±‚<a class=link href=@ref>4</a></li><li><strong>å®¹é‡åˆ†å±‚</strong>ï¼šRedis å­˜å‚¨å…¨é‡æ•°æ®ï¼ŒCaffeine ä»…å­˜é«˜é¢‘çƒ­ç‚¹<a class=link href=@ref>1</a></li><li><strong>ä¸€è‡´æ€§ä¿éšœ</strong>ï¼šé€šè¿‡å¼‚æ­¥é€šçŸ¥ + TTL æ§åˆ¶æ•°æ®åŒæ­¥<a class=link href=@ref>5</a></li></ul></li></ol><hr><h3 id=-ä¾èµ–é…ç½®pomxml>âš™ï¸ <strong>ä¾èµ–é…ç½®ï¼ˆpom.xmlï¼‰</strong></h3><pre tabindex=0><code>&lt;dependencies&gt;
    &lt;!-- Spring ç¼“å­˜æ”¯æŒ --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- Caffeine æœ¬åœ°ç¼“å­˜ --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.github.ben-manes.caffeine&lt;/groupId&gt;
        &lt;artifactId&gt;caffeine&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- Redis åˆ†å¸ƒå¼ç¼“å­˜ --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre><hr><h3 id=-å¤šçº§ç¼“å­˜é…ç½®ç±»>ğŸ”§ <strong>å¤šçº§ç¼“å­˜é…ç½®ç±»</strong></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableCaching</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CacheConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸€çº§ç¼“å­˜ï¼šCaffeineï¼ˆçŸ­å‘¨æœŸï¼Œé˜²ç©¿é€ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>caffeineCacheManager</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CaffeineCacheManager</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CaffeineCacheManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>manager</span><span class=p>.</span><span class=na>setCaffeine</span><span class=p>(</span><span class=n>Caffeine</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>initialCapacity</span><span class=p>(</span><span class=n>100</span><span class=p>)</span><span class=w>      </span><span class=c1>// åˆå§‹å®¹é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>maximumSize</span><span class=p>(</span><span class=n>1000</span><span class=p>)</span><span class=w>        </span><span class=c1>// æœ€å¤§æ¡ç›®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>expireAfterWrite</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>)</span><span class=w> </span><span class=c1>// çŸ­TTLé¿å…æ—§æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>recordStats</span><span class=p>());</span><span class=w>           </span><span class=c1>// å¯ç”¨ç»Ÿè®¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>manager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// äºŒçº§ç¼“å­˜ï¼šRedisï¼ˆé•¿å‘¨æœŸï¼Œå…¨é‡å­˜å‚¨ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=w> </span><span class=nf>redisCacheManager</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=p>.</span><span class=na>defaultCacheConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>entryTtl</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMinutes</span><span class=p>(</span><span class=n>30</span><span class=p>))</span><span class=w> </span><span class=c1>// é•¿TTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>serializeValuesWith</span><span class=p>(</span><span class=n>RedisSerializationContext</span><span class=p>.</span><span class=na>SerializationPair</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>fromSerializer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>GenericJackson2JsonRedisSerializer</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=n>factory</span><span class=p>).</span><span class=na>cacheDefaults</span><span class=p>(</span><span class=n>config</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç»„åˆå¤šçº§ç¼“å­˜ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>multiLevelCacheManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;caffeineCacheManager&#34;</span><span class=p>)</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;redisCacheManager&#34;</span><span class=p>)</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MultiLevelCacheManager</span><span class=p>(</span><span class=n>level1</span><span class=p>,</span><span class=w> </span><span class=n>level2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-å¤šçº§ç¼“å­˜ç®¡ç†å™¨å®ç°>ğŸ§© <strong>å¤šçº§ç¼“å­˜ç®¡ç†å™¨å®ç°</strong></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MultiLevelCacheManager</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level1</span><span class=p>;</span><span class=w> </span><span class=c1>// Caffeine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level2</span><span class=p>;</span><span class=w> </span><span class=c1>// Redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Cache</span><span class=o>&gt;</span><span class=w> </span><span class=n>caches</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MultiLevelCacheManager</span><span class=p>(</span><span class=n>CacheManager</span><span class=w> </span><span class=n>level1</span><span class=p>,</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>level1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>level1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>level2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>level2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=nf>getCache</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>caches</span><span class=p>.</span><span class=na>computeIfAbsent</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>cacheName</span><span class=w> </span><span class=o>-&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>MultiLevelCache</span><span class=p>(</span><span class=n>level1</span><span class=p>.</span><span class=na>getCache</span><span class=p>(</span><span class=n>cacheName</span><span class=p>),</span><span class=w> </span><span class=n>level2</span><span class=p>.</span><span class=na>getCache</span><span class=p>(</span><span class=n>cacheName</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MultiLevelCache</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=n>level1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=n>level2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>MultiLevelCache</span><span class=p>(</span><span class=n>Cache</span><span class=w> </span><span class=n>level1</span><span class=p>,</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=n>level2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>level1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>level1</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>level1</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoOpCache</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>level2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>level2</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>level2</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoOpCache</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>ValueWrapper</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ValueWrapper</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>level1</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 2. å†æŸ¥Redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>level2</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>level1</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>get</span><span class=p>());</span><span class=w> </span><span class=c1>// å›å¡«æœ¬åœ°ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// ä¸¤çº§å‡æœªå‘½ä¸­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åŒå†™ç­–ç•¥ï¼šåŒæ—¶æ›´æ–°ä¸¤çº§ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>level1</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>level2</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>evict</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åŒåˆ ç­–ç•¥ï¼šä¿è¯ä¸€è‡´æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>level1</span><span class=p>.</span><span class=na>evict</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>level2</span><span class=p>.</span><span class=na>evict</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç©ºç¼“å­˜å®ç°ï¼ˆå®¹é”™ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>NoOpCache</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* åŸºç¡€æ–¹æ³•å®ç° */</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹>ğŸ› ï¸ <strong>ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹</strong></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ProductRepository</span><span class=w> </span><span class=n>repository</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¯»å–æ•°æ®ï¼šè‡ªåŠ¨èµ°å¤šçº§ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;products&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Product</span><span class=w> </span><span class=nf>getProduct</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>repository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>id</span><span class=p>).</span><span class=na>orElse</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w> </span><span class=c1>// æ¨¡æ‹ŸDBæŸ¥è¯¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ›´æ–°æ•°æ®ï¼šæ¸…é™¤ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@CacheEvict</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;products&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#product.id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateProduct</span><span class=p>(</span><span class=n>Product</span><span class=w> </span><span class=n>product</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>repository</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>product</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-å…³é”®ä¼˜åŒ–ç­–ç•¥>ğŸ›¡ï¸ <strong>å…³é”®ä¼˜åŒ–ç­–ç•¥</strong></h3><ol><li><strong>æ•°æ®ä¸€è‡´æ€§ä¿éšœ</strong><ul><li><strong>åŒåˆ ç­–ç•¥</strong>ï¼šæ›´æ–°æ•°æ®ååŒæ—¶æ¸…é™¤ä¸¤çº§ç¼“å­˜ï¼ˆå¦‚ä¸Šä¾‹ <code>@CacheEvict</code>ï¼‰</li><li><strong>Pub/Sub åŒæ­¥</strong>ï¼šé€šè¿‡ Redis å‘å¸ƒè®¢é˜…ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹å¤±æ•ˆæœ¬åœ°ç¼“å­˜<a class=link href=@ref>1</a></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=c1>// Redis æ¶ˆæ¯ç›‘å¬ç¤ºä¾‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>MessageListenerAdapter</span><span class=w> </span><span class=nf>listenerAdapter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MessageListenerAdapter</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CacheEvictListener</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CacheEvictListener</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>cacheKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>caffeineCacheManager</span><span class=p>.</span><span class=na>getCache</span><span class=p>(</span><span class=s>&#34;products&#34;</span><span class=p>).</span><span class=na>evict</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>é˜²ç¼“å­˜ç©¿é€</strong><ul><li>ç¼“å­˜ç©ºå€¼ï¼ˆçŸ­TTLï¼‰ï¼š</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>product</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>level2</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>NULL_OBJECT</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w> </span><span class=c1>// ç¼“å­˜ç©ºå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>é˜²é›ªå´©æœºåˆ¶</strong><ul><li>Redis TTL æ·»åŠ éšæœºæ‰°åŠ¨ï¼š</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>10</span><span class=p>),</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MINUTES</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>æ€§èƒ½ç›‘æ§</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// è·å–Caffeineç»Ÿè®¡ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CacheStats</span><span class=w> </span><span class=n>stats</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>caffeineCache</span><span class=p>.</span><span class=na>getNativeCache</span><span class=p>().</span><span class=na>stats</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;L1å‘½ä¸­ç‡: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stats</span><span class=p>.</span><span class=na>hitRate</span><span class=p>());</span><span class=w>
</span></span></span></code></pre></div></li></ol><hr><h3 id=-é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½å¯¹æ¯”>ğŸ’ <strong>é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½å¯¹æ¯”</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>åœºæ™¯</strong></th><th><strong>æ¨èæ–¹æ¡ˆ</strong></th><th><strong>æ€§èƒ½æå‡</strong></th></tr></thead><tbody><tr><td>é«˜é¢‘è¯»ï¼ˆå¦‚å•†å“è¯¦æƒ…ï¼‰</td><td>å¤šçº§ç¼“å­˜</td><td>QPS ä» 5.8ä¸‡ â†’ 120ä¸‡ <a class=link href=@ref>4</a></td></tr><tr><td>ä½é¢‘å†™é«˜ä¸€è‡´æ€§</td><td>çº¯Redis</td><td>æ•°æ®ä¸€è‡´ä½†å»¶è¿Ÿè¾ƒé«˜</td></tr><tr><td>é™æ€æ•°æ®ï¼ˆå¦‚é…ç½®ï¼‰</td><td>çº¯Caffeine</td><td>é›¶ç½‘ç»œå»¶è¿Ÿ</td></tr></tbody></table></div><blockquote><p><strong>æ³¨</strong>ï¼šå®Œæ•´ä»£ç éœ€æ ¹æ®ä¸šåŠ¡è°ƒæ•´ä»¥ä¸‹é…ç½®ï¼š</p><ul><li>Caffeine çš„ <code>refreshAfterWrite</code>ï¼ˆæ­é… <code>CacheLoader</code> å¼‚æ­¥åˆ·æ–°ï¼‰<a class=link href=@ref>8</a></li><li>Redis åˆ†å¸ƒå¼é”æ§åˆ¶å›æºï¼ˆé˜²ç¼“å­˜å‡»ç©¿ï¼‰</li><li>åŠ¨æ€é¢„çƒ­çƒ­ç‚¹æ•°æ®ï¼ˆ<code>@PostConstruct</code> åŠ è½½é«˜é¢‘æ•°æ®ï¼‰<a class=link href=@ref>5</a>
é€šè¿‡ä»¥ä¸Šè®¾è®¡ï¼Œç³»ç»Ÿå¯æ˜¾è‘—é™ä½æ•°æ®åº“è´Ÿè½½ï¼ˆå®æµ‹ä¸‹é™ 90%ï¼‰ï¼ŒTP99 å»¶è¿Ÿä» 120ms é™è‡³ 45ms <a class=link href=@ref>4</a>ã€‚å®é™…éƒ¨ç½²æ—¶å»ºè®®é…åˆ <strong>Prometheus ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡</strong>å’Œ <strong>Hystrix é™çº§ç­–ç•¥</strong>ï¼Œä¿éšœé«˜å¯ç”¨æ€§ã€‚</li></ul></blockquote><h2 id=å·®å¼‚åŒ–å¤šçº§ç¼“å­˜>å·®å¼‚åŒ–å¤šçº§ç¼“å­˜</h2><p>åœ¨ Spring Boot åº”ç”¨ä¸­ï¼Œå¯é€šè¿‡<strong>åˆ†æ²»ç­–ç•¥</strong>å®ç°éƒ¨åˆ†æ¥å£ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼ˆCaffeine + Redisï¼‰ï¼Œå…¶ä½™æ¥å£ä»…ç”¨ Redis ç¼“å­˜ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ–¹æ¡ˆå’Œç¤ºä¾‹ï¼š</p><hr><h3 id=-æ ¸å¿ƒé…ç½®åˆ›å»ºä¸¤ç±»ç¼“å­˜ç®¡ç†å™¨>ğŸ”§ <strong>æ ¸å¿ƒé…ç½®ï¼šåˆ›å»ºä¸¤ç±»ç¼“å­˜ç®¡ç†å™¨</strong></h3><h4 id=å¤šçº§ç¼“å­˜ç®¡ç†å™¨caffeine--redis><strong>å¤šçº§ç¼“å­˜ç®¡ç†å™¨</strong>ï¼ˆCaffeine + Redisï¼‰</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CacheConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸€çº§ç¼“å­˜ï¼šCaffeineï¼ˆçŸ­TTLï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;caffeineCacheManager&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>caffeineCacheManager</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CaffeineCacheManager</span><span class=w> </span><span class=n>manager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CaffeineCacheManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>manager</span><span class=p>.</span><span class=na>setCaffeine</span><span class=p>(</span><span class=n>Caffeine</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>maximumSize</span><span class=p>(</span><span class=n>1000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>expireAfterWrite</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>));</span><span class=w> </span><span class=c1>// çŸ­TTLé¿å…è„æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>manager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// äºŒçº§ç¼“å­˜ï¼šRedisï¼ˆé•¿TTLï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;redisCacheManager&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>redisCacheManager</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=p>.</span><span class=na>defaultCacheConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>entryTtl</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMinutes</span><span class=p>(</span><span class=n>30</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=n>factory</span><span class=p>).</span><span class=na>cacheDefaults</span><span class=p>(</span><span class=n>config</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¤šçº§ç¼“å­˜ç»„åˆç®¡ç†å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;multiLevelCacheManager&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>multiLevelCacheManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;caffeineCacheManager&#34;</span><span class=p>)</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;redisCacheManager&#34;</span><span class=p>)</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>level2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CompositeCacheManager</span><span class=p>(</span><span class=n>level1</span><span class=p>,</span><span class=w> </span><span class=n>level2</span><span class=p>);</span><span class=w> </span><span class=c1>// ç»„åˆä¸¤çº§ç¼“å­˜[1,4](@ref)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=å•çº§redisç¼“å­˜ç®¡ç†å™¨ç‹¬ç«‹é…ç½®><strong>å•çº§Redisç¼“å­˜ç®¡ç†å™¨</strong>ï¼ˆç‹¬ç«‹é…ç½®ï¼‰</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;pureRedisCacheManager&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>pureRedisCacheManager</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=p>.</span><span class=na>defaultCacheConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>entryTtl</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofHours</span><span class=p>(</span><span class=n>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=n>factory</span><span class=p>).</span><span class=na>cacheDefaults</span><span class=p>(</span><span class=n>config</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-ä¸šåŠ¡å±‚ä½¿ç”¨æŒ‰æ¥å£æŒ‡å®šç¼“å­˜ç­–ç•¥>ğŸ› ï¸ <strong>ä¸šåŠ¡å±‚ä½¿ç”¨ï¼šæŒ‰æ¥å£æŒ‡å®šç¼“å­˜ç­–ç•¥</strong></h3><h4 id=å¤šçº§ç¼“å­˜æ¥å£çƒ­ç‚¹æ•°æ®><strong>å¤šçº§ç¼“å­˜æ¥å£</strong>ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼ˆä¼˜å…ˆæŸ¥Caffeineï¼Œæœªå‘½ä¸­æŸ¥Redisï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>cacheManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;multiLevelCacheManager&#34;</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;hot_products&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Product</span><span class=w> </span><span class=nf>getHotProduct</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>productRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>id</span><span class=p>).</span><span class=na>orElse</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w> </span><span class=c1>// æ•°æ®åº“æŸ¥è¯¢[4](@ref)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=å•çº§redisç¼“å­˜æ¥å£æ™®é€šæ•°æ®><strong>å•çº§Redisç¼“å­˜æ¥å£</strong>ï¼ˆæ™®é€šæ•°æ®ï¼‰</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä»…ç”¨Redisç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>cacheManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;pureRedisCacheManager&#34;</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;users&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>id</span><span class=p>).</span><span class=na>orElse</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w> </span><span class=c1>// æ•°æ®åº“æŸ¥è¯¢[5](@ref)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=åŠ¨æ€æ¡ä»¶æ§åˆ¶æ›´ç²¾ç»†çš„ç²’åº¦><strong>åŠ¨æ€æ¡ä»¶æ§åˆ¶</strong>ï¼ˆæ›´ç²¾ç»†çš„ç²’åº¦ï¼‰</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>cacheManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;multiLevelCacheManager&#34;</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;products&#34;</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>condition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#isHot == true&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// ä»…å½“isHot=trueæ—¶å¯ç”¨å¤šçº§ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Product</span><span class=w> </span><span class=nf>getProduct</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isHot</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-é«˜çº§åœºæ™¯è‡ªå®šä¹‰æ³¨è§£ç®€åŒ–é…ç½®>âš™ï¸ <strong>é«˜çº§åœºæ™¯ï¼šè‡ªå®šä¹‰æ³¨è§£ç®€åŒ–é…ç½®</strong></h3><h4 id=å®šä¹‰æ³¨è§£-multilevelcache>å®šä¹‰æ³¨è§£ <code>@MultiLevelCache</code></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>cacheManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;multiLevelCacheManager&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>MultiLevelCache</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>value</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>key</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=åœ¨ç›®æ ‡æ¥å£ä¸Šä½¿ç”¨>åœ¨ç›®æ ‡æ¥å£ä¸Šä½¿ç”¨</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@MultiLevelCache</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;orders&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#orderId&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// è‡ªåŠ¨èµ°å¤šçº§ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Order</span><span class=w> </span><span class=nf>getOrder</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–>âš ï¸ <strong>æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–</strong></h3><ol><li><strong>ç¼“å­˜ä¸€è‡´æ€§</strong><ul><li>æ›´æ–°å¤šçº§ç¼“å­˜æ•°æ®æ—¶ï¼Œéœ€åŒæ—¶æ¸…é™¤æœ¬åœ°å’ŒRedisç¼“å­˜ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@CacheEvict</span><span class=p>(</span><span class=n>cacheManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;multiLevelCacheManager&#34;</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;hot_products&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateProduct</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li>é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ <strong>Redis Pub/Sub é€šçŸ¥å…¶ä»–èŠ‚ç‚¹å¤±æ•ˆæœ¬åœ°ç¼“å­˜</strong><a class=link href=@ref>2,3</a>ã€‚</li></ul></li><li><strong>å†…å­˜æ§åˆ¶</strong><ul><li>æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰é™åˆ¶ <code>maximumSize</code>ï¼Œé¿å… OOMã€‚</li><li>éçƒ­ç‚¹æ•°æ®ç¦æ­¢ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼Œå‡å°‘å†…å­˜å‹åŠ›ã€‚</li></ul></li><li><strong>ç›‘æ§åŒºåˆ†</strong><ul><li>ç‹¬ç«‹ç›‘æ§ä¸¤ç±»ç¼“å­˜å‘½ä¸­ç‡ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å¤šçº§ç¼“å­˜ç›‘æ§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>caffeineCacheManager</span><span class=p>.</span><span class=na>getCache</span><span class=p>(</span><span class=s>&#34;hot_products&#34;</span><span class=p>).</span><span class=na>getNativeCache</span><span class=p>().</span><span class=na>stats</span><span class=p>().</span><span class=na>hitRate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Redisç¼“å­˜ç›‘æ§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;users::123&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div></li></ul></li></ol><hr><h3 id=-æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹>ğŸ’ <strong>æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>åœºæ™¯</strong></th><th><strong>ç­–ç•¥</strong></th><th><strong>é…ç½®æ–¹å¼</strong></th><th><strong>ä¼˜åŠ¿</strong></th></tr></thead><tbody><tr><td>é«˜é¢‘çƒ­ç‚¹æ•°æ®ï¼ˆå¦‚å•†å“è¯¦æƒ…ï¼‰</td><td>å¤šçº§ç¼“å­˜</td><td><code>@Cacheable(cacheManager="multiLevelCacheManager")</code></td><td>çº³ç§’çº§å“åº”ï¼Œé™ä½Rediså‹åŠ›</td></tr><tr><td>ä½é¢‘æ™®é€šæ•°æ®ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰</td><td>å•çº§Redis</td><td><code>@Cacheable(cacheManager="pureRedisCacheManager")</code></td><td>èŠ‚çœå†…å­˜ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</td></tr><tr><td>æ¡ä»¶åŒ–ç¼“å­˜ï¼ˆåŠ¨æ€å†³ç­–ï¼‰</td><td>æ³¨è§£+SpELæ¡ä»¶è¡¨è¾¾å¼</td><td><code>condition = "#isHot"</code></td><td>çµæ´»æ§åˆ¶ç¼“å­˜å±‚çº§</td></tr></tbody></table></div><hr><h3 id=-æ‰©å±•è§£å†³å¤šçº§ç¼“å­˜çš„å…¸å‹é—®é¢˜>ğŸ” <strong>æ‰©å±•ï¼šè§£å†³å¤šçº§ç¼“å­˜çš„å…¸å‹é—®é¢˜</strong></h3><ul><li>ç¼“å­˜ç©¿é€ï¼šåœ¨å¤šçº§ç¼“å­˜çš„ get æ–¹æ³•ä¸­ï¼Œå¯¹ç©ºå€¼è¿›è¡ŒçŸ­æ—¶é—´ç¼“å­˜ï¼š<pre tabindex=0><code>if (value == null) {
    redisCache.put(key, NULL_OBJECT, 30, TimeUnit.SECONDS); // ç¼“å­˜ç©ºå€¼[5](@ref)
}
</code></pre></li><li>ç¼“å­˜é›ªå´©ï¼šä¸º Redis çš„ TTL æ·»åŠ éšæœºæ‰°åŠ¨ï¼š<pre tabindex=0><code>.entryTtl(Duration.ofMinutes(30 + ThreadLocalRandom.current().nextInt(10)));
</code></pre></li></ul><hr><p>é€šè¿‡ä»¥ä¸Šè®¾è®¡ï¼Œ<strong>çƒ­ç‚¹æ¥å£</strong>ï¼ˆå¦‚ç§’æ€å•†å“æŸ¥è¯¢ï¼‰äº«å—æœ¬åœ°ç¼“å­˜çš„é€Ÿåº¦ä¼˜åŠ¿ï¼ˆ&lt;10msï¼‰ï¼Œ<strong>æ™®é€šæ¥å£</strong>ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰ä¿æŒ Redis çš„å…¨å±€ä¸€è‡´æ€§ï¼ŒåŒæ—¶é¿å…å†…å­˜æµªè´¹ã€‚å®é™…éƒ¨ç½²æ—¶ï¼Œå»ºè®®ç»“åˆ <strong>Spring Actuator</strong> ç›‘æ§ç¼“å­˜æŒ‡æ ‡ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡æµé‡åŠ¨æ€è°ƒæ•´ç¼“å­˜ç­–ç•¥ã€‚</p><h2 id=è‡ªå®šä¹‰ttl>è‡ªå®šä¹‰TTL</h2><p>åœ¨Spring Bootä¸­ï¼Œ<code>@Cacheable</code>æœ¬èº«ä¸ç›´æ¥æ”¯æŒTTLè®¾ç½®ï¼ˆå› å…¶ä¸ºæŠ½è±¡å±‚ï¼Œä¸ä¾èµ–å…·ä½“ç¼“å­˜å®ç°ï¼‰ï¼Œä½†å¯é€šè¿‡ä»¥ä¸‹æ–¹æ³•å®ç°è‡ªå®šä¹‰TTLï¼š</p><hr><h3 id=-è‡ªå®šä¹‰cachemanageræ¨è>â³ <strong>è‡ªå®šä¹‰CacheManagerï¼ˆæ¨èï¼‰</strong></h3><p>é€šè¿‡æ‰©å±•<code>RedisCacheManager</code>è§£æ<code>cacheNames</code>ä¸­çš„TTLä¿¡æ¯ï¼š</p><ol><li><p><strong>è‡ªå®šä¹‰CacheManager</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomRedisCacheManager</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>CustomRedisCacheManager</span><span class=p>(</span><span class=n>RedisCacheWriter</span><span class=w> </span><span class=n>writer</span><span class=p>,</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>config</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>writer</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>RedisCache</span><span class=w> </span><span class=nf>createRedisCache</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>config</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>parts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;#&#34;</span><span class=p>);</span><span class=w>  </span><span class=c1>// æ ¼å¼ï¼šcacheName#TTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>parts</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>ttl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>parseLong</span><span class=p>(</span><span class=n>parts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>entryTtl</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofSeconds</span><span class=p>(</span><span class=n>ttl</span><span class=p>));</span><span class=w> </span><span class=c1>// è®¾ç½®TTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>createRedisCache</span><span class=p>(</span><span class=n>parts</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>é…ç½®Bean</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>cacheManager</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>defaultConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=p>.</span><span class=na>defaultCacheConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>entryTtl</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofHours</span><span class=p>(</span><span class=n>1</span><span class=p>));</span><span class=w> </span><span class=c1>// é»˜è®¤TTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CustomRedisCacheManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisCacheWriter</span><span class=p>.</span><span class=na>nonLockingRedisCacheWriter</span><span class=p>(</span><span class=n>factory</span><span class=p>),</span><span class=w> </span><span class=n>defaultConfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>ä½¿ç”¨æ³¨è§£</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>cacheNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;users#3600&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// TTL=3600ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>ä¼˜ç‚¹</strong>ï¼šç®€æ´é«˜æ•ˆï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç <a class=link href=@ref>1,2,6</a>ã€‚</p></li></ol><hr><h3 id=-è‡ªå®šä¹‰æ³¨è§£aop>âœ¨ <strong>è‡ªå®šä¹‰æ³¨è§£+AOP</strong></h3><p>é€šè¿‡è‡ªå®šä¹‰æ³¨è§£ï¼ˆå¦‚<code>@CacheTTL</code>ï¼‰å’ŒAOPåŠ¨æ€è®¾ç½®TTLï¼š</p><ol><li><p><strong>å®šä¹‰æ³¨è§£</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>CacheTTL</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=nf>value</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>60</span><span class=p>;</span><span class=w> </span><span class=c1>// é»˜è®¤60ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>AOPæ‹¦æˆª</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CacheTTLAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Around</span><span class=p>(</span><span class=s>&#34;@annotation(cacheTTL)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>applyTTL</span><span class=p>(</span><span class=n>ProceedingJoinPoint</span><span class=w> </span><span class=n>pjp</span><span class=p>,</span><span class=w> </span><span class=n>CacheTTL</span><span class=w> </span><span class=n>cacheTTL</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>ttl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cacheTTL</span><span class=p>.</span><span class=na>value</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†TTLå­˜å…¥ThreadLocal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CacheContext</span><span class=p>.</span><span class=na>setTTL</span><span class=p>(</span><span class=n>ttl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>pjp</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p><strong>æ‰©å±•RedisCache</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomRedisCache</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RedisCache</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>ttl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CacheContext</span><span class=p>.</span><span class=na>getTTL</span><span class=p>();</span><span class=w> </span><span class=c1>// ä»ThreadLocalè·å–TTL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ttl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä½¿ç”¨è‡ªå®šä¹‰TTLå†™å…¥Redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cacheWriter</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>serializeKey</span><span class=p>(</span><span class=n>key</span><span class=p>),</span><span class=w> </span><span class=n>serializeValue</span><span class=p>(</span><span class=n>value</span><span class=p>),</span><span class=w> </span><span class=n>Duration</span><span class=p>.</span><span class=na>ofSeconds</span><span class=p>(</span><span class=n>ttl</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>ä¼˜ç‚¹</strong>ï¼šè¯­ä¹‰æ˜ç¡®ï¼Œæ”¯æŒæ–¹æ³•çº§ç²¾ç»†æ§åˆ¶<a class=link href=@ref>1,6,8</a>ã€‚</p></li></ol><hr><h3 id=-ç¼“å­˜æä¾›è€…åŸç”Ÿé…ç½®>âš™ï¸ <strong>ç¼“å­˜æä¾›è€…åŸç”Ÿé…ç½®</strong></h3><p>é’ˆå¯¹å…·ä½“ç¼“å­˜ä¸­é—´ä»¶é…ç½®å…¨å±€æˆ–ç¼“å­˜åŒºTTLï¼š</p><ol><li><strong>Rediså…¨å±€é»˜è®¤TTL</strong>ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>cacheManager</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RedisCacheConfiguration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RedisCacheConfiguration</span><span class=p>.</span><span class=na>defaultCacheConfig</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>entryTtl</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofMinutes</span><span class=p>(</span><span class=n>30</span><span class=p>));</span><span class=w> </span><span class=c1>// æ‰€æœ‰ç¼“å­˜é»˜è®¤30åˆ†é’Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=p>.</span><span class=na>builder</span><span class=p>(</span><span class=n>factory</span><span class=p>).</span><span class=na>cacheDefaults</span><span class=p>(</span><span class=n>config</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>Ehcacheç¼“å­˜åŒºTTL</strong>ï¼š<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;!--</span><span class=w> </span><span class=n>ehcache</span><span class=p>.</span><span class=na>xml</span><span class=w> </span><span class=o>--&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>cache</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s>&#34;users&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>maxEntriesLocalHeap</span><span class=o>=</span><span class=s>&#34;1000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>timeToLiveSeconds</span><span class=o>=</span><span class=s>&#34;3600&#34;</span><span class=o>/&gt;</span><span class=w> </span><span class=o>&lt;!--</span><span class=w> </span><span class=n>TTL</span><span class=o>=</span><span class=n>1å°æ—¶</span><span class=w> </span><span class=o>--&gt;</span><span class=w>
</span></span></span></code></pre></div><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šTTLç»Ÿä¸€æˆ–æŒ‰ç¼“å­˜åŒºåˆ†ç»„è®¾ç½®<a class=link href=@ref>4,7</a>ã€‚</li></ol><hr><h3 id=-æ³¨æ„äº‹é¡¹>âš ï¸ <strong>æ³¨æ„äº‹é¡¹</strong></h3><ol><li>ä¼˜å…ˆçº§ï¼š<ul><li>æ–¹æ³•çº§æ³¨è§£TTL > ç¼“å­˜åŒºé…ç½® > å…¨å±€é»˜è®¤TTL<a class=link href=@ref>1,6</a>ã€‚</li></ul></li><li>æ—¶é—´å•ä½ï¼š<ul><li>Redisé»˜è®¤ç”¨ç§’ï¼ŒEhcacheæ”¯æŒç§’/æ¯«ç§’ï¼Œéœ€æ³¨æ„å•ä½è½¬æ¢ã€‚</li></ul></li><li>ç¼“å­˜ç©¿é€ï¼š<ul><li>çŸ­TTLç¼“å­˜ç©ºå€¼ï¼ˆ<code>unless = "#result == null"</code>ï¼‰é¿å…é¢‘ç¹æŸ¥è¯¢DB<a class=link href=@ref>1</a>ã€‚</li></ul></li><li>åŠ¨æ€åˆ·æ–°ï¼š<ul><li>ç»“åˆ<code>@Scheduled</code>+<code>@CacheEvict</code>å®šæ—¶åˆ·æ–°çƒ­ç‚¹æ•°æ®ï¼ˆå¦‚æå‰10ç§’ç»­æœŸï¼‰<a class=link href=@ref>1,6</a>ã€‚</li></ul></li></ol><hr><h3 id=-æ–¹æ³•å¯¹æ¯”>ğŸ”„ <strong>æ–¹æ³•å¯¹æ¯”</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>æ–¹æ³•</strong></th><th>é€‚ç”¨åœºæ™¯</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>è‡ªå®šä¹‰CacheManager</td><td>Redisç¯å¢ƒï¼Œéœ€å¿«é€Ÿé›†æˆ</td><td>ä»£ç ä¾µå…¥å°ï¼Œé…ç½®çµæ´»</td><td>éœ€è§„èŒƒcacheNamesæ ¼å¼</td></tr><tr><td>è‡ªå®šä¹‰æ³¨è§£+AOP</td><td>éœ€è¦æ–¹æ³•çº§ç²¾ç»†æ§åˆ¶</td><td>è¯­ä¹‰æ¸…æ™°ï¼Œæ‰©å±•æ€§å¼º</td><td>AOPå¢åŠ å¤æ‚åº¦</td></tr><tr><td>ç¼“å­˜æä¾›è€…åŸç”Ÿé…ç½®</td><td>TTLåˆ†ç»„æˆ–å…¨å±€ç»Ÿä¸€</td><td>æ— éœ€ä»£ç æ”¹åŠ¨ï¼Œä¾èµ–ä¸­é—´ä»¶èƒ½åŠ›</td><td>çµæ´»æ€§ä½</td></tr></tbody></table></div><blockquote><p>ğŸ’¡ <strong>æ¨èé€‰æ‹©</strong>ï¼š</p><ul><li>ç®€å•åœºæ™¯ â†’ <strong>è‡ªå®šä¹‰CacheManager</strong>ï¼ˆå¿«é€Ÿç”Ÿæ•ˆï¼‰<a class=link href=@ref>1,2</a>ï¼›</li><li>å¤æ‚é€»è¾‘ â†’ <strong>è‡ªå®šä¹‰æ³¨è§£+AOP</strong>ï¼ˆå¦‚åŠ¨æ€TTL+è‡ªåŠ¨åˆ·æ–°ï¼‰<a class=link href=@ref>6,8</a>ã€‚</li></ul></blockquote><h2 id=å»¶è¿ŸåŒåˆ >å»¶è¿ŸåŒåˆ </h2><p>åœ¨Springåº”ç”¨ä¸­å®ç°å»¶è¿ŸåŒåˆ ç­–ç•¥ï¼Œéœ€ç»“åˆç¼“å­˜æ³¨è§£ï¼ˆå¦‚<code>@CacheEvict</code>ï¼‰ä¸å¼‚æ­¥å»¶è¿Ÿåˆ é™¤æœºåˆ¶ï¼Œè§£å†³é«˜å¹¶å‘ä¸‹ç¼“å­˜ä¸æ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸¤ç§ä¸»æµå®ç°æ–¹æ¡ˆåŠæ ¸å¿ƒå®è·µï¼š</p><hr><h3 id=-å»¶è¿ŸåŒåˆ çš„æ ¸å¿ƒåŸç†>âš™ï¸ <strong>å»¶è¿ŸåŒåˆ çš„æ ¸å¿ƒåŸç†</strong></h3><p><strong>é—®é¢˜åœºæ™¯</strong>ï¼š
åœ¨å¹¶å‘æ›´æ–°æ—¶ï¼Œè‹¥ä»…åˆ é™¤ä¸€æ¬¡ç¼“å­˜ï¼Œå¯èƒ½å‡ºç°ï¼š</p><ol><li>çº¿ç¨‹Aåˆ é™¤ç¼“å­˜ â†’ æ›´æ–°æ•°æ®åº“ï¼ˆè€—æ—¶æ“ä½œï¼‰</li><li>çº¿ç¨‹Båœ¨Aæ›´æ–°å®Œæˆå‰è¯»å–æ•°æ®åº“æ—§æ•°æ® â†’ å°†æ—§æ•°æ®å†™å…¥ç¼“å­˜</li><li>çº¿ç¨‹Aæ›´æ–°å®Œæˆï¼Œä½†ç¼“å­˜å·²è¢«Bæ±¡æŸ“ï¼Œå¯¼è‡´åç»­è¯·æ±‚è¯»å–è„æ•°æ®ã€‚
<strong>å»¶è¿ŸåŒåˆ æµç¨‹</strong>ï¼š</li><li><strong>é¦–æ¬¡åˆ é™¤ç¼“å­˜</strong>ï¼šæ›´æ–°æ•°æ®åº“å‰åˆ é™¤ç¼“å­˜ï¼Œé˜²æ­¢æ—§æ•°æ®è¢«è¯»å–ã€‚</li><li><strong>æ›´æ–°æ•°æ®åº“</strong>ï¼šæ‰§è¡Œä¸šåŠ¡æ•°æ®æ›´æ–°ã€‚</li><li><strong>å»¶è¿ŸäºŒæ¬¡åˆ é™¤</strong>ï¼šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆå¦‚500msï¼‰åå†æ¬¡åˆ é™¤ç¼“å­˜ï¼Œç¡®ä¿å¹¶å‘è¯»æ“ä½œå·²å®Œæˆï¼Œé¿å…è„æ•°æ®æ®‹ç•™ã€‚</li></ol><hr><h3 id=-å®ç°æ–¹æ¡ˆä¸€åŸºäºaopåˆ‡é¢--è‡ªå®šä¹‰æ³¨è§£>ğŸ› ï¸ <strong>å®ç°æ–¹æ¡ˆä¸€ï¼šåŸºäºAOPåˆ‡é¢ + è‡ªå®šä¹‰æ³¨è§£</strong></h3><h4 id=å®šä¹‰è‡ªå®šä¹‰æ³¨è§£><strong>å®šä¹‰è‡ªå®šä¹‰æ³¨è§£</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>DelayDoubleDelete</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>cacheName</span><span class=p>();</span><span class=w>  </span><span class=c1>// ç¼“å­˜åç§°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=nf>delay</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>500</span><span class=p>;</span><span class=w> </span><span class=c1>// å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=å®ç°aopåˆ‡é¢æ ¸å¿ƒé€»è¾‘><strong>å®ç°AOPåˆ‡é¢ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DelayDoubleDeleteAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Around</span><span class=p>(</span><span class=s>&#34;@annotation(delayDelete)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>doDelayDelete</span><span class=p>(</span><span class=n>ProceedingJoinPoint</span><span class=w> </span><span class=n>joinPoint</span><span class=p>,</span><span class=w> </span><span class=n>DelayDoubleDelete</span><span class=w> </span><span class=n>delayDelete</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodSignature</span><span class=w> </span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MethodSignature</span><span class=p>)</span><span class=w> </span><span class=n>joinPoint</span><span class=p>.</span><span class=na>getSignature</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>signature</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1. é¦–æ¬¡åˆ é™¤ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cacheName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>delayDelete</span><span class=p>.</span><span class=na>cacheName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>keys</span><span class=p>(</span><span class=n>cacheName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;:*&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// æ¨¡ç³ŠåŒ¹é…Key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>keys</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2. æ‰§è¡Œæ•°æ®åº“æ›´æ–°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>joinPoint</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3. å»¶è¿ŸäºŒæ¬¡åˆ é™¤ï¼ˆå¼‚æ­¥çº¿ç¨‹ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>runAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>delayDelete</span><span class=p>.</span><span class=na>delay</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>keysAgain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>keys</span><span class=p>(</span><span class=n>cacheName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;:*&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>keysAgain</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹><strong>ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DelayDoubleDelete</span><span class=p>(</span><span class=n>cacheName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;userCache&#34;</span><span class=p>,</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>500</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateUser</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userRepository</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w> </span><span class=c1>// æ›´æ–°æ•°æ®åº“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=-å®ç°æ–¹æ¡ˆäºŒå¢å¼ºcachemanageréä¾µå…¥å¼>ğŸ”Œ <strong>å®ç°æ–¹æ¡ˆäºŒï¼šå¢å¼ºCacheManagerï¼ˆéä¾µå…¥å¼ï¼‰</strong></h3><p>è‹¥å¸Œæœ›æ— ä¾µå…¥å¼é›†æˆï¼Œå¯åŒ…è£…Spring Cacheçš„<code>CacheManager</code>ï¼Œè‡ªåŠ¨ä¸º<code>@CacheEvict</code>æ·»åŠ å»¶è¿ŸåŒåˆ é€»è¾‘ã€‚</p><h4 id=åŒ…è£…cacheä¸cachemanager><strong>åŒ…è£…Cacheä¸CacheManager</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EnhancedCache</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=n>delegate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>delay</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>evict</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>delegate</span><span class=p>.</span><span class=na>evict</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w> </span><span class=c1>// é¦–æ¬¡åˆ é™¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CompletableFuture</span><span class=p>.</span><span class=na>runAsync</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>delay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>delegate</span><span class=p>.</span><span class=na>evict</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w> </span><span class=c1>// å»¶è¿ŸäºŒæ¬¡åˆ é™¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>ignored</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EnhancedCacheManager</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=n>delegate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>delay</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Cache</span><span class=w> </span><span class=nf>getCache</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EnhancedCache</span><span class=p>(</span><span class=n>delegate</span><span class=p>.</span><span class=na>getCache</span><span class=p>(</span><span class=n>name</span><span class=p>),</span><span class=w> </span><span class=n>delay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=æ³¨å†Œå¢å¼ºcachemanagerè‡³springå®¹å™¨><strong>æ³¨å†Œå¢å¼ºCacheManagerè‡³Springå®¹å™¨</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CacheConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>CacheManager</span><span class=w> </span><span class=nf>cacheManager</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisCacheManager</span><span class=w> </span><span class=n>defaultManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RedisCacheManager</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>EnhancedCacheManager</span><span class=p>(</span><span class=n>defaultManager</span><span class=p>,</span><span class=w> </span><span class=n>500</span><span class=p>);</span><span class=w> </span><span class=c1>// å»¶è¿Ÿ500ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>æ•ˆæœ</strong>ï¼šæ‰€æœ‰ä½¿ç”¨<code>@CacheEvict</code>çš„æ–¹æ³•è‡ªåŠ¨è§¦å‘å»¶è¿ŸåŒåˆ ã€‚</p><hr><h3 id=-å…³é”®æ³¨æ„äº‹é¡¹>âš ï¸ <strong>å…³é”®æ³¨æ„äº‹é¡¹</strong></h3><ol><li><strong>å»¶è¿Ÿæ—¶é—´è®¾ç½®</strong><ul><li>å»ºè®®<strong>500ms-1000ms</strong>ï¼Œæ ¹æ®ä¸šåŠ¡SQLå¹³å‡æ‰§è¡Œæ—¶é—´è°ƒæ•´ã€‚</li><li>å¯é€šè¿‡SpELåŠ¨æ€è®¾ç½®ï¼š<code>@DelayDoubleDelete(delay = "#{T(java.lang.Math).min(1000, #user.updateTime)})</code>ã€‚</li></ul></li><li><strong>ç¼“å­˜Keyçš„åŒ¹é…</strong><ul><li>ä½¿ç”¨<code>redisTemplate.keys(pattern)</code>éœ€è°¨æ…ï¼Œé¿å…æ¨¡ç³ŠåŒ¹é…å¯¼è‡´è¯¯åˆ ã€‚</li><li>æ¨è<strong>ç²¾ç¡®Keyå®šä½</strong>ï¼šåœ¨æ³¨è§£ä¸­æŒ‡å®šKeyè¡¨è¾¾å¼ï¼ˆå¦‚<code>key = "#user.id"</code>ï¼‰ã€‚</li></ul></li><li><strong>çº¿ç¨‹æ± ä¼˜åŒ–</strong><ul><li>å¼‚æ­¥åˆ é™¤éœ€ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼š<pre tabindex=0><code>private final ScheduledExecutorService executor = Executors.newScheduledThreadPool(4);
executor.schedule(() -&gt; deleteCache(key), delay, TimeUnit.MILLISECONDS);
</code></pre></li></ul></li><li><strong>é€‚ç”¨åœºæ™¯é™åˆ¶</strong><ul><li><strong>è¯»å¤šå†™å°‘</strong>ï¼šé¢‘ç¹å†™æ“ä½œä¼šå¯¼è‡´ç¼“å­˜é¢‘ç¹å¤±æ•ˆï¼Œé™ä½æ€§èƒ½ã€‚</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šå»¶è¿ŸåŒåˆ ä¸ä¿è¯å¼ºä¸€è‡´ï¼Œé€‚ç”¨äºå®¹å¿æ¯«ç§’çº§å»¶è¿Ÿçš„ä¸šåŠ¡ã€‚</li></ul></li></ol><hr><h3 id=-æ–¹æ¡ˆå¯¹æ¯”>ğŸ“Š <strong>æ–¹æ¡ˆå¯¹æ¯”</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>æ–¹æ¡ˆ</strong></th><th>ä¾µå…¥æ€§</th><th>çµæ´»æ€§</th><th>ç»´æŠ¤æ€§</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>AOP + è‡ªå®šä¹‰æ³¨è§£</td><td>ä¸­</td><td>é«˜</td><td>éœ€ç»´æŠ¤åˆ‡é¢é€»è¾‘</td><td>éœ€ç²¾ç»†æ§åˆ¶ç¼“å­˜Key</td></tr><tr><td>å¢å¼ºCacheManager</td><td>ä½</td><td>ä¸­</td><td>å…¨å±€ç”Ÿæ•ˆï¼Œæ— éœ€æ”¹ä¸šåŠ¡ä»£ç </td><td>å…¨é¡¹ç›®ç»Ÿä¸€ç­–ç•¥</td></tr></tbody></table></div><hr><h3 id=-æ€»ç»“-1>ğŸ’ <strong>æ€»ç»“</strong></h3><ul><li><strong>é¦–é€‰AOPæ–¹æ¡ˆ</strong>ï¼šéœ€å®šåˆ¶åŒ–ç¼“å­˜æ¸…ç†é€»è¾‘æ—¶ï¼ˆå¦‚æ¨¡ç³Šåˆ é™¤ã€å¤šçº§ç¼“å­˜ï¼‰ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£æ›´çµæ´»ã€‚</li><li><strong>æ— ä¾µå…¥æ–¹æ¡ˆ</strong>ï¼šè‹¥é¡¹ç›®å¹¿æ³›ä½¿ç”¨<code>@CacheEvict</code>ï¼Œå¢å¼º<code>CacheManager</code>å¯å¿«é€Ÿç”Ÿæ•ˆã€‚</li><li><strong>å…œåº•ç­–ç•¥</strong>ï¼šç»“åˆ<strong>çŸ­TTL</strong>ï¼ˆå¦‚30sï¼‰ç¡®ä¿æç«¯æƒ…å†µä¸‹ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆï¼ŒåŒé‡ä¿éšœæ•°æ®ä¸€è‡´æ€§ã€‚</li></ul><blockquote><p>å®Œæ•´ä»£ç å‚è€ƒï¼š<a class=link href=https://github.com/example/delay-double-delete target=_blank rel=noopener>GitHubç¤ºä¾‹</a></p></blockquote><h2 id=cachemanager-å¢å¼º>CacheManager å¢å¼º</h2><p>åœ¨ Spring ç¯å¢ƒä¸‹ï¼Œ<code>EnhancedCache</code> çš„å»¶è¿ŸåŒåˆ æœºåˆ¶ä¸äº‹åŠ¡å›æ»šçš„å†²çªæ ¸å¿ƒåœ¨äºï¼š<strong>äº‹åŠ¡å›æ»šæ—¶æ•°æ®åº“æ“ä½œè¢«æ’¤é”€ï¼Œä½†å¼‚æ­¥çš„äºŒæ¬¡åˆ é™¤ä»ä¼šæ‰§è¡Œï¼Œå¯¼è‡´æ–°å†™å…¥çš„ç¼“å­˜è¢«è¯¯åˆ </strong>ã€‚ä»¥ä¸‹æ˜¯ä¼˜åŒ–æ–¹æ¡ˆä¸åŸç†è¯´æ˜ï¼š</p><hr><h3 id=-é—®é¢˜æ ¹æº>âš ï¸ <strong>é—®é¢˜æ ¹æº</strong></h3><pre tabindex=0><code>CompletableFuture.runAsync(() -&gt; {
    Thread.sleep(delay);
    delegate.evict(key); // äº‹åŠ¡å›æ»šåä»æ‰§è¡ŒäºŒæ¬¡åˆ é™¤
});
</code></pre><ul><li><strong>é£é™©</strong>ï¼šè‹¥æ•°æ®åº“äº‹åŠ¡å›æ»šï¼ŒäºŒæ¬¡åˆ é™¤ä¼šæ¸…é™¤å…¶ä»–çº¿ç¨‹å†™å…¥çš„æ–°ç¼“å­˜ï¼ˆå¦‚æ–°æ’å…¥çš„æ•°æ®ï¼‰ï¼Œé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚</li></ul><hr><h3 id=-è§£å†³æ–¹æ¡ˆç»‘å®šäºŒæ¬¡åˆ é™¤åˆ°äº‹åŠ¡æäº¤>ğŸ”§ <strong>è§£å†³æ–¹æ¡ˆï¼šç»‘å®šäºŒæ¬¡åˆ é™¤åˆ°äº‹åŠ¡æäº¤</strong></h3><h4 id=æ ¸å¿ƒæ”¹é€ æ€è·¯><strong>æ ¸å¿ƒæ”¹é€ æ€è·¯</strong></h4><p>å°†äºŒæ¬¡åˆ é™¤æ“ä½œå»¶è¿Ÿåˆ°äº‹åŠ¡æäº¤åæ‰§è¡Œï¼Œè‹¥äº‹åŠ¡å›æ»šåˆ™å–æ¶ˆåˆ é™¤ä»»åŠ¡ï¼š</p><pre tabindex=0><code>@Override
public void evict(Object key) {
    delegate.evict(key); // é¦–æ¬¡åˆ é™¤

    // ä»…åœ¨äº‹åŠ¡æäº¤åæ‰§è¡ŒäºŒæ¬¡åˆ é™¤
    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                scheduleSecondEvict(key); // æäº¤åè°ƒåº¦äºŒæ¬¡åˆ é™¤
            }
        }
    );
}

private void scheduleSecondEvict(Object key) {
    CompletableFuture.runAsync(() -&gt; {
        try {
            Thread.sleep(delay);
            delegate.evict(key);
        } catch (InterruptedException ignored) {}
    });
}
</code></pre><p><strong>åŸç†</strong>ï¼š</p><ul><li><code>TransactionSynchronization.afterCommit()</code> ç¡®ä¿äºŒæ¬¡åˆ é™¤ä»…åœ¨äº‹åŠ¡æˆåŠŸæäº¤åè§¦å‘ã€‚</li><li>è‹¥äº‹åŠ¡å›æ»šï¼Œ<code>afterCommit()</code> ä¸ä¼šæ‰§è¡Œï¼Œé¿å…è¯¯åˆ æ–°ç¼“å­˜ã€‚</li></ul><h4 id=å¤„ç†æ— äº‹åŠ¡åœºæ™¯><strong>å¤„ç†æ— äº‹åŠ¡åœºæ™¯</strong></h4><p>è‹¥å½“å‰æ— äº‹åŠ¡ï¼Œç›´æ¥æ‰§è¡Œå¼‚æ­¥åˆ é™¤ï¼š</p><pre tabindex=0><code>@Override
public void evict(Object key) {
    delegate.evict(key); 
    
    if (TransactionSynchronizationManager.isActualTransactionActive()) {
        // ç»‘å®šåˆ°äº‹åŠ¡æäº¤
        TransactionSynchronizationManager.registerSynchronization(...);
    } else {
        // æ— äº‹åŠ¡æ—¶ç›´æ¥å¼‚æ­¥åˆ é™¤
        scheduleSecondEvict(key);
    }
}
</code></pre><hr><h3 id=-å¢å¼ºå¥å£®æ€§>âš™ï¸ <strong>å¢å¼ºå¥å£®æ€§</strong></h3><h4 id=çº¿ç¨‹æ± éš”ç¦»><strong>çº¿ç¨‹æ± éš”ç¦»</strong></h4><p>ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œé¿å…é˜»å¡äº‹åŠ¡çº¿ç¨‹ï¼š</p><pre tabindex=0><code>private final ScheduledExecutorService executor = 
    Executors.newScheduledThreadPool(4);

private void scheduleSecondEvict(Object key) {
    executor.schedule(() -&gt; delegate.evict(key), delay, TimeUnit.MILLISECONDS);
}
</code></pre><h4 id=äº‹åŠ¡å›æ»šè¡¥å¿><strong>äº‹åŠ¡å›æ»šè¡¥å¿</strong></h4><p>è‹¥äº‹åŠ¡å›æ»šéœ€æ’¤é”€é¦–æ¬¡åˆ é™¤ï¼ˆå¤æ‚åœºæ™¯ï¼‰ï¼š</p><pre tabindex=0><code>@Override
public void evict(Object key) {
    Object cachedValue = delegate.get(key).orElse(null); // å¤‡ä»½æ—§å€¼
    delegate.evict(key); // é¦–æ¬¡åˆ é™¤

    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronization() {
            @Override
            public void afterCompletion(int status) {
                if (status == STATUS_ROLLED_BACK) {
                    delegate.put(key, cachedValue); // å›æ»šæ—¶æ¢å¤æ—§ç¼“å­˜
                } else if (status == STATUS_COMMITTED) {
                    scheduleSecondEvict(key); // æäº¤åäºŒæ¬¡åˆ é™¤
                }
            }
        }
    );
}
</code></pre><p><strong>æ³¨æ„</strong>ï¼šæ­¤æ–¹æ¡ˆé€‚ç”¨äº<strong>å¼ºä¸€è‡´æ€§è¦æ±‚</strong>çš„åœºæ™¯ï¼Œä½†éœ€è€ƒè™‘ç¼“å­˜æ¢å¤çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚</p><hr><h3 id=-æ–¹æ¡ˆå¯¹æ¯”-1>ğŸ“Š <strong>æ–¹æ¡ˆå¯¹æ¯”</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>æ–¹æ¡ˆ</strong></th><th>ä¸€è‡´æ€§ä¿éšœ</th><th>å¤æ‚åº¦</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>äº‹åŠ¡æäº¤åè§¦å‘äºŒæ¬¡åˆ é™¤</td><td>é¿å…è¯¯åˆ æ–°ç¼“å­˜</td><td>ä¸­</td><td>é€šç”¨åœºæ™¯ï¼ˆæ¨èï¼‰</td></tr><tr><td>å›æ»šæ—¶æ¢å¤æ—§ç¼“å­˜</td><td>å¼ºä¸€è‡´æ€§</td><td>é«˜</td><td>é‡‘è/æ”¯ä»˜ç­‰é«˜æ•æ„Ÿä¸šåŠ¡</td></tr></tbody></table></div><hr><h3 id=-æ€»ç»“-2>ğŸ’ <strong>æ€»ç»“</strong></h3><ul><li><strong>ä¼˜å…ˆäº‹åŠ¡ç»‘å®š</strong>ï¼šé€šè¿‡ <code>TransactionSynchronization.afterCommit()</code> ç¡®ä¿äºŒæ¬¡åˆ é™¤ä»…åœ¨äº‹åŠ¡æäº¤åæ‰§è¡Œã€‚</li><li><strong>å¤‡ä»½æ¢å¤æ…ç”¨</strong>ï¼šä»…åœ¨å¿…è¦æ—¶æ¢å¤æ—§ç¼“å­˜ï¼Œé¿å…å¹¶å‘å†²çªã€‚</li><li><strong>å»¶è¿ŸåŒåˆ æœ¬è´¨</strong>ï¼šè¯¥æœºåˆ¶é€‚ç”¨äº<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>åœºæ™¯ï¼Œè‹¥éœ€å¼ºä¸€è‡´æ€§ï¼Œå»ºè®®ç»“åˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¦‚ TCCï¼‰ã€‚</li></ul><blockquote><p>å®Œæ•´ä»£ç ç¤ºä¾‹å‚è€ƒï¼š<a class=link href=https://gist.github.com/example target=_blank rel=noopener>GitHub Gist</a>
æ‰©å±•é˜…è¯»ï¼š<a class=link href=https://spring.io/guides target=_blank rel=noopener>Spring äº‹åŠ¡ä¸ç¼“å­˜ååŒè®¾è®¡</a></p></blockquote><h2 id=aop>AOP</h2><p>åœ¨Springæ¡†æ¶ä¸­ï¼Œé€šè¿‡è‡ªå®šä¹‰AOPåˆ‡é¢ç»“åˆè‡ªå®šä¹‰æ³¨è§£æ–¹æ¡ˆï¼Œ<strong>å¯ä»¥è¯†åˆ«äº‹åŠ¡æ˜¯å¦å›æ»š</strong>ï¼Œä½†éœ€ä¾èµ–Springçš„äº‹åŠ¡ç®¡ç†æœºåˆ¶å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡çŠ¶æ€ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ–¹æ¡ˆåŠæ³¨æ„äº‹é¡¹ï¼š</p><hr><h3 id=-æ ¸å¿ƒå®ç°æ–¹æ¡ˆ>ğŸ” æ ¸å¿ƒå®ç°æ–¹æ¡ˆ</h3><h4 id=é€šè¿‡><strong>é€šè¿‡ <code>TransactionSynchronizationManager</code> ä¸»åŠ¨æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€</strong></h4><p>åœ¨åˆ‡é¢ä¸­å¯ç›´æ¥æ£€æŸ¥å½“å‰äº‹åŠ¡çš„æ ‡è®°çŠ¶æ€ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Around</span><span class=p>(</span><span class=s>&#34;@annotation(com.example.CustomAnnotation)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>aroundAdvice</span><span class=p>(</span><span class=n>ProceedingJoinPoint</span><span class=w> </span><span class=n>joinPoint</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>joinPoint</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w> </span><span class=c1>// æ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ£€æŸ¥äº‹åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå›æ»š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>isActualTransactionActive</span><span class=p>()</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>TransactionAspectSupport</span><span class=p>.</span><span class=na>currentTransactionStatus</span><span class=p>().</span><span class=na>isRollbackOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ã€äº‹åŠ¡å·²æ ‡è®°å›æ»šã€‘&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è‹¥ä¸šåŠ¡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡é€šå¸¸å·²æ ‡è®°å›æ»š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ã€äº‹åŠ¡å› å¼‚å¸¸å›æ»šã€‘&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>åŸç†ï¼š<ul><li><code>TransactionAspectSupport.currentTransactionStatus().isRollbackOnly()</code> è¿”å› <code>true</code> è¡¨ç¤ºäº‹åŠ¡å·²è¢«æ ‡è®°ä¸ºå›æ»šï¼ˆä¾‹å¦‚è°ƒç”¨ <code>setRollbackOnly()</code> æˆ–æ»¡è¶³å›æ»šè§„åˆ™çš„å¼‚å¸¸ï¼‰ã€‚</li><li><code>TransactionSynchronizationManager.isActualTransactionActive()</code> æ£€æŸ¥å½“å‰æ˜¯å¦å­˜åœ¨æ´»åŠ¨äº‹åŠ¡ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šåœ¨æ–¹æ³•æ‰§è¡Œåæ£€æµ‹äº‹åŠ¡çŠ¶æ€ã€‚</li></ul><hr><h4 id=æ³¨å†Œäº‹åŠ¡åŒæ­¥å›è°ƒæ¨è><strong>æ³¨å†Œäº‹åŠ¡åŒæ­¥å›è°ƒï¼ˆæ¨èï¼‰</strong></h4><p>é€šè¿‡ <code>TransactionSynchronization</code> ç›‘å¬äº‹åŠ¡æäº¤æˆ–å›æ»šäº‹ä»¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Around</span><span class=p>(</span><span class=s>&#34;@annotation(com.example.CustomAnnotation)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>aroundAdvice</span><span class=p>(</span><span class=n>ProceedingJoinPoint</span><span class=w> </span><span class=n>joinPoint</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>registerSynchronization</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TransactionSynchronization</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>STATUS_ROLLED_BACK</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ã€äº‹åŠ¡å·²å›æ»šã€‘&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>STATUS_COMMITTED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ã€äº‹åŠ¡å·²æäº¤ã€‘&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>joinPoint</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>åŸç†ï¼š<ul><li><code>afterCompletion</code> å›è°ƒåœ¨äº‹åŠ¡å®Œæˆæ—¶è§¦å‘ï¼Œå‚æ•° <code>status</code> æ ‡è¯†äº‹åŠ¡çŠ¶æ€ï¼ˆ<code>STATUS_ROLLED_BACK</code> æˆ– <code>STATUS_COMMITTED</code>ï¼‰ã€‚</li></ul></li><li><strong>ä¼˜åŠ¿</strong>ï¼šæ— éœ€ä¸»åŠ¨æŸ¥è¯¢ï¼Œç”±äº‹åŠ¡ç®¡ç†å™¨è‡ªåŠ¨é€šçŸ¥ï¼Œå‡†ç¡®æ€§é«˜ã€‚</li></ul><hr><h4 id=åœ¨åˆ‡é¢ä¸­ç›´æ¥è·å–><strong>åœ¨åˆ‡é¢ä¸­ç›´æ¥è·å– <code>TransactionStatus</code></strong></h4><p>è‹¥è‡ªå®šä¹‰åˆ‡é¢åœ¨äº‹åŠ¡åˆ‡é¢<strong>ä¹‹å</strong>æ‰§è¡Œï¼ˆä¼˜å…ˆçº§æ›´ä½ï¼‰ï¼Œå¯ç›´æ¥æ³¨å…¥äº‹åŠ¡çŠ¶æ€ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Order</span><span class=p>(</span><span class=n>Ordered</span><span class=p>.</span><span class=na>LOWEST_PRECEDENCE</span><span class=p>)</span><span class=w> </span><span class=c1>// ç¡®ä¿ä¼˜å…ˆçº§ä½äºäº‹åŠ¡åˆ‡é¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Around</span><span class=p>(</span><span class=s>&#34;@annotation(com.example.CustomAnnotation)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>aroundAdvice</span><span class=p>(</span><span class=n>ProceedingJoinPoint</span><span class=w> </span><span class=n>joinPoint</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransactionStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransactionAspectSupport</span><span class=p>.</span><span class=na>currentTransactionStatus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>joinPoint</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isRollbackOnly</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;äº‹åŠ¡å·²æ ‡è®°å›æ»š&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;äº‹åŠ¡å› å¼‚å¸¸å›æ»š&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>æ³¨æ„</strong>ï¼šåˆ‡é¢ä¼˜å…ˆçº§å¿…é¡»ä½äºäº‹åŠ¡åˆ‡é¢ï¼ˆ<code>@Order(Ordered.LOWEST_PRECEDENCE)</code>ï¼‰ï¼Œå¦åˆ™æ— æ³•è·å–æ­£ç¡®çŠ¶æ€ã€‚</li></ul><hr><h3 id=-æ³¨æ„äº‹é¡¹-1>âš ï¸ æ³¨æ„äº‹é¡¹</h3><h4 id=åˆ‡é¢æ‰§è¡Œé¡ºåº><strong>åˆ‡é¢æ‰§è¡Œé¡ºåº</strong></h4><ul><li>äº‹åŠ¡åˆ‡é¢é»˜è®¤ä¼˜å…ˆçº§ä¸º <code>Ordered.LOWEST_PRECEDENCE</code>ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰ã€‚</li><li><strong>é—®é¢˜</strong>ï¼šè‹¥è‡ªå®šä¹‰åˆ‡é¢ä¼˜å…ˆçº§æ›´é«˜ä¸”æœªæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡åˆ‡é¢æ— æ³•æ„ŸçŸ¥å¼‚å¸¸ï¼Œå¯¼è‡´å›æ»šå¤±æ•ˆã€‚</li><li>è§£å†³ï¼š<ul><li>è‡ªå®šä¹‰åˆ‡é¢ä¼˜å…ˆçº§éœ€ä½äºäº‹åŠ¡åˆ‡é¢ï¼š<code>@Order(Ordered.LOWEST_PRECEDENCE + 1)</code>ã€‚</li><li>åœ¨åˆ‡é¢ä¸­æ•è·å¼‚å¸¸åå¿…é¡»é‡æ–°æŠ›å‡ºæˆ–è°ƒç”¨ <code>setRollbackOnly()</code>ã€‚</li></ul></li></ul><h4 id=æ— äº‹åŠ¡åœºæ™¯><strong>æ— äº‹åŠ¡åœºæ™¯</strong></h4><ul><li>è‹¥æ–¹æ³•æœªå¼€å¯äº‹åŠ¡ï¼ˆå¦‚ <code>@Transactional(propagation = NOT_SUPPORTED)</code>ï¼‰ï¼Œåˆ™ <code>TransactionSynchronizationManager.isActualTransactionActive()</code> è¿”å› <code>false</code>ï¼Œéœ€é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</li></ul><h4 id=å¼‚æ­¥çº¿ç¨‹é—®é¢˜><strong>å¼‚æ­¥çº¿ç¨‹é—®é¢˜</strong></h4><ul><li>äº‹åŠ¡çŠ¶æ€ç»‘å®šäºå½“å‰çº¿ç¨‹ï¼Œè‹¥åˆ‡é¢å†…å¯ç”¨æ–°çº¿ç¨‹ï¼Œéœ€æ‰‹åŠ¨ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼ˆå¦‚ä½¿ç”¨ <code>TransactionContextHolder</code>ï¼‰ã€‚</li></ul><hr><h3 id=-æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©>ğŸ’ æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©</h3><div class=table-wrapper><table><thead><tr><th><strong>æ–¹æ¡ˆ</strong></th><th>å‡†ç¡®æ€§</th><th>å¤æ‚åº¦</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>ä¸»åŠ¨æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€</td><td>ä¸­</td><td>ä½</td><td>ç®€å•çŠ¶æ€æ£€æµ‹</td></tr><tr><td>äº‹åŠ¡åŒæ­¥å›è°ƒ (<code>TransactionSynchronization</code>)</td><td>é«˜</td><td>ä¸­</td><td>éœ€ç²¾å‡†ç›‘å¬äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td>ç›´æ¥è·å– <code>TransactionStatus</code></td><td>é«˜</td><td>é«˜</td><td>åˆ‡é¢ä¼˜å…ˆçº§ä½äºäº‹åŠ¡åˆ‡é¢æ—¶</td></tr></tbody></table></div><blockquote><p><strong>æ¨èå®è·µ</strong>ï¼šä¼˜å…ˆä½¿ç”¨ <strong>äº‹åŠ¡åŒæ­¥å›è°ƒ</strong> æ–¹æ¡ˆï¼Œå¯é æ€§æœ€é«˜ä¸”ä¸äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸè§£è€¦ã€‚</p></blockquote><hr><h3 id=-æ‰©å±•ç¼–ç¨‹å¼æ ‡è®°å›æ»š>ğŸ› ï¸ æ‰©å±•ï¼šç¼–ç¨‹å¼æ ‡è®°å›æ»š</h3><p>è‹¥éœ€åœ¨åˆ‡é¢ä¸­ä¸»åŠ¨è§¦å‘å›æ»šï¼ˆå¦‚æƒé™æ ¡éªŒå¤±è´¥ï¼‰ï¼š</p><pre tabindex=0><code>@Around(&#34;@annotation(com.example.CustomAnnotation)&#34;)
public Object aroundAdvice(ProceedingJoinPoint joinPoint) throws Throwable {
    if (!checkPermission()) {
        // æ ‡è®°äº‹åŠ¡å›æ»š
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
        throw new SecurityException(&#34;æƒé™ä¸è¶³&#34;);
    }
    return joinPoint.proceed();
}
</code></pre><p>æ­¤æ“ä½œä¼šå¼ºåˆ¶äº‹åŠ¡å›æ»šï¼Œä¸”åç»­äº‹åŠ¡åŒæ­¥å™¨å°†æ”¶åˆ° <code>STATUS_ROLLED_BACK</code> äº‹ä»¶ã€‚</p><hr><h3 id=-æ€»ç»“-3>ğŸ’ <strong>æ€»ç»“</strong></h3><p>åœ¨è‡ªå®šä¹‰AOPåˆ‡é¢ä¸­è¯†åˆ«äº‹åŠ¡å›æ»šçš„å…³é”®æ˜¯ï¼š</p><ol><li><strong>äº‹åŠ¡çŠ¶æ€æŸ¥è¯¢</strong>ï¼šé€šè¿‡ <code>TransactionAspectSupport.currentTransactionStatus()</code> æˆ– <code>TransactionSynchronizationManager</code> ä¸»åŠ¨æ£€æµ‹ã€‚</li><li><strong>äº‹ä»¶ç›‘å¬</strong>ï¼šæ³¨å†Œ <code>TransactionSynchronization</code> å›è°ƒç›‘å¬æäº¤/å›æ»šäº‹ä»¶ã€‚</li><li><strong>åˆ‡é¢é¡ºåº</strong>ï¼šç¡®ä¿è‡ªå®šä¹‰åˆ‡é¢ä¼˜å…ˆçº§ä½äºäº‹åŠ¡åˆ‡é¢ï¼Œé¿å…çŠ¶æ€è¯¯åˆ¤ã€‚</li><li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šåˆ‡é¢å†…æ•è·å¼‚å¸¸åéœ€é‡æ–°æŠ›å‡ºæˆ–æ˜¾å¼è°ƒç”¨ <code>setRollbackOnly()</code>ã€‚</li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/postopia/>Postopia</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Oct 22, 2025 16:26 CST</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/postopiaexactly-once/><div class=article-details><h2 class=article-title>ã€Postopiaã€‘Exactly Once</h2></div></a></article><article><a href=/p/postopiaqps/><div class=article-details><h2 class=article-title>ã€Postopiaã€‘QPS</h2></div></a></article><article><a href=/p/postopiapage/><div class=article-details><h2 class=article-title>ã€Postopiaã€‘page</h2></div></a></article><article><a href=/p/postopiatimer/><div class=article-details><h2 class=article-title>ã€Postopiaã€‘timer</h2></div></a></article><article><a href=/p/distributedxxl-job/><div class=article-details><h2 class=article-title>ã€Distributedã€‘XXL-JOB</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 é£é¸¿è¸é›ªæ³¥</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>