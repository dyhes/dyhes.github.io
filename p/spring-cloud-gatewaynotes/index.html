<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Flux vs. Mono Flux 和 Mono 是 Reactor 框架中实现响应式编程的核心类型，用于处理异步数据流。它们基于 Reactive Streams 规范，支持非阻塞、背压（Backpressure）等特性，适用于高并发场景。以下是两者的对比与解析：\n核心概念 Flux\n定义：表示一个 0到N个元素的异步序列，支持无限数据流（如实时事件流）或有限数据集（如数据库查询结果集）。 信号类型：通过 onNext 发送多个元素，最终以 onComplete 或 onError 终止流。 典型场景：处理多个数据项（如消息队列、批量查询）或持续生成的事件流（如传感器数据）。 Mono\n定义：表示 0或1个元素的异步序列，用于单次结果操作（如 HTTP 请求、唯一 ID 查询）。 信号类型：最多触发一次 onNext，随后立即终止（onComplete 或 onError）。 典型场景：返回单个对象（如用户信息）、无返回值的异步操作（如保存操作）。 核心特性对比 特性 Flux Mono 元素数量 0-N 个，支持无限流 0或1个 操作符 支持多元素操作（如 buffer、flatMap） 单元素操作（如 map、flatMap） 性能优化 适合批量数据处理，内存占用较高 单结果处理，轻量级 错误处理 错误终止整个流 直接传递错误信号 使用场景 Flux 的典型应用 批量数据查询 Flux<User> users = userRepository.findAll(); // 查询所有用户 实时事件流处理 Flux<Event> events = Flux.interval(Duration.ofSeconds(1)) .map(tick -> generateEvent()); // 每秒生成事件 数据转换与聚合\n使用 flatMap 和 groupBy 对多个数据流进行合并或拆分。 Mono 的典型应用 单次数据库查询 Mono<User> user = userRepository.findById(id); // 根据ID查询用户 HTTP 请求响应 @GetMapping("/user/{id}") public Mono<User> getUser(@PathVariable String id) { return userService.findUserById(id); } 异步操作结果封装 Mono<Void> saveOperation = userRepository.save(user).then(); // 保存后返回空 操作符与功能 共有操作符 转换类：map（元素转换）、flatMap（异步转换）。 过滤类：filter（条件过滤）、take（限制元素数量）。 错误处理：onErrorResume（错误降级）、retry（重试机制）。 特有操作符 类型 操作符 功能 Flux buffer(10) 将元素按批次收集（如每10个一组） Flux zipWith(otherFlux) 合并两个流并按元素配对处理 Mono defaultIfEmpty() 空值时返回默认值 Mono then(Mono) 当前流完成后触发另一个流 代码示例 Flux 示例 // 创建包含多个元素的流并转换 Flux<Integer> numbers = Flux.just(1, 2, 3) .map(n -> n * 2) // 转换为 [2, 4, 6] .filter(n -> n > 3); // 过滤出 [4, 6] numbers.subscribe(System.out::println); Mono 示例 // 模拟异步查询用户并处理结果 Mono<User> userMono = userRepository.findById("123") .flatMap(user -> { user.setName(user.getName().toUpperCase()); return Mono.just(user); }) .onErrorResume(e -> Mono.just(new User("fallback"))); // 错误时返回默认用户 userMono.subscribe(); 如何选择 Flux 或 Mono？ 数据量：需要处理多个元素时选 Flux，单个或无结果时选 Mono。 性能：Mono 更轻量，适合高频单次操作；Flux 适合批量或流式处理。 语义明确性：使用 Mono 可增强代码可读性（如明确表示“可能有或没有结果”）。 总结 Flux 和 Mono 是响应式编程的基石，分别解决多元素和单元素异步流处理的问题。Flux 擅长复杂的数据流操作（如合并、批处理），而 Mono 在单结果场景中更高效直观。实际开发中需根据业务需求选择，例如在 Spring WebFlux 中，Controller 方法通常返回 Mono（单结果）或 Flux（列表或流）。\n'><title>【Spring Cloud Gateway】Notes</title><link rel=canonical href=https://dyhes.github.io/p/spring-cloud-gatewaynotes/><link rel=stylesheet href=/scss/style.min.f7091bff8043bd3e53b22be6c05dd86b506e8dec4d0d75d249d2dfb0fe074a46.css><meta property='og:title' content="【Spring Cloud Gateway】Notes"><meta property='og:description' content='Flux vs. Mono Flux 和 Mono 是 Reactor 框架中实现响应式编程的核心类型，用于处理异步数据流。它们基于 Reactive Streams 规范，支持非阻塞、背压（Backpressure）等特性，适用于高并发场景。以下是两者的对比与解析：\n核心概念 Flux\n定义：表示一个 0到N个元素的异步序列，支持无限数据流（如实时事件流）或有限数据集（如数据库查询结果集）。 信号类型：通过 onNext 发送多个元素，最终以 onComplete 或 onError 终止流。 典型场景：处理多个数据项（如消息队列、批量查询）或持续生成的事件流（如传感器数据）。 Mono\n定义：表示 0或1个元素的异步序列，用于单次结果操作（如 HTTP 请求、唯一 ID 查询）。 信号类型：最多触发一次 onNext，随后立即终止（onComplete 或 onError）。 典型场景：返回单个对象（如用户信息）、无返回值的异步操作（如保存操作）。 核心特性对比 特性 Flux Mono 元素数量 0-N 个，支持无限流 0或1个 操作符 支持多元素操作（如 buffer、flatMap） 单元素操作（如 map、flatMap） 性能优化 适合批量数据处理，内存占用较高 单结果处理，轻量级 错误处理 错误终止整个流 直接传递错误信号 使用场景 Flux 的典型应用 批量数据查询 Flux<User> users = userRepository.findAll(); // 查询所有用户 实时事件流处理 Flux<Event> events = Flux.interval(Duration.ofSeconds(1)) .map(tick -> generateEvent()); // 每秒生成事件 数据转换与聚合\n使用 flatMap 和 groupBy 对多个数据流进行合并或拆分。 Mono 的典型应用 单次数据库查询 Mono<User> user = userRepository.findById(id); // 根据ID查询用户 HTTP 请求响应 @GetMapping("/user/{id}") public Mono<User> getUser(@PathVariable String id) { return userService.findUserById(id); } 异步操作结果封装 Mono<Void> saveOperation = userRepository.save(user).then(); // 保存后返回空 操作符与功能 共有操作符 转换类：map（元素转换）、flatMap（异步转换）。 过滤类：filter（条件过滤）、take（限制元素数量）。 错误处理：onErrorResume（错误降级）、retry（重试机制）。 特有操作符 类型 操作符 功能 Flux buffer(10) 将元素按批次收集（如每10个一组） Flux zipWith(otherFlux) 合并两个流并按元素配对处理 Mono defaultIfEmpty() 空值时返回默认值 Mono then(Mono) 当前流完成后触发另一个流 代码示例 Flux 示例 // 创建包含多个元素的流并转换 Flux<Integer> numbers = Flux.just(1, 2, 3) .map(n -> n * 2) // 转换为 [2, 4, 6] .filter(n -> n > 3); // 过滤出 [4, 6] numbers.subscribe(System.out::println); Mono 示例 // 模拟异步查询用户并处理结果 Mono<User> userMono = userRepository.findById("123") .flatMap(user -> { user.setName(user.getName().toUpperCase()); return Mono.just(user); }) .onErrorResume(e -> Mono.just(new User("fallback"))); // 错误时返回默认用户 userMono.subscribe(); 如何选择 Flux 或 Mono？ 数据量：需要处理多个元素时选 Flux，单个或无结果时选 Mono。 性能：Mono 更轻量，适合高频单次操作；Flux 适合批量或流式处理。 语义明确性：使用 Mono 可增强代码可读性（如明确表示“可能有或没有结果”）。 总结 Flux 和 Mono 是响应式编程的基石，分别解决多元素和单元素异步流处理的问题。Flux 擅长复杂的数据流操作（如合并、批处理），而 Mono 在单结果场景中更高效直观。实际开发中需根据业务需求选择，例如在 Spring WebFlux 中，Controller 方法通常返回 Mono（单结果）或 Flux（列表或流）。\n'><meta property='og:url' content='https://dyhes.github.io/p/spring-cloud-gatewaynotes/'><meta property='og:site_name' content='飞鸿踏雪泥'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring'><meta property='article:tag' content='Postopia'><meta property='article:published_time' content='2025-05-17T00:00:00+00:00'><meta property='article:modified_time' content='2025-07-15T00:01:07+08:00'><meta name=twitter:title content="【Spring Cloud Gateway】Notes"><meta name=twitter:description content='Flux vs. Mono Flux 和 Mono 是 Reactor 框架中实现响应式编程的核心类型，用于处理异步数据流。它们基于 Reactive Streams 规范，支持非阻塞、背压（Backpressure）等特性，适用于高并发场景。以下是两者的对比与解析：\n核心概念 Flux\n定义：表示一个 0到N个元素的异步序列，支持无限数据流（如实时事件流）或有限数据集（如数据库查询结果集）。 信号类型：通过 onNext 发送多个元素，最终以 onComplete 或 onError 终止流。 典型场景：处理多个数据项（如消息队列、批量查询）或持续生成的事件流（如传感器数据）。 Mono\n定义：表示 0或1个元素的异步序列，用于单次结果操作（如 HTTP 请求、唯一 ID 查询）。 信号类型：最多触发一次 onNext，随后立即终止（onComplete 或 onError）。 典型场景：返回单个对象（如用户信息）、无返回值的异步操作（如保存操作）。 核心特性对比 特性 Flux Mono 元素数量 0-N 个，支持无限流 0或1个 操作符 支持多元素操作（如 buffer、flatMap） 单元素操作（如 map、flatMap） 性能优化 适合批量数据处理，内存占用较高 单结果处理，轻量级 错误处理 错误终止整个流 直接传递错误信号 使用场景 Flux 的典型应用 批量数据查询 Flux<User> users = userRepository.findAll(); // 查询所有用户 实时事件流处理 Flux<Event> events = Flux.interval(Duration.ofSeconds(1)) .map(tick -> generateEvent()); // 每秒生成事件 数据转换与聚合\n使用 flatMap 和 groupBy 对多个数据流进行合并或拆分。 Mono 的典型应用 单次数据库查询 Mono<User> user = userRepository.findById(id); // 根据ID查询用户 HTTP 请求响应 @GetMapping("/user/{id}") public Mono<User> getUser(@PathVariable String id) { return userService.findUserById(id); } 异步操作结果封装 Mono<Void> saveOperation = userRepository.save(user).then(); // 保存后返回空 操作符与功能 共有操作符 转换类：map（元素转换）、flatMap（异步转换）。 过滤类：filter（条件过滤）、take（限制元素数量）。 错误处理：onErrorResume（错误降级）、retry（重试机制）。 特有操作符 类型 操作符 功能 Flux buffer(10) 将元素按批次收集（如每10个一组） Flux zipWith(otherFlux) 合并两个流并按元素配对处理 Mono defaultIfEmpty() 空值时返回默认值 Mono then(Mono) 当前流完成后触发另一个流 代码示例 Flux 示例 // 创建包含多个元素的流并转换 Flux<Integer> numbers = Flux.just(1, 2, 3) .map(n -> n * 2) // 转换为 [2, 4, 6] .filter(n -> n > 3); // 过滤出 [4, 6] numbers.subscribe(System.out::println); Mono 示例 // 模拟异步查询用户并处理结果 Mono<User> userMono = userRepository.findById("123") .flatMap(user -> { user.setName(user.getName().toUpperCase()); return Mono.just(user); }) .onErrorResume(e -> Mono.just(new User("fallback"))); // 错误时返回默认用户 userMono.subscribe(); 如何选择 Flux 或 Mono？ 数据量：需要处理多个元素时选 Flux，单个或无结果时选 Mono。 性能：Mono 更轻量，适合高频单次操作；Flux 适合批量或流式处理。 语义明确性：使用 Mono 可增强代码可读性（如明确表示“可能有或没有结果”）。 总结 Flux 和 Mono 是响应式编程的基石，分别解决多元素和单元素异步流处理的问题。Flux 擅长复杂的数据流操作（如合并、批处理），而 Mono 在单结果场景中更高效直观。实际开发中需根据业务需求选择，例如在 Spring WebFlux 中，Controller 方法通常返回 Mono（单结果）或 Flux（列表或流）。\n'><link rel="shortcut icon" href=/github.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b567f26f71c49c33.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>飞鸿踏雪泥</a></h1><h2 class=site-description>没有记录，就没有发生</h2></div></header><ol class=menu-social><li><a href=https://leetcode.cn/u/dyhes/ target=_blank title=LeetCode rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg></a></li><li><a href=https://github.com/dyhes target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:dyheslin@gmail.com target=_blank title=Gmail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-gmail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li><li><a href=mailto:1325574784@qq.com target=_blank title=Mail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 19H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v5.5"/><path d="M3 7l9 6 9-6"/><path d="M19 16l-2 3h4l-2 3"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/categories/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/tags/><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Tags</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#flux-vs-mono>Flux vs. Mono</a><ol><li><a href=#核心概念><strong>核心概念</strong></a></li><li><a href=#核心特性对比><strong>核心特性对比</strong></a></li><li><a href=#使用场景><strong>使用场景</strong></a><ol><li><a href=#flux-的典型应用><strong>Flux 的典型应用</strong></a></li><li><a href=#mono-的典型应用><strong>Mono 的典型应用</strong></a></li></ol></li><li><a href=#操作符与功能><strong>操作符与功能</strong></a><ol><li><a href=#共有操作符><strong>共有操作符</strong></a></li><li><a href=#特有操作符><strong>特有操作符</strong></a></li></ol></li><li><a href=#代码示例><strong>代码示例</strong></a><ol><li><a href=#flux-示例><strong>Flux 示例</strong></a></li><li><a href=#mono-示例><strong>Mono 示例</strong></a></li></ol></li><li><a href=#如何选择-flux-或-mono><strong>如何选择 Flux 或 Mono？</strong></a></li><li><a href=#总结><strong>总结</strong></a></li></ol></li><li><a href=#serverhttprequestdecorator>ServerHttpRequestDecorator</a><ol><li><a href=#核心功能与作用><strong>核心功能与作用</strong></a></li><li><a href=#关键方法与使用示例><strong>关键方法与使用示例</strong></a><ol><li><a href=#常用方法><strong>常用方法</strong></a></li><li><a href=#代码示例-1><strong>代码示例</strong></a></li></ol></li><li><a href=#典型应用场景><strong>典型应用场景</strong></a></li><li><a href=#注意事项><strong>注意事项</strong></a></li><li><a href=#相关类对比><strong>相关类对比</strong></a></li></ol></li><li><a href=#serverhttpresponsedecorator>ServerHttpResponseDecorator</a><ol><li><a href=#核心功能与作用-1><strong>核心功能与作用</strong></a></li><li><a href=#核心方法与使用示例><strong>核心方法与使用示例</strong></a><ol><li><a href=#关键方法><strong>关键方法</strong></a></li><li><a href=#代码示例-2><strong>代码示例</strong></a></li></ol></li><li><a href=#典型应用场景-1><strong>典型应用场景</strong></a></li><li><a href=#注意事项-1><strong>注意事项</strong></a></li><li><a href=#相关类与上下文><strong>相关类与上下文</strong></a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/willow/ style=background-color:#dc9123;color:>满城风絮
</a><a href=/categories/nutrition/ style=background-color:#93b5cf;color:>积雪粮</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/spring-cloud-gatewaynotes/>【Spring Cloud Gateway】Notes</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 17, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><h2 id=flux-vs-mono>Flux vs. Mono</h2><p>Flux 和 Mono 是 Reactor 框架中实现响应式编程的核心类型，用于处理异步数据流。它们基于 Reactive Streams 规范，支持非阻塞、背压（Backpressure）等特性，适用于高并发场景。以下是两者的对比与解析：</p><hr><h3 id=核心概念><strong>核心概念</strong></h3><ol><li><p><strong>Flux</strong></p><ul><li><strong>定义</strong>：表示一个 <strong>0到N个元素的异步序列</strong>，支持无限数据流（如实时事件流）或有限数据集（如数据库查询结果集）。</li><li><strong>信号类型</strong>：通过 <code>onNext</code> 发送多个元素，最终以 <code>onComplete</code> 或 <code>onError</code> 终止流。</li><li><strong>典型场景</strong>：处理多个数据项（如消息队列、批量查询）或持续生成的事件流（如传感器数据）。</li></ul></li><li><p><strong>Mono</strong></p><ul><li><strong>定义</strong>：表示 <strong>0或1个元素的异步序列</strong>，用于单次结果操作（如 HTTP 请求、唯一 ID 查询）。</li><li><strong>信号类型</strong>：最多触发一次 <code>onNext</code>，随后立即终止（<code>onComplete</code> 或 <code>onError</code>）。</li><li><strong>典型场景</strong>：返回单个对象（如用户信息）、无返回值的异步操作（如保存操作）。</li></ul></li></ol><hr><h3 id=核心特性对比><strong>核心特性对比</strong></h3><div class=table-wrapper><table><thead><tr><th>特性</th><th>Flux</th><th>Mono</th></tr></thead><tbody><tr><td><strong>元素数量</strong></td><td>0-N 个，支持无限流</td><td>0或1个</td></tr><tr><td><strong>操作符</strong></td><td>支持多元素操作（如 <code>buffer</code>、<code>flatMap</code>）</td><td>单元素操作（如 <code>map</code>、<code>flatMap</code>）</td></tr><tr><td><strong>性能优化</strong></td><td>适合批量数据处理，内存占用较高</td><td>单结果处理，轻量级</td></tr><tr><td><strong>错误处理</strong></td><td>错误终止整个流</td><td>直接传递错误信号</td></tr></tbody></table></div><hr><h3 id=使用场景><strong>使用场景</strong></h3><h4 id=flux-的典型应用><strong>Flux 的典型应用</strong></h4><ol><li><strong>批量数据查询</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>findAll</span><span class=p>();</span><span class=w>  </span><span class=c1>// 查询所有用户</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>实时事件流处理</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Event</span><span class=o>&gt;</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>interval</span><span class=p>(</span><span class=n>Duration</span><span class=p>.</span><span class=na>ofSeconds</span><span class=p>(</span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>tick</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>generateEvent</span><span class=p>());</span><span class=w>  </span><span class=c1>// 每秒生成事件</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>数据转换与聚合</strong><br>使用 <code>flatMap</code> 和 <code>groupBy</code> 对多个数据流进行合并或拆分。</li></ol><h4 id=mono-的典型应用><strong>Mono 的典型应用</strong></h4><ol><li><strong>单次数据库查询</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Mono</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>  </span><span class=c1>// 根据ID查询用户</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>HTTP 请求响应</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/user/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUser</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>findUserById</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>异步操作结果封装</strong><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=n>saveOperation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>user</span><span class=p>).</span><span class=na>then</span><span class=p>();</span><span class=w>  </span><span class=c1>// 保存后返回空</span><span class=w>
</span></span></span></code></pre></div></li></ol><hr><h3 id=操作符与功能><strong>操作符与功能</strong></h3><h4 id=共有操作符><strong>共有操作符</strong></h4><ul><li><strong>转换类</strong>：<code>map</code>（元素转换）、<code>flatMap</code>（异步转换）。</li><li><strong>过滤类</strong>：<code>filter</code>（条件过滤）、<code>take</code>（限制元素数量）。</li><li><strong>错误处理</strong>：<code>onErrorResume</code>（错误降级）、<code>retry</code>（重试机制）。</li></ul><h4 id=特有操作符><strong>特有操作符</strong></h4><div class=table-wrapper><table><thead><tr><th>类型</th><th>操作符</th><th>功能</th></tr></thead><tbody><tr><td>Flux</td><td><code>buffer(10)</code></td><td>将元素按批次收集（如每10个一组）</td></tr><tr><td>Flux</td><td><code>zipWith(otherFlux)</code></td><td>合并两个流并按元素配对处理</td></tr><tr><td>Mono</td><td><code>defaultIfEmpty()</code></td><td>空值时返回默认值</td></tr><tr><td>Mono</td><td><code>then(Mono)</code></td><td>当前流完成后触发另一个流</td></tr></tbody></table></div><hr><h3 id=代码示例><strong>代码示例</strong></h3><h4 id=flux-示例><strong>Flux 示例</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 创建包含多个元素的流并转换</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>numbers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w>                </span><span class=c1>// 转换为 [2, 4, 6]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>3</span><span class=p>);</span><span class=w>            </span><span class=c1>// 过滤出 [4, 6]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>numbers</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>::</span><span class=n>println</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h4 id=mono-示例><strong>Mono 示例</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 模拟异步查询用户并处理结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>userMono</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userRepository</span><span class=p>.</span><span class=na>findById</span><span class=p>(</span><span class=s>&#34;123&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>flatMap</span><span class=p>(</span><span class=n>user</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>user</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>toUpperCase</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=na>onErrorResume</span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>Mono</span><span class=p>.</span><span class=na>just</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>(</span><span class=s>&#34;fallback&#34;</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 错误时返回默认用户</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>userMono</span><span class=p>.</span><span class=na>subscribe</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=如何选择-flux-或-mono><strong>如何选择 Flux 或 Mono？</strong></h3><ol><li><strong>数据量</strong>：需要处理多个元素时选 Flux，单个或无结果时选 Mono。</li><li><strong>性能</strong>：Mono 更轻量，适合高频单次操作；Flux 适合批量或流式处理。</li><li><strong>语义明确性</strong>：使用 Mono 可增强代码可读性（如明确表示“可能有或没有结果”）。</li></ol><hr><h3 id=总结><strong>总结</strong></h3><p>Flux 和 Mono 是响应式编程的基石，分别解决多元素和单元素异步流处理的问题。Flux 擅长复杂的数据流操作（如合并、批处理），而 Mono 在单结果场景中更高效直观。实际开发中需根据业务需求选择，例如在 Spring WebFlux 中，Controller 方法通常返回 Mono（单结果）或 Flux（列表或流）。</p><h2 id=serverhttprequestdecorator>ServerHttpRequestDecorator</h2><p>ServerHttpRequestDecorator 是 Spring WebFlux 框架中用于增强或修改 HTTP 请求的核心工具类，基于装饰器模式实现对请求的拦截和动态处理。以下是其核心特性、使用场景及示例的详细解析：</p><hr><h3 id=核心功能与作用><strong>核心功能与作用</strong></h3><ul><li><p><strong>请求信息拦截与修改</strong><br>继承自 <code>ServerHttpRequest</code>，通过重写 <code>getHeaders()</code>、<code>getBody()</code> 等方法，开发者可以修改请求头、请求体等关键信息。例如，动态添加请求头、解密请求内容或统一请求格式。</p></li><li><p><strong>装饰器模式实现</strong><br>在不改变原始 <code>ServerHttpRequest</code> 对象的基础上扩展功能，支持链式调用和多层包装，适用于对请求进行非侵入式处理。</p></li></ul><hr><h3 id=关键方法与使用示例><strong>关键方法与使用示例</strong></h3><h4 id=常用方法><strong>常用方法</strong></h4><ul><li><p><code>getHeaders()</code><br>重写此方法可动态修改请求头信息（如强制设置 <code>Content-Type</code>）。</p></li><li><p><code>getBody()</code><br>拦截请求体数据流（<code>Flux&lt;DataBuffer></code>），允许对原始数据进行转换（如解密、日志记录）。</p></li></ul><h4 id=代码示例-1><strong>代码示例</strong></h4><p><strong>场景：强制设置请求头的 Content-Type</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ContentRequestDecorator</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ServerHttpRequestDecorator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ContentRequestDecorator</span><span class=p>(</span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>delegate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>delegate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>HttpHeaders</span><span class=w> </span><span class=nf>getHeaders</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpHeaders</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HttpHeaders</span><span class=p>.</span><span class=na>writableHttpHeaders</span><span class=p>(</span><span class=kd>super</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>headers</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=n>MediaType</span><span class=p>.</span><span class=na>APPLICATION_JSON</span><span class=p>);</span><span class=w> </span><span class=c1>// 强制设置为 JSON 类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>headers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>应用方式</strong><br>在过滤器中包装原始请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>WebFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>decoratedRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ContentRequestDecorator</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>getRequest</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>().</span><span class=na>request</span><span class=p>(</span><span class=n>decoratedRequest</span><span class=p>).</span><span class=na>build</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>场景：解密请求体内容</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DecryptRequestDecorator</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ServerHttpRequestDecorator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getBody</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>getBody</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>buffer</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>encrypted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataBufferUtils</span><span class=p>.</span><span class=na>releaseBufferToString</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>decrypted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AesUtils</span><span class=p>.</span><span class=na>decrypt</span><span class=p>(</span><span class=n>encrypted</span><span class=p>);</span><span class=w> </span><span class=c1>// 自定义解密逻辑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>bufferFactory</span><span class=p>().</span><span class=na>wrap</span><span class=p>(</span><span class=n>decrypted</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=典型应用场景><strong>典型应用场景</strong></h3><ol><li><p><strong>请求头动态处理</strong><br>例如统一添加认证头（如 <code>Authorization</code>）或修复客户端缺失的 <code>Content-Type</code>。</p></li><li><p><strong>请求体内容转换</strong><br>解密敏感数据、压缩/解压缩请求体，或记录原始请求内容用于调试。</p></li><li><p><strong>协议兼容性适配</strong><br>将非标准协议（如自定义二进制格式）转换为标准 HTTP 请求，方便后续处理。</p></li><li><p><strong>数据格式统一</strong><br>对异构客户端发送的 XML、表单数据等统一转换为 JSON，简化业务逻辑。</p></li></ol><hr><h3 id=注意事项><strong>注意事项</strong></h3><ul><li><p><strong>避免重复提交</strong><br>若直接操作请求体数据流，需确保数据仅被消费一次，否则会触发 <code>IllegalStateException</code>。可通过缓存（如 <code>Flux.cache()</code>）解决。</p></li><li><p><strong>性能优化</strong><br>高频请求处理需注意内存管理，推荐使用非阻塞式流处理（如 <code>Flux.map</code> 代替同步循环）。</p></li><li><p><strong>与 ServerWebExchange 集成</strong><br>通常结合 <code>ServerWebExchange.mutate()</code> 方法，将装饰后的请求注入过滤器链。</p></li></ul><hr><h3 id=相关类对比><strong>相关类对比</strong></h3><ul><li><p><strong>ServerHttpRequest</strong><br>原始请求接口，提供基础请求信息访问能力。</p></li><li><p><strong>ServletServerHttpRequest</strong><br>针对 Servlet 容器的适配器，将 <code>HttpServletRequest</code> 转换为响应式请求对象，通常与 <code>ServerHttpRequestDecorator</code> 配合使用。</p></li></ul><p>通过合理应用 <code>ServerHttpRequestDecorator</code>，开发者能够灵活控制请求处理流程，满足复杂的业务需求。</p><h2 id=serverhttpresponsedecorator>ServerHttpResponseDecorator</h2><p>在 Spring Cloud Gateway 中，<code>ServerHttpResponseDecorator</code> 是一个用于包装并增强 <code>ServerHttpResponse</code> 功能的工具类，主要用于拦截和修改网关的响应内容。以下是其核心特性和应用场景的详细介绍：</p><hr><h3 id=核心功能与作用-1><strong>核心功能与作用</strong></h3><ul><li><p><strong>响应内容拦截与修改</strong><br><code>ServerHttpResponseDecorator</code> 继承自 <code>ServerHttpResponse</code>，通过重写 <code>writeWith()</code> 方法，开发者可以在响应体写入前或写入后对数据进行修改。例如，可以动态添加响应头、加密响应内容或记录日志。</p></li><li><p><strong>装饰器模式实现</strong><br>通过装饰器模式，<code>ServerHttpResponseDecorator</code> 在不改变原始 <code>ServerHttpResponse</code> 对象的基础上扩展功能，支持链式调用和多重包装。</p></li></ul><hr><h3 id=核心方法与使用示例><strong>核心方法与使用示例</strong></h3><h4 id=关键方法><strong>关键方法</strong></h4><ul><li><p><code>writeWith(Publisher&lt;DataBuffer> body)</code><br>重写此方法以拦截原始响应体的数据流，允许对 <code>DataBuffer</code> 进行自定义处理（如字符串转换、JSON 序列化等）。</p></li><li><p><code>getDelegate()</code><br>获取被装饰的原始 <code>ServerHttpResponse</code> 实例，便于直接操作底层属性（如状态码、Cookie 等）。</p></li></ul><h4 id=代码示例-2><strong>代码示例</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomResponseDecorator</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ServerHttpResponseDecorator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>CustomResponseDecorator</span><span class=p>(</span><span class=n>ServerHttpResponse</span><span class=w> </span><span class=n>delegate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>delegate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>writeWith</span><span class=p>(</span><span class=n>Publisher</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>DataBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>body</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 修改响应体内容（例如添加前缀）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>modifiedBody</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flux</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>body</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>buffer</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataBufferUtils</span><span class=p>.</span><span class=na>releaseBufferToString</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>bufferFactory</span><span class=p>().</span><span class=na>wrap</span><span class=p>((</span><span class=s>&#34;Modified: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>content</span><span class=p>).</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>writeWith</span><span class=p>(</span><span class=n>modifiedBody</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在过滤器中应用该装饰器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CustomFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>GlobalFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filter</span><span class=p>(</span><span class=n>ServerWebExchange</span><span class=w> </span><span class=n>exchange</span><span class=p>,</span><span class=w> </span><span class=n>GatewayFilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerHttpResponse</span><span class=w> </span><span class=n>decoratedResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CustomResponseDecorator</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>getResponse</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>chain</span><span class=p>.</span><span class=na>filter</span><span class=p>(</span><span class=n>exchange</span><span class=p>.</span><span class=na>mutate</span><span class=p>().</span><span class=na>response</span><span class=p>(</span><span class=n>decoratedResponse</span><span class=p>).</span><span class=na>build</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=典型应用场景-1><strong>典型应用场景</strong></h3><ol><li><p><strong>动态修改响应头</strong><br>例如添加安全相关的 <code>Content-Security-Policy</code> 或自定义业务标识头。</p></li><li><p><strong>统一响应格式</strong><br>对后端服务的原始响应进行封装，统一错误码或标准化数据结构。</p></li><li><p><strong>日志记录与监控</strong><br>记录响应耗时、响应体大小等指标，集成监控系统。</p></li><li><p><strong>敏感数据脱敏</strong><br>在响应返回客户端前，对敏感字段（如手机号、身份证号）进行脱敏处理。</p></li></ol><hr><h3 id=注意事项-1><strong>注意事项</strong></h3><ul><li><p><strong>响应提交状态</strong><br>需通过 <code>isCommitted()</code> 方法判断响应是否已提交，避免重复操作导致异常。</p></li><li><p><strong>性能影响</strong><br>响应体的拦截和修改涉及数据流操作，需注意内存消耗和延迟，建议使用非阻塞式处理。</p></li></ul><hr><h3 id=相关类与上下文><strong>相关类与上下文</strong></h3><ul><li><p><strong><code>ServerWebExchange</code></strong><br>网关请求的上下文对象，持有 <code>ServerHttpRequest</code> 和 <code>ServerHttpResponse</code>，是操作请求和响应的入口。</p></li><li><p><strong><code>ReactorServerHttpResponse</code></strong><br><code>ServerHttpResponse</code> 的默认实现类，基于 Netty 的响应处理，其 <code>HttpHeaders</code> 可直接修改。</p></li></ul><p>通过合理使用 <code>ServerHttpResponseDecorator</code>，开发者可以灵活控制网关的响应行为，满足复杂业务需求。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/spring/>Spring</a>
<a href=/tags/postopia/>Postopia</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Jul 15, 2025 00:01 CST</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/spring-clouddeployment/><div class=article-details><h2 class=article-title>【Spring Cloud】Deployment</h2></div></a></article><article><a href=/p/postopiaexactly-once/><div class=article-details><h2 class=article-title>【Postopia】Exactly Once</h2></div></a></article><article><a href=/p/postopiaqps/><div class=article-details><h2 class=article-title>【Postopia】QPS</h2></div></a></article><article><a href=/p/postopiacaffeine/><div class=article-details><h2 class=article-title>【Postopia】caffeine</h2></div></a></article><article><a href=/p/postopiapage/><div class=article-details><h2 class=article-title>【Postopia】page</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 飞鸿踏雪泥</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>