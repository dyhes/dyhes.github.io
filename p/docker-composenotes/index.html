<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Version 在 docker-compose.yaml 文件中，第一行的 version 字段用于指定当前文件遵循的 Docker Compose 配置规范版本。它的作用主要体现在以下几个方面：\n定义语法与功能支持 version 决定了 Compose 文件使用的语法规则和可用功能。不同版本的 Compose 规范支持不同的配置项：\n版本 2：引入 services 顶级键，支持资源限制（如 CPU、内存）、容器依赖管理、网络和卷的高级配置。 版本 3：兼容 Docker Swarm 集群模式，支持滚动更新、服务扩展等编排功能，适用于多主机部署场景。 更高版本（如 3.8）：逐步新增特性（如 GPU 资源分配、健康检查增强等），同时保持向后兼容性。 若未显式指定 version，默认行为因 Docker Compose 版本而异：\n旧版工具（如 Docker Compose v1/v2）可能默认使用版本 2 的语法； 新版工具（如 Compose V2+）支持无 version 声明，直接遵循最新的 Compose 规范。 与 Docker 引擎的兼容性 Docker Compose 文件版本需与 Docker 引擎版本匹配，否则可能因语法不兼容导致报错。例如：\nversion: '3.8' 要求 Docker Engine 19.03.0+； version: '3' 最低要求 Docker Engine 1.13.0+； 若使用旧版 Docker（如 17.06），需选择 version: '3.3' 或更低。 废弃与演进 旧版本（如 v1）：已废弃，仅支持基础配置，不推荐使用。 新版规范趋势：官方逐步弱化对 version 的强制要求。若文件未声明 version，默认采用最新规范，同时可能触发警告（如 WARN[0000] version is obsolete）。 推荐做法： 单机环境：可省略 version，直接使用最新语法； 集群或需明确版本控制：显式声明版本（如 3.8）以确保兼容性。 示例与选择建议 version: '3.8' # 声明使用 3.8 版本规范（需 Docker 19.03.0+） services: web: image: nginx deploy: # 此配置项仅在版本 3+ 中有效 replicas: 3 总结：version 主要用于控制语法解析规则和功能范围，需根据 Docker 环境版本和需求选择。新版开发中可逐步过渡到无 version 声明，以简化配置。\n"><title>【Docker Compose】Notes</title><link rel=canonical href=https://dyhes.github.io/p/docker-composenotes/><link rel=stylesheet href=/scss/style.min.f7091bff8043bd3e53b22be6c05dd86b506e8dec4d0d75d249d2dfb0fe074a46.css><meta property='og:title' content="【Docker Compose】Notes"><meta property='og:description' content="Version 在 docker-compose.yaml 文件中，第一行的 version 字段用于指定当前文件遵循的 Docker Compose 配置规范版本。它的作用主要体现在以下几个方面：\n定义语法与功能支持 version 决定了 Compose 文件使用的语法规则和可用功能。不同版本的 Compose 规范支持不同的配置项：\n版本 2：引入 services 顶级键，支持资源限制（如 CPU、内存）、容器依赖管理、网络和卷的高级配置。 版本 3：兼容 Docker Swarm 集群模式，支持滚动更新、服务扩展等编排功能，适用于多主机部署场景。 更高版本（如 3.8）：逐步新增特性（如 GPU 资源分配、健康检查增强等），同时保持向后兼容性。 若未显式指定 version，默认行为因 Docker Compose 版本而异：\n旧版工具（如 Docker Compose v1/v2）可能默认使用版本 2 的语法； 新版工具（如 Compose V2+）支持无 version 声明，直接遵循最新的 Compose 规范。 与 Docker 引擎的兼容性 Docker Compose 文件版本需与 Docker 引擎版本匹配，否则可能因语法不兼容导致报错。例如：\nversion: '3.8' 要求 Docker Engine 19.03.0+； version: '3' 最低要求 Docker Engine 1.13.0+； 若使用旧版 Docker（如 17.06），需选择 version: '3.3' 或更低。 废弃与演进 旧版本（如 v1）：已废弃，仅支持基础配置，不推荐使用。 新版规范趋势：官方逐步弱化对 version 的强制要求。若文件未声明 version，默认采用最新规范，同时可能触发警告（如 WARN[0000] version is obsolete）。 推荐做法： 单机环境：可省略 version，直接使用最新语法； 集群或需明确版本控制：显式声明版本（如 3.8）以确保兼容性。 示例与选择建议 version: '3.8' # 声明使用 3.8 版本规范（需 Docker 19.03.0+） services: web: image: nginx deploy: # 此配置项仅在版本 3+ 中有效 replicas: 3 总结：version 主要用于控制语法解析规则和功能范围，需根据 Docker 环境版本和需求选择。新版开发中可逐步过渡到无 version 声明，以简化配置。\n"><meta property='og:url' content='https://dyhes.github.io/p/docker-composenotes/'><meta property='og:site_name' content='飞鸿踏雪泥'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Docker'><meta property='article:published_time' content='2025-05-14T00:00:00+00:00'><meta property='article:modified_time' content='2025-06-15T19:46:57+08:00'><meta name=twitter:title content="【Docker Compose】Notes"><meta name=twitter:description content="Version 在 docker-compose.yaml 文件中，第一行的 version 字段用于指定当前文件遵循的 Docker Compose 配置规范版本。它的作用主要体现在以下几个方面：\n定义语法与功能支持 version 决定了 Compose 文件使用的语法规则和可用功能。不同版本的 Compose 规范支持不同的配置项：\n版本 2：引入 services 顶级键，支持资源限制（如 CPU、内存）、容器依赖管理、网络和卷的高级配置。 版本 3：兼容 Docker Swarm 集群模式，支持滚动更新、服务扩展等编排功能，适用于多主机部署场景。 更高版本（如 3.8）：逐步新增特性（如 GPU 资源分配、健康检查增强等），同时保持向后兼容性。 若未显式指定 version，默认行为因 Docker Compose 版本而异：\n旧版工具（如 Docker Compose v1/v2）可能默认使用版本 2 的语法； 新版工具（如 Compose V2+）支持无 version 声明，直接遵循最新的 Compose 规范。 与 Docker 引擎的兼容性 Docker Compose 文件版本需与 Docker 引擎版本匹配，否则可能因语法不兼容导致报错。例如：\nversion: '3.8' 要求 Docker Engine 19.03.0+； version: '3' 最低要求 Docker Engine 1.13.0+； 若使用旧版 Docker（如 17.06），需选择 version: '3.3' 或更低。 废弃与演进 旧版本（如 v1）：已废弃，仅支持基础配置，不推荐使用。 新版规范趋势：官方逐步弱化对 version 的强制要求。若文件未声明 version，默认采用最新规范，同时可能触发警告（如 WARN[0000] version is obsolete）。 推荐做法： 单机环境：可省略 version，直接使用最新语法； 集群或需明确版本控制：显式声明版本（如 3.8）以确保兼容性。 示例与选择建议 version: '3.8' # 声明使用 3.8 版本规范（需 Docker 19.03.0+） services: web: image: nginx deploy: # 此配置项仅在版本 3+ 中有效 replicas: 3 总结：version 主要用于控制语法解析规则和功能范围，需根据 Docker 环境版本和需求选择。新版开发中可逐步过渡到无 version 声明，以简化配置。\n"><link rel="shortcut icon" href=/github.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b567f26f71c49c33.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>飞鸿踏雪泥</a></h1><h2 class=site-description>没有记录，就没有发生</h2></div></header><ol class=menu-social><li><a href=https://leetcode.cn/u/dyhes/ target=_blank title=LeetCode rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg></a></li><li><a href=https://github.com/dyhes target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:dyheslin@gmail.com target=_blank title=Gmail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-gmail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li><li><a href=mailto:1325574784@qq.com target=_blank title=Mail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 19H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v5.5"/><path d="M3 7l9 6 9-6"/><path d="M19 16l-2 3h4l-2 3"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/categories/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/tags/><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Tags</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#version>Version</a><ol><li><a href=#定义语法与功能支持><strong>定义语法与功能支持</strong></a></li><li><a href=#与-docker-引擎的兼容性><strong>与 Docker 引擎的兼容性</strong></a></li><li><a href=#废弃与演进><strong>废弃与演进</strong></a></li><li><a href=#示例与选择建议>示例与选择建议</a></li></ol></li><li><a href=#volumns-不设置>Volumns 不设置</a><ol><li><a href=#数据存储方式><strong>数据存储方式</strong></a></li><li><a href=#自动创建的条件><strong>自动创建的条件</strong></a></li><li><a href=#推荐做法><strong>推荐做法</strong></a></li><li><a href=#模式对比>模式对比</a></li></ol></li><li><a href=#volumes-语法>Volumes 语法</a><ol><li><a href=#短格式short-syntax><strong>短格式（Short Syntax）</strong></a><ol><li><a href=#基本结构><strong>基本结构</strong></a></li><li><a href=#常见用法示例><strong>常见用法示例</strong></a></li></ol></li><li><a href=#长格式long-syntax><strong>长格式（Long Syntax）</strong></a><ol><li><a href=#基本结构-1><strong>基本结构</strong></a></li><li><a href=#示例与配置项><strong>示例与配置项</strong></a></li></ol></li><li><a href=#匿名卷与命名卷对比><strong>匿名卷与命名卷对比</strong></a></li><li><a href=#数据持久化策略><strong>数据持久化策略</strong></a></li><li><a href=#注意事项><strong>注意事项</strong></a></li><li><a href=#完整示例><strong>完整示例</strong></a></li></ol></li><li><a href=#build>build</a><ol><li><a href=#基本用法>基本用法</a></li><li><a href=#常用选项与参数>常用选项与参数</a></li><li><a href=#配置文件中的-build-参数>配置文件中的 <code>build</code> 参数</a></li><li><a href=#使用场景与注意事项>使用场景与注意事项</a></li><li><a href=#完整示例-1>完整示例</a></li></ol></li><li><a href=#rebuild>rebuild</a><ol><li><a href=#核心命令及用法>核心命令及用法</a><ol><li><a href=#单独执行><strong>单独执行 <code>build</code> 命令</strong></a></li><li><a href=#结合><strong>结合 <code>up</code> 命令触发重建</strong></a></li></ol></li><li><a href=#高级配置与参数>高级配置与参数</a><ol><li><a href=#拉取最新基础镜像><strong>拉取最新基础镜像</strong></a></li><li><a href=#传递构建参数><strong>传递构建参数</strong></a></li><li><a href=#并行构建加速><strong>并行构建加速</strong></a></li></ol></li><li><a href=#清理与调试技巧>清理与调试技巧</a><ol><li><a href=#删除旧容器与中间层><strong>删除旧容器与中间层</strong></a></li><li><a href=#查看构建日志><strong>查看构建日志</strong></a></li></ol></li><li><a href=#典型场景示例>典型场景示例</a><ol><li><a href=#全量重建并启动服务><strong>全量重建并启动服务</strong></a></li><li><a href=#增量更新指定服务><strong>增量更新指定服务</strong></a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/willow/ style=background-color:#dc9123;color:>满城风絮
</a><a href=/categories/nutrition/ style=background-color:#93b5cf;color:>积雪粮</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/docker-composenotes/>【Docker Compose】Notes</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 14, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h2 id=version>Version</h2><p>在 <code>docker-compose.yaml</code> 文件中，第一行的 <code>version</code> 字段用于指定当前文件遵循的 Docker Compose 配置规范版本。它的作用主要体现在以下几个方面：</p><hr><h3 id=定义语法与功能支持><strong>定义语法与功能支持</strong></h3><p><code>version</code> 决定了 Compose 文件使用的语法规则和可用功能。不同版本的 Compose 规范支持不同的配置项：</p><ul><li><strong>版本 2</strong>：引入 <code>services</code> 顶级键，支持资源限制（如 CPU、内存）、容器依赖管理、网络和卷的高级配置。</li><li><strong>版本 3</strong>：兼容 Docker Swarm 集群模式，支持滚动更新、服务扩展等编排功能，适用于多主机部署场景。</li><li><strong>更高版本（如 3.8）</strong>：逐步新增特性（如 GPU 资源分配、健康检查增强等），同时保持向后兼容性。</li></ul><p>若未显式指定 <code>version</code>，默认行为因 Docker Compose 版本而异：</p><ul><li>旧版工具（如 Docker Compose v1/v2）可能默认使用版本 2 的语法；</li><li>新版工具（如 Compose V2+）支持无 <code>version</code> 声明，直接遵循最新的 <a class=link href=https://compose-spec.io/ target=_blank rel=noopener>Compose 规范</a>。</li></ul><hr><h3 id=与-docker-引擎的兼容性><strong>与 Docker 引擎的兼容性</strong></h3><p>Docker Compose 文件版本需与 Docker 引擎版本匹配，否则可能因语法不兼容导致报错。例如：</p><ul><li><code>version: '3.8'</code> 要求 Docker Engine <strong>19.03.0+</strong>；</li><li><code>version: '3'</code> 最低要求 Docker Engine <strong>1.13.0+</strong>；</li><li>若使用旧版 Docker（如 17.06），需选择 <code>version: '3.3'</code> 或更低。</li></ul><hr><h3 id=废弃与演进><strong>废弃与演进</strong></h3><ul><li><strong>旧版本（如 v1）</strong>：已废弃，仅支持基础配置，不推荐使用。</li><li><strong>新版规范趋势</strong>：官方逐步弱化对 <code>version</code> 的强制要求。若文件未声明 <code>version</code>，默认采用最新规范，同时可能触发警告（如 <code>WARN[0000] version is obsolete</code>）。</li><li><strong>推荐做法</strong>：<ul><li><strong>单机环境</strong>：可省略 <code>version</code>，直接使用最新语法；</li><li><strong>集群或需明确版本控制</strong>：显式声明版本（如 <code>3.8</code>）以确保兼容性。</li></ul></li></ul><hr><h3 id=示例与选择建议>示例与选择建议</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>  </span><span class=c># 声明使用 3.8 版本规范（需 Docker 19.03.0+）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>  </span><span class=c># 此配置项仅在版本 3+ 中有效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><p><strong>总结</strong>：<code>version</code> 主要用于控制语法解析规则和功能范围，需根据 Docker 环境版本和需求选择。新版开发中可逐步过渡到无 <code>version</code> 声明，以简化配置。</p><h2 id=volumns-不设置>Volumns 不设置</h2><p>在 Docker Compose 中，<strong>不设置 <code>volumes</code> 字段时，Docker 不会自动创建任何宿主机目录或数据卷</strong>，此时容器内的数据仅存储在容器的可写层中，且具备以下特性：</p><hr><h3 id=数据存储方式><strong>数据存储方式</strong></h3><ul><li><strong>默认行为</strong>：不配置 <code>volumes</code> 时，容器内的文件系统与宿主机完全隔离，所有数据仅在容器内部临时存储。</li><li><strong>数据生命周期</strong>：当容器被删除或重建时，所有未持久化的数据都会丢失。</li></ul><hr><h3 id=自动创建的条件><strong>自动创建的条件</strong></h3><p>若需 Docker 自动创建目录或卷，需满足以下条件：</p><ul><li><strong>显式定义 <code>volumes</code></strong>：必须通过 <code>volumes</code> 字段明确指定宿主机路径（如 <code>- /host/path:/container/path</code>）或命名卷（如 <code>- my_volume:/container/path</code>）。</li><li><strong>宿主机路径不存在时</strong>：当使用绑定挂载（<code>bind</code> 模式）且宿主机目录不存在时，Docker 会尝试自动创建该目录，但可能因权限问题导致容器无法写入（自动创建的目录权限默认归属 <code>root</code>）。</li></ul><hr><h3 id=推荐做法><strong>推荐做法</strong></h3><ul><li><strong>显式定义持久化路径</strong>：若需数据持久化，应在 <code>volumes</code> 中明确配置宿主机路径或命名卷。例如：<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./data:/app/data </span><span class=w> </span><span class=c># 自动创建宿主机目录（需注意权限）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>db_volume:/var/lib/mysql </span><span class=w> </span><span class=c># 使用命名卷自动管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db_volume</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div></li><li><strong>手动创建宿主机目录</strong>：对于关键目录（如配置文件、日志路径），建议提前手动创建并设置权限（如 <code>chmod 777 /host/path</code>），避免自动创建引发的权限问题。</li><li><strong>使用命名卷</strong>：对于需要跨容器共享或长期存储的数据，优先使用 Docker 管理的命名卷（<code>volumes</code> 模式），其生命周期独立于容器，且权限更易控制。</li></ul><hr><h3 id=模式对比>模式对比</h3><div class=table-wrapper><table><thead><tr><th><strong>模式</strong></th><th><strong>是否需要显式定义 <code>volumes</code></strong></th><th><strong>数据持久化</strong></th><th><strong>自动创建目录</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>未配置 <code>volumes</code></td><td>否</td><td>否</td><td>否</td><td>临时测试、无需保存数据的场景</td></tr><tr><td>绑定挂载（<code>bind</code>）</td><td>是</td><td>是</td><td>是（有条件）</td><td>开发环境配置文件映射、日志收集</td></tr><tr><td>命名卷（<code>volume</code>）</td><td>是</td><td>是</td><td>是（自动管理）</td><td>生产环境数据持久化、多容器共享数据</td></tr></tbody></table></div><hr><p><strong>总结</strong>：Docker Compose 仅在显式配置 <code>volumes</code> 时才会根据规则自动创建目录或卷。若需数据持久化，务必通过 <code>volumes</code> 字段定义路径或命名卷，并优先通过手动管理目录权限以避免运行时问题。</p><h2 id=volumes-语法>Volumes 语法</h2><p>在 Docker Compose 中，<code>volumes</code> 用于定义容器与宿主机之间的数据挂载规则，支持多种语法格式和配置选项。以下是其核心语法规则及使用场景的总结：</p><hr><h3 id=短格式short-syntax><strong>短格式（Short Syntax）</strong></h3><p>短格式是日常开发中最常用的简洁写法，适用于快速定义简单的数据挂载需求。</p><h4 id=基本结构><strong>基本结构</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>[</span><span class=l>宿主机路径|卷名]:[容器路径]:[权限]</span><span class=w>
</span></span></span></code></pre></div><h4 id=常见用法示例><strong>常见用法示例</strong></h4><div class=table-wrapper><table><thead><tr><th><strong>场景</strong></th><th><strong>示例</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>绑定挂载（Bind Mount）</strong></td><td><code>- /host/path:/container/path</code></td><td>将宿主机的 <code>/host/path</code> 映射到容器的 <code>/container/path</code>，路径需存在或自动创建</td></tr><tr><td><strong>相对路径绑定</strong></td><td><code>- ./data:/app/data</code></td><td>以 Compose 文件所在目录为基准的相对路径映射</td></tr><tr><td><strong>只读权限</strong></td><td><code>- /configs:/etc/configs:ro</code></td><td>容器内目录 <code>/etc/configs</code> 以只读模式挂载</td></tr><tr><td><strong>匿名卷</strong></td><td><code>- /var/lib/mysql</code></td><td>容器内路径挂载到宿主机随机生成的匿名卷（数据生命周期与容器绑定）</td></tr><tr><td><strong>命名卷</strong></td><td><code>- db_volume:/var/lib/mysql</code></td><td>使用预定义的命名卷 <code>db_volume</code>（需在顶级 <code>volumes</code> 块中声明）</td></tr></tbody></table></div><hr><h3 id=长格式long-syntax><strong>长格式（Long Syntax）</strong></h3><p>长格式（Compose v3.2+ 支持）提供更精细的配置选项，适用于复杂场景。</p><h4 id=基本结构-1><strong>基本结构</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>volume|bind|tmpfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>宿主机路径|卷名]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>容器路径]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volume</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nocopy</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=l>|false </span><span class=w> </span><span class=c># 是否禁止复制容器初始数据到新卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>read_only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=l>|false</span><span class=w>
</span></span></span></code></pre></div><h4 id=示例与配置项><strong>示例与配置项</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bind          </span><span class=w> </span><span class=c># 绑定宿主机目录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>./static    </span><span class=w> </span><span class=c># 宿主机相对路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=l>/opt/app/static</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>read_only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>      </span><span class=c># 容器内只读</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>volume        </span><span class=w> </span><span class=c># 使用命名卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=l>db_data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volume</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nocopy</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>       </span><span class=c># 禁止从容器复制初始化数据到新卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>tmpfs         </span><span class=w> </span><span class=c># 临时内存文件系统</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tmpfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=m>10000</span><span class=w>        </span><span class=c># 限制内存大小（单位：字节）</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=匿名卷与命名卷对比><strong>匿名卷与命名卷对比</strong></h3><div class=table-wrapper><table><thead><tr><th><strong>类型</strong></th><th><strong>定义方式</strong></th><th><strong>生命周期</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td><strong>匿名卷</strong></td><td><code>- /container/path</code></td><td>随容器删除而丢失</td><td>临时数据存储（如测试环境）</td></tr><tr><td><strong>命名卷</strong></td><td>需在顶级 <code>volumes</code> 块声明</td><td>独立于容器，需手动删除</td><td>生产环境数据持久化（如数据库文件）</td></tr></tbody></table></div><p><strong>命名卷定义示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db_data</span><span class=p>:</span><span class=w>  </span><span class=c># 顶级定义命名卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver_opts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>nfs         </span><span class=w> </span><span class=c># 使用 NFS 驱动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>o</span><span class=p>:</span><span class=w> </span><span class=l>addr=192.168.1.100,rw</span><span class=w>
</span></span></span></code></pre></div><hr><h3 id=数据持久化策略><strong>数据持久化策略</strong></h3><ol><li><p><strong>开发环境</strong></p><ul><li>使用绑定挂载（<code>bind</code>）实时同步代码和配置文件。</li><li>示例：<code>- ./src:/app/src</code> 实现代码热更新。</li></ul></li><li><p><strong>生产环境</strong></p><ul><li>优先使用命名卷（<code>volume</code>）保证数据安全性和可移植性。</li><li>结合云存储驱动（如 AWS EBS、NFS）实现跨主机共享。</li></ul></li><li><p><strong>临时数据</strong></p><ul><li>使用 <code>tmpfs</code> 类型将数据存储在内存中，避免磁盘 I/O 开销。</li></ul></li></ol><hr><h3 id=注意事项><strong>注意事项</strong></h3><ol><li><p><strong>路径存在性</strong></p><ul><li>绑定挂载时，若宿主机路径不存在，Docker 会自动创建目录（需注意权限问题）。</li></ul></li><li><p><strong>权限冲突</strong></p><ul><li>容器内进程需有权限读写挂载路径，可通过 <code>chmod</code> 提前设置宿主机目录权限。</li></ul></li><li><p><strong>版本兼容性</strong></p><ul><li>长格式需 Compose 文件版本 ≥ <code>3.2</code>。</li></ul></li><li><p><strong>数据备份</strong></p><ul><li>命名卷可通过 <code>docker volume inspect</code> 查看物理路径，便于备份。</li></ul></li></ol><hr><h3 id=完整示例><strong>完整示例</strong></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mysql:8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>db_data:/var/lib/mysql     </span><span class=w> </span><span class=c># 命名卷持久化数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./my.cnf:/etc/mysql/my.cnf </span><span class=w> </span><span class=c># 绑定配置文件（只读）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MYSQL_ROOT_PASSWORD=secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db_data</span><span class=p>:</span><span class=w>  </span><span class=c># 定义命名卷</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span></code></pre></div><p>通过合理选择 <code>volumes</code> 语法，可灵活管理容器数据，满足开发、测试、生产多场景需求。</p><h2 id=build>build</h2><p>Docker Compose 的 <code>build</code> 命令用于根据 <code>docker-compose.yml</code> 文件中的配置构建服务镜像，是管理多容器应用的核心命令之一。以下是其核心功能和用法详解：</p><hr><h3 id=基本用法>基本用法</h3><ol><li><p><strong>构建所有服务镜像</strong><br>默认情况下，<code>docker-compose build</code> 会读取 <code>docker-compose.yml</code> 文件中所有定义了 <code>build</code> 配置的服务，并依次构建它们的镜像。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>./app </span><span class=w> </span><span class=c># 指定构建上下文目录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>api</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>./api</span><span class=w>
</span></span></span></code></pre></div><p>执行 <code>docker-compose build</code> 将同时构建 <code>web</code> 和 <code>api</code> 服务的镜像。</p></li><li><p><strong>构建指定服务镜像</strong><br>若只需构建部分服务，可在命令后添加服务名称。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build web  <span class=c1># 仅构建 web 服务</span>
</span></span></code></pre></div></li></ol><hr><h3 id=常用选项与参数>常用选项与参数</h3><ol><li><p><strong>强制不使用缓存（<code>--no-cache</code>）</strong><br>默认情况下，Docker 会利用缓存层加速构建。使用 <code>--no-cache</code> 可跳过缓存，从头开始构建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --no-cache
</span></span></code></pre></div></li><li><p><strong>拉取最新基础镜像（<code>--pull</code>）</strong><br>强制从镜像仓库拉取最新版本的 <code>FROM</code> 基础镜像，确保构建基于最新依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --pull
</span></span></code></pre></div></li><li><p><strong>并行构建（<code>--parallel</code>）</strong><br>在 Docker Compose 3.4+ 版本中，可通过 <code>--parallel</code> 并行构建多个服务，缩短构建时间：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --parallel
</span></span></code></pre></div></li><li><p><strong>传递构建参数（<code>--build-arg</code>）</strong><br>向 Dockerfile 传递动态参数，例如环境变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --build-arg <span class=nv>APP_ENV</span><span class=o>=</span>production
</span></span></code></pre></div></li><li><p><strong>保留中间容器（<code>--no-rm</code>）</strong><br>默认构建后会删除中间容器，添加此选项可保留用于调试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --no-rm
</span></span></code></pre></div></li></ol><hr><h3 id=配置文件中的-build-参数>配置文件中的 <code>build</code> 参数</h3><p>在 <code>docker-compose.yml</code> 中，<code>build</code> 部分支持以下配置：</p><ul><li><strong><code>context</code></strong>：指定构建上下文的目录（包含 Dockerfile 的路径）。</li><li><strong><code>dockerfile</code></strong>：自定义 Dockerfile 文件名（默认为 <code>Dockerfile</code>）。</li><li><strong><code>args</code></strong>：定义构建时传递的变量，需在 Dockerfile 中通过 <code>ARG</code> 声明。<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>./app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dockerfile</span><span class=p>:</span><span class=w> </span><span class=l>Dockerfile.prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>APP_VERSION=1.0</span><span class=w>
</span></span></span></code></pre></div></li></ul><hr><h3 id=使用场景与注意事项>使用场景与注意事项</h3><ol><li><p><strong>适用场景</strong></p><ul><li>修改了 Dockerfile 或构建上下文中的文件（如代码、依赖配置）。</li><li>需要手动更新镜像版本或传递特定构建参数。</li></ul></li><li><p><strong>与 <code>docker-compose up</code> 的区别</strong><br><code>docker-compose up</code> 会自动检测镜像是否需要重新构建，但直接使用 <code>build</code> 命令可更精细控制构建过程（例如跳过缓存）。</p></li><li><p><strong>注意事项</strong></p><ul><li>并行构建需确保服务间无依赖，否则可能引发构建顺序问题。</li><li>构建完成后需通过 <code>docker-compose up</code> 启动服务容器。</li></ul></li></ol><hr><h3 id=完整示例-1>完整示例</h3><p>假设项目结构如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>./backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dockerfile</span><span class=p>:</span><span class=w> </span><span class=l>Dockerfile.prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>NODE_ENV=production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3000:3000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:14</span><span class=w>
</span></span></span></code></pre></div><p>执行以下命令将构建 <code>app</code> 服务镜像：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --no-cache --pull app
</span></span></code></pre></div><hr><p>通过灵活组合这些选项和配置，可以高效管理 Docker 镜像的构建流程，确保开发与生产环境的一致性。</p><h2 id=rebuild>rebuild</h2><p>在 Docker Compose 中执行镜像的重新构建（Rebuild）可通过以下方法实现，适用于开发过程中代码或配置变更后的更新需求：</p><hr><h3 id=核心命令及用法>核心命令及用法</h3><h4 id=单独执行><strong>单独执行 <code>build</code> 命令</strong></h4><p>通过 <code>docker-compose build</code> 重新构建所有服务的镜像，默认使用缓存加速构建。若需强制完全重建，需添加参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 重建全部服务镜像（跳过缓存）</span>
</span></span><span class=line><span class=cl>docker-compose build --no-cache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 仅重建指定服务（如 web 服务）</span>
</span></span><span class=line><span class=cl>docker-compose build --no-cache web
</span></span></code></pre></div><p>通过 <code>--no-cache</code> 参数禁用缓存，确保从头开始构建镜像。</p><h4 id=结合><strong>结合 <code>up</code> 命令触发重建</strong></h4><p>通过 <code>docker-compose up</code> 的 <code>--build</code> 参数，可在启动服务时自动执行镜像重建：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 重建并启动所有服务（推荐开发调试使用）</span>
</span></span><span class=line><span class=cl>docker-compose up --build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 后台运行并强制重建指定服务</span>
</span></span><span class=line><span class=cl>docker-compose up -d --build web
</span></span></code></pre></div><p>此方式会先执行构建流程再启动容器，适合需要快速验证变更的场景。</p><hr><h3 id=高级配置与参数>高级配置与参数</h3><h4 id=拉取最新基础镜像><strong>拉取最新基础镜像</strong></h4><p>使用 <code>--pull</code> 参数强制从镜像仓库更新 <code>FROM</code> 指令中的基础镜像：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --pull
</span></span></code></pre></div><p>确保构建基于最新依赖环境，避免基础镜像过期问题。</p><h4 id=传递构建参数><strong>传递构建参数</strong></h4><p>在 <code>docker-compose.yml</code> 中定义 <code>args</code> 或通过命令行动态注入变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># docker-compose.yml 配置示例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>APP_ENV</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span></code></pre></div><p>命令行覆盖参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --build-arg <span class=nv>APP_ENV</span><span class=o>=</span>staging
</span></span></code></pre></div><p>适用于环境差异配置（如开发/生产环境切换）。</p><h4 id=并行构建加速><strong>并行构建加速</strong></h4><p>在 Docker Compose 3.4+ 版本中，启用并行构建缩短多服务重建时间：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --parallel
</span></span></code></pre></div><p>需确保服务间无构建顺序依赖。</p><hr><h3 id=清理与调试技巧>清理与调试技巧</h3><h4 id=删除旧容器与中间层><strong>删除旧容器与中间层</strong></h4><p>重建前可通过以下命令清理环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 停止并删除所有关联容器（保留数据卷）</span>
</span></span><span class=line><span class=cl>docker-compose down
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除构建过程中的临时容器（避免残留干扰）</span>
</span></span><span class=line><span class=cl>docker-compose build --force-rm
</span></span></code></pre></div><p><code>--force-rm</code> 参数强制删除中间容器。</p><h4 id=查看构建日志><strong>查看构建日志</strong></h4><p>通过日志排查构建失败原因：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose logs --tail<span class=o>=</span><span class=m>100</span> web
</span></span></code></pre></div><p>结合 <code>docker-compose config</code> 验证配置文件语法正确性。</p><hr><h3 id=典型场景示例>典型场景示例</h3><h4 id=全量重建并启动服务><strong>全量重建并启动服务</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose down <span class=o>&amp;&amp;</span> docker-compose build --no-cache <span class=o>&amp;&amp;</span> docker-compose up -d
</span></span></code></pre></div><p>适用于代码或依赖项大规模变更后的环境刷新。</p><h4 id=增量更新指定服务><strong>增量更新指定服务</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker-compose build --pull web <span class=o>&amp;&amp;</span> docker-compose up -d web
</span></span></code></pre></div><p>仅更新 <code>web</code> 服务，减少对其他服务的影响。</p><hr><p>通过灵活组合上述命令，可高效管理镜像重建流程，兼顾开发效率与部署稳定性。建议根据具体需求选择参数组合，并通过 <code>docker-compose help build</code> 查看完整选项说明。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/docker/>Docker</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Jun 15, 2025 19:46 CST</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/dockerconcepts/><div class=article-details><h2 class=article-title>【Docker】Concepts</h2></div></a></article><article><a href=/p/milvusfundamentals/><div class=article-details><h2 class=article-title>【Milvus】Fundamentals</h2></div></a></article><article><a href=/p/mongodbfundamentals/><div class=article-details><h2 class=article-title>【MongoDB】Fundamentals</h2></div></a></article><article><a href=/p/nebulafundamentals/><div class=article-details><h2 class=article-title>【Nebula】Fundamentals</h2></div></a></article><article><a href=/p/distributedlock/><div class=article-details><h2 class=article-title>【Distributed】Lock</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 飞鸿踏雪泥</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>